<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Leap & Learn ‚Äî Editor (Genially)</title>

<style>
  :root{
    --text:#eaf0ff;
    --muted:#a9b4d6;
    --accent:#7cf9ff;
    --shadow: 0 18px 60px rgba(0,0,0,.55);
    --radius: 18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 800px at 20% 10%, rgba(124,249,255,.12), transparent 60%),
      radial-gradient(1200px 800px at 80% 90%, rgba(255,59,59,.10), transparent 60%),
      linear-gradient(180deg, #050612, #070817);
    overflow:hidden;
  }
  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 16px;
    border-bottom:1px solid rgba(124,249,255,.12);
    background: linear-gradient(180deg, rgba(14,19,48,.75), rgba(8,10,24,.25));
    backdrop-filter: blur(10px);
  }
  header .title{display:flex; gap:10px; align-items:center;}
  .badge{
    padding:6px 10px; border-radius:999px;
    font-weight:900; letter-spacing:.4px; font-size:12px;
    background: rgba(124,249,255,.12);
    border:1px solid rgba(124,249,255,.25);
    color:var(--accent);
    box-shadow: 0 0 22px rgba(124,249,255,.12);
  }
  h1{margin:0;font-size:16px;font-weight:1000;letter-spacing:.2px}
  .sub{color:var(--muted); font-size:12px}

  .wrap{
    height: calc(100% - 62px);
    display:grid;
    grid-template-columns: 460px 1fr;
    gap:14px;
    padding:14px;
  }
  .left, .right{
    border-radius: var(--radius);
    background: linear-gradient(180deg, rgba(14,19,48,.65), rgba(11,16,39,.35));
    border:1px solid rgba(124,249,255,.12);
    box-shadow: var(--shadow);
    overflow:hidden;
    min-height:0;
  }
  .left{display:flex; flex-direction:column;}
  .left .scroll{padding:12px; overflow:auto; height:100%;}

  .section{
    border:1px solid rgba(124,249,255,.12);
    background: rgba(7,9,18,.35);
    border-radius:16px;
    padding:10px;
    margin-bottom:10px;
  }
  .section h2{
    margin:0 0 8px 0;
    font-size:13px;
    letter-spacing:.2px;
    display:flex; align-items:center; justify-content:space-between;
  }
  .hint{color:var(--muted); font-size:11px; line-height:1.25}

  .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
  .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
  label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}

  input[type="text"], input[type="number"], textarea, select{
    width:100%;
    padding:10px 10px;
    border-radius:12px;
    border:1px solid rgba(124,249,255,.16);
    background: rgba(6,8,18,.6);
    color: var(--text);
    outline:none;
  }
  textarea{min-height:140px; resize:vertical}
  input[type="color"]{
    width:100%;
    height:42px;
    border-radius:12px;
    border:1px solid rgba(124,249,255,.16);
    background: rgba(6,8,18,.6);
    padding:6px;
  }

  .check{
    display:flex; gap:10px; align-items:center;
    padding:10px;
    border-radius:12px;
    border:1px solid rgba(124,249,255,.12);
    background: rgba(6,8,18,.45);
    color:var(--text);
  }
  .check input{transform: scale(1.15)}

  .btnbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;}
  button{
    cursor:pointer; border:none;
    padding:10px 12px;
    border-radius:14px;
    font-weight:1000;
    color:#081018;
    background: linear-gradient(180deg, rgba(124,249,255,1), rgba(124,249,255,.7));
    box-shadow: 0 0 25px rgba(124,249,255,.18);
  }
  button.secondary{
    color:var(--text);
    background: rgba(6,8,18,.55);
    border:1px solid rgba(124,249,255,.18);
    box-shadow:none;
  }
  button.danger{
    color:#13060a;
    background: linear-gradient(180deg, rgba(255,59,59,1), rgba(255,59,59,.65));
    box-shadow: 0 0 25px rgba(255,59,59,.16);
  }

  /* LEVEL BLOCKS */
  .lvl{
    border:1px solid rgba(124,249,255,.14);
    border-radius:16px;
    background: rgba(0,0,0,.18);
    padding:10px;
    margin-top:10px;
  }
  .lvlHead{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; margin-bottom:8px;
  }
  .lvlTitle{
    font-weight:1000; color:var(--accent);
    display:flex; align-items:center; gap:10px;
  }
  .trash{
    border:1px solid rgba(255,59,59,.35);
    background: rgba(255,59,59,.14);
    color:#ffd7d7;
    border-radius:12px;
    padding:8px 10px;
    font-weight:1000;
    cursor:pointer;
  }
  .trash:hover{filter:brightness(1.05)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .example{
    margin-top:8px;
    padding:10px;
    border-radius:14px;
    border:1px dashed rgba(124,249,255,.22);
    background: rgba(6,8,18,.35);
    color: var(--muted);
    font-size:11px;
    line-height:1.35;
  }

  .right{display:flex; flex-direction:column; min-height:0;}
  .rightTop{
    padding:10px 12px;
    border-bottom:1px solid rgba(124,249,255,.12);
    display:flex; justify-content:space-between; align-items:center;
  }
  .rightTop .title2{font-weight:1000; letter-spacing:.2px}
  .previewWrap{flex:1; min-height:0; padding:12px;}
  iframe{
    width:100%;
    height:100%;
    border:1px solid rgba(124,249,255,.16);
    border-radius:16px;
    background: rgba(0,0,0,.25);
  }
  .out{
    padding:12px;
    border-top:1px solid rgba(124,249,255,.12);
    background: rgba(7,9,18,.35);
  }
  .out textarea{min-height:170px}

  .toast{
    position:fixed; left:50%; bottom:14px; transform:translateX(-50%);
    padding:10px 12px;
    border-radius:999px;
    background: rgba(6,8,18,.75);
    border:1px solid rgba(124,249,255,.20);
    color:var(--text);
    box-shadow: var(--shadow);
    opacity:0; pointer-events:none;
    transition:.22s;
  }
  .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}

  .err{
    margin-top:10px;
    padding:10px;
    border-radius:14px;
    border:1px solid rgba(255,59,59,.35);
    background: rgba(255,59,59,.10);
    color:#ffd7d7;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size:12px;
    white-space:pre-wrap;
    display:none;
  }
</style>
</head>

<body>
<header>
  <div class="title">
    <span class="badge">EDITOR</span>
    <div>
      <h1>Leap & Learn</h1>
      <div class="sub">–†–µ–¥–∞–∫—Ç–æ—Ä ‚Üí –∂–∏–≤–æ–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä ‚Üí iframe(srcdoc) –¥–ª—è Genially</div>
    </div>
  </div>
  <div class="sub">GitHub Pages ‚Üí Genially</div>
</header>

<div class="wrap">
  <aside class="left">
    <div class="scroll">

      <div class="section">
        <h2>–ë–∞–∑–æ–≤—ã–µ</h2>
        <div class="grid2">
          <div>
            <label>–°–ª–æ–∂–Ω–æ—Å—Ç—å: —Å–µ–∫—É–Ω–¥ –Ω–∞ –≤–æ–ø—Ä–æ—Å</label>
            <input id="seconds" type="number" min="3" max="60" value="10">
          </div>
          <div>
            <label>–ñ–∏–∑–Ω–∏</label>
            <input id="lives" type="number" min="1" max="10" value="5">
          </div>
        </div>
        <div class="hint" style="margin-top:8px">
          –î–æ–±–∞–≤–ª—è–π —É—Ä–æ–≤–Ω–∏ –∫–Ω–æ–ø–∫–æ–π –Ω–∏–∂–µ. –í –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ ‚Äî —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ ‚Äú–≤–æ–ø—Ä–æ—Å + 3 –æ—Ç–≤–µ—Ç–∞‚Äù.
        </div>
      </div>

      <div class="section">
        <h2>–£—Ä–æ–≤–Ω–∏</h2>

        <div id="levelsBox"></div>

        <div class="btnbar" style="margin-top:10px">
          <button id="addLevelBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
        </div>

        <div class="example">
          –§–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–∫–∏ (1-–π –æ—Ç–≤–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π):<br>
          <span class="mono">I ____ running. am/is/are</span><br><br>
          –ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ ‚Äî –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ = –æ—Ç–¥–µ–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å.
        </div>
      </div>

      <div class="section">
        <h2>–¶–≤–µ—Ç–∞ –∏ –Ω–µ–æ–Ω</h2>
        <div class="grid3">
          <div><label>–ù–µ–æ–Ω (main)</label><input id="neonMain" type="color" value="#7cf9ff"></div>
          <div><label>Danger</label><input id="dangerColor" type="color" value="#ff3b3b"></div>
          <div><label>Win</label><input id="winColor" type="color" value="#ffe44d"></div>
        </div>
        <div class="grid2" style="margin-top:10px">
          <div class="check">
            <input id="neonOn" type="checkbox" checked>
            <div>
              <div style="font-weight:1000">–ù–µ–æ–Ω–æ–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞</div>
              <div class="hint">–í—ã–∫–ª—é—á–∏ ‚Äî —É–±–µ—Ä—É—Ç—Å—è glow/—Ç–µ–Ω–∏</div>
            </div>
          </div>
          <div><label>–¶–≤–µ—Ç –≤–æ–ø—Ä–æ—Å–∞</label><input id="questionColor" type="color" value="#000000"></div>
        </div>
      </div>

      <div class="section">
        <h2>–§–æ–Ω / –ø–µ—Ä—Å–æ–Ω–∞–∂ / –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</h2>
        <div class="grid2">
          <div>
            <label>–§–æ–Ω (–ª–æ–∫–∞—Ü–∏—è)</label>
            <select id="bgPreset">
              <option value="river">–†–µ–∫–∞</option>
              <option value="lava">–õ–∞–≤–∞</option>
              <option value="swamp">–ë–æ–ª–æ—Ç–æ</option>
              <option value="custom">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π</option>
            </select>
            <input id="bgUpload" type="file" accept="image/*" style="margin-top:8px; display:none">
          </div>
          <div>
            <label>–ü–µ—Ä—Å–æ–Ω–∞–∂</label>
            <select id="heroPreset">
              <option value="frog">–õ—è–≥—É—à–∫–∞</option>
              <option value="chameleon">–•–∞–º–µ–ª–µ–æ–Ω</option>
              <option value="lizard">–Ø—â–µ—Ä–∏—Ü–∞</option>
              <option value="custom">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–µ–≥–æ</option>
            </select>
            <input id="heroUpload" type="file" accept="image/*" style="margin-top:8px; display:none">
          </div>
        </div>

        <div style="margin-top:10px">
          <label>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
          <select id="platformPreset">
            <option value="lily">–õ–∏–ª–∏—è</option>
            <option value="rock">–ö–∞–º–µ–Ω—å</option>
            <option value="hummock">–ë–æ–ª–æ—Ç–Ω–∞—è –∫–æ—á–∫–∞</option>
            <option value="custom">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—é</option>
          </select>
          <input id="platformUpload" type="file" accept="image/*" style="margin-top:8px; display:none">
        </div>
      </div>

      <div class="section">
        <h2>–î–µ–π—Å—Ç–≤–∏—è</h2>
        <div class="btnbar">
          <button id="copyBtn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe –∏–≥—Ä—ã</button>
          <button class="secondary" id="resetBtn">–°–±—Ä–æ—Å–∏—Ç—å (–¥–µ–º–æ)</button>
          <button class="danger" id="forceReloadBtn">–ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å</button>
        </div>

        <div id="errBox" class="err"></div>
      </div>

    </div>
  </aside>

  <section class="right">
    <div class="rightTop">
      <div class="title2">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
      <div class="sub">–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>
    </div>
    <div class="previewWrap">
      <iframe id="preview" sandbox="allow-scripts"></iframe>
    </div>

    <div class="out">
      <label>–ì–æ—Ç–æ–≤—ã–π –∫–æ–¥ iframe (–≤—Å—Ç–∞–≤—å –≤ Genially)</label>
      <textarea id="iframeOut" readonly></textarea>
      <div class="hint" style="margin-top:8px">
        –≠—Ç–æ –∏ –µ—Å—Ç—å ‚Äú–∫–æ–Ω–µ—á–Ω—ã–π –∫–æ–¥‚Äù –∏–≥—Ä—ã. –í Genially –≤—Å—Ç–∞–≤–ª—è–π —Ü–µ–ª–∏–∫–æ–º.
      </div>
    </div>
  </section>
</div>

<div class="toast" id="toast">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ</div>

<script>
window.addEventListener('error', (ev)=>{
  try{
    const box = document.getElementById('errBox');
    if(!box) return;
    box.style.display = 'block';
    box.textContent =
      'JS ERROR:\\n' +
      (ev.message || 'unknown') + '\\n' +
      (ev.filename ? (ev.filename + ':' + ev.lineno + ':' + ev.colno) : '') + '\\n\\n' +
      (ev.error && ev.error.stack ? ev.error.stack : '');
  }catch(e){}
});
window.addEventListener('unhandledrejection', (ev)=>{
  try{
    const box = document.getElementById('errBox');
    if(!box) return;
    box.style.display = 'block';
    box.textContent = 'PROMISE REJECTION:\\n' + String(ev.reason || ev);
  }catch(e){}
});

document.addEventListener('DOMContentLoaded', ()=>{
  const PRESET_BACKGROUNDS = {
    river: "https://img.genially.com/67961b32a116fb001568a75e/c0c9010f-c3dd-42c1-b7c1-65024fa3aec6.png",
    lava:  "https://img.genially.com/67961b32a116fb001568a75e/fa2ab459-fec9-4ccd-97e3-254427b4ade0.png",
    swamp: "https://img.genially.com/67961b32a116fb001568a75e/02b52ad4-9d31-4b21-a305-8fec6e8a4487.png"
  };
  const PRESET_HERO = {
    frog: "https://img.genially.com/67961b32a116fb001568a75e/3074df22-5c73-4ad2-b0b2-491c6fc247f3.png",
    chameleon: "https://img.genially.com/67961b32a116fb001568a75e/74b56fcf-5354-43dd-9c9a-f50facc9a9bf.png",
    lizard: "https://img.genially.com/67961b32a116fb001568a75e/0feda2a1-485a-4654-8640-bf1adcc9f9ec.png"
  };

  const PLATFORMS = {
    lily: "https://img.genially.com/67961b32a116fb001568a75e/ed6c6e82-953b-43d4-947d-e46227b760f0.png",
    rock: "https://img.genially.com/67961b32a116fb001568a75e/bad37c6d-f04c-45c0-b954-807d79ec3a95.png",
    hummock: "https://img.genially.com/67961b32a116fb001568a75e/c6775617-bde5-43e4-9da8-5332d928807e.png"
  };

  const $ = (id)=>document.getElementById(id);
  const ui = {
    seconds: $('seconds'),
    lives: $('lives'),

    levelsBox: $('levelsBox'),
    addLevelBtn: $('addLevelBtn'),

    neonMain: $('neonMain'),
    dangerColor: $('dangerColor'),
    winColor: $('winColor'),
    neonOn: $('neonOn'),
    questionColor: $('questionColor'),

    bgPreset: $('bgPreset'),
    bgUpload: $('bgUpload'),
    heroPreset: $('heroPreset'),
    heroUpload: $('heroUpload'),
    platformPreset: $('platformPreset'),
    platformUpload: $('platformUpload'),

    preview: $('preview'),
    iframeOut: $('iframeOut'),

    copyBtn: $('copyBtn'),
    resetBtn: $('resetBtn'),
    forceReloadBtn: $('forceReloadBtn'),

    toast: $('toast'),
    errBox: $('errBox'),
  };

  let customBgDataUrl = "";
  let customHeroDataUrl = "";
  let customPlatformDataUrl = "";

  function showError(msg){
    ui.errBox.style.display = msg ? "block" : "none";
    ui.errBox.textContent = msg || "";
  }
  function toast(msg){
    ui.toast.textContent = msg;
    ui.toast.classList.add('show');
    setTimeout(()=>ui.toast.classList.remove('show'), 1100);
  }
  function clampInt(v,min,max,def){
    const n = parseInt(v,10);
    if(Number.isNaN(n)) return def;
    return Math.max(min, Math.min(max, n));
  }
  function readFileAsDataURL(file){
    return new Promise((resolve,reject)=>{
      const fr=new FileReader();
      fr.onload=()=>resolve(fr.result);
      fr.onerror=()=>reject(fr.error);
      fr.readAsDataURL(file);
    });
  }
  function escapeForSingleQuotedAttr(s){
    return s.replace(/&/g,'&amp;').replace(/'/g,'&#39;');
  }
  function escapeHtml(s){
    return String(s)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function getPlatformUrl(){
    const p = ui.platformPreset.value;
    if(p === "custom") return customPlatformDataUrl || PLATFORMS.lily;
    return PLATFORMS[p] || PLATFORMS.lily;
  }

  // ===== LEVEL UI (ADD / DELETE) =====
  function renumberLevels(){
    [...ui.levelsBox.querySelectorAll('.lvl')].forEach((lvl, i)=>{
      lvl.dataset.idx = String(i);
      const title = lvl.querySelector('.lvlTitle span');
      if(title) title.textContent = `–£—Ä–æ–≤–µ–Ω—å ${i+1}`;
      const nameInput = lvl.querySelector('.lvlName');
      if(nameInput && !nameInput.value.trim()){
        nameInput.value = `Level ${i+1}`;
      }
    });
  }

  function addLevel(prefill){
    const idx = ui.levelsBox.querySelectorAll('.lvl').length;
    const wrap = document.createElement('div');
    wrap.className = 'lvl';
    wrap.dataset.idx = String(idx);

    const nameVal = prefill?.name ?? `Level ${idx+1}`;
    const tasksVal = prefill?.tasks ?? `I ____ running. am/is/are`;

    wrap.innerHTML = `
      <div class="lvlHead">
        <div class="lvlTitle">
          <span>–£—Ä–æ–≤–µ–Ω—å ${idx+1}</span>
        </div>
        <button class="trash" type="button" title="–£–¥–∞–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å">üóë</button>
      </div>

      <div>
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è</label>
        <input class="lvlName" type="text" value="${escapeHtml(nameVal)}">
      </div>

      <div style="margin-top:10px">
        <label>–ó–∞–¥–∞–Ω–∏—è (–∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ = 1 –≤–æ–ø—Ä–æ—Å)</label>
        <textarea class="lvlTasks" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä:
I ____ running. am/is/are
She ____ a teacher. am/is/are">${escapeHtml(tasksVal)}</textarea>
      </div>
    `;

    // delete
    wrap.querySelector('.trash').addEventListener('click', ()=>{
      wrap.remove();
      renumberLevels();
      rebuild();
    });

    // rebuild on edit
    wrap.querySelectorAll('input,textarea').forEach(el=>{
      el.addEventListener('input', rebuild);
      el.addEventListener('change', rebuild);
    });

    ui.levelsBox.appendChild(wrap);
    renumberLevels();
    // –ø—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ –Ω–æ–≤–æ–º—É —É—Ä–æ–≤–Ω—é
    setTimeout(()=>wrap.scrollIntoView({behavior:'smooth', block:'start'}), 20);
    rebuild();
  }

  ui.addLevelBtn.addEventListener('click', ()=>addLevel());

  // ===== TASK PARSER =====
  // Accepts lines like: "I ____ running. am/is/are"
  // We split by the LAST space before "a/b/c". Safer: find last token containing "/" and 3 parts.
  function parseTasksText(text){
    const lines = String(text||"")
      .split(/\r?\n/)
      .map(s=>s.trim())
      .filter(s=>s.length>0);

    const questions = [];

    for(const line of lines){
      // find an answers chunk with two slashes
      // try: last chunk after last space
      let qPart = line;
      let aPart = "";

      // first try split by " :: "
      if(line.includes("::")){
        const parts = line.split("::");
        qPart = (parts[0]||"").trim();
        aPart = (parts.slice(1).join("::")||"").trim();
      } else {
        // find last space where the rest contains a/b/c
        const lastSpace = line.lastIndexOf(" ");
        if(lastSpace>0){
          const tail = line.slice(lastSpace+1).trim();
          if((tail.match(/\//g)||[]).length>=2){
            qPart = line.slice(0,lastSpace).trim();
            aPart = tail;
          } else {
            // fallback: find first token in line that contains slashes
            const tokens = line.split(/\s+/);
            const slashTok = [...tokens].reverse().find(t => (t.match(/\//g)||[]).length>=2);
            if(slashTok){
              aPart = slashTok;
              const pos = line.lastIndexOf(slashTok);
              qPart = line.slice(0,pos).trim();
            }
          }
        }
      }

      const ans = aPart.split("/").map(x=>x.trim()).filter(Boolean);
      if(ans.length < 3){
        // if format broken, skip silently (or could keep as text only)
        continue;
      }
      const a1 = ans[0], a2 = ans[1], a3 = ans[2];
      questions.push({ text: qPart || "‚Ä¶", answers:[a1,a2,a3], correct:0 });
    }
    return questions;
  }

  // ===== CONFIG =====
  function getConfig(){
    const seconds = clampInt(ui.seconds.value, 3, 60, 10);
    const lives = clampInt(ui.lives.value, 1, 10, 5);

    const levels = [...ui.levelsBox.querySelectorAll('.lvl')].map((lvl, i)=>{
      const name = (lvl.querySelector('.lvlName')?.value || "").trim() || `Level ${i+1}`;
      const tasks = (lvl.querySelector('.lvlTasks')?.value || "");
      const questions = parseTasksText(tasks);
      // –µ—Å–ª–∏ —É—á–∏—Ç–µ–ª—å –Ω–∏—á–µ–≥–æ –Ω–µ –≤–≤—ë–ª/–æ—à–∏–±—Å—è —Å —Ñ–æ—Ä–º–∞—Ç–æ–º ‚Äî –æ—Å—Ç–∞–≤–∏–º —Ö–æ—Ç—è –±—ã 1 –≤–æ–ø—Ä–æ—Å, —á—Ç–æ–±—ã –∏–≥—Ä–∞ –Ω–µ –ª–æ–º–∞–ª–∞—Å—å
      if(questions.length === 0){
        return {
          name,
          questions: [{ text: "–î–æ–±–∞–≤—å –∑–∞–¥–∞–Ω–∏—è –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ", answers:["OK","...","..."], correct:0 }]
        };
      }
      return { name, questions };
    });

    const bgUrl = (ui.bgPreset.value==='custom')
      ? (customBgDataUrl || PRESET_BACKGROUNDS.river)
      : PRESET_BACKGROUNDS[ui.bgPreset.value];

    const heroUrl = (ui.heroPreset.value==='custom')
      ? (customHeroDataUrl || PRESET_HERO.frog)
      : PRESET_HERO[ui.heroPreset.value];

    return {
      seconds,
      lives,
      levelsData: levels.length ? levels : [{
        name:"Level 1",
        questions:[{text:"I ____ running.",answers:["am","is","are"],correct:0}]
      }],
      colors:{
        neonMain: ui.neonMain.value,
        danger: ui.dangerColor.value,
        win: ui.winColor.value,
        question: ui.questionColor.value
      },
      neonOn: !!ui.neonOn.checked,
      assets:{ bg:bgUrl, hero:heroUrl, platform: getPlatformUrl() }
    };
  }

  // ===== GAME SRC DOC (answers shuffled) =====
  function buildGameSrcdoc(cfg){
    const CFG_JSON = JSON.stringify(cfg);

    let html = `<!doctype html>
<html lang="ru"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Leap & Learn</title>
<style>
:root{--neon-main:${cfg.colors.neonMain};--danger:${cfg.colors.danger};--win:${cfg.colors.win};}
html,body{margin:0;width:100%;height:100%;overflow:hidden;font-family:Arial;background:#0a1730}
#GAME{position:relative;width:100%;height:100%}
#BG{position:absolute;inset:0;z-index:0;background:url("${cfg.assets.bg}") center/cover no-repeat}
#QUESTION{position:absolute;top:26px;width:100%;text-align:center;font-size:26px;z-index:20;color:${cfg.colors.question};text-shadow:0 2px 0 rgba(0,0,0,.35)}
#TIMER{position:absolute;top:70px;left:50%;transform:translateX(-50%);width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#fff;border:2px solid var(--neon-main);box-shadow:${cfg.neonOn ? "0 0 18px var(--neon-main)" : "none"};z-index:20;font-weight:900;color:#053149}
#TIMER.danger{border-color:var(--danger);color:var(--danger);box-shadow:${cfg.neonOn ? "0 0 25px var(--danger)" : "none"}}
#LEVELNAME{position:absolute;top:125px;left:50%;transform:translateX(-50%);z-index:20;font-weight:900;color:#eaf6ff;opacity:.95;text-shadow:${cfg.neonOn ? "0 0 16px rgba(124,249,255,.20)" : "none"}}
#LIVES{position:absolute;top:30px;right:30px;font-size:26px;z-index:20}
#SCORE{position:absolute;top:30px;left:30px;font-size:20px;font-weight:900;z-index:20;color:#fff;text-shadow:0 2px 0 rgba(0,0,0,.35)}
#FROG{position:absolute;left:160px;top:50%;width:110px;height:110px;background:url("${cfg.assets.hero}") no-repeat center/contain;transform:translate(-50%,-65%);z-index:15;pointer-events:none}
#PLATFORMS{position:absolute;inset:0;z-index:10}
.platform{position:absolute;width:150px;height:150px;transition:filter .15s}
.pl{width:150px;height:150px;background:url("${cfg.assets.platform}") no-repeat center/contain;display:flex;align-items:center;justify-content:center;font-weight:900;color:#141414;text-shadow:0 2px 0 rgba(255,255,255,.65),0 0 10px rgba(0,0,0,.35);padding:10px;text-align:center}
.platform.answer{cursor:pointer}
.platform.answer:hover{filter:drop-shadow(0 0 14px rgba(124,249,255,.35))}
#START{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:60;background:rgba(8,16,34,.92)}
.card{width:min(780px,calc(100vw - 40px));border-radius:26px;background:rgba(10,20,50,.92);border:2px solid rgba(124,249,255,.55);box-shadow:${cfg.neonOn ? "0 0 30px rgba(124,249,255,.35)" : "none"};padding:18px;color:#eaf6ff}
.btn{padding:12px 34px;border-radius:16px;font-weight:900;background:#fff;border:2px solid var(--neon-main);box-shadow:${cfg.neonOn ? "0 0 15px var(--neon-main)" : "none"};cursor:pointer;color:#043149}
#END{position:absolute;inset:0;z-index:80;background:rgba(8,16,34,.92);display:none;align-items:center;justify-content:center;flex-direction:column}
#END.show{display:flex}
#END h1{margin:0 0 10px;font-size:48px;text-align:center}
.win{color:var(--win)} .lose{color:var(--danger)}
</style></head><body>
<div id="GAME">
  <div id="BG"></div>
  <div id="SCORE">‚≠ê 0</div>
  <div id="QUESTION"></div>
  <div id="TIMER">00:10</div>
  <div id="LEVELNAME"></div>
  <div id="LIVES"></div>
  <div id="FROG"></div>
  <div id="PLATFORMS"></div>

  <div id="START">
    <div class="card">
      <h2 style="margin:0 0 8px;font-weight:900">Leap & Learn</h2>
      <div style="opacity:.9;font-weight:700;margin-bottom:14px">–ù–∞–∂–º–∏ START –∏ –≤—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞.</div>
      <button id="START_BTN" class="btn">‚ñ∂ START</button>
    </div>
  </div>

  <div id="END">
    <h1 id="END_TXT"></h1>
    <button id="RETRY" class="btn">üîÅ Play again</button>
  </div>
</div>

<script>
const CFG = ${CFG_JSON};
let LEVELS = (CFG.levelsData||[]).map(l=>({
  name:l.name||'Level',
  questions:(l.questions||[]).slice()
}));

function shuffle(a){
  const arr=a.slice();
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

// shuffle answers and keep correct
function randomizeQuestion(q){
  const packs = q.answers.map((txt,idx)=>({txt, idx}));
  const s = shuffle(packs);
  const answers = s.map(x=>x.txt);
  const correct = s.findIndex(x=>x.idx===q.correct);
  return { text:q.text, answers, correct };
}

// shuffle questions inside each level (but keep the level order)
LEVELS = LEVELS.map(l=>{
  const qs = shuffle((l.questions||[]).map(q=>randomizeQuestion(q)));
  return {...l, questions: qs};
});

let score=0, lives=(CFG.lives||5), timer=null, timeLeft=0;

const Q = document.getElementById("QUESTION");
const T = document.getElementById("TIMER");
const L = document.getElementById("LIVES");
const S = document.getElementById("SCORE");
const P = document.getElementById("PLATFORMS");
const START = document.getElementById("START");
const START_BTN = document.getElementById("START_BTN");
const END = document.getElementById("END");
const END_TXT = document.getElementById("END_TXT");
const RETRY = document.getElementById("RETRY");
const LEVELNAME = document.getElementById("LEVELNAME");

function fmt(s){ return "00:"+String(s).padStart(2,"0"); }

let lvl=0; // index level
let qi=0; // index question in level

function curLevel(){ return LEVELS[lvl]; }
function curQ(){ return (curLevel()?.questions||[])[qi]; }

function render(){
  P.innerHTML="";
  const level = curLevel();
  const qq = curQ();

  LEVELNAME.textContent = level ? level.name : "";
  Q.textContent = qq?.text || "";
  L.textContent = "‚ù§Ô∏è".repeat(lives);
  S.textContent = "‚≠ê "+score;

  const answers = qq?.answers || [];
  const correct = qq?.correct ?? 0;

  const STEP=190, y=innerHeight/2;
  const count=Math.ceil((innerWidth-160)/STEP)+4;

  for(let i=0;i<count;i++){
    const d=document.createElement("div");
    d.className="platform";
    d.style.left=160+STEP*i-75+"px";
    d.style.top=y-75+"px";

    const pl=document.createElement("div");
    pl.className="pl";

    if(i>0 && i<=answers.length){
      pl.textContent = answers[i-1];
      d.classList.add("answer");
      d.onclick = () => pick(i-1, correct);
    }

    d.appendChild(pl);
    P.appendChild(d);
  }
}

function startTimer(){
  clearInterval(timer);
  timeLeft = CFG.seconds || 10;
  T.classList.remove("danger");
  T.textContent = fmt(timeLeft);
  timer=setInterval(()=>{
    timeLeft--;
    if(timeLeft<=0){
      clearInterval(timer);
      fail();
      return;
    }
    T.textContent = fmt(timeLeft);
    if(timeLeft<=3) T.classList.add("danger");
  },1000);
}

function pick(answerIdx, correctIdx){
  clearInterval(timer);
  if(answerIdx === correctIdx){
    score += 100 + timeLeft*10;
    nextStep();
  }else{
    fail();
  }
}

function fail(){
  lives--;
  score = Math.max(0, score-80);
  if(lives<=0){ showEnd(false); return; }
  startRound();
}

function nextStep(){
  const level = curLevel();
  const totalQ = (level?.questions||[]).length;

  qi++;
  if(qi >= totalQ){
    // next level
    lvl++;
    qi=0;
    if(lvl >= LEVELS.length){
      showEnd(true);
      return;
    }
  }
  startRound();
}

function startRound(){
  render();
  startTimer();
}

function showEnd(win){
  clearInterval(timer);
  END.classList.add("show");
  END_TXT.textContent = win ? "CONGRATULATIONS!" : "YOU LOST!";
  END_TXT.className = win ? "win" : "lose";
}

function reset(){
  clearInterval(timer);
  END.classList.remove("show");
  START.style.display="flex";
  score=0; lives=(CFG.lives||5); lvl=0; qi=0;
  // reshuffle on restart
  LEVELS = (CFG.levelsData||[]).map(l=>({
    name:l.name||'Level',
    questions: shuffle((l.questions||[]).map(q=>randomizeQuestion(q)))
  }));
  T.textContent = fmt(CFG.seconds||10);
  render();
}

START_BTN.onclick=()=>{
  START.style.display="none";
  score=0; lives=(CFG.lives||5); lvl=0; qi=0;
  startRound();
};
RETRY.onclick=()=>reset();

T.textContent = fmt(CFG.seconds||10);
render();
<\/script>
</body></html>`;

    html = html.replaceAll("</script>", "<\\/script>");
    return html;
  }

  function buildIframeCode(srcdoc){
    const escaped = escapeForSingleQuotedAttr(srcdoc);
    return `<iframe style="width:100%;height:100%;border:0" srcdoc='${escaped}'></iframe>`;
  }

  let rebuildTimer=null;
  function rebuild(){
    clearTimeout(rebuildTimer);
    rebuildTimer=setTimeout(()=>{
      try{
        showError("");
        const cfg = getConfig();
        const srcdoc = buildGameSrcdoc(cfg);
        ui.preview.srcdoc = srcdoc;
        ui.iframeOut.value = buildIframeCode(srcdoc);
      }catch(e){
        showError(String(e && (e.stack || e.message) || e));
        ui.preview.removeAttribute("srcdoc");
        ui.iframeOut.value = "";
      }
    },80);
  }

  function bindRebuild(el){
    el.addEventListener('input', rebuild);
    el.addEventListener('change', rebuild);
  }

  // uploads
  ui.bgPreset.addEventListener('change', ()=>{
    ui.bgUpload.style.display = (ui.bgPreset.value==='custom') ? 'block' : 'none';
    rebuild();
  });
  ui.bgUpload.addEventListener('change', async ()=>{
    const f=ui.bgUpload.files && ui.bgUpload.files[0];
    customBgDataUrl = f ? await readFileAsDataURL(f) : "";
    rebuild();
  });

  ui.heroPreset.addEventListener('change', ()=>{
    ui.heroUpload.style.display = (ui.heroPreset.value==='custom') ? 'block' : 'none';
    rebuild();
  });
  ui.heroUpload.addEventListener('change', async ()=>{
    const f=ui.heroUpload.files && ui.heroUpload.files[0];
    customHeroDataUrl = f ? await readFileAsDataURL(f) : "";
    rebuild();
  });

  ui.platformPreset.addEventListener('change', ()=>{
    ui.platformUpload.style.display = (ui.platformPreset.value==='custom') ? 'block' : 'none';
    rebuild();
  });
  ui.platformUpload.addEventListener('change', async ()=>{
    const f=ui.platformUpload.files && ui.platformUpload.files[0];
    customPlatformDataUrl = f ? await readFileAsDataURL(f) : "";
    rebuild();
  });

  // bind basics
  [ui.seconds, ui.lives, ui.neonMain, ui.dangerColor, ui.winColor, ui.neonOn, ui.questionColor,
   ui.bgPreset, ui.heroPreset, ui.platformPreset
  ].forEach(bindRebuild);

  // buttons
  ui.copyBtn.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(ui.iframeOut.value);
      toast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ");
    }catch(e){
      ui.iframeOut.focus(); ui.iframeOut.select();
      document.execCommand('copy');
      toast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ");
    }
  });

  ui.forceReloadBtn.addEventListener('click', ()=>{ rebuild(); toast("–ü–µ—Ä–µ—Å–æ–±—Ä–∞–Ω–æ"); });

  ui.resetBtn.addEventListener('click', ()=>{
    ui.seconds.value=10;
    ui.lives.value=5;

    ui.neonMain.value="#7cf9ff";
    ui.dangerColor.value="#ff3b3b";
    ui.winColor.value="#ffe44d";
    ui.neonOn.checked=true;
    ui.questionColor.value="#000000";

    ui.bgPreset.value="river"; ui.bgUpload.style.display="none"; customBgDataUrl="";
    ui.heroPreset.value="frog"; ui.heroUpload.style.display="none"; customHeroDataUrl="";
    ui.platformPreset.value="lily"; ui.platformUpload.style.display="none"; customPlatformDataUrl="";

    ui.levelsBox.innerHTML="";
    addLevel({name:"Level 1", tasks:"I ____ running. am/is/are\nShe ____ a teacher. is/am/are"});

    rebuild();
    toast("–°–±—Ä–æ—à–µ–Ω–æ");
  });

  // —Å—Ç–∞—Ä—Ç: –æ–¥–∏–Ω —É—Ä–æ–≤–µ–Ω—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  addLevel({name:"Level 1", tasks:"I ____ running. am/is/are"});

  rebuild();
});
</script>
</body>
</html>
