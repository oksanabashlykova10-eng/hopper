<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Leap and Learn — Editor</title>
<style>
  :root{
    --bg:#070912;
    --panel:#0e1330;
    --panel2:#0b1027;
    --text:#eaf0ff;
    --muted:#a9b4d6;
    --accent:#7cf9ff;
    --danger:#ff3b3b;
    --ok:#39ff88;
    --shadow: 0 18px 60px rgba(0,0,0,.55);
    --radius: 18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text);
    background: radial-gradient(1200px 800px at 20% 10%, rgba(124,249,255,.12), transparent 60%),
                radial-gradient(1200px 800px at 80% 90%, rgba(255,59,59,.10), transparent 60%),
                linear-gradient(180deg, #050612, #070817);
    overflow:hidden;
  }

  /* floating neon stars */
  .stars{position:fixed; inset:0; pointer-events:none; opacity:.9; mix-blend-mode:screen; filter: drop-shadow(0 0 10px rgba(124,249,255,.25));}
  .star{
    position:absolute; width:10px; height:10px;
    background: conic-gradient(from 180deg, rgba(255,255,255,0), rgba(255,255,255,.9), rgba(255,255,255,0));
    transform: rotate(45deg);
    border-radius:2px;
    opacity:.7;
    animation: drift linear infinite, twinkle ease-in-out infinite;
  }
  @keyframes drift{
    from{transform: translate3d(0,0,0) rotate(45deg)}
    to{transform: translate3d(var(--dx), var(--dy), 0) rotate(405deg)}
  }
  @keyframes twinkle{
    0%,100%{opacity:.25; filter: drop-shadow(0 0 8px var(--c))}
    50%{opacity:1; filter: drop-shadow(0 0 18px var(--c))}
  }

  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 16px;
    border-bottom:1px solid rgba(124,249,255,.12);
    background: linear-gradient(180deg, rgba(14,19,48,.75), rgba(8,10,24,.25));
    backdrop-filter: blur(10px);
  }
  header .title{
    display:flex; gap:10px; align-items:center;
  }
  .badge{
    padding:6px 10px;
    border-radius:999px;
    font-weight:700;
    letter-spacing:.4px;
    font-size:12px;
    background: rgba(124,249,255,.12);
    border:1px solid rgba(124,249,255,.25);
    color:var(--accent);
    box-shadow: 0 0 22px rgba(124,249,255,.12);
  }
  h1{
    margin:0;
    font-size:16px;
    font-weight:800;
    letter-spacing:.3px;
  }
  .sub{color:var(--muted); font-size:12px}

  .wrap{
    height: calc(100% - 62px);
    display:grid;
    grid-template-columns: 410px 1fr;
    gap:14px;
    padding:14px;
  }

  .left, .right{
    border-radius: var(--radius);
    background: linear-gradient(180deg, rgba(14,19,48,.65), rgba(11,16,39,.35));
    border:1px solid rgba(124,249,255,.12);
    box-shadow: var(--shadow);
    overflow:hidden;
    min-height:0;
  }

  .left{
    display:flex; flex-direction:column;
  }
  .left .scroll{
    padding:12px;
    overflow:auto;
    height:100%;
  }

  .section{
    border:1px solid rgba(124,249,255,.12);
    background: rgba(7,9,18,.35);
    border-radius:16px;
    padding:10px;
    margin-bottom:10px;
  }
  .section h2{
    margin:0 0 8px 0;
    font-size:13px;
    letter-spacing:.2px;
    display:flex; align-items:center; justify-content:space-between;
  }
  .hint{color:var(--muted); font-size:11px; line-height:1.25}

  .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
  .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
  label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
  input[type="text"], input[type="number"], textarea, select{
    width:100%;
    padding:10px 10px;
    border-radius:12px;
    border:1px solid rgba(124,249,255,.16);
    background: rgba(6,8,18,.6);
    color: var(--text);
    outline:none;
  }
  textarea{min-height:120px; resize:vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px}
  input[type="color"]{
    width:100%;
    height:42px;
    border-radius:12px;
    border:1px solid rgba(124,249,255,.16);
    background: rgba(6,8,18,.6);
    padding:6px;
  }
  .row{display:flex; gap:10px; align-items:flex-end}
  .row > div{flex:1}
  .check{
    display:flex; gap:10px; align-items:center;
    padding:10px;
    border-radius:12px;
    border:1px solid rgba(124,249,255,.12);
    background: rgba(6,8,18,.45);
    color:var(--text);
  }
  .check input{transform: scale(1.15)}
  .btnbar{
    display:flex; gap:10px; flex-wrap:wrap;
    margin-top:8px;
  }
  button{
    cursor:pointer;
    border:none;
    padding:10px 12px;
    border-radius:14px;
    font-weight:800;
    color:#081018;
    background: linear-gradient(180deg, rgba(124,249,255,1), rgba(124,249,255,.7));
    box-shadow: 0 0 25px rgba(124,249,255,.18);
  }
  button.secondary{
    color:var(--text);
    background: rgba(6,8,18,.55);
    border:1px solid rgba(124,249,255,.18);
    box-shadow:none;
  }
  button.danger{
    color:#13060a;
    background: linear-gradient(180deg, rgba(255,59,59,1), rgba(255,59,59,.65));
    box-shadow: 0 0 25px rgba(255,59,59,.16);
  }
  .small{
    font-size:11px; color:var(--muted); margin-top:6px; line-height:1.25
  }

  .right{
    display:flex; flex-direction:column;
    min-height:0;
  }
  .rightTop{
    padding:10px 12px;
    border-bottom:1px solid rgba(124,249,255,.12);
    display:flex; justify-content:space-between; align-items:center;
  }
  .rightTop .title2{font-weight:900; letter-spacing:.2px}
  .previewWrap{
    flex:1;
    min-height:0;
    padding:12px;
  }
  iframe{
    width:100%;
    height:100%;
    border:1px solid rgba(124,249,255,.16);
    border-radius:16px;
    background: rgba(0,0,0,.25);
  }

  .out{
    padding:12px;
    border-top:1px solid rgba(124,249,255,.12);
    background: rgba(7,9,18,.35);
  }
  .out label{margin-bottom:8px}
  .out textarea{min-height:110px}

  .pill{
    display:inline-flex; gap:8px; align-items:center;
    padding:8px 10px;
    border-radius:999px;
    background: rgba(124,249,255,.10);
    border:1px solid rgba(124,249,255,.20);
    color:var(--accent);
    font-size:12px;
    font-weight:800;
  }

  .toast{
    position:fixed; left:50%; bottom:14px; transform:translateX(-50%);
    padding:10px 12px;
    border-radius:999px;
    background: rgba(6,8,18,.75);
    border:1px solid rgba(124,249,255,.20);
    color:var(--text);
    box-shadow: var(--shadow);
    opacity:0; pointer-events:none;
    transition:.22s;
  }
  .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}
</style>
</head>
<body>
<div class="stars" id="stars"></div>

<header>
  <div class="title">
    <span class="badge">EDITOR</span>
    <div>
      <h1>Leap and Learn</h1>
      <div class="sub">Редактор для Genially + живой предпросмотр + копирование iframe (srcdoc)</div>
    </div>
  </div>
  <div class="pill">GitHub Pages → Genially</div>
</header>

<div class="wrap">
  <aside class="left">
    <div class="scroll">

      <div class="section">
        <h2>Базовые</h2>
        <div class="grid2">
          <div>
            <label>Количество уровней</label>
            <input id="levels" type="number" min="1" max="30" value="5">
          </div>
          <div>
            <label>Сложность: секунд на уровень</label>
            <input id="seconds" type="number" min="3" max="120" value="10">
          </div>
        </div>
        <div class="small">Задания берутся по порядку: 1 строка = 1 уровень (лишние строки игнорируются, недостающие — повторяются).</div>
      </div>

      <div class="section">
        <h2>Задания по уровням</h2>
        <label>Окно для заданий (каждая строка — отдельное задание)</label>
        <textarea id="tasks">Choose the correct article: ___ apple
Find the verb: She ___ to school.
Pick the plural: child → ___
Select preposition: I am ___ the river.
Correct spelling: chameleon / camaleon?</textarea>
        <div class="small">Игра в демо-режиме делает 3 варианта ответа автоматически (1 правильный + 2 случайных). Можно менять текст заданий как хочешь.</div>
      </div>

      <div class="section">
        <h2>Экраны (старт / финиш)</h2>
        <div class="grid2">
          <div>
            <label>Цвет стартового экрана</label>
            <input id="startColor" type="color" value="#061c2a">
          </div>
          <div>
            <label>Цвет конечного экрана</label>
            <input id="endColor" type="color" value="#1a0720">
          </div>
        </div>
        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Текст победы</label>
            <input id="winText" type="text" value="Победа! Ты прошёл(а) все уровни!">
          </div>
          <div>
            <label>Текст провала</label>
            <input id="loseText" type="text" value="Упс… Попробуй ещё раз!">
          </div>
        </div>
      </div>

      <div class="section">
        <h2>Панели / таймер / неон</h2>
        <div class="grid3">
          <div>
            <label>Цвет панелей</label>
            <input id="panelColor" type="color" value="#0e2a4a">
          </div>
          <div>
            <label>Цвет таймера</label>
            <input id="timerColor" type="color" value="#7cf9ff">
          </div>
          <div>
            <label>Таймер (критич. цвет)</label>
            <input id="timerDanger" type="color" value="#ff3b3b">
          </div>
        </div>
        <div class="grid2" style="margin-top:10px">
          <div class="check">
            <input id="neon" type="checkbox" checked>
            <div>
              <div style="font-weight:900">Неоновая подсветка</div>
              <div class="hint">Добавляет glow к панелям/таймеру</div>
            </div>
          </div>
          <div>
            <label>Порог “красного” таймера (сек.)</label>
            <input id="dangerAt" type="number" min="1" max="30" value="3">
          </div>
        </div>
      </div>

      <div class="section">
        <h2>Шрифт</h2>
        <div class="grid3">
          <div>
            <label>Цвет текста</label>
            <input id="fontColor" type="color" value="#eaf0ff">
          </div>
          <div>
            <label>Размер шрифта (px)</label>
            <input id="fontSize" type="number" min="12" max="40" value="18">
          </div>
          <div>
            <label>Шрифт</label>
            <select id="fontFamily">
              <option value="Arial, sans-serif">Arial</option>
              <option value="'Trebuchet MS', sans-serif">Trebuchet</option>
              <option value="Verdana, sans-serif">Verdana</option>
              <option value="'Comic Sans MS', cursive">Comic Sans</option>
              <option value="system-ui, -apple-system, Segoe UI, Roboto, sans-serif">System</option>
            </select>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>Локация / персонаж / платформа</h2>
        <div class="grid2">
          <div>
            <label>Фон (локация)</label>
            <select id="bgPreset">
              <option value="river">Река</option>
              <option value="lava">Лава</option>
              <option value="swamp">Болото</option>
              <option value="custom">Загрузить свой</option>
            </select>
            <input id="bgUpload" type="file" accept="image/*" style="margin-top:8px; display:none">
            <div class="small">Если “Загрузить свой” — выбери файл, он встраивается как dataURL.</div>
          </div>
          <div>
            <label>Персонаж</label>
            <select id="heroPreset">
              <option value="frog">Лягушка</option>
              <option value="chameleon">Хамелеон</option>
              <option value="lizard">Ящерица</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Платформа</label>
          <select id="platformPreset">
            <option value="lily">Лилия (SVG)</option>
            <option value="rock">Камень (SVG)</option>
            <option value="log">Бревно (SVG)</option>
          </select>
          <div class="small">Сделал 3 платформы встроенными (SVG), чтобы работало без ссылок. Если дашь свои ссылки на платформы — я заменю.</div>
        </div>
      </div>

      <div class="section">
        <h2>Звуки</h2>
        <div class="grid2">
          <div>
            <label>Правильный ответ (URL или upload)</label>
            <input id="sndOkUrl" type="text" placeholder="https://... или оставь пустым">
            <input id="sndOkFile" type="file" accept="audio/*" style="margin-top:8px">
          </div>
          <div>
            <label>Неправильный ответ (URL или upload)</label>
            <input id="sndBadUrl" type="text" placeholder="https://... или оставь пустым">
            <input id="sndBadFile" type="file" accept="audio/*" style="margin-top:8px">
          </div>
        </div>
        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Победа (URL или upload)</label>
            <input id="sndWinUrl" type="text" placeholder="https://... или оставь пустым">
            <input id="sndWinFile" type="file" accept="audio/*" style="margin-top:8px">
          </div>
          <div>
            <label>Провал (URL или upload)</label>
            <input id="sndLoseUrl" type="text" placeholder="https://... или оставь пустым">
            <input id="sndLoseFile" type="file" accept="audio/*" style="margin-top:8px">
          </div>
        </div>
        <div class="small">Если URL пустой и файл не выбран — звук просто не проигрывается.</div>
      </div>

      <div class="section">
        <h2>Действия</h2>
        <div class="btnbar">
          <button id="copyBtn">Копировать iframe игры</button>
          <button class="secondary" id="resetBtn">Сбросить (к демо)</button>
          <button class="danger" id="forceReloadBtn">Пересобрать предпросмотр</button>
        </div>
        <div class="small">Копируй iframe из поля снизу и вставляй в Genially (как embed/iframe).</div>
      </div>

    </div>
  </aside>

  <section class="right">
    <div class="rightTop">
      <div class="title2">Предпросмотр</div>
      <div class="sub">обновляется автоматически</div>
    </div>
    <div class="previewWrap">
      <iframe id="preview" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
    </div>

    <div class="out">
      <label>Готовый код iframe (вставь в Genially)</label>
      <textarea id="iframeOut" readonly></textarea>
      <div class="small">Если Genially ругается на кавычки — просто вставляй целиком как есть (там srcdoc в одинарных кавычках).</div>
    </div>
  </section>
</div>

<div class="toast" id="toast">Скопировано ✅</div>

<script>
/* =========================
   Neon drifting stars BG
========================= */
(function makeStars(){
  const root = document.getElementById('stars');
  const N = 28;
  const colors = ['#7cf9ff','#ff3b3b','#39ff88','#b56bff','#ffd36b'];
  const rand = (a,b)=>a+Math.random()*(b-a);
  for(let i=0;i<N;i++){
    const s=document.createElement('div');
    s.className='star';
    const c=colors[Math.floor(Math.random()*colors.length)];
    s.style.setProperty('--c', c);
    s.style.left = rand(0,100)+'%';
    s.style.top  = rand(0,100)+'%';
    const dx = rand(-220,220)+'px';
    const dy = rand(-160,160)+'px';
    s.style.setProperty('--dx', dx);
    s.style.setProperty('--dy', dy);
    const dur = rand(8,18);
    const dur2= rand(1.4,3.2);
    s.style.animationDuration = `${dur}s, ${dur2}s`;
    s.style.animationDelay = `${rand(-dur,0)}s, ${rand(0,1)}s`;
    const size = rand(10,22);
    s.style.width = size+'px';
    s.style.height= size+'px';
    s.style.filter = `drop-shadow(0 0 10px ${c})`;
    root.appendChild(s);
  }
})();

/* =========================
   Assets provided by user
========================= */
const PRESET_BACKGROUNDS = {
  river: "https://img.genially.com/67961b32a116fb001568a75e/c0c9010f-c3dd-42c1-b7c1-65024fa3aec6.png",
  lava:  "https://img.genially.com/67961b32a116fb001568a75e/fa2ab459-fec9-4ccd-97e3-254427b4ade0.png",
  swamp: "https://img.genially.com/67961b32a116fb001568a75e/02b52ad4-9d31-4b21-a305-8fec6e8a4487.png"
};
const PRESET_HERO = {
  frog: "https://img.genially.com/67961b32a116fb001568a75e/3074df22-5c73-4ad2-b0b2-491c6fc247f3.png",
  chameleon: "https://img.genially.com/67961b32a116fb001568a75e/74b56fcf-5354-43dd-9c9a-f50facc9a9bf.png",
  lizard: "https://img.genially.com/67961b32a116fb001568a75e/0feda2a1-485a-4654-8640-bf1adcc9f9ec.png"
};

/* Platforms as inline SVG data URIs (so it ALWAYS works) */
function svgDataUri(svg){
  return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg.trim());
}
const PRESET_PLATFORM = {
  lily: svgDataUri(`
    <svg xmlns="http://www.w3.org/2000/svg" width="260" height="140" viewBox="0 0 260 140">
      <defs>
        <radialGradient id="g" cx="40%" cy="35%" r="70%">
          <stop offset="0" stop-color="#9dff7a"/>
          <stop offset="1" stop-color="#0b8b45"/>
        </radialGradient>
        <filter id="s" x="-30%" y="-30%" width="160%" height="160%">
          <feDropShadow dx="0" dy="8" stdDeviation="6" flood-color="#000" flood-opacity=".35"/>
        </filter>
      </defs>
      <path filter="url(#s)" d="M30 85c10-40 60-70 110-70 60 0 100 40 90 80-10 40-70 40-115 40S20 125 30 85Z" fill="url(#g)" stroke="#0a5a2f" stroke-width="6" stroke-linejoin="round"/>
      <path d="M150 35c-8 12-20 22-35 30 18 4 37 1 55-8-10-6-16-12-20-22Z" fill="#c7ffb0" opacity=".6"/>
      <path d="M190 45c-18 2-36 12-52 28 22 2 44-5 64-20-4-3-8-6-12-8Z" fill="#c7ffb0" opacity=".35"/>
    </svg>
  `),
  rock: svgDataUri(`
    <svg xmlns="http://www.w3.org/2000/svg" width="260" height="140" viewBox="0 0 260 140">
      <defs>
        <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#d5d9e6"/>
          <stop offset="1" stop-color="#646c86"/>
        </linearGradient>
        <filter id="s" x="-30%" y="-30%" width="160%" height="160%">
          <feDropShadow dx="0" dy="10" stdDeviation="7" flood-color="#000" flood-opacity=".35"/>
        </filter>
      </defs>
      <path filter="url(#s)" d="M35 92c5-35 40-65 85-70 50-6 95 12 118 42 20 26 14 55-10 65-35 14-78 10-120 6-42-4-78-14-73-43Z" fill="url(#g)" stroke="#3e465d" stroke-width="6" stroke-linejoin="round"/>
      <path d="M70 80c8-20 28-35 55-38 10-1 22 0 34 2-12 6-22 14-30 24-24-6-44-2-59 12Z" fill="#ffffff" opacity=".25"/>
    </svg>
  `),
  log: svgDataUri(`
    <svg xmlns="http://www.w3.org/2000/svg" width="260" height="140" viewBox="0 0 260 140">
      <defs>
        <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#ffcf8a"/>
          <stop offset="1" stop-color="#8a4a1f"/>
        </linearGradient>
        <filter id="s" x="-30%" y="-30%" width="160%" height="160%">
          <feDropShadow dx="0" dy="10" stdDeviation="7" flood-color="#000" flood-opacity=".35"/>
        </filter>
      </defs>
      <rect filter="url(#s)" x="22" y="52" width="216" height="64" rx="28" fill="url(#g)" stroke="#5a2f14" stroke-width="6"/>
      <circle cx="56" cy="84" r="22" fill="#a05a2c" opacity=".55"/>
      <circle cx="56" cy="84" r="10" fill="#6b3516" opacity=".6"/>
      <path d="M88 74h120" stroke="#6b3516" stroke-width="6" opacity=".35" stroke-linecap="round"/>
      <path d="M98 92h120" stroke="#6b3516" stroke-width="6" opacity=".25" stroke-linecap="round"/>
    </svg>
  `)
};

/* =========================
   UI refs
========================= */
const $ = (id)=>document.getElementById(id);

const ui = {
  levels: $('levels'),
  seconds: $('seconds'),
  tasks: $('tasks'),
  startColor: $('startColor'),
  endColor: $('endColor'),
  winText: $('winText'),
  loseText: $('loseText'),
  panelColor: $('panelColor'),
  timerColor: $('timerColor'),
  timerDanger: $('timerDanger'),
  neon: $('neon'),
  dangerAt: $('dangerAt'),
  fontColor: $('fontColor'),
  fontSize: $('fontSize'),
  fontFamily: $('fontFamily'),
  bgPreset: $('bgPreset'),
  bgUpload: $('bgUpload'),
  heroPreset: $('heroPreset'),
  platformPreset: $('platformPreset'),
  sndOkUrl: $('sndOkUrl'),
  sndBadUrl: $('sndBadUrl'),
  sndWinUrl: $('sndWinUrl'),
  sndLoseUrl: $('sndLoseUrl'),
  sndOkFile: $('sndOkFile'),
  sndBadFile: $('sndBadFile'),
  sndWinFile: $('sndWinFile'),
  sndLoseFile: $('sndLoseFile'),
  preview: $('preview'),
  iframeOut: $('iframeOut'),
  copyBtn: $('copyBtn'),
  resetBtn: $('resetBtn'),
  forceReloadBtn: $('forceReloadBtn'),
  toast: $('toast')
};

let customBgDataUrl = "";
let sndData = { ok:"", bad:"", win:"", lose:"" };

function toast(msg){
  ui.toast.textContent = msg;
  ui.toast.classList.add('show');
  setTimeout(()=>ui.toast.classList.remove('show'), 1000);
}

function readFileAsDataURL(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=()=>resolve(fr.result);
    fr.onerror=()=>reject(fr.error);
    fr.readAsDataURL(file);
  });
}

async function handleSoundFile(which, fileInput){
  const f = fileInput.files && fileInput.files[0];
  if(!f){ sndData[which] = ""; rebuild(); return; }
  const dataUrl = await readFileAsDataURL(f);
  sndData[which] = dataUrl;
  rebuild();
}

ui.bgPreset.addEventListener('change', ()=>{
  ui.bgUpload.style.display = (ui.bgPreset.value==='custom') ? 'block' : 'none';
  rebuild();
});
ui.bgUpload.addEventListener('change', async ()=>{
  const f = ui.bgUpload.files && ui.bgUpload.files[0];
  if(!f){ customBgDataUrl=""; rebuild(); return; }
  customBgDataUrl = await readFileAsDataURL(f);
  rebuild();
});

ui.sndOkFile.addEventListener('change', ()=>handleSoundFile('ok', ui.sndOkFile));
ui.sndBadFile.addEventListener('change', ()=>handleSoundFile('bad', ui.sndBadFile));
ui.sndWinFile.addEventListener('change', ()=>handleSoundFile('win', ui.sndWinFile));
ui.sndLoseFile.addEventListener('change', ()=>handleSoundFile('lose', ui.sndLoseFile));

function getConfig(){
  const levels = clampInt(ui.levels.value, 1, 30, 5);
  const seconds = clampInt(ui.seconds.value, 3, 120, 10);
  const dangerAt = clampInt(ui.dangerAt.value, 1, 30, 3);

  const tasks = ui.tasks.value
    .split(/\r?\n/)
    .map(s=>s.trim())
    .filter(Boolean);

  const bgPreset = ui.bgPreset.value;
  const bgUrl = (bgPreset==='custom')
    ? (customBgDataUrl || PRESET_BACKGROUNDS.river)
    : PRESET_BACKGROUNDS[bgPreset];

  const heroUrl = PRESET_HERO[ui.heroPreset.value];
  const platformUrl = PRESET_PLATFORM[ui.platformPreset.value];

  const sounds = {
    ok:   ui.sndOkUrl.value.trim()   || sndData.ok || "",
    bad:  ui.sndBadUrl.value.trim()  || sndData.bad || "",
    win:  ui.sndWinUrl.value.trim()  || sndData.win || "",
    lose: ui.sndLoseUrl.value.trim() || sndData.lose || ""
  };

  return {
    title: "Leap and Learn",
    levels,
    seconds,
    dangerAt,
    tasks,
    colors:{
      start: ui.startColor.value,
      end: ui.endColor.value,
      panel: ui.panelColor.value,
      timer: ui.timerColor.value,
      timerDanger: ui.timerDanger.value,
      font: ui.fontColor.value
    },
    neon: !!ui.neon.checked,
    font:{
      size: clampInt(ui.fontSize.value, 12, 40, 18),
      family: ui.fontFamily.value
    },
    texts:{
      win: ui.winText.value || "Победа!",
      lose: ui.loseText.value || "Попробуй ещё раз!"
    },
    assets:{
      bg: bgUrl,
      hero: heroUrl,
      platform: platformUrl
    },
    sounds
  };
}

function clampInt(v,min,max,def){
  const n = parseInt(v,10);
  if(Number.isNaN(n)) return def;
  return Math.max(min, Math.min(max, n));
}

function escapeForSingleQuotedAttr(s){
  // for iframe srcdoc='...'
  // convert & first to avoid double-escaping
  return s
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/'/g,'&#39;');
}

/* =========================
   GAME TEMPLATE (srcdoc)
========================= */
function buildGameSrcdoc(cfg){
  const cfgJson = JSON.stringify(cfg);

  return `<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>${cfg.title}</title>
<style>
  :root{
    --start:${cfg.colors.start};
    --end:${cfg.colors.end};
    --panel:${cfg.colors.panel};
    --timer:${cfg.colors.timer};
    --danger:${cfg.colors.timerDanger};
    --font:${cfg.colors.font};
    --neon:${cfg.neon ? 1 : 0};
    --fs:${cfg.font.size}px;
  }
  html,body{margin:0;height:100%;width:100%;overflow:hidden;font-family:${cfg.font.family};}
  #APP{position:relative;width:100%;height:100%; background:#000;}
  .bg{
    position:absolute; inset:0;
    background: url('${cfg.assets.bg}') center/cover no-repeat;
    filter:saturate(1.05) contrast(1.05);
  }
  .veil{position:absolute; inset:0; background: radial-gradient(900px 700px at 30% 20%, rgba(255,255,255,.12), transparent 60%),
                                     linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.35));}
  .panel{
    position:absolute; left:50%; transform:translateX(-50%);
    width:min(920px, calc(100% - 24px));
    border-radius:18px;
    background: color-mix(in srgb, var(--panel) 82%, rgba(0,0,0,.2));
    border:1px solid rgba(255,255,255,.18);
    box-shadow: 0 18px 60px rgba(0,0,0,.55);
    color:var(--font);
  }
  .neonGlow{
    box-shadow: 0 18px 60px rgba(0,0,0,.55), 0 0 26px rgba(124,249,255,.22);
    border-color: rgba(124,249,255,.22);
  }
  .hud{
    top:12px;
    padding:10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .chip{
    display:flex; gap:10px; align-items:center;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.18);
    font-weight:900;
    letter-spacing:.2px;
    font-size:14px;
  }
  .timer{
    color:var(--timer);
    text-shadow: calc(var(--neon)*0px) calc(var(--neon)*0px) calc(var(--neon)*14px) rgba(124,249,255,.65);
  }
  .timer.danger{
    color:var(--danger);
    text-shadow: calc(var(--neon)*0px) calc(var(--neon)*0px) calc(var(--neon)*16px) rgba(255,59,59,.7);
  }

  .stage{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
  }

  .start, .end{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
  }
  .card{
    width:min(880px, calc(100% - 26px));
    border-radius:22px;
    padding:18px;
    border:1px solid rgba(255,255,255,.18);
    box-shadow: 0 18px 60px rgba(0,0,0,.6);
    color:var(--font);
  }
  .start .card{background: linear-gradient(180deg, color-mix(in srgb, var(--start) 82%, rgba(0,0,0,.2)), rgba(0,0,0,.35));}
  .end .card{background: linear-gradient(180deg, color-mix(in srgb, var(--end) 82%, rgba(0,0,0,.2)), rgba(0,0,0,.40));}

  .h{
    font-size: calc(var(--fs) * 1.4);
    font-weight:1000;
    letter-spacing:.3px;
    margin:0 0 8px;
    text-shadow: 0 0 18px rgba(0,0,0,.35);
  }
  .p{margin:0 0 14px; opacity:.92; font-size:var(--fs); line-height:1.2}
  .btn{
    cursor:pointer;
    border:none;
    padding:12px 14px;
    border-radius:16px;
    font-weight:1000;
    font-size: var(--fs);
    background: rgba(124,249,255,.92);
    color:#071018;
    box-shadow: 0 0 24px rgba(124,249,255,.22);
  }
  .btn:active{transform: translateY(1px)}

  /* gameplay layout */
  .gamePanel{
    bottom:12px;
    padding:12px;
    display:grid;
    grid-template-columns: 1.15fr .85fr;
    gap:12px;
    align-items:stretch;
  }
  .qbox{
    border-radius:18px;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.18);
    padding:12px;
  }
  .qtext{
    font-size: calc(var(--fs) * 1.08);
    font-weight:1000;
    margin:0 0 10px;
    color:var(--font);
    text-shadow: 0 0 18px rgba(0,0,0,.35);
  }
  .answers{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
  }
  .ans{
    cursor:pointer;
    user-select:none;
    padding:12px 12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.14);
    font-weight:900;
    font-size: var(--fs);
    transition:.12s transform, .12s filter;
  }
  .ans:hover{transform: translateY(-1px); filter:brightness(1.05)}
  .ans.good{
    border-color: rgba(57,255,136,.55);
    box-shadow: 0 0 18px rgba(57,255,136,.16);
  }
  .ans.bad{
    border-color: rgba(255,59,59,.55);
    box-shadow: 0 0 18px rgba(255,59,59,.14);
  }

  /* world + character */
  .world{
    position:absolute; inset:0;
    pointer-events:none;
  }
  .platforms{
    position:absolute; left:50%; top:50%;
    transform: translate(-50%,-50%);
    width:min(980px, 100%);
    height:min(520px, 100%);
  }
  .plat{
    position:absolute;
    width: 220px; height:120px;
    background: url('${cfg.assets.platform}') center/contain no-repeat;
    filter: drop-shadow(0 16px 18px rgba(0,0,0,.35));
    opacity:.98;
  }
  .hero{
    position:absolute;
    width: 120px; height:120px;
    background: url('${cfg.assets.hero}') center/contain no-repeat;
    transform: translate(-50%,-50%);
    filter: drop-shadow(0 16px 18px rgba(0,0,0,.38));
    transition: left .35s cubic-bezier(.2,.9,.2,1.05), top .35s cubic-bezier(.2,.9,.2,1.05);
  }
  .pop{animation: pop .24s ease-out}
  @keyframes pop{
    0%{transform:translate(-50%,-50%) scale(.92)}
    100%{transform:translate(-50%,-50%) scale(1)}
  }
  .shake{animation: shake .28s}
  @keyframes shake{
    0%{transform:translate(-50%,-50%)}
    25%{transform:translate(-50%,-50%) translate(-4px,2px)}
    50%{transform:translate(-50%,-50%) translate(4px,-2px)}
    75%{transform:translate(-50%,-50%) translate(-3px,2px)}
    100%{transform:translate(-50%,-50%)}
  }

  /* small FX */
  .spark{
    position:absolute;
    width:10px; height:10px;
    border-radius:2px;
    background: rgba(124,249,255,.9);
    box-shadow: 0 0 16px rgba(124,249,255,.7);
    transform: rotate(45deg);
    opacity:0;
    pointer-events:none;
    animation: spark .55s ease-out forwards;
  }
  @keyframes spark{
    0%{opacity:0; transform:translate(-50%,-50%) rotate(45deg) scale(.6)}
    20%{opacity:1}
    100%{opacity:0; transform:translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) rotate(140deg) scale(1.25)}
  }

  .hide{display:none !important}
</style>
</head>
<body>
<div id="APP">
  <div class="bg"></div>
  <div class="veil"></div>

  <div class="start" id="START">
    <div class="card ${cfg.neon ? "neonGlow":""}">
      <div class="h">Leap and Learn</div>
      <div class="p">Нажми “Старт”. На каждом уровне выбери правильный вариант до окончания таймера.</div>
      <button class="btn" id="startBtn">Старт ▶</button>
      <div class="p" style="opacity:.8;margin-top:10px;font-size:calc(var(--fs)*.92)">Уровней: <b id="lvlTotal"></b> • Время: <b id="secTotal"></b> сек.</div>
    </div>
  </div>

  <div class="end hide" id="END">
    <div class="card ${cfg.neon ? "neonGlow":""}">
      <div class="h" id="endTitle">Конец</div>
      <div class="p" id="endText"></div>
      <button class="btn" id="restartBtn">Сыграть ещё раз ↻</button>
    </div>
  </div>

  <div class="world hide" id="WORLD">
    <div class="panel hud ${cfg.neon ? "neonGlow":""}">
      <div class="chip">Уровень: <span id="lvl">1</span>/<span id="lvlMax">1</span></div>
      <div class="chip timer" id="timerChip">⏱ <span id="t">10</span></div>
      <div class="chip">Очки: <span id="score">0</span></div>
    </div>

    <div class="platforms" id="platforms">
      <!-- platforms -->
      <div class="plat" id="p1"></div>
      <div class="plat" id="p2"></div>
      <div class="plat" id="p3"></div>
      <div class="plat" id="p4"></div>
      <div class="plat" id="p5"></div>
      <div class="hero" id="hero"></div>
    </div>

    <div class="panel gamePanel ${cfg.neon ? "neonGlow":""}">
      <div class="qbox">
        <div class="qtext" id="qtext">…</div>
        <div class="answers" id="answers"></div>
      </div>
      <div class="qbox">
        <div class="qtext" style="margin-bottom:8px">Подсказка</div>
        <div class="p" id="tip" style="margin:0; opacity:.92; font-size:var(--fs)">Выбирай ответ быстро — таймер горит красным за ${cfg.dangerAt} сек. до конца.</div>
      </div>
    </div>
  </div>
</div>

<script>
  const CFG = ${cfgJson};

  const $ = (id)=>document.getElementById(id);
  const START=$('START'), END=$('END'), WORLD=$('WORLD');
  const lvlEl=$('lvl'), lvlMaxEl=$('lvlMax'), tEl=$('t'), timerChip=$('timerChip'), scoreEl=$('score');
  const qtext=$('qtext'), answers=$('answers');
  const hero=$('hero');
  const plats=[ $('p1'),$('p2'),$('p3'),$('p4'),$('p5') ];

  const snd = {
    ok:   CFG.sounds.ok   ? new Audio(CFG.sounds.ok) : null,
    bad:  CFG.sounds.bad  ? new Audio(CFG.sounds.bad) : null,
    win:  CFG.sounds.win  ? new Audio(CFG.sounds.win) : null,
    lose: CFG.sounds.lose ? new Audio(CFG.sounds.lose) : null,
  };
  function play(a){
    try{
      if(!a) return;
      a.currentTime = 0;
      a.play().catch(()=>{});
    }catch(e){}
  }

  const totalLevels = Math.max(1, Math.min(30, CFG.levels|0));
  const secondsPer = Math.max(3, Math.min(120, CFG.seconds|0));
  const dangerAt = Math.max(1, Math.min(30, CFG.dangerAt|0));

  $('lvlTotal').textContent = totalLevels;
  $('secTotal').textContent = secondsPer;
  lvlMaxEl.textContent = totalLevels;

  const tasks = (CFG.tasks && CFG.tasks.length) ? CFG.tasks : ["Level task 1","Level task 2","Level task 3"];
  let level=1, score=0, timeLeft=secondsPer, timer=null, locked=false;

  function layoutPlatforms(){
    // deterministic "zig-zag" layout
    const W = Math.min(980, window.innerWidth);
    const H = Math.min(520, window.innerHeight);
    const cx = 50, cy = 50;
    const xs = [18, 58, 28, 68, 42];
    const ys = [68, 54, 38, 26, 18];

    plats.forEach((p,i)=>{
      p.style.left = xs[i] + '%';
      p.style.top  = ys[i] + '%';
    });

    // put hero on first platform
    moveHeroTo(0, true);
  }

  function moveHeroTo(i, instant=false){
    const p = plats[i];
    const rect = p.getBoundingClientRect();
    const host = $('platforms').getBoundingClientRect();

    const x = (rect.left - host.left) + rect.width/2;
    const y = (rect.top - host.top)  + rect.height/2 - 50;

    if(instant){
      hero.style.transition = 'none';
      hero.style.left = x+'px';
      hero.style.top  = y+'px';
      void hero.offsetWidth;
      hero.style.transition = '';
    }else{
      hero.classList.remove('pop'); void hero.offsetWidth; hero.classList.add('pop');
      hero.style.left = x+'px';
      hero.style.top  = y+'px';
    }
  }

  function mkAnswers(task){
    // Demo generator:
    // 1 correct = last word or blank placeholder
    // plus 2 distractors (simple mutations)
    const base = (task.includes("___") ? task.split("___")[1].trim() : task.split(/[:?]/).pop().trim()) || "answer";
    const correct = base.split(/\s+/).slice(0,2).join(' ') || base;

    const d1 = correct.split('').reverse().join('').slice(0, Math.max(3, correct.length));
    const d2 = (correct + "s").replace(/\s+/g,' ');

    const opts = shuffle([correct, d1, d2]).slice(0,3);
    const correctIndex = opts.indexOf(correct);

    answers.innerHTML='';
    opts.forEach((txt, idx)=>{
      const b=document.createElement('div');
      b.className='ans';
      b.textContent = txt;
      b.onclick = ()=>choose(idx===correctIndex, b);
      answers.appendChild(b);
    });
  }

  function shuffle(arr){
    const a=arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function setQuestion(){
    const task = tasks[(level-1) % tasks.length] || ("Level "+level);
    qtext.textContent = task;
    mkAnswers(task);
  }

  function startLevel(){
    locked=false;
    timeLeft = secondsPer;
    tEl.textContent = timeLeft;
    timerChip.classList.remove('danger');
    lvlEl.textContent = level;
    setQuestion();
    moveHeroTo(Math.min(level-1, 4), level===1);
    clearInterval(timer);
    timer = setInterval(()=>{
      timeLeft--;
      tEl.textContent = timeLeft;
      if(timeLeft<=dangerAt) timerChip.classList.add('danger');
      if(timeLeft<=0){
        clearInterval(timer);
        fail();
      }
    }, 1000);
  }

  function sparkAt(el, color){
    const r = el.getBoundingClientRect();
    for(let i=0;i<10;i++){
      const s=document.createElement('div');
      s.className='spark';
      s.style.left = (r.left + r.width/2) + 'px';
      s.style.top  = (r.top + r.height/2) + 'px';
      s.style.background = color;
      s.style.boxShadow = '0 0 16px ' + color;
      s.style.setProperty('--dx', (Math.random()*160-80)+'px');
      s.style.setProperty('--dy', (Math.random()*120-60)+'px');
      document.body.appendChild(s);
      setTimeout(()=>s.remove(), 600);
    }
  }

  function choose(isCorrect, btn){
    if(locked) return;
    locked=true;
    if(isCorrect){
      btn.classList.add('good');
      play(snd.ok);
      sparkAt(btn, 'rgba(57,255,136,.95)');
      score += 10;
      scoreEl.textContent = score;
      clearInterval(timer);

      // next
      setTimeout(()=>{
        level++;
        if(level>totalLevels){
          win();
        }else{
          startLevel();
        }
      }, 420);

    }else{
      btn.classList.add('bad');
      play(snd.bad);
      sparkAt(btn, 'rgba(255,59,59,.95)');
      hero.classList.remove('shake'); void hero.offsetWidth; hero.classList.add('shake');
      clearInterval(timer);
      setTimeout(()=>fail(), 520);
    }
  }

  function showEnd(ok){
    WORLD.classList.add('hide');
    END.classList.remove('hide');
    $('endTitle').textContent = ok ? 'Готово!' : 'Не получилось';
    $('endText').textContent = ok ? CFG.texts.win : CFG.texts.lose;
  }

  function win(){
    play(snd.win);
    showEnd(true);
  }
  function fail(){
    play(snd.lose);
    showEnd(false);
  }

  $('startBtn').onclick = ()=>{
    START.classList.add('hide');
    END.classList.add('hide');
    WORLD.classList.remove('hide');
    level=1; score=0; scoreEl.textContent=0;
    layoutPlatforms();
    startLevel();
  };
  $('restartBtn').onclick = ()=>{
    END.classList.add('hide');
    START.classList.remove('hide');
  };

  window.addEventListener('resize', ()=>layoutPlatforms());
  // show start
  START.classList.remove('hide');
<\/script>
</body>
</html>`;
}

/* =========================
   Build preview + iframe
========================= */
function buildIframeCode(srcdoc){
  const escaped = escapeForSingleQuotedAttr(srcdoc);
  // width/height 100% for Genially
  return `<iframe style="width:100%;height:100%;border:0" srcdoc='${escaped}'></iframe>`;
}

let rebuildTimer = null;
function rebuild(){
  clearTimeout(rebuildTimer);
  rebuildTimer = setTimeout(()=>{
    const cfg = getConfig();
    const srcdoc = buildGameSrcdoc(cfg);
    ui.preview.srcdoc = srcdoc;

    const iframeCode = buildIframeCode(srcdoc);
    ui.iframeOut.value = iframeCode;
  }, 60);
}

function bindAuto(){
  const ids = [
    'levels','seconds','tasks','startColor','endColor','winText','loseText',
    'panelColor','timerColor','timerDanger','neon','dangerAt','fontColor','fontSize','fontFamily',
    'bgPreset','heroPreset','platformPreset',
    'sndOkUrl','sndBadUrl','sndWinUrl','sndLoseUrl'
  ];
  ids.forEach(id=>{
    $(id).addEventListener('input', rebuild);
    $(id).addEventListener('change', rebuild);
  });
}
bindAuto();

/* Buttons */
ui.copyBtn.addEventListener('click', async ()=>{
  try{
    await navigator.clipboard.writeText(ui.iframeOut.value);
    toast('Скопировано ✅');
  }catch(e){
    // fallback
    ui.iframeOut.focus();
    ui.iframeOut.select();
    document.execCommand('copy');
    toast('Скопировано ✅');
  }
});

ui.forceReloadBtn.addEventListener('click', ()=>{
  // full rebuild now
  const cfg = getConfig();
  const srcdoc = buildGameSrcdoc(cfg);
  ui.preview.srcdoc = srcdoc;
  ui.iframeOut.value = buildIframeCode(srcdoc);
  toast('Предпросмотр пересобран');
});

ui.resetBtn.addEventListener('click', ()=>{
  ui.levels.value = 5;
  ui.seconds.value = 10;
  ui.tasks.value = [
    "Choose the correct article: ___ apple",
    "Find the verb: She ___ to school.",
    "Pick the plural: child → ___",
    "Select preposition: I am ___ the river.",
    "Correct spelling: chameleon / camaleon?"
  ].join("\\n");

  ui.startColor.value="#061c2a";
  ui.endColor.value="#1a0720";
  ui.winText.value="Победа! Ты прошёл(а) все уровни!";
  ui.loseText.value="Упс… Попробуй ещё раз!";

  ui.panelColor.value="#0e2a4a";
  ui.timerColor.value="#7cf9ff";
  ui.timerDanger.value="#ff3b3b";
  ui.neon.checked=true;
  ui.dangerAt.value=3;

  ui.fontColor.value="#eaf0ff";
  ui.fontSize.value=18;
  ui.fontFamily.value="Arial, sans-serif";

  ui.bgPreset.value="river";
  ui.bgUpload.style.display="none";
  customBgDataUrl="";

  ui.heroPreset.value="frog";
  ui.platformPreset.value="lily";

  ui.sndOkUrl.value="";
  ui.sndBadUrl.value="";
  ui.sndWinUrl.value="";
  ui.sndLoseUrl.value="";
  ui.sndOkFile.value="";
  ui.sndBadFile.value="";
  ui.sndWinFile.value="";
  ui.sndLoseFile.value="";
  sndData = { ok:"", bad:"", win:"", lose:"" };

  rebuild();
  toast('Сброшено к демо');
});

/* initial */
rebuild();
</script>
</body>
</html>
