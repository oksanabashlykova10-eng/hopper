<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>–ü–æ–ø—Ä—ã–≥—É–Ω 31 ‚Äî –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–¥–ª—è Genially)</title>
<style>
  :root{
    --bg:#061427;
    --card:rgba(255,255,255,.08);
    --stroke:rgba(124,249,255,.35);
    --glow:rgba(124,249,255,.35);
    --txt:#eaf6ff;
    --muted:#bfe9ff;
    --accent:#7cf9ff;
    --danger:#ff3b3b;
  }
  html,body{height:100%;margin:0;font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:radial-gradient(1200px 900px at 20% 20%,rgba(124,249,255,.10),transparent 50%),var(--bg);color:var(--txt);overflow:hidden}
  *{box-sizing:border-box}
  a{color:var(--accent);text-decoration:none}
  .app{display:grid;grid-template-columns:420px 1fr;gap:14px;height:100%;padding:14px}
  .panel{
    background:linear-gradient(180deg, rgba(10,20,50,.92), rgba(5,10,25,.92));
    border:1px solid var(--stroke);
    box-shadow:0 0 22px rgba(124,249,255,.18), inset 0 0 18px rgba(124,249,255,.10);
    border-radius:18px;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    min-height:0;
  }
  .panel header{
    padding:12px 12px 10px;
    border-bottom:1px solid rgba(124,249,255,.18);
    background:linear-gradient(90deg, rgba(124,249,255,.12), transparent);
  }
  .panel header h1{margin:0;font-size:16px;letter-spacing:.04em}
  .panel header .sub{margin-top:4px;color:var(--muted);opacity:.92;font-weight:700;font-size:12px}
  .scroll{padding:12px;overflow:auto;min-height:0}
  .group{
    background:var(--card);
    border:1px solid rgba(124,249,255,.25);
    border-radius:14px;
    padding:10px;
    box-shadow:0 0 14px rgba(124,249,255,.10);
    margin-bottom:10px;
  }
  .group h2{margin:0 0 8px;font-size:13px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  label{display:block;font-size:12px;color:#d8f3ff;opacity:.92;font-weight:800;margin:0 0 6px}
  input[type="text"], input[type="number"], select, textarea{
    width:100%;
    border-radius:12px;
    border:1px solid rgba(124,249,255,.25);
    background:rgba(255,255,255,.06);
    color:var(--txt);
    padding:9px 10px;
    outline:none;
    box-shadow: inset 0 0 14px rgba(124,249,255,.08);
    font-weight:800;
  }
  textarea{min-height:110px;resize:vertical;font-weight:700}
  input[type="color"]{width:100%;height:40px;border-radius:12px;border:1px solid rgba(124,249,255,.25);background:rgba(255,255,255,.06);padding:4px}
  .hint{font-size:11px;color:#bfe9ff;opacity:.85;font-weight:700;margin-top:6px;line-height:1.35}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  button{
    border-radius:14px;
    border:1px solid rgba(124,249,255,.35);
    background:rgba(255,255,255,.10);
    color:var(--txt);
    padding:10px 12px;
    font-weight:900;
    cursor:pointer;
    box-shadow:0 0 14px rgba(124,249,255,.12);
  }
  button.primary{
    border-color:rgba(124,249,255,.65);
    background:linear-gradient(180deg, rgba(124,249,255,.25), rgba(255,255,255,.08));
    box-shadow:0 0 18px rgba(124,249,255,.22);
  }
  button.danger{
    border-color:rgba(255,59,59,.55);
    box-shadow:0 0 18px rgba(255,59,59,.18);
  }
  .check{
    display:flex;align-items:center;gap:8px;margin-top:6px;
    font-weight:800;color:#d8f3ff;opacity:.92;font-size:12px;
  }
  .check input{transform:scale(1.15)}
  .previewWrap{display:flex;flex-direction:column;gap:10px;min-height:0}
  .topbar{
    display:flex;gap:10px;align-items:center;justify-content:space-between;
    padding:10px 12px;
    border:1px solid rgba(124,249,255,.25);
    border-radius:18px;
    background:rgba(255,255,255,.06);
    box-shadow:0 0 16px rgba(124,249,255,.10);
  }
  .topbar .title{font-weight:900}
  .topbar .mini{font-size:12px;color:var(--muted);opacity:.9;font-weight:800}
  iframe{width:100%;height:100%;border:0;border-radius:18px;background:#000}
  .out{
    display:grid;
    grid-template-rows:auto auto;
    gap:8px;
    min-height:0;
  }
  .out textarea{min-height:140px}
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 10px;border-radius:999px;
    border:1px solid rgba(124,249,255,.25);
    background:rgba(255,255,255,.06);
    font-weight:900;
  }
  .sep{height:1px;background:rgba(124,249,255,.18);margin:8px 0}
  .levelCard{
    border:1px solid rgba(124,249,255,.22);
    border-radius:14px;
    padding:10px;
    background:rgba(255,255,255,.05);
    margin-top:8px;
  }
  .levelCard h3{margin:0 0 8px;font-size:13px;color:#fff;font-weight:900}
  .small{font-size:11px;color:var(--muted);opacity:.85;font-weight:800;margin-top:6px;line-height:1.35}
</style>
</head>
<body>
<div class="app">
  <!-- LEFT: SETTINGS -->
  <section class="panel">
    <header>
      <h1>–ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ ‚Äú–ü–æ–ø—Ä—ã–≥—É–Ω 31‚Äù</h1>
      <div class="sub">–°–æ–±–∏—Ä–∞–µ—Ç <b>iframe</b> —Å –∏–≥—Ä–æ–π (srcdoc) –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ Genially. –•–æ—Å—Ç–∏–Ω–≥: GitHub Pages.</div>
    </header>

    <div class="scroll" id="SCROLL">
      <div class="group">
        <h2>–≠–∫—Ä–∞–Ω —Å—Ç–∞—Ä—Ç / —ç–∫—Ä–∞–Ω —Ñ–∏–Ω–∏—à</h2>
        <div class="row">
          <div>
            <label>–¶–≤–µ—Ç —Ñ–æ–Ω–∞ —Å—Ç–∞—Ä—Ç-—ç–∫—Ä–∞–Ω–∞</label>
            <input type="color" id="startBg" value="#081022">
          </div>
          <div>
            <label>–¶–≤–µ—Ç —Ñ–æ–Ω–∞ —Ñ–∏–Ω–∏—à-—ç–∫—Ä–∞–Ω–∞</label>
            <input type="color" id="endBg" value="#081022">
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label>–¢–µ–∫—Å—Ç –ø–æ–±–µ–¥—ã</label>
            <input type="text" id="winText" value="CONGRATULATIONS!">
          </div>
          <div>
            <label>–¢–µ–∫—Å—Ç –ø–æ—Ä–∞–∂–µ–Ω–∏—è</label>
            <input type="text" id="loseText" value="YOU LOST!">
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä—ã (–Ω–∞ —Å—Ç–∞—Ä—Ç–µ)</label>
            <input type="text" id="startTitle" value="Leap & Learn">
          </div>
          <div>
            <label>–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ (–Ω–∞ —Å—Ç–∞—Ä—Ç–µ)</label>
            <input type="text" id="startSub" value="Fast quiz game ‚Ä¢ platforms, combos and speed">
          </div>
        </div>
        <div class="hint">–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –ø–æ–±–µ–¥—ã/–ø–æ—Ä–∞–∂–µ–Ω–∏—è –±–µ—Ä—ë—Ç—Å—è –∏–∑ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö (win/danger), –Ω–æ –∏—Ö —Ç–æ–∂–µ –º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –Ω–∏–∂–µ –≤ ‚Äú–¶–≤–µ—Ç–∞ / –ù–µ–æ–Ω‚Äù.</div>
      </div>

      <div class="group">
        <h2>–¶–≤–µ—Ç–∞ / –ù–µ–æ–Ω / –®—Ä–∏—Ñ—Ç—ã</h2>
        <div class="row3">
          <div>
            <label>–û—Å–Ω–æ–≤–Ω–æ–π –Ω–µ–æ–Ω (accent)</label>
            <input type="color" id="accent" value="#7cf9ff">
          </div>
          <div>
            <label>–û–ø–∞—Å–Ω–æ—Å—Ç—å (danger)</label>
            <input type="color" id="danger" value="#ff3b3b">
          </div>
          <div>
            <label>–ü–æ–±–µ–¥–∞ (win)</label>
            <input type="color" id="win" value="#ffe44d">
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div>
            <label>–¶–≤–µ—Ç –ø–∞–Ω–µ–ª–µ–π (–∫–∞—Ä—Ç–æ—á–µ–∫)</label>
            <input type="color" id="panelColor" value="#0f2a46">
            <div class="hint">–≠—Ç–æ —Ñ–æ–Ω –∫–∞—Ä—Ç–æ—á–µ–∫/–ø–∞–Ω–µ–ª–µ–π (–ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏).</div>
          </div>
          <div>
            <label>–¶–≤–µ—Ç —Ç–∞–π–º–µ—Ä–∞ (—Ñ–æ–Ω)</label>
            <input type="color" id="timerBg" value="#ffffff">
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label>–¶–≤–µ—Ç —Ç–∞–π–º–µ—Ä–∞ (—Ç–µ–∫—Å—Ç)</label>
            <input type="color" id="timerText" value="#053149">
          </div>
          <div>
            <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ (–æ–±—â–∏–π)</label>
            <input type="color" id="uiText" value="#eaf6ff">
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞ (px)</label>
            <input type="number" id="qFont" min="12" max="64" value="26">
          </div>
          <div>
            <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –æ—Ç–≤–µ—Ç–æ–≤ (px)</label>
            <input type="number" id="aFont" min="10" max="44" value="16">
          </div>
        </div>

        <div class="check">
          <input type="checkbox" id="neonOn" checked>
          <span>–ù–µ–æ–Ω–æ–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ (glow) –¥–ª—è —Ç–∞–π–º–µ—Ä–∞/–∫–Ω–æ–ø–æ–∫/–∫–∞—Ä—Ç–æ—á–µ–∫</span>
        </div>
      </div>

      <div class="group">
        <h2>–°–ª–æ–∂–Ω–æ—Å—Ç—å (—Å–µ–∫—É–Ω–¥—ã)</h2>
        <div class="row3">
          <div>
            <label>t1 (–ø–µ—Ä–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã)</label>
            <input type="number" id="t1" min="1" max="60" value="10">
          </div>
          <div>
            <label>t2 (–ø–æ—Å–ª–µ 3 –≤–µ—Ä–Ω—ã—Ö)</label>
            <input type="number" id="t2" min="1" max="60" value="7">
          </div>
          <div>
            <label>t3 (–ø–æ—Å–ª–µ 6 –≤–µ—Ä–Ω—ã—Ö)</label>
            <input type="number" id="t3" min="1" max="60" value="5">
          </div>
        </div>
        <div class="hint">–≠—Ç–æ –∑–∞–º–µ–Ω—è–µ—Ç preset classic. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–∏–º 3 –ø—Ä–µ—Å–µ—Ç–∞ (easy/classic/hard) –∫–∞–∫ –≤ –∏–≥—Ä–µ.</div>
      </div>

      <div class="group">
        <h2>–ì—Ä–∞—Ñ–∏–∫–∞: —Ñ–æ–Ω / –ø–µ—Ä—Å–æ–Ω–∞–∂ / –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</h2>
        <div class="row">
          <div>
            <label>–õ–æ–∫–∞—Ü–∏—è (—Ñ–æ–Ω)</label>
            <select id="bgPick">
              <option value="river">–†–µ–∫–∞</option>
              <option value="lava" selected>–õ–∞–≤–∞</option>
              <option value="swamp">–ë–æ–ª–æ—Ç–æ</option>
              <option value="custom">–°–≤–æ–π URL / —Ñ–∞–π–ª</option>
            </select>
            <input type="text" id="bgUrl" placeholder="https://...png (–µ—Å–ª–∏ custom)" style="margin-top:8px;display:none">
            <input type="file" id="bgFile" accept="image/*" style="margin-top:8px;display:none">
          </div>
          <div>
            <label>–ü–µ—Ä—Å–æ–Ω–∞–∂</label>
            <select id="charPick">
              <option value="frog">–õ—è–≥—É—à–∫–∞</option>
              <option value="cham" selected>–•–∞–º–µ–ª–µ–æ–Ω</option>
              <option value="lizard">–Ø—â–µ—Ä–∏—Ü–∞</option>
              <option value="custom">–°–≤–æ–π URL / —Ñ–∞–π–ª</option>
            </select>
            <input type="text" id="charUrl" placeholder="https://...png (–µ—Å–ª–∏ custom)" style="margin-top:8px;display:none">
            <input type="file" id="charFile" accept="image/*" style="margin-top:8px;display:none">
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
            <select id="platPick">
              <option value="lily">–õ–∏–ª–∏—è</option>
              <option value="stone">–ö–∞–º–µ–Ω—å</option>
              <option value="hummock" selected>–ë–æ–ª–æ—Ç–Ω–∞—è –∫–æ—á–∫–∞</option>
              <option value="custom">–°–≤–æ–π URL / —Ñ–∞–π–ª</option>
            </select>
            <input type="text" id="platUrl" placeholder="https://...png (–µ—Å–ª–∏ custom)" style="margin-top:8px;display:none">
            <input type="file" id="platFile" accept="image/*" style="margin-top:8px;display:none">
          </div>
          <div>
            <label>–†–∞–∑–º–µ—Ä –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (px)</label>
            <input type="number" id="platSize" min="90" max="220" value="150">
            <div class="hint">–ú–µ–Ω—è–µ—Ç —Ä–∞–∑–º–µ—Ä ‚Äú–ª–∏—Å—Ç–æ–≤/–∫–∞–º–Ω–µ–π‚Äù –∏ —Å–º–µ—â–µ–Ω–∏–µ –ø—Ä—ã–∂–∫–æ–≤.</div>
          </div>
        </div>
        <div class="hint">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ data:URL –∏ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø—Ä—è–º–æ –≤ srcdoc (GitHub Pages –æ–∫).</div>
      </div>

      <div class="group">
        <h2>–ó–≤—É–∫ (URL –∏–ª–∏ —Ñ–∞–π–ª)</h2>
        <div class="row">
          <div>
            <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</label>
            <input type="text" id="sndOkUrl" placeholder="https://...mp3/ogg/wav">
            <input type="file" id="sndOkFile" accept="audio/*" style="margin-top:8px">
          </div>
          <div>
            <label>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</label>
            <input type="text" id="sndBadUrl" placeholder="https://...mp3/ogg/wav">
            <input type="file" id="sndBadFile" accept="audio/*" style="margin-top:8px">
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label>–ü–æ–±–µ–¥–∞ (—Ñ–∏–Ω–∞–ª)</label>
            <input type="text" id="sndWinUrl" placeholder="https://...mp3/ogg/wav">
            <input type="file" id="sndWinFile" accept="audio/*" style="margin-top:8px">
          </div>
          <div>
            <label>–ü—Ä–æ–≤–∞–ª (—Ñ–∏–Ω–∞–ª)</label>
            <input type="text" id="sndLoseUrl" placeholder="https://...mp3/ogg/wav">
            <input type="file" id="sndLoseFile" accept="audio/*" style="margin-top:8px">
          </div>
        </div>

        <div class="check">
          <input type="checkbox" id="useSynthFallback" checked>
          <span>–ï—Å–ª–∏ –∑–≤—É–∫ –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å–∏–Ω—Ç–µ–∑ (–∫–∞–∫ –≤ –∫–æ–¥–µ)</span>
        </div>
        <div class="hint">–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –±—Ä–∞—É–∑–µ—Ä–æ–º: –∑–≤—É–∫ –Ω–∞—á–Ω—ë—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ ‚ÄúSTART‚Äù (—ç—Ç–æ —É–∂–µ —É—á—Ç–µ–Ω–æ).</div>
      </div>

      <div class="group">
        <h2>–£—Ä–æ–≤–Ω–∏ –∏ –∑–∞–¥–∞–Ω–∏—è</h2>
        <div class="row">
          <div>
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–≤–Ω–µ–π</label>
            <input type="number" id="levelCount" min="1" max="10" value="3">
          </div>
          <div>
            <label>–ñ–∏–∑–Ω–∏ (‚ù§Ô∏è)</label>
            <input type="number" id="lives" min="1" max="10" value="5">
          </div>
        </div>

        <div class="check">
          <input type="checkbox" id="shuffleAnswers" checked>
          <span>–ü–µ—Ä–µ–º–µ—à–∏–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã (–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π)</span>
        </div>

        <div id="LEVELS_UI"></div>

        <div class="hint">
          –§–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–∫ –∑–∞–¥–∞–Ω–∏–π (–∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ = 1 –≤–æ–ø—Ä–æ—Å):<br>
          <b>Question;option1;option2;option3;correct(1-3)</b><br>
          –ü—Ä–∏–º–µ—Ä: <code>She ____ got a car.;have;has;is have;2</code>
        </div>
      </div>

      <div class="group">
        <h2>–≠–∫—Å–ø–æ—Ä—Ç</h2>
        <div class="btns">
          <button class="primary" id="BTN_REBUILD">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é</button>
          <button id="BTN_COPY">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe –¥–ª—è Genially</button>
          <button class="danger" id="BTN_RESET">‚Ü© –°–±—Ä–æ—Å –∫ –¥–µ–º–æ</button>
        </div>
        <div class="hint">
          <b>–ö–∞–∫ –Ω–∞ GitHub:</b> —Å–æ–∑–¥–∞–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ‚Üí –¥–æ–±–∞–≤—å —ç—Ç–æ—Ç —Ñ–∞–π–ª –∫–∞–∫ <b>index.html</b> ‚Üí –≤–∫–ª—é—á–∏ <b>Settings ‚Üí Pages ‚Üí Deploy from branch</b>.  
          –û—Ç–∫—Ä–æ–π GitHub Pages —Å—Å—ã–ª–∫—É –∏ –≤—Å—Ç–∞–≤—å –µ—ë –≤ Genially –∫–∞–∫ iframe (–∏–ª–∏ –∫–æ–ø–∏—Ä—É–π iframe –Ω–∏–∂–µ).
        </div>
      </div>
    </div>
  </section>

  <!-- RIGHT: PREVIEW + OUTPUT -->
  <section class="previewWrap">
    <div class="topbar">
      <div>
        <div class="title">–ü—Ä–µ–≤—å—é –∏–≥—Ä—ã (–≤–Ω—É—Ç—Ä–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞)</div>
        <div class="mini">–õ—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚Üí ‚Äú–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é‚Äù</div>
      </div>
      <div class="pill">üß© Popry–≥—É–Ω 31 ‚Ä¢ —Ä–µ–¥–∞–∫—Ç–æ—Ä</div>
    </div>

    <div class="panel" style="min-height:0">
      <iframe id="PREVIEW"></iframe>
    </div>

    <div class="panel out">
      <header>
        <h1>–ö–æ–¥ iframe –¥–ª—è Genially</h1>
        <div class="sub">–°–∫–æ–ø–∏—Ä—É–π –∏ –≤—Å—Ç–∞–≤—å –≤ Genially (–∫–∞–∫ HTML/embed). –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å width/height.</div>
      </header>
      <div class="scroll" style="padding:12px">
        <textarea id="OUT" spellcheck="false"></textarea>
        <div class="btns" style="margin-top:8px">
          <button id="BTN_COPY2" class="primary">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <button id="BTN_SELECT">üñ± –í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
/* ---------------------------
   ASSET PRESETS (–∏–∑ —Ç–≤–æ–∏—Ö —Å—Å—ã–ª–æ–∫)
---------------------------- */
const ASSETS = {
  bg: {
    river: "https://img.genially.com/67961b32a116fb001568a75e/c0c9010f-c3dd-42c1-b7c1-65024fa3aec6.png",
    lava:  "https://img.genially.com/67961b32a116fb001568a75e/fa2ab459-fec9-4ccd-97e3-254427b4ade0.png",
    swamp: "https://img.genially.com/67961b32a116fb001568a75e/02b52ad4-9d31-4b21-a305-8fec6e8a4487.png",
  },
  char: {
    frog:   "https://img.genially.com/67961b32a116fb001568a75e/3074df22-5c73-4ad2-b0b2-491c6fc247f3.png",
    cham:   "https://img.genially.com/67961b32a116fb001568a75e/74b56fcf-5354-43dd-9c9a-f50facc9a9bf.png",
    lizard: "https://img.genially.com/67961b32a116fb001568a75e/0feda2a1-485a-4654-8640-bf1adcc9f9ec.png",
  },
  plat: {
    lily:    "https://img.genially.com/67961b32a116fb001568a75e/ed6c6e82-953b-43d4-947d-e46227b760f0.png",
    stone:   "https://img.genially.com/67961b32a116fb001568a75e/bad37c6d-f04c-45c0-b954-807d79ec3a95.png",
    hummock: "https://img.genially.com/67961b32a116fb001568a75e/c6775617-bde5-43e4-9da8-5332d928807e.png",
  }
};

/* ---------------------------
   DOM
---------------------------- */
const $ = (id)=>document.getElementById(id);

const LEVELS_UI = $("LEVELS_UI");
const PREVIEW = $("PREVIEW");
const OUT = $("OUT");

/* ---------------------------
   HELPERS
---------------------------- */
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

function escAttr(s){
  return String(s ?? "").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}
function escSrcdoc(s){
  // srcdoc –≤ –æ–¥–∏–Ω–∞—Ä–Ω—ã—Ö –∫–∞–≤—ã—á–∫–∞—Ö: —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º ' –∏ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ </script>
  return String(s)
    .replace(/&/g,"&amp;")
    .replace(/'/g,"&#39;")
    .replace(/<\/script>/gi,"<\\/script>");
}

function hexToRgba(hex, a){
  const h = hex.replace("#","").trim();
  const full = h.length===3 ? h.split("").map(x=>x+x).join("") : h;
  const r = parseInt(full.slice(0,2),16);
  const g = parseInt(full.slice(2,4),16);
  const b = parseInt(full.slice(4,6),16);
  return `rgba(${r},${g},${b},${a})`;
}

function readFileAsDataURL(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=()=>resolve(String(fr.result||""));
    fr.onerror=()=>reject(fr.error);
    fr.readAsDataURL(file);
  });
}

function parseQuestions(text){
  const lines = String(text||"")
    .split(/\r?\n/)
    .map(l=>l.trim())
    .filter(l=>l && !l.startsWith("#"));

  const out=[];
  for(const line of lines){
    const parts=line.split(";").map(p=>p.trim());
    if(parts.length<5) continue;
    const qText=parts[0];
    const a1=parts[1], a2=parts[2], a3=parts[3];
    const idx=parseInt(parts[4],10);
    if(!qText || !a1 || !a2 || !a3) continue;
    if(!(idx>=1 && idx<=3)) continue;
    out.push({text:qText, answers:[a1,a2,a3], correct: idx-1});
  }
  return out;
}

/* ---------------------------
   LEVEL UI BUILDER
---------------------------- */
function buildLevelsUI(){
  const n = clamp(parseInt($("levelCount").value||"3",10),1,10);
  LEVELS_UI.innerHTML="";
  for(let i=0;i<n;i++){
    const wrap=document.createElement("div");
    wrap.className="levelCard";
    wrap.innerHTML=`
      <h3>–£—Ä–æ–≤–µ–Ω—å ${i+1}</h3>
      <div class="row">
        <div>
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è</label>
          <input type="text" id="lvlName_${i}" value="Level ${i+1}">
        </div>
        <div>
          <label>–ü–æ–¥—Å–∫–∞–∑–∫–∞ –Ω–∞ —Ñ–∏–Ω–∏—à–µ —É—Ä–æ–≤–Ω—è</label>
          <input type="text" id="lvlHint_${i}" value="">
        </div>
      </div>
      <div style="margin-top:8px">
        <label>–ó–∞–¥–∞–Ω–∏—è (–ø–æ —Å—Ç—Ä–æ–∫–∞–º, —á–µ—Ä–µ–∑ ; )</label>
        <textarea id="lvlQ_${i}" spellcheck="false"></textarea>
        <div class="small">–ü—Ä–∏–º–µ—Ä: <code>They ____ at home.;is;are;be;2</code></div>
      </div>
    `;
    LEVELS_UI.appendChild(wrap);
  }

  // –¥–µ–º–æ-–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –ø–µ—Ä–≤—ã—Ö 3 —É—Ä–æ–≤–Ω–µ–π (–µ—Å–ª–∏ –ø—É—Å—Ç–æ)
  const demo=[
`I ____ ready.;am;is;are;1
She ____ got a car.;have;has;is have;2
They ____ at home.;is;are;be;2
It ____ cold outside.;is;are;am;1
My sister ____ 10.;is;are;am;1
Tom and Ben ____ friends.;is;are;am;2
He ____ a teacher.;am;is;are;2
We ____ happy today.;am;are;is;2`,
`I ____ from Kazakhstan.;am;is;are;1
She ____ not hungry.;is;are;am;1
He ____ not at school.;is;are;am;1
They ____ friends.;am;are;is;2
We ____ students.;am;are;is;2
It ____ a cat.;is;are;am;1
I ____ happy.;am;is;are;1
She ____ a doctor.;is;are;am;1`,
`There ____ two books.;is;are;am;2
These ____ my keys.;is;are;am;2
That ____ my bag.;is;are;am;1
I ____ late.;am;is;are;1
We ____ not tired.;are;is;am;1
He ____ not ready.;is;are;am;1
They ____ not here.;are;is;am;1
It ____ not sunny.;is;are;am;1`
  ];
  for(let i=0;i<Math.min(n,3);i++){
    const ta=$(`lvlQ_${i}`);
    if(ta && !ta.value.trim()) ta.value=demo[i];
  }
}

/* ---------------------------
   CUSTOM URL/FILE toggles
---------------------------- */
function toggleCustom(pickId, urlId, fileId){
  const sel=$(pickId), url=$(urlId), file=$(fileId);
  const show = (sel.value==="custom");
  if(url) url.style.display = show ? "block" : "none";
  if(file) file.style.display = show ? "block" : "none";
}
["bgPick","charPick","platPick"].forEach(id=>{
  $(id).addEventListener("change", ()=>{
    if(id==="bgPick") toggleCustom("bgPick","bgUrl","bgFile");
    if(id==="charPick") toggleCustom("charPick","charUrl","charFile");
    if(id==="platPick") toggleCustom("platPick","platUrl","platFile");
    rebuild();
  });
});

/* ---------------------------
   BUILD CONFIG (includes dataURL from file)
---------------------------- */
let cache = {
  bgData:"",
  charData:"",
  platData:"",
  sndOkData:"",
  sndBadData:"",
  sndWinData:"",
  sndLoseData:"",
};

async function resolveAsset(kind){
  // kind: bg/char/plat
  const pick = $(`${kind}Pick`).value;
  const urlInput = $(`${kind}Url`).value.trim();
  const fileInput = $(`${kind}File`);
  const key = `${kind}Data`;

  if(pick!=="custom"){
    cache[key] = ASSETS[kind][pick] || "";
    return cache[key];
  }

  // custom: file preferred if chosen
  if(fileInput && fileInput.files && fileInput.files[0]){
    cache[key] = await readFileAsDataURL(fileInput.files[0]);
    return cache[key];
  }
  cache[key] = urlInput;
  return cache[key];
}

async function resolveSound(which){
  // which: Ok/Bad/Win/Lose
  const url = $(`snd${which}Url`).value.trim();
  const file = $(`snd${which}File`).files?.[0] || null;
  const key = `snd${which}Data`;
  if(file){
    cache[key] = await readFileAsDataURL(file);
    return cache[key];
  }
  cache[key] = url;
  return cache[key];
}

function buildLevels(){
  const n = clamp(parseInt($("levelCount").value||"3",10),1,10);
  const out=[];
  for(let i=0;i<n;i++){
    const name = ($(`lvlName_${i}`)?.value || `Level ${i+1}`).trim();
    const hint = ($(`lvlHint_${i}`)?.value || "").trim();
    const qText = ($(`lvlQ_${i}`)?.value || "");
    const questions = parseQuestions(qText);
    out.push({name, hint, questions});
  }
  // –∑–∞—â–∏—Ç–∞: –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –ø—É—Å—Ç–æ, –¥–æ–±–∞–≤–∏–º —Ö–æ—Ç—è –±—ã 1 –≤–æ–ø—Ä–æ—Å-–∑–∞–≥–ª—É—à–∫—É
  for(const lvl of out){
    if(!lvl.questions.length){
      lvl.questions = [{text:"(Add questions here) ____",answers:["A","B","C"],correct:0}];
    }
  }
  return out;
}

/* ---------------------------
   GAME TEMPLATE (Popry–≥—É–Ω 31) ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π
   (–≤—Å—Ç—Ä–æ–µ–Ω –ø—Ä—è–º–æ –≤ srcdoc)
---------------------------- */
function gameHTML(cfg){
  const neon = cfg.neonOn;
  const panelRGBA = hexToRgba(cfg.panelColor, 0.10);
  const panelRGBA2 = hexToRgba(cfg.panelColor, 0.06);

  const glowStrong = neon ? `0 0 18px ${hexToRgba(cfg.accent,0.55)}` : "none";
  const glowSoft = neon ? `0 0 14px ${hexToRgba(cfg.accent,0.22)}` : "none";

  // –í—Å—Ç—Ä–æ–∏–º config –∫–∞–∫ JSON
  const CFG_JSON = JSON.stringify(cfg)
    .replace(/</g,"\\u003c")
    .replace(/>/g,"\\u003e");

  return `<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>${escAttr(cfg.startTitle || "Leap & Learn")}</title>
<style>
:root{
  --neon-main:${cfg.accent};
  --danger:${cfg.danger};
  --win:${cfg.win};
  --uiText:${cfg.uiText};
  --panelA:${panelRGBA};
  --panelB:${panelRGBA2};
  --timerBg:${cfg.timerBg};
  --timerText:${cfg.timerText};
  --qFont:${cfg.qFont}px;
  --aFont:${cfg.aFont}px;
  --glowStrong:${glowStrong};
  --glowSoft:${glowSoft};
  --startBg:${cfg.startBg};
  --endBg:${cfg.endBg};
  --platSize:${cfg.platSize}px;
}
html,body{margin:0;width:100%;height:100%;overflow:hidden;font-family:Arial;background:#0a1730;color:var(--uiText)}

/* GAME */
#GAME{position:relative;width:100%;height:100%}
#GAME.shake{animation:shake .25s}
@keyframes shake{
  0%{transform:translate(0)}
  25%{transform:translate(-4px,3px)}
  50%{transform:translate(4px,-3px)}
  75%{transform:translate(-3px,2px)}
  100%{transform:translate(0)}
}

/* BACKGROUND */
#BG{position:absolute;inset:0;z-index:0;background:url("${escAttr(cfg.bgUrl)}") center/cover no-repeat}

/* UI */
#QUESTION{position:absolute;top:26px;width:100%;text-align:center;font-size:var(--qFont);z-index:20;color:var(--uiText);text-shadow:0 2px 0 rgba(0,0,0,.35);font-weight:900}
#TIMER{
  position:absolute;top:70px;left:50%;transform:translateX(-50%);
  width:80px;height:80px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  background:var(--timerBg);
  border:2px solid var(--neon-main);
  box-shadow:var(--glowStrong);
  z-index:20;font-weight:900;color:var(--timerText);
}
#TIMER.danger{
  border-color:var(--danger);color:var(--danger);
  box-shadow:${neon ? `0 0 25px ${hexToRgba(cfg.danger,0.75)}` : "none"};
  animation:pulse .8s infinite;
}
@keyframes pulse{50%{transform:translateX(-50%) scale(1.12)}}
#LIVES{position:absolute;top:30px;right:30px;font-size:26px;z-index:20}
#SCORE{position:absolute;top:30px;left:30px;font-size:20px;font-weight:900;z-index:20;color:var(--uiText);text-shadow:0 2px 0 rgba(0,0,0,.35)}

/* COMBO */
#COMBO{
  position:absolute;top:165px;left:50%;transform:translateX(-50%);
  z-index:20;padding:10px 16px;border-radius:18px;
  background:rgba(255,255,255,.88);
  border:2px solid var(--neon-main);
  box-shadow:${neon ? `0 0 18px ${hexToRgba(cfg.accent,0.55)}, inset 0 0 14px ${hexToRgba(cfg.accent,0.20)}` : "none"};
  font-weight:900;color:#043149;display:none;gap:10px;align-items:center;
}
#COMBO.show{display:inline-flex}
#COMBO_BOLT{width:18px;height:18px;border-radius:6px;background:${hexToRgba(cfg.accent,0.25)};box-shadow:${neon ? `0 0 14px ${hexToRgba(cfg.accent,0.75)}`:"none"};display:inline-block}
#COMBO.pulse{animation:comboPulse .55s ease}
@keyframes comboPulse{
  0%{transform:translateX(-50%) scale(1)}
  40%{transform:translateX(-50%) scale(1.12)}
  100%{transform:translateX(-50%) scale(1)}
}

/* BUTTONS */
.btn{
  padding:12px 34px;border-radius:16px;font-weight:900;
  background:#fff;border:2px solid var(--neon-main);
  box-shadow:var(--glowStrong);
  cursor:pointer;color:#043149;
}
.btn:active{transform:translateY(1px)}
.btn.dark{
  background:rgba(255,255,255,.10);
  color:var(--uiText);
  border:2px solid ${hexToRgba(cfg.accent,0.55)};
  box-shadow:var(--glowSoft);
}
#START.hide{display:none}

/* START SCREEN */
#START_SCREEN{
  position:absolute;inset:0;z-index:60;
  display:flex;align-items:center;justify-content:center;
  background:color-mix(in srgb, var(--startBg) 92%, transparent);
}
#START_CARD{
  width:min(760px, calc(100vw - 40px));
  border-radius:26px;
  background:linear-gradient(180deg, var(--panelA), var(--panelB));
  border:2px solid ${hexToRgba(cfg.accent,0.75)};
  box-shadow:${neon ? `0 0 30px ${hexToRgba(cfg.accent,0.35)}, inset 0 0 24px ${hexToRgba(cfg.accent,0.18)}` : "none"};
  padding:18px 18px 16px;
  position:relative;overflow:hidden;color:var(--uiText);
}
#START_TOP{position:relative;display:flex;align-items:center;gap:14px;padding:6px 6px 10px}
#START_ICON{
  width:64px;height:64px;flex:0 0 auto;
  background:url("${escAttr(cfg.charUrl)}") no-repeat center/contain;
  filter:${neon ? `drop-shadow(0 0 14px ${hexToRgba(cfg.accent,0.55)})` : "none"};
}
#START_TITLE{font-weight:900;font-size:34px;color:var(--uiText);text-shadow:${neon ? `0 0 18px ${hexToRgba(cfg.accent,0.55)}` : "none"};margin:0;line-height:1.05}
#START_SUB{margin:2px 0 0;color:${hexToRgba(cfg.uiText,0.9)};opacity:.92;font-weight:800}
.panel{
  background:${panelRGBA};
  border:1px solid ${hexToRgba(cfg.accent,0.35)};
  border-radius:18px;
  box-shadow:${neon ? `0 0 12px ${hexToRgba(cfg.accent,0.18)}` : "none"};
  padding:12px 12px 10px;margin-top:10px;
}
.panel h3{margin:0 0 8px;font-size:14px;letter-spacing:.08em;text-transform:uppercase;opacity:.95;color:var(--uiText)}
.rules{margin:0;color:${hexToRgba(cfg.uiText,0.92)};font-weight:800;line-height:1.35;font-size:14px}
.rules li{margin:6px 0}
.kbd{display:inline-block;padding:2px 8px;border-radius:10px;border:1px solid ${hexToRgba(cfg.accent,0.55)};box-shadow:${neon ? `0 0 10px ${hexToRgba(cfg.accent,0.22)}`:"none"};background:${hexToRgba(cfg.panelColor,0.10)};font-weight:900;color:var(--uiText)}
#START_BOTTOM{position:relative;display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px;flex-wrap:wrap}
.badge{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 12px;border-radius:16px;
  border:1px solid ${hexToRgba(cfg.accent,0.35)};
  box-shadow:${neon ? `0 0 12px ${hexToRgba(cfg.accent,0.18)}`:"none"};
  background:${hexToRgba(cfg.panelColor,0.08)};
  color:var(--uiText);font-weight:900;font-size:14px;
}
.badge small{opacity:.86;font-weight:900;color:${hexToRgba(cfg.uiText,0.85)}}

/* dropdown list text dark */
select{
  border-radius:14px;border:1px solid ${hexToRgba(cfg.accent,0.45)};
  background:${hexToRgba(cfg.panelColor,0.10)};
  padding:8px 10px;font-weight:900;color:var(--uiText);outline:none;
  box-shadow: inset 0 0 14px ${hexToRgba(cfg.accent,0.10)};
}
select option{
  color:#0b1630;
  background:#eaf6ff;
  font-weight:900;
}

/* END */
#END{
  position:absolute;inset:0;z-index:50;
  background:color-mix(in srgb, var(--endBg) 92%, transparent);
  display:none;align-items:center;justify-content:center;
  flex-direction:column;
}
#END.show{display:flex}
#END_TEXT{font-size:58px;font-weight:900;margin:0 0 10px;animation:sway 2.5s ease-in-out infinite;text-align:center}
.win{color:var(--win);text-shadow:${neon ? `0 0 12px var(--win),0 0 34px var(--win)` : "none"}}
.lose{color:var(--danger);text-shadow:${neon ? `0 0 12px var(--danger),0 0 34px var(--danger)` : "none"}}
@keyframes sway{
  0%{transform:rotate(0deg)}
  25%{transform:rotate(2deg)}
  50%{transform:rotate(0deg)}
  75%{transform:rotate(-2deg)}
  100%{transform:rotate(0deg)}
}
#LEVEL_BANNER{
  margin:0 0 10px;padding:14px 18px;border-radius:20px;
  background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
  border:1px solid ${hexToRgba(cfg.win,0.55)};
  box-shadow:${neon ? `0 0 24px ${hexToRgba(cfg.win,0.28)}, inset 0 0 18px ${hexToRgba(cfg.win,0.12)}`:"none"};
  color:#fff7cf;font-weight:900;letter-spacing:.06em;text-transform:uppercase;text-align:center;
}
#LEVEL_NAME{margin:0 0 10px;color:${hexToRgba(cfg.uiText,0.9)};font-weight:900;opacity:.95;text-shadow:${neon ? `0 0 12px ${hexToRgba(cfg.accent,0.25)}`:"none"}}
#HINT_LINE{margin:0 0 16px;color:${hexToRgba(cfg.uiText,0.9)};opacity:.9;font-weight:900;text-align:center}

/* SCORECARD */
#SCORECARD{
  width:min(620px, calc(100vw - 40px));
  background:${hexToRgba(cfg.panelColor,0.10)};
  border:2px solid ${hexToRgba(cfg.accent,0.55)};
  box-shadow:${neon ? `0 0 22px ${hexToRgba(cfg.accent,0.30)}, inset 0 0 16px ${hexToRgba(cfg.accent,0.12)}`:"none"};
  border-radius:22px;
  padding:18px 18px 14px;
  margin:6px 0 16px;
  position:relative;
  overflow:hidden;
  color:var(--uiText);
}
#SCOREGRID{position:relative;display:grid;grid-template-columns:1fr 1fr;gap:10px 14px;align-items:stretch}
.row{
  display:flex;align-items:center;justify-content:space-between;
  background:${hexToRgba(cfg.panelColor,0.08)};
  border:1px solid ${hexToRgba(cfg.accent,0.35)};
  border-radius:16px;padding:12px 14px;
  box-shadow:${neon ? `0 0 10px ${hexToRgba(cfg.accent,0.18)}`:"none"};
}
.label{font-size:13px;letter-spacing:.08em;text-transform:uppercase;opacity:.9}
.value{font-size:22px;font-weight:900;text-shadow:${neon ? `0 0 12px ${hexToRgba(cfg.accent,0.25)}`:"none"}}
#FINAL_LINE{
  position:relative;margin-top:12px;
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px;border-radius:18px;
  background:${hexToRgba(cfg.panelColor,0.10)};
  border:2px solid ${hexToRgba(cfg.accent,0.55)};
  box-shadow:${neon ? `0 0 18px ${hexToRgba(cfg.accent,0.25)}, inset 0 0 14px ${hexToRgba(cfg.accent,0.12)}`:"none"};
}
#FINAL_LABEL{font-weight:900;font-size:13px;letter-spacing:.08em;text-transform:uppercase;opacity:.95}
#FINAL_SCORE{font-weight:900;font-size:30px;text-shadow:${neon ? `0 0 16px ${hexToRgba(cfg.accent,0.35)}`:"none"}}
#END_BTNS{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}

/* PLAYER */
#FROG{
  position:absolute;left:160px;top:50%;
  width:110px;height:110px;
  background:url("${escAttr(cfg.charUrl)}") no-repeat center/contain;
  transform:translate(-50%,-65%);
  z-index:15;
  transition:transform .6s ease,opacity .6s ease;
  pointer-events:none;
}
#FROG.jump{transform:translate(-50%,-95%) scale(1.05)}
#FROG.sink{transform:translate(-50%,-10%) scale(.6);opacity:0}

/* PLATFORMS */
#PLATFORMS{position:absolute;inset:0;z-index:10}
.platform{position:absolute;width:var(--platSize);height:var(--platSize);transition:transform .5s,opacity .6s}
.lily{
  width:var(--platSize);height:var(--platSize);
  background:url("${escAttr(cfg.platUrl)}") no-repeat center/contain;
  display:flex;align-items:center;justify-content:center;
  font-weight:900;
  color:#141414;
  font-size:var(--aFont);
  text-shadow:0 2px 0 rgba(255,255,255,.65), 0 0 10px rgba(0,0,0,.35);
  animation:float 3.5s ease-in-out infinite;
  transition:transform .5s, filter .2s;
  padding:10px;
  text-align:center;
}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(6px)}}
.platform.answer{cursor:pointer}
.platform.fade{opacity:0}
.platform.fade .lily{transform:scale(.6)}
.platform.wrong .lily{filter:drop-shadow(0 0 18px red)}

/* FX ABOVE ALL */
#FX{position:absolute;inset:0;pointer-events:none;z-index:200}
.confetti{
  position:absolute;width:10px;height:14px;border-radius:4px;opacity:.95;
  animation:confFall 2.25s ease-in forwards;
  filter:drop-shadow(0 0 12px ${hexToRgba(cfg.accent,0.35)});
}
@keyframes confFall{
  0%{transform:translate3d(0,0,0) rotate(0deg);opacity:1}
  100%{transform:translate3d(var(--dx), calc(100vh + 140px), 0) rotate(720deg);opacity:0}
}
.spark{
  position:absolute;width:8px;height:8px;border-radius:50%;
  background:rgba(255,255,255,.95);
  box-shadow:0 0 22px ${hexToRgba(cfg.accent,0.60)};
  animation:spark 760ms ease-out forwards;
}
@keyframes spark{
  0%{transform:translate(0,0) scale(1);opacity:1}
  100%{transform:translate(var(--dx),var(--dy)) scale(.25);opacity:0}
}
</style>
</head>

<body>
<div id="GAME">
  <div id="BG"></div>

  <div id="SCORE">‚≠ê 0</div>
  <div id="QUESTION"></div>
  <div id="TIMER">00:10</div>
  <div id="COMBO"><span id="COMBO_BOLT"></span><span id="COMBO_TXT">COMBO x1.0</span></div>
  <div id="LIVES"></div>

  <div id="START" class="btn hide">‚ñ∂ Start</div>

  <div id="START_SCREEN">
    <div id="START_CARD">
      <div id="START_TOP">
        <div id="START_ICON"></div>
        <div>
          <h1 id="START_TITLE">${escAttr(cfg.startTitle)}</h1>
          <div id="START_SUB">${escAttr(cfg.startSub)}</div>
        </div>
      </div>

      <div class="panel">
        <h3>How to Play</h3>
        <ul class="rules">
          <li>Pick the correct answer ‚Äî move forward.</li>
          <li>Timer: <span class="kbd">${cfg.t1}s ‚Üí ${cfg.t2}s ‚Üí ${cfg.t3}s</span>.</li>
          <li>Combos increase your score multiplier; a mistake breaks the combo and adds a penalty.</li>
          <li>Choose a level (or all levels) and press <span class="kbd">START</span>.</li>
        </ul>
      </div>

      <div id="START_BOTTOM">
        <div class="badge">
          <span>Mode:</span>
          <select id="LEVEL">
            <option value="all" selected>All Levels (1‚Üí${cfg.levelCount})</option>
            ${Array.from({length:cfg.levelCount},(_,i)=>`<option value="${i}">Level ${i+1}</option>`).join("")}
          </select>
          <small>campaign or single</small>
        </div>

        <button id="START_BTN" class="btn">‚ñ∂ START</button>
      </div>
    </div>
  </div>

  <div id="END">
    <div id="END_TEXT"></div>
    <div id="LEVEL_BANNER">LEVEL COMPLETE</div>
    <div id="LEVEL_NAME">Level 1</div>
    <div id="HINT_LINE"></div>

    <div id="SCORECARD">
      <div id="SCOREGRID">
        <div class="row"><div class="label">Questions</div><div id="STAT_Q" class="value">0/0</div></div>
        <div class="row"><div class="label">Lives</div><div id="STAT_L" class="value">‚ù§Ô∏è0</div></div>
        <div class="row"><div class="label">Base</div><div id="STAT_B" class="value">‚≠ê 0</div></div>
        <div class="row"><div class="label">Time Bonus</div><div id="STAT_T" class="value">‚≠ê 0</div></div>
        <div class="row"><div class="label">Combo Bonus</div><div id="STAT_C" class="value">‚≠ê 0</div></div>
        <div class="row"><div class="label">Penalties</div><div id="STAT_P" class="value">‚≠ê 0</div></div>
      </div>
      <div id="FINAL_LINE">
        <div id="FINAL_LABEL">Total Score</div>
        <div id="FINAL_SCORE">‚≠ê Score: 0</div>
      </div>
    </div>

    <div id="END_BTNS">
      <button id="NEXT_LEVEL" class="btn">‚è≠ Next Level</button>
      <button id="FINISH" class="btn dark">üèÅ Finish</button>
      <button id="RETRY" class="btn">üîÅ Play again</button>
    </div>
  </div>

  <div id="FX"></div>
  <div id="FROG"></div>
  <div id="PLATFORMS"></div>
</div>

<script>
/* CONFIG injected */
const CFG = ${CFG_JSON};

/* ---------------------------
   LEVELS (from panel)
---------------------------- */
const LEVELS = CFG.levels.map((l,i)=>({
  name: l.name || ("Level " + (i+1)),
  hint: l.hint || "",
  questions: (l.questions||[]).map(q=>({text:q.text, answers:q.answers, correct:q.correct}))
}));

/* SETTINGS */
const BASE=100;
const MULT=10;
const WRONG_PENALTY=80;
const LIVES_START=CFG.lives || 5;

const DIFF_PRESETS={
  custom:{t1:CFG.t1, t2:CFG.t2, t3:CFG.t3}
};

/* ELEMENTS */
const Q=QUESTION, T=TIMER, L=LIVES, S=SCORE, P=PLATFORMS;
const FX=document.getElementById("FX");
const GAME=document.getElementById("GAME");
const FROG=document.getElementById("FROG");

const START_SCREEN=document.getElementById("START_SCREEN");
const START_BTN=document.getElementById("START_BTN");
const LEVEL=document.getElementById("LEVEL");

const COMBO_UI=document.getElementById("COMBO");
const COMBO_TXT=document.getElementById("COMBO_TXT");

const END=document.getElementById("END");
const END_TEXT=document.getElementById("END_TEXT");
const FINAL_SCORE=document.getElementById("FINAL_SCORE");
const RETRY=document.getElementById("RETRY");
const FINISH=document.getElementById("FINISH");
const NEXT_LEVEL=document.getElementById("NEXT_LEVEL");
const LEVEL_BANNER=document.getElementById("LEVEL_BANNER");
const LEVEL_NAME=document.getElementById("LEVEL_NAME");
const HINT_LINE=document.getElementById("HINT_LINE");

const STAT_Q=document.getElementById("STAT_Q");
const STAT_L=document.getElementById("STAT_L");
const STAT_B=document.getElementById("STAT_B");
const STAT_T=document.getElementById("STAT_T");
const STAT_C=document.getElementById("STAT_C");
const STAT_P=document.getElementById("STAT_P");

/* STATE */
let QUESTIONS=[];
let q=0, lives=LIVES_START, score=0, started=false, locked=false;
let timer=null, timeLeft=0;
let baseSum=0, timeBonusSum=0, comboBonusSum=0, penaltySum=0;
let correctCount=0, combo=0, maxCombo=0;
let diffKey="custom";

/* LEVEL / CAMPAIGN */
let levelIndex=0;
let campaignMode=false;
let campaignCompleted=false;
let finishStage=0;

/* GRAND TOTALS */
let grandScore=0, grandBase=0, grandTime=0, grandCombo=0, grandPenalty=0;
let grandDone=0, grandTotal=0;

/* AUDIO (URL / dataURL) + fallback synth */
const ctx = new (AudioContext||webkitAudioContext)();

function playUrlAudio(src){
  if(!src) return false;
  try{
    const a=new Audio(src);
    a.volume=0.9;
    a.play().catch(()=>{});
    return true;
  }catch(e){ return false; }
}
function okSynth(){
  const t=ctx.currentTime;
  [523,659,784].forEach((f,i)=>{
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.frequency.value=f;
    g.gain.setValueAtTime(0,t+i*.12);
    g.gain.linearRampToValueAtTime(.25,t+i*.12+.05);
    g.gain.exponentialRampToValueAtTime(.001,t+i*.12+.4);
    o.connect(g);g.connect(ctx.destination);
    o.start(t+i*.12);o.stop(t+i*.12+.45);
  });
}
function loseSynth(){
  const o=ctx.createOscillator(),g=ctx.createGain();
  o.type="sawtooth";
  o.frequency.setValueAtTime(220,ctx.currentTime);
  o.frequency.exponentialRampToValueAtTime(70,ctx.currentTime+1.4);
  g.gain.setValueAtTime(.4,ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+1.4);
  o.connect(g);g.connect(ctx.destination);
  o.start();o.stop(ctx.currentTime+1.5);
}
function winSynth(){
  const t=ctx.currentTime;
  const master=ctx.createGain();
  master.gain.setValueAtTime(0.0,t);
  master.gain.linearRampToValueAtTime(0.95,t+0.05);
  master.gain.exponentialRampToValueAtTime(0.001,t+2.6);
  master.connect(ctx.destination);
  function tone(freq, start, dur, type="sawtooth", gain=0.32){
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=type; o.frequency.value=freq;
    g.gain.setValueAtTime(0, t+start);
    g.gain.linearRampToValueAtTime(gain, t+start+0.03);
    g.gain.exponentialRampToValueAtTime(0.001, t+start+dur);
    o.connect(g); g.connect(master);
    o.start(t+start); o.stop(t+start+dur+0.02);
  }
  const C5=523.25, E5=659.25, G5=783.99, C6=1046.5, E6=1318.5;
  [C5,E5,G5].forEach(f=>tone(f,0.00,0.70,"sawtooth",0.30));
  [E5,G5,C6].forEach(f=>tone(f,0.55,0.80,"sawtooth",0.28));
  [G5,C6,E6].forEach(f=>tone(f,1.15,1.05,"sawtooth",0.25));
}
function badSynth(){
  const b=ctx.createBuffer(1,ctx.sampleRate*.9,ctx.sampleRate);
  const d=b.getChannelData(0);
  for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*(1-i/d.length);
  const s=ctx.createBufferSource(),g=ctx.createGain();
  g.gain.value=.6;
  s.buffer=b;
  s.connect(g);g.connect(ctx.destination);
  s.start();
}

function okSound(){
  const used = playUrlAudio(CFG.sounds.ok);
  if(!used && CFG.useSynth) okSynth();
}
function badSound(){
  const used = playUrlAudio(CFG.sounds.bad);
  if(!used && CFG.useSynth) badSynth();
}
function winSound(){
  const used = playUrlAudio(CFG.sounds.win);
  if(!used && CFG.useSynth) winSynth();
}
function loseSound(){
  const used = playUrlAudio(CFG.sounds.lose);
  if(!used && CFG.useSynth) loseSynth();
}

/* FX */
function confettiBurst(power=1){
  const count=Math.floor(180*power);
  for(let i=0;i<count;i++){
    const c=document.createElement("div");
    c.className="confetti";
    const x=Math.random()*innerWidth;
    c.style.left=x+"px";
    c.style.top=(-30 - Math.random()*200)+"px";
    c.style.setProperty("--dx",(Math.random()*420-210)+"px");
    c.style.background = \`hsla(\${Math.random()*360}, 98%, 62%, .99)\`;
    FX.appendChild(c);
    setTimeout(()=>c.remove(),2700);
  }
}
function sparkBurst(cx,cy, power=1){
  const n=Math.floor(64*power);
  for(let i=0;i<n;i++){
    const sp=document.createElement("div");
    sp.className="spark";
    sp.style.left=(cx-4)+"px";
    sp.style.top=(cy-4)+"px";
    sp.style.setProperty("--dx",(Math.random()*520-260)+"px");
    sp.style.setProperty("--dy",(Math.random()*-360-40)+"px");
    sp.style.background = \`hsla(\${Math.random()*360}, 98%, 72%, .99)\`;
    sp.style.boxShadow = \`0 0 28px hsla(\${Math.random()*360}, 98%, 72%, .98)\`;
    FX.appendChild(sp);
    setTimeout(()=>sp.remove(),1100);
  }
}

/* helpers */
function frogJump(){FROG.classList.add("jump");setTimeout(()=>FROG.classList.remove("jump"),300)}
function cameraShake(){GAME.classList.add("shake");setTimeout(()=>GAME.classList.remove("shake"),300)}
function fmt(s){ return "00:"+String(s).padStart(2,"0"); }

/* shuffle */
function shuffle(arr){
  const a=arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* shuffle answers and keep correct */
function randomizeQuestion(qObj){
  if(!CFG.shuffleAnswers) return qObj;
  const packs = qObj.answers.map((txt,idx)=>({txt, idx}));
  const shuffled = shuffle(packs);
  const newAnswers = shuffled.map(x=>x.txt);
  const newCorrect = shuffled.findIndex(x=>x.idx===qObj.correct);
  return { text:qObj.text, answers:newAnswers, correct:newCorrect };
}
function totalQuestionsInAllLevels(){
  return LEVELS.reduce((s,l)=>s+(l.questions?.length||0),0);
}

/* difficulty */
function getRoundTime(){
  const d=DIFF_PRESETS.custom;
  if(correctCount<3) return d.t1;
  if(correctCount<6) return d.t2;
  return d.t3;
}

/* combo */
function comboMultiplier(){
  const m = 1 + combo*0.12;
  return Math.min(2.0, Math.round(m*10)/10);
}
function updateComboUI(){
  if(combo<=0){
    COMBO_UI.classList.remove("show","pulse");
    return;
  }
  COMBO_UI.classList.add("show","pulse");
  setTimeout(()=>COMBO_UI.classList.remove("pulse"), 560);
  COMBO_TXT.textContent = \`COMBO x\${comboMultiplier().toFixed(1)}\`;
}

/* timer */
function startTimer(){
  clearInterval(timer);
  timeLeft=getRoundTime();
  T.classList.remove("danger");
  T.textContent=fmt(timeLeft);

  timer=setInterval(()=>{
    timeLeft--;
    if(timeLeft<=0){ clearInterval(timer); fail("time"); return; }
    T.textContent=fmt(timeLeft);
    if(timeLeft<=3) T.classList.add("danger");
  },1000);
}

/* build questions */
function buildQuestionsForLevel(idx){
  const lvl = LEVELS[idx] || LEVELS[0];
  const randomized = (lvl.questions||[]).map(q=>randomizeQuestion(q));
  QUESTIONS = shuffle(randomized);
}

/* render */
function render(){
  locked=!started;
  P.innerHTML="";
  FROG.classList.remove("sink");

  Q.textContent=QUESTIONS[q]?.text || "";
  L.textContent="‚ù§Ô∏è".repeat(lives);
  S.textContent="‚≠ê "+score;

  updateComboUI();

  const STEP = Math.round((parseInt(getComputedStyle(document.documentElement).getPropertyValue("--platSize")) || 150) + 40);
  const size = Math.round((parseInt(getComputedStyle(document.documentElement).getPropertyValue("--platSize")) || 150));
  const y=innerHeight/2;
  const count=Math.ceil((innerWidth-160)/STEP)+4;

  for(let i=0;i<count;i++){
    const d=document.createElement("div");
    d.className="platform";
    d.style.left=(160+STEP*i - size/2)+"px";
    d.style.top=(y - size/2)+"px";

    const lily=document.createElement("div");
    lily.className="lily";

    if(i>0 && QUESTIONS[q] && i<=QUESTIONS[q].answers.length){
      lily.textContent=QUESTIONS[q].answers[i-1];
      d.classList.add("answer");
      d.onclick=()=>pick(i,d,STEP,size);
    }

    d.appendChild(lily);
    P.appendChild(d);
  }
}

/* pick */
function pick(i,el,STEP,size){
  if(!started||locked) return;
  locked=true;
  clearInterval(timer);
  frogJump();

  // –∫–∞–º–µ—Ä–∞ ‚Äú–µ–¥–µ—Ç‚Äù —Ç–∞–∫, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞–Ω–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Å—Ç–∞–ª–∞ –Ω–∞ x=160
  document.querySelectorAll(".platform")
    .forEach(p=>p.style.transform=\`translateX(\${-(el.offsetLeft + size/2 - 160)}px)\`);

  setTimeout(()=>{
    const isCorrect = (i-1===QUESTIONS[q].correct);
    if(isCorrect){
      okSound();

      const basePts = BASE;
      const timePts = timeLeft*MULT;

      baseSum += basePts;
      timeBonusSum += timePts;

      combo++;
      maxCombo = Math.max(maxCombo, combo);

      const mult = comboMultiplier();
      const comboBonus = Math.round((basePts + timePts) * (mult-1));
      comboBonusSum += comboBonus;

      score += basePts + timePts + comboBonus;
      correctCount++;

      sparkBurst(innerWidth/2, innerHeight*0.35, 0.9);

      q++;
      if(q>=QUESTIONS.length) showEnd(true);
      else startRound();
    }else{
      fail("wrong");
    }
  },500);
}

/* fail */
function fail(reason){
  lives--;

  if(combo>0) combo=0;
  updateComboUI();

  const penalty = WRONG_PENALTY;
  penaltySum += penalty;
  score = Math.max(0, score - penalty);

  badSound();
  cameraShake();
  FROG.classList.add("sink");
  document.querySelectorAll(".platform").forEach(p=>p.classList.add("fade","wrong"));

  setTimeout(()=>{ lives<=0 ? showEnd(false) : startRound(); },900);
}

/* round */
function startRound(){
  locked=false;
  render();
  startTimer();
}

/* table fill */
function fillLevelTable(){
  const done = Math.min(q, QUESTIONS.length);
  STAT_Q.textContent = \`\${done}/\${QUESTIONS.length}\`;
  STAT_L.textContent = "‚ù§Ô∏è" + lives;
  STAT_B.textContent = "‚≠ê " + baseSum;
  STAT_T.textContent = "‚≠ê " + timeBonusSum;
  STAT_C.textContent = "‚≠ê " + comboBonusSum;
  STAT_P.textContent = "‚≠ê " + penaltySum;
  FINAL_SCORE.textContent="‚≠ê Score: "+score;
}

/* grand push */
function pushLevelToGrand(){
  grandScore += score;
  grandBase  += baseSum;
  grandTime  += timeBonusSum;
  grandCombo += comboBonusSum;
  grandPenalty += penaltySum;
  grandDone += Math.min(q, QUESTIONS.length);
}

/* total results */
function showTotalResults(){
  LEVEL_BANNER.textContent = "TOTAL RESULTS";
  LEVEL_NAME.textContent = "Game Completed";
  HINT_LINE.textContent = "";

  END_TEXT.textContent = CFG.finalTextWinAll || "GAME COMPLETED!";
  END_TEXT.className = "win";

  STAT_Q.textContent = \`\${grandDone}/\${grandTotal}\`;
  STAT_L.textContent = "‚ù§Ô∏è" + lives;
  STAT_B.textContent = "‚≠ê " + grandBase;
  STAT_T.textContent = "‚≠ê " + grandTime;
  STAT_C.textContent = "‚≠ê " + grandCombo;
  STAT_P.textContent = "‚≠ê " + grandPenalty;
  FINAL_SCORE.textContent = "‚≠ê Score: " + grandScore;

  NEXT_LEVEL.style.display="none";
  FINISH.textContent = "üè† Back to Menu";

  winSound();
  confettiBurst(1.6);
  sparkBurst(innerWidth/2, innerHeight*0.22, 1.5);
  setTimeout(()=>confettiBurst(1.2), 220);
  setTimeout(()=>sparkBurst(innerWidth/2, innerHeight*0.30, 1.6), 340);
}

/* end */
function showEnd(win){
  clearInterval(timer);
  END.classList.add("show");

  const lvlName = (LEVELS[levelIndex]?.name) || \`Level \${levelIndex+1}\`;
  LEVEL_NAME.textContent = campaignMode ? \`\${lvlName} (Campaign)\` : lvlName;

  finishStage=0;
  FINISH.textContent="üèÅ Finish";

  const last = (levelIndex >= LEVELS.length-1);

  if(win){
    END_TEXT.textContent = CFG.winText || "CONGRATULATIONS!";
    END_TEXT.className="win";
    LEVEL_BANNER.textContent="LEVEL COMPLETE";

    winSound();
    confettiBurst(1.1);
    sparkBurst(innerWidth/2, innerHeight*0.22, 1.1);

    const hint = LEVELS[levelIndex]?.hint || "";
    HINT_LINE.textContent = hint;

    if(campaignMode && last){
      campaignCompleted=true;
      HINT_LINE.textContent = hint || "All levels cleared ‚Äî press Finish to see Total Results";
      NEXT_LEVEL.style.display="none";
    }else{
      campaignCompleted=false;
      NEXT_LEVEL.style.display = (last ? "none" : "inline-block");
    }
  }else{
    END_TEXT.textContent = CFG.loseText || "YOU LOST!";
    END_TEXT.className="lose";
    LEVEL_BANNER.textContent="TRY AGAIN";
    HINT_LINE.textContent="";
    campaignCompleted=false;
    NEXT_LEVEL.style.display="none";
    loseSound();
  }

  fillLevelTable();
}

/* reset */
function resetState(){
  q=0; lives=LIVES_START; score=0; started=false; locked=false;
  baseSum=0; timeBonusSum=0; comboBonusSum=0; penaltySum=0;
  correctCount=0; combo=0; maxCombo=0;
  clearInterval(timer);
  END.classList.remove("show");
  END_TEXT.className="";
  COMBO_UI.classList.remove("show","pulse");
  T.classList.remove("danger");

  finishStage=0;
  campaignCompleted=false;
  HINT_LINE.textContent="";
  FINISH.textContent="üèÅ Finish";

  T.textContent=fmt(getRoundTime());
}

/* start level */
function startLevel(idx){
  levelIndex = Math.max(0, Math.min(LEVELS.length-1, idx));
  buildQuestionsForLevel(levelIndex);

  resetState();
  START_SCREEN.style.display="none";
  started=true;

  render();
  startRound();
}

/* start campaign */
function startCampaign(){
  campaignMode=true;
  levelIndex=0;

  grandScore=0; grandBase=0; grandTime=0; grandCombo=0; grandPenalty=0;
  grandDone=0;
  grandTotal = totalQuestionsInAllLevels();

  startLevel(0);
}

/* EVENTS */
START_BTN.onclick=()=>{
  // unlock audio
  try{ ctx.resume(); }catch(e){}
  const v = (LEVEL.value||"all");
  if(v==="all") startCampaign();
  else{
    campaignMode=false;
    grandScore=grandBase=grandTime=grandCombo=grandPenalty=grandDone=0;
    grandTotal=0;
    startLevel(parseInt(v,10)||0);
  }
};

RETRY.onclick=()=>{
  resetState();
  campaignMode=false;
  START_SCREEN.style.display="flex";
  render();
};

NEXT_LEVEL.onclick=()=>{
  try{ ctx.resume(); }catch(e){}
  if(campaignMode) pushLevelToGrand();
  const next = levelIndex+1;
  if(next >= LEVELS.length) return;
  startLevel(next);
};

FINISH.onclick=()=>{
  try{ ctx.resume(); }catch(e){}

  if(campaignMode && campaignCompleted && finishStage===0){
    pushLevelToGrand();
    finishStage=1;
    showTotalResults();
    return;
  }

  resetState();
  campaignMode=false;
  START_SCREEN.style.display="flex";
  render();
};

window.addEventListener("resize", ()=>{
  if(started && !END.classList.contains("show")) render();
});

/* INIT */
T.textContent = fmt(getRoundTime());
render();
</script>
</body>
</html>`;
}

/* ---------------------------
   BUILD FULL IFRAME (panel output)
---------------------------- */
async function buildConfig(){
  const levelCount = clamp(parseInt($("levelCount").value||"3",10),1,10);

  const cfg = {
    // colors
    startBg: $("startBg").value,
    endBg: $("endBg").value,
    accent: $("accent").value,
    danger: $("danger").value,
    win: $("win").value,

    panelColor: $("panelColor").value,
    timerBg: $("timerBg").value,
    timerText: $("timerText").value,
    uiText: $("uiText").value,

    neonOn: $("neonOn").checked,

    // fonts
    qFont: clamp(parseInt($("qFont").value||"26",10),12,64),
    aFont: clamp(parseInt($("aFont").value||"16",10),10,44),

    // text
    startTitle: $("startTitle").value.trim() || "Leap & Learn",
    startSub: $("startSub").value.trim() || "",
    winText: $("winText").value.trim() || "CONGRATULATIONS!",
    loseText: $("loseText").value.trim() || "YOU LOST!",
    finalTextWinAll: $("winText").value.trim() || "GAME COMPLETED!",

    // time
    t1: clamp(parseInt($("t1").value||"10",10),1,60),
    t2: clamp(parseInt($("t2").value||"7",10),1,60),
    t3: clamp(parseInt($("t3").value||"5",10),1,60),

    // gameplay
    lives: clamp(parseInt($("lives").value||"5",10),1,10),
    levelCount,
    shuffleAnswers: $("shuffleAnswers").checked,

    // assets (urls resolved)
    bgUrl: await resolveAsset("bg"),
    charUrl: await resolveAsset("char"),
    platUrl: await resolveAsset("plat"),
    platSize: clamp(parseInt($("platSize").value||"150",10),90,220),

    // sounds
    sounds:{
      ok: await resolveSound("Ok"),
      bad: await resolveSound("Bad"),
      win: await resolveSound("Win"),
      lose: await resolveSound("Lose"),
    },
    useSynth: $("useSynthFallback").checked,

    // levels
    levels: buildLevels().map(l=>({
      name:l.name,
      hint:l.hint,
      questions:l.questions
    })),
  };

  return cfg;
}

async function rebuild(){
  // ensure levels ui matches count
  buildLevelsUI();

  const cfg = await buildConfig();
  const html = gameHTML(cfg);

  // preview
  PREVIEW.srcdoc = html;

  // iframe export
  const srcdocEsc = escSrcdoc(html);
  const iframe = `<iframe style="width:100%;height:100%;border:0" srcdoc='${srcdocEsc}'></iframe>`;
  OUT.value = iframe;
}

function copyOut(){
  OUT.select();
  document.execCommand("copy");
}

/* ---------------------------
   EVENTS: rebuild on input
---------------------------- */
[
  "startBg","endBg","winText","loseText","startTitle","startSub",
  "accent","danger","win","panelColor","timerBg","timerText","uiText",
  "qFont","aFont","neonOn",
  "t1","t2","t3","levelCount","lives","shuffleAnswers",
  "bgUrl","charUrl","platUrl","platSize",
  "sndOkUrl","sndBadUrl","sndWinUrl","sndLoseUrl",
  "useSynthFallback"
].forEach(id=>{
  const el=$(id);
  if(el) el.addEventListener("input", ()=>rebuild());
  if(el) el.addEventListener("change", ()=>rebuild());
});

// file inputs rebuild after load
["bgFile","charFile","platFile","sndOkFile","sndBadFile","sndWinFile","sndLoseFile"].forEach(id=>{
  const el=$(id);
  if(el) el.addEventListener("change", ()=>rebuild());
});

$("BTN_REBUILD").onclick=()=>rebuild();
$("BTN_COPY").onclick=()=>copyOut();
$("BTN_COPY2").onclick=()=>copyOut();
$("BTN_SELECT").onclick=()=>{ OUT.focus(); OUT.select(); };

$("BTN_RESET").onclick=()=>{
  // reset key fields to demo
  $("startBg").value="#081022";
  $("endBg").value="#081022";
  $("accent").value="#7cf9ff";
  $("danger").value="#ff3b3b";
  $("win").value="#ffe44d";
  $("panelColor").value="#0f2a46";
  $("timerBg").value="#ffffff";
  $("timerText").value="#053149";
  $("uiText").value="#eaf6ff";
  $("neonOn").checked=true;

  $("qFont").value=26;
  $("aFont").value=16;

  $("t1").value=10; $("t2").value=7; $("t3").value=5;
  $("levelCount").value=3;
  $("lives").value=5;
  $("shuffleAnswers").checked=true;

  $("startTitle").value="Leap & Learn";
  $("startSub").value="Fast quiz game ‚Ä¢ platforms, combos and speed";
  $("winText").value="CONGRATULATIONS!";
  $("loseText").value="YOU LOST!";

  $("bgPick").value="lava";
  $("charPick").value="cham";
  $("platPick").value="hummock";
  toggleCustom("bgPick","bgUrl","bgFile");
  toggleCustom("charPick","charUrl","charFile");
  toggleCustom("platPick","platUrl","platFile");

  $("sndOkUrl").value=""; $("sndBadUrl").value=""; $("sndWinUrl").value=""; $("sndLoseUrl").value="";
  $("useSynthFallback").checked=true;

  $("platSize").value=150;

  buildLevelsUI();
  rebuild();
};

/* INIT */
toggleCustom("bgPick","bgUrl","bgFile");
toggleCustom("charPick","charUrl","charFile");
toggleCustom("platPick","platUrl","platFile");
buildLevelsUI();
rebuild();
</script>
</body>
</html>
