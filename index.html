<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Leap & Learn Editor ‚Äî Restored Game</title>
<style>
  :root { --primary: #7cf9ff; --dark: #0a1730; --panel: #142342; --text: #eaf6ff; --accent: #4dff88; }
  body { margin:0; display:flex; height:100vh; background: #050b1a; color: var(--text); font-family: 'Segoe UI', sans-serif; overflow:hidden; }

  /* SIDEBAR */
  #EDITOR { width: 460px; background: var(--dark); border-right: 1px solid #333; display:flex; flex-direction:column; z-index:10; box-shadow: 4px 0 15px rgba(0,0,0,0.3); }
  #EDITOR_HEADER { padding:15px; background:var(--panel); border-bottom:1px solid #333; display:flex; align-items:center; justify-content:space-between; }
  #EDITOR_HEADER h2 { margin:0; font-size:18px; color:var(--primary); }

  #TABS { display:flex; background:#000; flex-wrap:wrap; }
  .tab { flex:1; min-width:60px; padding:10px 5px; text-align:center; cursor:pointer; background:#111; color:#777; border-bottom:3px solid transparent; font-size:11px; font-weight:bold; transition:0.2s; }
  .tab:hover { color:#fff; background:#1a1a1a; }
  .tab.active { background:var(--panel); color:var(--primary); border-bottom:3px solid var(--primary); }

  #CONTROLS { flex:1; overflow-y:auto; padding:20px; }

  /* FORM ELEMENTS */
  .group { margin-bottom:25px; border-bottom:1px solid #222; padding-bottom:20px; }
  .group h3 { margin:0 0 15px; font-size:13px; color:var(--primary); text-transform:uppercase; letter-spacing:1px; opacity:0.8; }

  label { display:block; font-size:11px; margin-bottom:4px; margin-top:10px; color:#ccc; font-weight:600; }
  input[type="text"], input[type="number"], select, textarea {
    width:100%; box-sizing:border-box; padding:8px; background:#080f20; border:1px solid #333; color:#fff; border-radius:4px; font-size:12px;
  }
  input[type="color"] { width:100%; height:30px; border:none; background:none; cursor:pointer; padding:0; }

  .row { display:flex; gap:10px; align-items: flex-end; }
  .col { flex:1; }

  /* BULK EDITOR */
  .level-item { background:rgba(255,255,255,0.03); border:1px solid #333; margin-bottom:10px; border-radius:6px; overflow:hidden; }
  .level-header { padding:10px; background:rgba(255,255,255,0.05); cursor:pointer; font-weight:bold; display:flex; justify-content:space-between; align-items:center; font-size:13px; }
  .level-content { padding:10px; display:none; border-top:1px solid #333; }
  .level-content.show { display:block; }
  .bulk-container { display:flex; gap:10px; height:180px; }
  .bulk-col { flex:1; display:flex; flex-direction:column; }
  .bulk-area { flex:1; resize:none; font-family: monospace; font-size:11px; white-space:pre; background:#050a15; border:1px solid #444; color:#aaddff; padding:5px; }

  /* BUTTONS */
  .btn { width:100%; padding:12px; cursor:pointer; background:var(--primary); color:#000; font-weight:bold; border:none; border-radius:4px; margin-top:10px; }
  .btn:hover { filter:brightness(1.1); }
  .btn.danger { background:transparent; color:#ff3b3b; width:auto; padding:4px; margin:0; }

  /* PREVIEW */
  #PREVIEW_AREA { flex:1; background:#000; display:flex; flex-direction:column; }
  #PREVIEW_BAR { height:40px; background:#111; display:flex; align-items:center; justify-content:center; gap:20px; border-bottom:1px solid #333; }
  .view-btn { padding:5px 15px; border-radius:15px; background:#222; color:#888; cursor:pointer; font-size:12px; border:1px solid #333; }
  .view-btn.active { background:var(--primary); color:#000; font-weight:bold; border-color:var(--primary); }

  iframe { border:none; width:100%; flex:1; background:#0a1730; }

  /* COPY MODAL */
  #COPY_MODAL { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; display:none; align-items:center; justify-content:center; flex-direction:column; }
  #COPY_MODAL textarea { width:min(900px, 90vw); height:min(420px, 60vh); margin-bottom:15px; }
  .hint { font-size:11px; color:#9fb2d8; max-width:min(900px, 90vw); text-align:center; margin:0 0 10px; }
</style>
</head>
<body>

<div id="EDITOR">
  <div id="EDITOR_HEADER"><h2>üê∏ Leap & Learn Editor</h2></div>
  <div id="TABS">
    <div class="tab active" onclick="setTab('visuals')">–í–ò–ó–£–ê–õ</div>
    <div class="tab" onclick="setTab('fonts')">–®–†–ò–§–¢–´</div>
    <div class="tab" onclick="setTab('texts')">–¢–ï–ö–°–¢–´</div>
    <div class="tab" onclick="setTab('gameplay')">–ì–ï–ô–ú–ü–õ–ï–ô</div>
    <div class="tab" onclick="setTab('levels')">–£–†–û–í–ù–ò</div>
  </div>

  <div id="CONTROLS">
    <!-- VISUALS TAB -->
    <div id="tab-visuals">
      <div class="group">
        <h3>üé® –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –°—Ü–µ–Ω—ã</h3>
        <label>–õ–æ–∫–∞—Ü–∏—è</label>
        <select id="bgSelect" onchange="toggleCustom('bgSelect','bgCustom'); updatePreview()">
          <option value="river">–†–µ–∫–∞</option>
          <option value="lava">–õ–∞–≤–∞</option>
          <option value="swamp">–ë–æ–ª–æ—Ç–æ</option>
          <option value="custom">–°–≤–æ—è —Å—Å—ã–ª–∫–∞...</option>
        </select>
        <input type="text" id="bgCustom" style="display:none;margin-top:5px" oninput="updatePreview()" placeholder="https://...">

        <label>–ü–µ—Ä—Å–æ–Ω–∞–∂</label>
        <select id="charSelect" onchange="toggleCustom('charSelect','charCustom'); updatePreview()">
          <option value="frog">–õ—è–≥—É—à–∫–∞</option>
          <option value="chameleon">–•–∞–º–µ–ª–µ–æ–Ω</option>
          <option value="lizard">–Ø—â–µ—Ä–∏—Ü–∞</option>
          <option value="custom">–°–≤–æ—è —Å—Å—ã–ª–∫–∞...</option>
        </select>
        <input type="text" id="charCustom" style="display:none;margin-top:5px" oninput="updatePreview()" placeholder="https://...">

        <label>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
        <select id="platSelect" onchange="toggleCustom('platSelect','platCustom'); updatePreview()">
          <option value="lily">–õ–∏–ª–∏—è</option>
          <option value="stone">–ö–∞–º–µ–Ω—å</option>
          <option value="mound">–ö–æ—á–∫–∞</option>
          <option value="custom">–°–≤–æ—è —Å—Å—ã–ª–∫–∞...</option>
        </select>
        <input type="text" id="platCustom" style="display:none;margin-top:5px" oninput="updatePreview()" placeholder="https://...">
      </div>

      <div class="group">
        <h3>‚ú® –¶–≤–µ—Ç–∞ (–∫–∞–∫ –≤ –∏—Å—Ö–æ–¥–Ω–æ–π –∏–≥—Ä–µ)</h3>
        <label>–ù–µ–æ–Ω (main)</label>
        <input type="color" id="colNeon" value="#7cf9ff" oninput="updatePreview()">
        <div class="row">
          <div class="col">
            <label>Danger</label>
            <input type="color" id="colDanger" value="#ff3b3b" oninput="updatePreview()">
          </div>
          <div class="col">
            <label>Win</label>
            <input type="color" id="colWin" value="#ffe44d" oninput="updatePreview()">
          </div>
        </div>

        <label>–ù–µ–æ–Ω–æ–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ (glow)</label>
        <select id="neonGlow" onchange="updatePreview()">
          <option value="on" selected>–í–∫–ª—é—á–µ–Ω–æ</option>
          <option value="off">–í—ã–∫–ª—é—á–µ–Ω–æ</option>
        </select>

        <label>–§–∏–Ω–∞–ª—å–Ω—ã–π —Å–∞–ª—é—Ç</label>
        <select id="winFX" onchange="updatePreview()">
          <option value="confetti">–ö–æ–Ω—Ñ–µ—Ç—Ç–∏ (–†–∞–∑–Ω–æ—Ü–≤–µ—Ç–Ω—ã–µ)</option>
          <option value="sparks">–ò—Å–∫—Ä—ã (–ó–æ–ª–æ—Ç—ã–µ)</option>
          <option value="both" selected>–ö–æ–Ω—Ñ–µ—Ç—Ç–∏ + –ò—Å–∫—Ä—ã</option>
        </select>
      </div>

      <div class="group">
        <h3>üè† –≠–∫—Ä–∞–Ω –ü—Ä–∞–≤–∏–ª</h3>
        <label>–¶–≤–µ—Ç –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è —Ñ–æ–Ω–∞</label>
        <div class="row">
           <input type="color" id="colOverlay" value="#081022" oninput="updatePreview()">
           <input type="number" id="opOverlay" value="92" min="0" max="100" style="width:60px" oninput="updatePreview()" title="% –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏">
        </div>
      </div>
    </div>

    <!-- FONTS TAB -->
    <div id="tab-fonts" style="display:none">
      <div class="group">
        <h3>‚ùì –í–æ–ø—Ä–æ—Å</h3>
        <div class="row">
          <div class="col"><label>–¶–≤–µ—Ç</label><input type="color" id="qCol" value="#000000" oninput="updatePreview()"></div>
          <div class="col"><label>–†–∞–∑–º–µ—Ä</label><input type="number" id="qSize" value="26" oninput="updatePreview()"></div>
        </div>
        <label>–®—Ä–∏—Ñ—Ç</label>
        <select id="qFont" onchange="updatePreview()">
           <option value="Arial, sans-serif" selected>Arial</option>
           <option value="'Courier New', monospace">Courier New</option>
           <option value="'Verdana', sans-serif">Verdana</option>
           <option value="'Comic Sans MS', cursive">Comic Sans</option>
        </select>
      </div>

      <div class="group">
        <h3>üçÄ –û—Ç–≤–µ—Ç—ã (–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ)</h3>
        <div class="row">
          <div class="col"><label>–¶–≤–µ—Ç</label><input type="color" id="ansCol" value="#141414" oninput="updatePreview()"></div>
          <div class="col"><label>–†–∞–∑–º–µ—Ä</label><input type="number" id="ansSize" value="18" oninput="updatePreview()"></div>
        </div>
      </div>

      <div class="group">
        <h3>‚è±Ô∏è –¢–∞–π–º–µ—Ä</h3>
        <div class="row">
          <div class="col"><label>–¶–≤–µ—Ç —Ü–∏—Ñ—Ä</label><input type="color" id="timeCol" value="#053149" oninput="updatePreview()"></div>
          <div class="col"><label>–†–∞–∑–º–µ—Ä</label><input type="number" id="timeSize" value="20" oninput="updatePreview()"></div>
        </div>
      </div>
    </div>

    <!-- TEXTS TAB -->
    <div id="tab-texts" style="display:none">
      <div class="group">
        <h3>–ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</h3>
        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä—ã</label><input type="text" id="txtTitle" value="Leap & Learn" oninput="updatePreview()">
        <label>–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label><input type="text" id="txtSub" value="Fast quiz game ‚Ä¢ platforms, combos and speed" oninput="updatePreview()">
        <label>–¢–µ–∫—Å—Ç –ø—Ä–∞–≤–∏–ª (—Å–ø–∏—Å–æ–∫, HTML –º–æ–∂–Ω–æ)</label>
        <textarea id="txtRules" oninput="updatePreview()" rows="4"><li>Pick the correct answer ‚Äî move forward.</li><li>Timer difficulty: <b>10s ‚Üí 7s ‚Üí 5s</b>.</li><li>Combos increase your score; a mistake breaks the combo.</li></textarea>
        <label>–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –°—Ç–∞—Ä—Ç</label><input type="text" id="btnStartTxt" value="‚ñ∂ START" oninput="updatePreview()">
      </div>

      <div class="group">
        <h3>–§–∏–Ω–∞–ª</h3>
        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ü–æ–±–µ–¥—ã</label><input type="text" id="txtWin" value="CONGRATULATIONS!" oninput="updatePreview()">
        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ü—Ä–æ–∏–≥—Ä—ã—à–∞</label><input type="text" id="txtLose" value="YOU LOST!" oninput="updatePreview()">
        <label>–ö–Ω–æ–ø–∫–∞ –î–∞–ª–µ–µ</label><input type="text" id="btnNextTxt" value="‚è≠ Next Level" oninput="updatePreview()">
        <label>–ö–Ω–æ–ø–∫–∞ Finish</label><input type="text" id="btnFinishTxt" value="üèÅ Finish" oninput="updatePreview()">
        <label>–ö–Ω–æ–ø–∫–∞ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</label><input type="text" id="btnRetryTxt" value="üîÅ Play again" oninput="updatePreview()">
      </div>
    </div>

    <!-- GAMEPLAY TAB -->
    <div id="tab-gameplay" style="display:none">
      <div class="group">
        <h3>‚è±Ô∏è –¢–∞–π–º–µ—Ä (–∫–∞–∫ –≤ –∏—Å—Ö–æ–¥–Ω–æ–π –∏–≥—Ä–µ)</h3>
        <div class="row">
          <div class="col"><label>t1 (–ø–µ—Ä–≤—ã–µ 3 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö)</label><input type="number" id="t1" value="10" oninput="updatePreview()"></div>
          <div class="col"><label>t2 (—Å 4 –ø–æ 6)</label><input type="number" id="t2" value="7" oninput="updatePreview()"></div>
          <div class="col"><label>t3 (–ø–æ—Å–ª–µ 6)</label><input type="number" id="t3" value="5" oninput="updatePreview()"></div>
        </div>
      </div>

      <div class="group">
        <h3>üîä –ó–≤—É–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</h3>
        <p style="font-size:10px;color:#888;margin:0 0 8px">–ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º ‚Äî –±—É–¥—É—Ç —Å–∏–Ω—Ç-–∑–≤—É–∫–∏ –∫–∞–∫ –≤ —Ç–≤–æ—ë–º –∏—Å—Ö–æ–¥–Ω–æ–º –∫–æ–¥–µ.</p>
        <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (URL .mp3/.wav)</label><input type="text" id="audOk" oninput="updatePreview()">
        <label>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (URL .mp3/.wav)</label><input type="text" id="audWrong" oninput="updatePreview()">
        <label>–§–∏–Ω–∞–ª: –ü–æ–±–µ–¥–∞ (URL)</label><input type="text" id="audFinalWin" oninput="updatePreview()">
        <label>–§–∏–Ω–∞–ª: –ü—Ä–æ–∏–≥—Ä—ã—à (URL)</label><input type="text" id="audFinalLose" oninput="updatePreview()">
      </div>
    </div>

    <!-- LEVELS TAB -->
    <div id="tab-levels" style="display:none">
      <div id="levelsContainer"></div>
      <button class="btn" style="background:#333; color:#fff; border:1px dashed #555" onclick="addLevel()">+ –î–û–ë–ê–í–ò–¢–¨ –£–†–û–í–ï–ù–¨</button>
      <p style="font-size:10px;color:#8ea3cd;line-height:1.35;margin:10px 0 0">
        –í–û–ü–†–û–°–´: –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ = 1 –≤–æ–ø—Ä–æ—Å.<br>
        –û–¢–í–ï–¢–´: —Å—Ç—Ä–æ–∫–∞ –∫ —Å—Ç—Ä–æ–∫–µ, —Ñ–æ—Ä–º–∞—Ç: <b>–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π | –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π | –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π</b>
      </p>
    </div>

    <br>
    <button class="btn" style="background:var(--accent); padding:16px;" onclick="generateCode()">üìã –ö–û–ü–ò–†–û–í–ê–¢–¨ IFRAME –î–õ–Ø GENIALLY</button>
  </div>
</div>

<div id="PREVIEW_AREA">
  <div id="PREVIEW_BAR">
    <div class="view-btn active" id="btnRules" onclick="toggleView('rules')">üëÅÔ∏è –ú–µ–Ω—é</div>
    <div class="view-btn" id="btnGame" onclick="toggleView('game')">üéÆ –ò–≥—Ä–∞—Ç—å</div>
  </div>
  <iframe id="previewFrame" sandbox="allow-scripts"></iframe>
</div>

<div id="COPY_MODAL">
  <h2 style="color:#fff;margin:0 0 8px">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥:</h2>
  <div class="hint">–≠—Ç–æ –∫–æ–Ω–µ—á–Ω—ã–π iframe(srcdoc). –í Genially –≤—Å—Ç–∞–≤–ª—è–π —Ü–µ–ª–∏–∫–æ–º.</div>
  <textarea id="finalCode" onclick="this.select()"></textarea>
  <button class="btn" style="width:220px" onclick="document.getElementById('COPY_MODAL').style.display='none'">–ó–ê–ö–†–´–¢–¨</button>
</div>

<script>
/* ASSETS DB (—Ç–≤–æ–∏ —Å—Å—ã–ª–∫–∏) */
const ASSETS={
  bg:{
    river:"https://img.genially.com/67961b32a116fb001568a75e/c0c9010f-c3dd-42c1-b7c1-65024fa3aec6.png",
    lava:"https://img.genially.com/67961b32a116fb001568a75e/fa2ab459-fec9-4ccd-97e3-254427b4ade0.png",
    swamp:"https://img.genially.com/67961b32a116fb001568a75e/02b52ad4-9d31-4b21-a305-8fec6e8a4487.png"
  },
  char:{
    frog:"https://img.genially.com/67961b32a116fb001568a75e/3074df22-5c73-4ad2-b0b2-491c6fc247f3.png",
    chameleon:"https://img.genially.com/67961b32a116fb001568a75e/74b56fcf-5354-43dd-9c9a-f50facc9a9bf.png",
    lizard:"https://img.genially.com/67961b32a116fb001568a75e/0feda2a1-485a-4654-8640-bf1adcc9f9ec.png"
  },
  plat:{
    lily:"https://img.genially.com/67961b32a116fb001568a75e/ed6c6e82-953b-43d4-947d-e46227b760f0.png",
    stone:"https://img.genially.com/67961b32a116fb001568a75e/bad37c6d-f04c-45c0-b954-807d79ec3a95.png",
    mound:"https://img.genially.com/67961b32a116fb001568a75e/c6775617-bde5-43e4-9da8-5332d928807e.png"
  }
};

let levels=[{
  name:"Level 1",
  q:"I ____ ready.\nShe ____ got a car.\nThey ____ at home.\nIt ____ cold outside.",
  a:"am | is | are\nhas | have | is have\nare | is | be\nis | are | am"
}];
let viewMode='rules';

function setTab(t){
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  event.target.classList.add('active');
  document.querySelectorAll('#CONTROLS > div').forEach(d=>d.style.display='none');
  document.getElementById('tab-'+t).style.display='block';
}
function toggleCustom(selId, inputId){
  document.getElementById(inputId).style.display = (document.getElementById(selId).value==='custom') ? 'block' : 'none';
}

function renderLevels(){
  const c=document.getElementById('levelsContainer');
  c.innerHTML='';
  levels.forEach((l,i)=>{
    const qn = l.q.split('\n').filter(x=>x.trim()).length;
    const d=document.createElement('div');
    d.className='level-item';
    d.innerHTML=`
      <div class="level-header" onclick="this.nextElementSibling.classList.toggle('show')">
        <span>${escapeHtml(l.name)} (${qn})</span>
        <button class="btn danger" onclick="event.stopPropagation();remLevel(${i})">üóëÔ∏è</button>
      </div>
      <div class="level-content">
        <label>–ò–º—è</label>
        <input value="${escapeAttr(l.name)}" oninput="levels[${i}].name=this.value;renderLevels();upd()">
        <div class="bulk-container">
          <div class="bulk-col">
            <label>–í–û–ü–†–û–°–´</label>
            <textarea class="bulk-area" oninput="levels[${i}].q=this.value;upd()">${escapeHtml(l.q)}</textarea>
          </div>
          <div class="bulk-col">
            <label>–û–¢–í–ï–¢–´ (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π | –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π | –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π)</label>
            <textarea class="bulk-area" oninput="levels[${i}].a=this.value;upd()">${escapeHtml(l.a)}</textarea>
          </div>
        </div>
      </div>
    `;
    c.appendChild(d);
  });
}
function addLevel(){
  levels.push({name:`Level ${levels.length+1}`, q:"", a:""});
  renderLevels(); upd();
}
function remLevel(i){
  if(levels.length<=1){ alert("–ù—É–∂–µ–Ω —Ö–æ—Ç—è –±—ã 1 —É—Ä–æ–≤–µ–Ω—å."); return; }
  if(confirm("–£–¥–∞–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å?")){
    levels.splice(i,1);
    renderLevels(); upd();
  }
}

/* helpers */
function escapeHtml(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function escapeAttr(s){
  return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;');
}
function toRgba(hex, alpha01){
  const h = (hex||"#000000").replace('#','').trim();
  const full = (h.length===3) ? h.split('').map(ch=>ch+ch).join('') : h;
  const r = parseInt(full.slice(0,2),16)||0;
  const g = parseInt(full.slice(2,4),16)||0;
  const b = parseInt(full.slice(4,6),16)||0;
  const a = Math.max(0, Math.min(1, alpha01));
  return `rgba(${r},${g},${b},${a})`;
}

/* PARSE bulk levels -> LEVELS structure from original game */
function parseLevels(){
  const parsed = levels.map((lvl, idx)=>{
    const qs = String(lvl.q||"").split('\n').map(s=>s.trim()).filter(Boolean);
    const as = String(lvl.a||"").split('\n').map(s=>s.trim()).filter(Boolean);

    const questions = qs.map((text, i)=>{
      const line = as[i] || "Correct | Wrong A | Wrong B";
      const parts = line.split('|').map(x=>x.trim()).filter(Boolean);
      const a1 = parts[0] ?? "Correct";
      const a2 = parts[1] ?? "Wrong A";
      const a3 = parts[2] ?? "Wrong B";
      return { text, answers:[a1,a2,a3], correct:0 };
    });

    return {
      name: (lvl.name||`Level ${idx+1}`).trim() || `Level ${idx+1}`,
      questions: questions.length ? questions : [{text:"Add questions in editor", answers:["OK","...","..."], correct:0}]
    };
  });

  return parsed.length ? parsed : [{
    name:"Level 1",
    questions:[{text:"I ____ running.", answers:["am","is","are"], correct:0}]
  }];
}

/* Escape srcdoc for single-quoted attribute */
function escapeForSingleQuotedAttr(s){
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/'/g,'&#39;');
}

/* ===== RESTORED ORIGINAL GAME TEMPLATE (with CFG bridge) ===== */
function getGameHTML(){
  const g=(id)=>document.getElementById(id).value;

  const bgSel=g('bgSelect');
  const chSel=g('charSelect');
  const plSel=g('platSelect');

  const bg = (bgSel==='custom' ? g('bgCustom') : ASSETS.bg[bgSel]) || ASSETS.bg.river;
  const ch = (chSel==='custom' ? g('charCustom') : ASSETS.char[chSel]) || ASSETS.char.frog;
  const pl = (plSel==='custom' ? g('platCustom') : ASSETS.plat[plSel]) || ASSETS.plat.lily;

  const LEVELS = parseLevels();

  const cfg = {
    assets:{ bg, hero: ch, platform: pl },
    colors:{
      neon: document.getElementById('colNeon').value,
      danger: document.getElementById('colDanger').value,
      win: document.getElementById('colWin').value,
      question: document.getElementById('qCol').value
    },
    fonts:{
      qFont: document.getElementById('qFont').value,
      qSize: parseInt(document.getElementById('qSize').value,10)||26,
      ansColor: document.getElementById('ansCol').value,
      ansSize: parseInt(document.getElementById('ansSize').value,10)||18,
      timeColor: document.getElementById('timeCol').value,
      timeSize: parseInt(document.getElementById('timeSize').value,10)||20
    },
    overlay:{
      color: document.getElementById('colOverlay').value,
      op: Math.max(0, Math.min(100, parseInt(document.getElementById('opOverlay').value,10)||92))
    },
    neonGlow: (document.getElementById('neonGlow').value || 'on') === 'on',
    timers:{
      t1: Math.max(3, parseInt(document.getElementById('t1').value,10)||10),
      t2: Math.max(2, parseInt(document.getElementById('t2').value,10)||7),
      t3: Math.max(1, parseInt(document.getElementById('t3').value,10)||5),
    },
    texts:{
      title: document.getElementById('txtTitle').value || "Leap & Learn",
      sub: document.getElementById('txtSub').value || "",
      rules: document.getElementById('txtRules').value || "",
      btnStart: document.getElementById('btnStartTxt').value || "‚ñ∂ START",
      win: document.getElementById('txtWin').value || "CONGRATULATIONS!",
      lose: document.getElementById('txtLose').value || "YOU LOST!",
      btnNext: document.getElementById('btnNextTxt').value || "‚è≠ Next Level",
      btnFinish: document.getElementById('btnFinishTxt').value || "üèÅ Finish",
      btnRetry: document.getElementById('btnRetryTxt').value || "üîÅ Play again"
    },
    sounds:{
      ok: (document.getElementById('audOk').value||"").trim(),
      wrong: (document.getElementById('audWrong').value||"").trim(),
      finalWin: (document.getElementById('audFinalWin').value||"").trim(),
      finalLose: (document.getElementById('audFinalLose').value||"").trim()
    },
    winFX: document.getElementById('winFX').value || "both",
    levels: LEVELS
  };

  const overlayRgba = toRgba(cfg.overlay.color, cfg.overlay.op/100);

  // IMPORTANT: we must avoid literal </script> in a template string
  const jsStart = "<scr" + "ipt>";
  const jsEnd = "</scr" + "ipt>";

  const html = `<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Leap & Learn</title>

<style>
:root{
  --neon-main:${cfg.colors.neon};
  --danger:${cfg.colors.danger};
  --win:${cfg.colors.win};
}
html,body{margin:0;width:100%;height:100%;overflow:hidden;font-family:Arial;background:#0a1730}

/* GAME */
#GAME{position:relative;width:100%;height:100%}
#GAME.shake{animation:shake .25s}
@keyframes shake{
  0%{transform:translate(0)}
  25%{transform:translate(-4px,3px)}
  50%{transform:translate(4px,-3px)}
  75%{transform:translate(-3px,2px)}
  100%{transform:translate(0)}
}

/* BACKGROUND */
#BG{position:absolute;inset:0;z-index:0;background:url("${cfg.assets.bg}") center/cover no-repeat}

/* UI */
#QUESTION{
  position:absolute;top:26px;width:100%;text-align:center;
  font-size:${cfg.fonts.qSize}px;z-index:20;
  color:${cfg.colors.question};
  text-shadow:0 2px 0 rgba(0,0,0,.35);
  font-family:${cfg.fonts.qFont};
}
#TIMER{
  position:absolute;top:70px;left:50%;transform:translateX(-50%);
  width:80px;height:80px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  background:#fff;border:2px solid var(--neon-main);
  box-shadow:${cfg.neonGlow ? "0 0 18px var(--neon-main)" : "none"};
  z-index:20;font-weight:900;
  color:${cfg.fonts.timeColor};
  font-size:${cfg.fonts.timeSize}px;
}
#TIMER.danger{
  border-color:var(--danger);color:var(--danger);
  box-shadow:${cfg.neonGlow ? "0 0 25px var(--danger)" : "none"};
  animation:pulse .8s infinite;
}
@keyframes pulse{50%{transform:translateX(-50%) scale(1.12)}}
#LIVES{position:absolute;top:30px;right:30px;font-size:26px;z-index:20}
#SCORE{position:absolute;top:30px;left:30px;font-size:20px;font-weight:900;z-index:20;color:#fff;text-shadow:0 2px 0 rgba(0,0,0,.35)}

/* COMBO */
#COMBO{
  position:absolute;top:165px;left:50%;transform:translateX(-50%);
  z-index:20;padding:10px 16px;border-radius:18px;
  background:rgba(255,255,255,.88);
  border:2px solid var(--neon-main);
  box-shadow:${cfg.neonGlow ? "0 0 18px rgba(124,249,255,.65), inset 0 0 14px rgba(124,249,255,.25)" : "none"};
  font-weight:900;color:#043149;display:none;gap:10px;align-items:center;
}
#COMBO.show{display:inline-flex}
#COMBO_BOLT{width:18px;height:18px;border-radius:6px;background:rgba(124,249,255,.25);box-shadow:${cfg.neonGlow ? "0 0 14px rgba(124,249,255,.75)" : "none"};display:inline-block}
#COMBO.pulse{animation:comboPulse .55s ease}
@keyframes comboPulse{
  0%{transform:translateX(-50%) scale(1)}
  40%{transform:translateX(-50%) scale(1.12)}
  100%{transform:translateX(-50%) scale(1)}
}

/* BUTTONS */
.btn{
  padding:12px 34px;border-radius:16px;font-weight:900;
  background:#fff;border:2px solid var(--neon-main);
  box-shadow:${cfg.neonGlow ? "0 0 15px var(--neon-main)" : "none"};
  cursor:pointer;color:#043149;
}
.btn:active{transform:translateY(1px)}
.btn.dark{
  background:rgba(255,255,255,.10);
  color:#eaf6ff;
  border:2px solid rgba(124,249,255,.55);
  box-shadow:${cfg.neonGlow ? "0 0 16px rgba(124,249,255,.25)" : "none"};
}

/* START SCREEN */
#START_SCREEN{
  position:absolute;inset:0;z-index:60;
  display:flex;align-items:center;justify-content:center;
  background:${overlayRgba};
}
#START_CARD{
  width:min(760px, calc(100vw - 40px));
  border-radius:26px;
  background:linear-gradient(180deg, rgba(10,20,50,.92), rgba(5,10,25,.92));
  border:2px solid rgba(124,249,255,.75);
  box-shadow:${cfg.neonGlow ? "0 0 30px rgba(124,249,255,.55), inset 0 0 24px rgba(124,249,255,.18)" : "none"};
  padding:18px 18px 16px;
  position:relative;overflow:hidden;color:#eaf6ff;
}
#START_TOP{position:relative;display:flex;align-items:center;gap:14px;padding:6px 6px 10px}
#START_ICON{
  width:64px;height:64px;flex:0 0 auto;
  background:url("${cfg.assets.hero}") no-repeat center/contain;
  filter:${cfg.neonGlow ? "drop-shadow(0 0 14px rgba(124,249,255,.55))" : "none"};
}
#START_TITLE{font-weight:900;font-size:34px;color:#eaf6ff;text-shadow:${cfg.neonGlow ? "0 0 18px rgba(124,249,255,.55)" : "none"};margin:0;line-height:1.05}
#START_SUB{margin:2px 0 0;color:#bfe9ff;opacity:.9;font-weight:700}
.panel{
  background:rgba(255,255,255,.08);
  border:1px solid rgba(124,249,255,.35);
  border-radius:18px;
  box-shadow:${cfg.neonGlow ? "0 0 12px rgba(124,249,255,.18)" : "none"};
  padding:12px 12px 10px;margin-top:10px;
}
.panel h3{margin:0 0 8px;font-size:14px;letter-spacing:.08em;text-transform:uppercase;opacity:.9;color:#eaf6ff}
.rules{margin:0;color:#cfefff;font-weight:700;line-height:1.35;font-size:14px}
.rules li{margin:6px 0}
#START_BOTTOM{position:relative;display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px;flex-wrap:wrap}
.badge{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 12px;border-radius:16px;
  border:1px solid rgba(124,249,255,.35);
  box-shadow:${cfg.neonGlow ? "0 0 12px rgba(124,249,255,.18)" : "none"};
  background:rgba(255,255,255,.08);
  color:#eaf6ff;font-weight:900;font-size:14px;
}
.badge small{opacity:.8;font-weight:900;color:#bfe9ff}

/* dropdowns (dark list) */
select{
  border-radius:14px;border:1px solid rgba(124,249,255,.45);
  background:rgba(255,255,255,.10);
  padding:8px 10px;font-weight:900;color:#eaf6ff;outline:none;
  box-shadow: inset 0 0 14px rgba(124,249,255,.10);
}
select option{color:#0b1630;background:#eaf6ff;font-weight:900}

/* END */
#END{
  position:absolute;inset:0;z-index:50;
  background:rgba(8,16,34,.92);
  display:none;align-items:center;justify-content:center;flex-direction:column;
}
#END.show{display:flex}
#END_TEXT{font-size:58px;font-weight:900;margin:0 0 10px;animation:sway 2.5s ease-in-out infinite;text-align:center}
.win{color:var(--win);text-shadow:${cfg.neonGlow ? "0 0 12px var(--win),0 0 34px var(--win)" : "none"}}
.lose{color:var(--danger);text-shadow:${cfg.neonGlow ? "0 0 12px var(--danger),0 0 34px var(--danger)" : "none"}}
@keyframes sway{0%{transform:rotate(0)}25%{transform:rotate(2deg)}50%{transform:rotate(0)}75%{transform:rotate(-2deg)}100%{transform:rotate(0)}}
#LEVEL_BANNER{
  margin:0 0 10px;padding:14px 18px;border-radius:20px;
  background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
  border:1px solid rgba(255,228,77,.55);
  box-shadow:${cfg.neonGlow ? "0 0 24px rgba(255,228,77,.35), inset 0 0 18px rgba(255,228,77,.12)" : "none"};
  color:#fff7cf;font-weight:900;letter-spacing:.06em;text-transform:uppercase;text-align:center;
}
#LEVEL_NAME{margin:0 0 10px;color:#bfe9ff;font-weight:900;opacity:.95;text-shadow:${cfg.neonGlow ? "0 0 12px rgba(124,249,255,.25)" : "none"}}
#HINT_LINE{margin:0 0 16px;color:#cfefff;opacity:.9;font-weight:900;text-align:center}

/* SCORECARD */
#SCORECARD{
  width:min(620px, calc(100vw - 40px));
  background:rgba(255,255,255,.10);
  border:2px solid rgba(124,249,255,.55);
  box-shadow:${cfg.neonGlow ? "0 0 22px rgba(124,249,255,.45), inset 0 0 16px rgba(124,249,255,.15)" : "none"};
  border-radius:22px;
  padding:18px 18px 14px;
  margin:6px 0 16px;
  position:relative;
  overflow:hidden;
  color:#eaf6ff;
}
#SCOREGRID{position:relative;display:grid;grid-template-columns:1fr 1fr;gap:10px 14px;align-items:stretch}
.row{
  display:flex;align-items:center;justify-content:space-between;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(124,249,255,.35);
  border-radius:16px;padding:12px 14px;
  box-shadow:${cfg.neonGlow ? "0 0 10px rgba(124,249,255,.18)" : "none"};
}
.label{font-size:13px;letter-spacing:.08em;text-transform:uppercase;opacity:.9}
.value{font-size:22px;font-weight:900;text-shadow:${cfg.neonGlow ? "0 0 12px rgba(124,249,255,.25)" : "none"}}
#FINAL_LINE{
  position:relative;margin-top:12px;
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px;border-radius:18px;
  background:rgba(255,255,255,.10);
  border:2px solid rgba(124,249,255,.55);
  box-shadow:${cfg.neonGlow ? "0 0 18px rgba(124,249,255,.35), inset 0 0 14px rgba(124,249,255,.12)" : "none"};
}
#FINAL_LABEL{font-weight:900;font-size:13px;letter-spacing:.08em;text-transform:uppercase;opacity:.95}
#FINAL_SCORE{font-weight:900;font-size:30px;text-shadow:${cfg.neonGlow ? "0 0 16px rgba(124,249,255,.35)" : "none"}}
#END_BTNS{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}

/* PLAYER */
#FROG{
  position:absolute;left:160px;top:50%;
  width:110px;height:110px;
  background:url("${cfg.assets.hero}") no-repeat center/contain;
  transform:translate(-50%,-65%);
  z-index:15;
  transition:transform .6s ease,opacity .6s ease;
  pointer-events:none;
}
#FROG.jump{transform:translate(-50%,-95%) scale(1.05)}
#FROG.sink{transform:translate(-50%,-10%) scale(.6);opacity:0}

/* PLATFORMS */
#PLATFORMS{position:absolute;inset:0;z-index:10}
.platform{position:absolute;width:150px;height:150px;transition:transform .5s,opacity .6s}
.lily{
  width:150px;height:150px;
  background:url("${cfg.assets.platform}") no-repeat center/contain;
  display:flex;align-items:center;justify-content:center;
  font-weight:900;
  color:${cfg.fonts.ansColor};
  font-size:${cfg.fonts.ansSize}px;
  text-shadow:0 2px 0 rgba(255,255,255,.65), 0 0 10px rgba(0,0,0,.35);
  animation:float 3.5s ease-in-out infinite;
  transition:transform .5s, filter .2s;
}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(6px)}}
.platform.answer{cursor:pointer}
.platform.fade{opacity:0}
.platform.fade .lily{transform:scale(.6)}
.platform.wrong .lily{filter:drop-shadow(0 0 18px red)}
@keyframes wobble{
  0%{transform:translateY(0) rotate(0deg)}
  25%{transform:translateY(1px) rotate(-3deg)}
  50%{transform:translateY(0) rotate(3deg)}
  75%{transform:translateY(1px) rotate(-2deg)}
  100%{transform:translateY(0) rotate(0deg)}
}
.platform.wobble .lily{
  animation:float 3.5s ease-in-out infinite, wobble .35s ease-in-out 0s 3;
}

/* FX ABOVE ALL */
#FX{position:absolute;inset:0;pointer-events:none;z-index:200}

/* waves + bubbles */
.splash{position:absolute;width:90px;height:34px;background:rgba(255,255,255,.92);border-radius:50%;animation:splash .45s forwards;filter:drop-shadow(0 0 10px rgba(255,255,255,.25))}
@keyframes splash{to{transform:scale(2.2);opacity:0}}
.ripple{position:absolute;border:3px solid rgba(255,255,255,.92);border-radius:50%;animation:ripple 1.45s forwards;filter:drop-shadow(0 0 10px rgba(255,255,255,.15))}
@keyframes ripple{to{transform:scale(2.2);opacity:0}}
.bubble{position:absolute;border-radius:50%;background:rgba(255,255,255,.88);animation:bubble 1.7s forwards;filter:drop-shadow(0 0 10px rgba(255,255,255,.15))}
@keyframes bubble{to{transform:translate(var(--dx),var(--dy));opacity:0}}

/* confetti + sparks */
.confetti{position:absolute;width:10px;height:14px;border-radius:4px;opacity:.95;animation:confFall 2.25s ease-in forwards;filter:drop-shadow(0 0 12px rgba(124,249,255,.55))}
@keyframes confFall{
  0%{transform:translate3d(0,0,0) rotate(0deg);opacity:1}
  100%{transform:translate3d(var(--dx), calc(100vh + 140px), 0) rotate(720deg);opacity:0}
}
.spark{
  position:absolute;width:8px;height:8px;border-radius:50%;
  background:rgba(255,255,255,.95);
  box-shadow:0 0 22px rgba(124,249,255,.95);
  animation:spark 760ms ease-out forwards;
}
@keyframes spark{
  0%{transform:translate(0,0) scale(1);opacity:1}
  100%{transform:translate(var(--dx),var(--dy)) scale(.25);opacity:0}
}
</style>
</head>

<body>
<div id="GAME">
  <div id="BG"></div>

  <div id="SCORE">‚≠ê 0</div>
  <div id="QUESTION"></div>
  <div id="TIMER">00:10</div>
  <div id="COMBO"><span id="COMBO_BOLT"></span><span id="COMBO_TXT">COMBO x1.0</span></div>
  <div id="LIVES"></div>

  <!-- START SCREEN -->
  <div id="START_SCREEN">
    <div id="START_CARD">
      <div id="START_TOP">
        <div id="START_ICON"></div>
        <div>
          <h1 id="START_TITLE">${escapeHtml(cfg.texts.title)}</h1>
          <div id="START_SUB">${escapeHtml(cfg.texts.sub)}</div>
        </div>
      </div>

      <div class="panel">
        <h3>How to Play</h3>
        <ul class="rules" id="RULES_LIST">${cfg.texts.rules}</ul>
      </div>

      <div id="START_BOTTOM">
        <div class="badge">
          <span>Mode:</span>
          <select id="LEVEL">
            <option value="all" selected>All Levels (1‚Üí${cfg.levels.length})</option>
          </select>
          <small>campaign or single</small>
        </div>

        <div class="badge">
          <span>Difficulty:</span>
          <select id="DIFF">
            <option value="classic" selected>Classic</option>
            <option value="easy">Easy</option>
            <option value="hard">Hard</option>
          </select>
          <small>+ combos & penalties</small>
        </div>

        <button id="START_BTN" class="btn">${escapeHtml(cfg.texts.btnStart)}</button>
      </div>
    </div>
  </div>

  <!-- END SCREEN -->
  <div id="END">
    <div id="END_TEXT"></div>
    <div id="LEVEL_BANNER">LEVEL COMPLETE</div>
    <div id="LEVEL_NAME">Level 1</div>
    <div id="HINT_LINE"></div>

    <div id="SCORECARD">
      <div id="SCOREGRID">
        <div class="row"><div class="label">Questions</div><div id="STAT_Q" class="value">0/0</div></div>
        <div class="row"><div class="label">Lives</div><div id="STAT_L" class="value">‚ù§Ô∏è0</div></div>
        <div class="row"><div class="label">Base</div><div id="STAT_B" class="value">‚≠ê 0</div></div>
        <div class="row"><div class="label">Time Bonus</div><div id="STAT_T" class="value">‚≠ê 0</div></div>
        <div class="row"><div class="label">Combo Bonus</div><div id="STAT_C" class="value">‚≠ê 0</div></div>
        <div class="row"><div class="label">Penalties</div><div id="STAT_P" class="value">‚≠ê 0</div></div>
      </div>
      <div id="FINAL_LINE">
        <div id="FINAL_LABEL">Total Score</div>
        <div id="FINAL_SCORE">‚≠ê Score: 0</div>
      </div>
    </div>

    <div id="END_BTNS">
      <button id="NEXT_LEVEL" class="btn">${escapeHtml(cfg.texts.btnNext)}</button>
      <button id="FINISH" class="btn dark">${escapeHtml(cfg.texts.btnFinish)}</button>
      <button id="RETRY" class="btn">${escapeHtml(cfg.texts.btnRetry)}</button>
    </div>
  </div>

  <div id="FX"></div>
  <div id="FROG"></div>
  <div id="PLATFORMS"></div>
</div>

${jsStart}
/* ---------------------------
   RESTORED GAME CORE (from your original)
   + CFG bridge injected by editor
---------------------------- */
const CFG = ${JSON.stringify(cfg)};
const LEVELS = (CFG.levels||[]);

/* SETTINGS (original-like) */
const BASE=100;
const MULT=10;
const WRONG_PENALTY=80;
const LIVES_START=5;

const DIFF_PRESETS={
  classic:{t1:CFG.timers.t1, t2:CFG.timers.t2, t3:CFG.timers.t3},
  easy:{t1:CFG.timers.t1+2, t2:CFG.timers.t2+2, t3:CFG.timers.t3+2},
  hard:{t1:Math.max(3,CFG.timers.t1-1), t2:Math.max(2,CFG.timers.t2-1), t3:Math.max(1,CFG.timers.t3-1)},
};

/* ELEMENTS */
const Q=QUESTION, T=TIMER, L=LIVES, S=SCORE, P=PLATFORMS;
const FX=document.getElementById("FX");
const GAME=document.getElementById("GAME");
const FROG=document.getElementById("FROG");

const START_SCREEN=document.getElementById("START_SCREEN");
const START_BTN=document.getElementById("START_BTN");
const DIFF=document.getElementById("DIFF");
const LEVEL=document.getElementById("LEVEL");

const COMBO_UI=document.getElementById("COMBO");
const COMBO_TXT=document.getElementById("COMBO_TXT");

const END=document.getElementById("END");
const END_TEXT=document.getElementById("END_TEXT");
const FINAL_SCORE=document.getElementById("FINAL_SCORE");
const RETRY=document.getElementById("RETRY");
const FINISH=document.getElementById("FINISH");
const NEXT_LEVEL=document.getElementById("NEXT_LEVEL");
const LEVEL_BANNER=document.getElementById("LEVEL_BANNER");
const LEVEL_NAME=document.getElementById("LEVEL_NAME");
const HINT_LINE=document.getElementById("HINT_LINE");

const STAT_Q=document.getElementById("STAT_Q");
const STAT_L=document.getElementById("STAT_L");
const STAT_B=document.getElementById("STAT_B");
const STAT_T=document.getElementById("STAT_T");
const STAT_C=document.getElementById("STAT_C");
const STAT_P=document.getElementById("STAT_P");

/* STATE */
let QUESTIONS=[];
let q=0, lives=LIVES_START, score=0, started=false, locked=false;
let timer=null, timeLeft=0;
let baseSum=0, timeBonusSum=0, comboBonusSum=0, penaltySum=0;
let correctCount=0, combo=0, maxCombo=0;
let diffKey="classic";

/* LEVEL / CAMPAIGN */
let levelIndex=0;
let campaignMode=false;
let campaignCompleted=false;
let finishStage=0;

/* GRAND TOTALS */
let grandScore=0, grandBase=0, grandTime=0, grandCombo=0, grandPenalty=0;
let grandDone=0, grandTotal=0;

/* AUDIO (original synth, with optional custom files) */
const ctx=new (AudioContext||webkitAudioContext)();

function playUrl(url){
  try{
    const a = new Audio(url);
    a.volume = 1;
    a.play().catch(()=>{});
  }catch(e){}
}

function okSound(){
  if(CFG.sounds.ok){ playUrl(CFG.sounds.ok); return; }
  const t=ctx.currentTime;
  [523,659,784].forEach((f,i)=>{
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.frequency.value=f;
    g.gain.setValueAtTime(0,t+i*.12);
    g.gain.linearRampToValueAtTime(.25,t+i*.12+.05);
    g.gain.exponentialRampToValueAtTime(.001,t+i*.12+.4);
    o.connect(g);g.connect(ctx.destination);
    o.start(t+i*.12);o.stop(t+i*.12+.45);
  });
}
function loseFinalSound(){
  if(CFG.sounds.finalLose){ playUrl(CFG.sounds.finalLose); return; }
  const o=ctx.createOscillator(),g=ctx.createGain();
  o.type="sawtooth";
  o.frequency.setValueAtTime(220,ctx.currentTime);
  o.frequency.exponentialRampToValueAtTime(70,ctx.currentTime+1.4);
  g.gain.setValueAtTime(.4,ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+1.4);
  o.connect(g);g.connect(ctx.destination);
  o.start();o.stop(ctx.currentTime+1.5);
}
function waterFailSound(){
  if(CFG.sounds.wrong){ playUrl(CFG.sounds.wrong); return; }
  const b=ctx.createBuffer(1,ctx.sampleRate*.9,ctx.sampleRate);
  const d=b.getChannelData(0);
  for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*(1-i/d.length);
  const s=ctx.createBufferSource(),g=ctx.createGain();
  g.gain.value=.6;
  s.buffer=b;
  s.connect(g);g.connect(ctx.destination);
  s.start();
}

/* fanfare (original-like) */
function fanfareSound(strength=1){
  if(CFG.sounds.finalWin){ playUrl(CFG.sounds.finalWin); return; }
  const t=ctx.currentTime;
  const master=ctx.createGain();
  master.gain.setValueAtTime(0.0,t);
  master.gain.linearRampToValueAtTime(0.95*strength,t+0.05);
  master.gain.exponentialRampToValueAtTime(0.001,t+2.8);
  master.connect(ctx.destination);

  function tone(freq, start, dur, type="sawtooth", gain=0.34){
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=type; o.frequency.value=freq;
    g.gain.setValueAtTime(0, t+start);
    g.gain.linearRampToValueAtTime(gain*strength, t+start+0.03);
    g.gain.exponentialRampToValueAtTime(0.001, t+start+dur);
    o.connect(g); g.connect(master);
    o.start(t+start); o.stop(t+start+dur+0.02);
  }
  const C5=523.25, E5=659.25, G5=783.99, C6=1046.5, E6=1318.5;
  [C5,E5,G5].forEach(f=>tone(f,0.00,0.70,"sawtooth",0.30));
  [E5,G5,C6].forEach(f=>tone(f,0.55,0.80,"sawtooth",0.28));
  [G5,C6,E6].forEach(f=>tone(f,1.15,1.05,"sawtooth",0.25));
  const arp=[C5,E5,G5,C6,E5,G5,C6,E6];
  arp.forEach((f,i)=>tone(f,0.15+i*0.10,0.22,"triangle",0.20));
}
function playWinSound(){ fanfareSound(1.0); }
function playTotalSound(){ fanfareSound(1.25); }

/* FX helpers (waves/bubbles + confetti/sparks) */
function waterFX(bubbles=false){
  const x=160, y=innerHeight/2+64;

  const s=document.createElement("div");
  s.className="splash";
  s.style.left=(x-45)+"px";
  s.style.top=(y-17)+"px";
  FX.appendChild(s);
  setTimeout(()=>s.remove(),520);

  for(let i=0;i<3;i++){
    const r=document.createElement("div");
    r.className="ripple";
    const size=64+i*40;
    r.style.width=r.style.height=size+"px";
    r.style.left=(x-size/2)+"px";
    r.style.top=(y-size/2)+"px";
    FX.appendChild(r);
    setTimeout(()=>r.remove(),1550);
  }

  if(bubbles){
    for(let i=0;i<20;i++){
      const b=document.createElement("div");
      b.className="bubble";
      const ss=6+Math.random()*12;
      b.style.width=b.style.height=ss+"px";
      b.style.left=(x + Math.random()*140 - 70)+"px";
      b.style.top=(y + Math.random()*34 - 17)+"px";
      b.style.setProperty("--dx",(Math.random()*140-70)+"px");
      b.style.setProperty("--dy",(-140-Math.random()*120)+"px");
      FX.appendChild(b);
      setTimeout(()=>b.remove(),1750);
    }
  }
}
function confettiBurst(power=1){
  const count=Math.floor(180*power);
  for(let i=0;i<count;i++){
    const c=document.createElement("div");
    c.className="confetti";
    const x=Math.random()*innerWidth;
    c.style.left=x+"px";
    c.style.top=(-30 - Math.random()*200)+"px";
    c.style.setProperty("--dx",(Math.random()*420-210)+"px");
    c.style.background = `hsla(${Math.random()*360}, 98%, 62%, .99)`;
    FX.appendChild(c);
    setTimeout(()=>c.remove(),2700);
  }
}
function sparkBurst(cx,cy, power=1){
  const n=Math.floor(64*power);
  for(let i=0;i<n;i++){
    const sp=document.createElement("div");
    sp.className="spark";
    sp.style.left=(cx-4)+"px";
    sp.style.top=(cy-4)+"px";
    sp.style.setProperty("--dx",(Math.random()*520-260)+"px");
    sp.style.setProperty("--dy",(Math.random()*-360-40)+"px");
    sp.style.background = `hsla(${Math.random()*360}, 98%, 72%, .99)`;
    sp.style.boxShadow = `0 0 28px hsla(${Math.random()*360}, 98%, 72%, .98)`;
    FX.appendChild(sp);
    setTimeout(()=>sp.remove(),1100);
  }
}

/* helpers */
function frogJump(){FROG.classList.add("jump");setTimeout(()=>FROG.classList.remove("jump"),300)}
function cameraShake(){GAME.classList.add("shake");setTimeout(()=>GAME.classList.remove("shake"),300)}
function fmt(s){ return "00:"+String(s).padStart(2,"0"); }

/* shuffle */
function shuffle(arr){
  const a=arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* shuffle answers & keep correct */
function randomizeQuestion(qObj){
  const packs = qObj.answers.map((txt,idx)=>({txt, idx}));
  const shuffled = shuffle(packs);
  const newAnswers = shuffled.map(x=>x.txt);
  const newCorrect = shuffled.findIndex(x=>x.idx===qObj.correct);
  return { text:qObj.text, answers:newAnswers, correct:newCorrect };
}

function totalQuestionsInAllLevels(){
  return LEVELS.reduce((s,l)=>s+(l.questions?.length||0),0);
}

/* difficulty */
function getRoundTime(){
  const d=DIFF_PRESETS[diffKey] || DIFF_PRESETS.classic;
  if(correctCount<3) return d.t1;
  if(correctCount<6) return d.t2;
  return d.t3;
}

/* combo */
function comboMultiplier(){
  const m = 1 + combo*0.12;
  return Math.min(2.0, Math.round(m*10)/10);
}
function updateComboUI(){
  if(combo<=0){
    COMBO_UI.classList.remove("show","pulse");
    return;
  }
  COMBO_UI.classList.add("show","pulse");
  setTimeout(()=>COMBO_UI.classList.remove("pulse"), 560);
  COMBO_TXT.textContent = `COMBO x${comboMultiplier().toFixed(1)}`;
}

/* timer */
function startTimer(){
  clearInterval(timer);
  timeLeft=getRoundTime();
  T.classList.remove("danger");
  T.textContent=fmt(timeLeft);

  timer=setInterval(()=>{
    timeLeft--;
    if(timeLeft<=0){ clearInterval(timer); fail("time"); return; }
    T.textContent=fmt(timeLeft);
    if(timeLeft<=3) T.classList.add("danger");
  },1000);
}

/* build questions */
function buildQuestionsForLevel(idx){
  const lvl = LEVELS[idx] || LEVELS[0];
  const randomized = (lvl.questions||[]).map(q=>randomizeQuestion(q));
  QUESTIONS = shuffle(randomized);
}

/* render */
function render(){
  locked=!started;
  P.innerHTML="";
  FROG.classList.remove("sink");

  Q.textContent=QUESTIONS[q]?.text || "";
  L.textContent="‚ù§Ô∏è".repeat(lives);
  S.textContent="‚≠ê "+score;

  updateComboUI();

  const STEP=190,y=innerHeight/2;
  const count=Math.ceil((innerWidth-160)/STEP)+4;

  for(let i=0;i<count;i++){
    const d=document.createElement("div");
    d.className="platform";
    d.style.left=160+STEP*i-75+"px";
    d.style.top=y-75+"px";

    const lily=document.createElement("div");
    lily.className="lily";

    if(i>0 && QUESTIONS[q] && i<=QUESTIONS[q].answers.length){
      lily.textContent=QUESTIONS[q].answers[i-1];
      d.classList.add("answer");
      d.onclick=()=>pick(i,d);
    }

    d.appendChild(lily);
    P.appendChild(d);
  }
}

/* pick */
function pick(i,el){
  if(!started||locked) return;
  locked=true;
  clearInterval(timer);
  frogJump();

  document.querySelectorAll(".platform")
    .forEach(p=>p.style.transform=`translateX(${-(el.offsetLeft+75-160)}px)`);

  setTimeout(()=>{
    const isCorrect = (i-1===QUESTIONS[q].correct);
    if(isCorrect){
      okSound();
      waterFX(false);

      const basePts = BASE;
      const timePts = timeLeft*MULT;

      baseSum += basePts;
      timeBonusSum += timePts;

      combo++;
      maxCombo = Math.max(maxCombo, combo);

      const mult = comboMultiplier();
      const comboBonus = Math.round((basePts + timePts) * (mult-1));
      comboBonusSum += comboBonus;

      score += basePts + timePts + comboBonus;
      correctCount++;

      sparkBurst(innerWidth/2, innerHeight*0.35, 0.9);

      q++;
      if(q>=QUESTIONS.length) showEnd(true);
      else startRound();
    }else{
      fail("wrong");
    }
  },500);
}

/* fail */
function fail(reason){
  lives--;

  if(combo>0) combo=0;
  updateComboUI();

  const penalty = WRONG_PENALTY;
  penaltySum += penalty;
  score = Math.max(0, score - penalty);

  waterFailSound();
  waterFX(true);
  cameraShake();
  FROG.classList.add("sink");

  document.querySelectorAll(".platform").forEach(p=>{
    p.classList.add("fade","wrong","wobble");
    setTimeout(()=>p.classList.remove("wobble"), 900);
  });

  setTimeout(()=>{ lives<=0 ? showEnd(false) : startRound(); },900);
}

/* round */
function startRound(){
  locked=false;
  render();
  startTimer();
}

/* table fill */
function fillLevelTable(){
  const done = Math.min(q, QUESTIONS.length);
  STAT_Q.textContent = `${done}/${QUESTIONS.length}`;
  STAT_L.textContent = "‚ù§Ô∏è" + lives;
  STAT_B.textContent = "‚≠ê " + baseSum;
  STAT_T.textContent = "‚≠ê " + timeBonusSum;
  STAT_C.textContent = "‚≠ê " + comboBonusSum;
  STAT_P.textContent = "‚≠ê " + penaltySum;
  FINAL_SCORE.textContent="‚≠ê Score: "+score;
}

/* grand push */
function pushLevelToGrand(){
  grandScore += score;
  grandBase  += baseSum;
  grandTime  += timeBonusSum;
  grandCombo += comboBonusSum;
  grandPenalty += penaltySum;
  grandDone += Math.min(q, QUESTIONS.length);
}

/* total results */
function showTotalResults(){
  LEVEL_BANNER.textContent = "TOTAL RESULTS";
  LEVEL_NAME.textContent = "Game Completed";
  HINT_LINE.textContent = "";

  END_TEXT.textContent = "GAME COMPLETED!";
  END_TEXT.className = "win";

  STAT_Q.textContent = `${grandDone}/${grandTotal}`;
  STAT_L.textContent = "‚ù§Ô∏è" + lives;
  STAT_B.textContent = "‚≠ê " + grandBase;
  STAT_T.textContent = "‚≠ê " + grandTime;
  STAT_C.textContent = "‚≠ê " + grandCombo;
  STAT_P.textContent = "‚≠ê " + grandPenalty;
  FINAL_SCORE.textContent = "‚≠ê Score: " + grandScore;

  NEXT_LEVEL.style.display="none";
  FINISH.textContent = "üè† Back to Menu";

  playTotalSound();

  if(CFG.winFX==="confetti" || CFG.winFX==="both") confettiBurst(1.8);
  if(CFG.winFX==="sparks" || CFG.winFX==="both") sparkBurst(innerWidth/2, innerHeight*0.22, 1.7);
  setTimeout(()=>{ if(CFG.winFX==="confetti" || CFG.winFX==="both") confettiBurst(1.4); }, 220);
  setTimeout(()=>{ if(CFG.winFX==="sparks" || CFG.winFX==="both") sparkBurst(innerWidth/2, innerHeight*0.30, 1.8); }, 340);
  setTimeout(()=>{ if(CFG.winFX==="sparks" || CFG.winFX==="both") sparkBurst(innerWidth/2, innerHeight*0.38, 1.4); }, 560);
}

/* end */
function showEnd(win){
  clearInterval(timer);
  END.classList.add("show");

  const lvlName = (LEVELS[levelIndex]?.name) || `Level ${levelIndex+1}`;
  LEVEL_NAME.textContent = campaignMode ? `${lvlName} (Campaign)` : lvlName;

  finishStage=0;
  FINISH.textContent=CFG.texts.btnFinish || "üèÅ Finish";

  const last = (levelIndex >= LEVELS.length-1);

  if(win){
    END_TEXT.textContent=CFG.texts.win || "CONGRATULATIONS!";
    END_TEXT.className="win";
    LEVEL_BANNER.textContent="LEVEL COMPLETE";

    playWinSound();

    if(CFG.winFX==="confetti" || CFG.winFX==="both") confettiBurst(1.2);
    if(CFG.winFX==="sparks" || CFG.winFX==="both") sparkBurst(innerWidth/2, innerHeight*0.22, 1.2);

    if(campaignMode && last){
      campaignCompleted=true;
      HINT_LINE.textContent = "All levels cleared ‚Äî press Finish to see Total Results";
      NEXT_LEVEL.style.display="none";
    }else{
      campaignCompleted=false;
      HINT_LINE.textContent = "";
      NEXT_LEVEL.style.display = (last ? "none" : "inline-block");
    }
  }else{
    END_TEXT.textContent=CFG.texts.lose || "YOU LOST!";
    END_TEXT.className="lose";
    LEVEL_BANNER.textContent="TRY AGAIN";
    HINT_LINE.textContent="";
    campaignCompleted=false;
    NEXT_LEVEL.style.display="none";
    loseFinalSound();
  }

  fillLevelTable();
}

/* reset */
function resetState(){
  q=0; lives=LIVES_START; score=0; started=false; locked=false;
  baseSum=0; timeBonusSum=0; comboBonusSum=0; penaltySum=0;
  correctCount=0; combo=0; maxCombo=0;
  clearInterval(timer);
  END.classList.remove("show");
  END_TEXT.className="";
  COMBO_UI.classList.remove("show","pulse");
  T.classList.remove("danger");

  finishStage=0;
  campaignCompleted=false;
  HINT_LINE.textContent="";
  FINISH.textContent=CFG.texts.btnFinish || "üèÅ Finish";

  T.textContent=fmt(getRoundTime());
}

/* start level */
function startLevel(idx){
  levelIndex = Math.max(0, Math.min(LEVELS.length-1, idx));
  buildQuestionsForLevel(levelIndex);

  resetState();
  START_SCREEN.style.display="none";
  started=true;

  render();
  startRound();
}

/* start campaign */
function startCampaign(){
  campaignMode=true;
  levelIndex=0;

  grandScore=0; grandBase=0; grandTime=0; grandCombo=0; grandPenalty=0;
  grandDone=0;
  grandTotal = totalQuestionsInAllLevels();

  startLevel(0);
}

/* EVENTS */
DIFF.onchange=()=>{
  diffKey = DIFF.value || "classic";
  if(!started){
    correctCount=0;
    T.textContent = fmt(getRoundTime());
  }
};

START_BTN.onclick=()=>{
  ctx.resume();
  const v = (LEVEL.value||"all");
  if(v==="all") startCampaign();
  else{
    campaignMode=false;
    grandScore=grandBase=grandTime=grandCombo=grandPenalty=grandDone=0;
    grandTotal=0;
    startLevel(parseInt(v,10)||0);
  }
};

RETRY.onclick=()=>{
  resetState();
  campaignMode=false;
  START_SCREEN.style.display="flex";
  render();
};

NEXT_LEVEL.onclick=()=>{
  ctx.resume();
  if(campaignMode) pushLevelToGrand();
  const next = levelIndex+1;
  if(next >= LEVELS.length) return;
  startLevel(next);
};

FINISH.onclick=()=>{
  ctx.resume();

  if(campaignMode && campaignCompleted && finishStage===0){
    pushLevelToGrand();
    finishStage=1;
    showTotalResults();
    return;
  }

  resetState();
  campaignMode=false;
  START_SCREEN.style.display="flex";
  render();
};

window.addEventListener("resize", ()=>{
  if(started && !END.classList.contains("show")) render();
});

/* INIT: build mode select options dynamically */
(function initMenu(){
  const sel = document.getElementById("LEVEL");
  // keep first option (all)
  while(sel.options.length>1) sel.remove(1);
  for(let i=0;i<LEVELS.length;i++){
    const opt=document.createElement("option");
    opt.value=String(i);
    opt.textContent=`Level ${i+1}`;
    sel.appendChild(opt);
  }
  diffKey = DIFF.value || "classic";
  T.textContent = fmt(getRoundTime());
  render();
})();
${jsEnd}
</body>
</html>`;

  // IMPORTANT: prevent breaking the editor generator
  return html;
}

/* ===== PREVIEW + COPY ===== */
let updTimer;
function upd(){
  clearTimeout(updTimer);
  updTimer=setTimeout(updatePreview,250);
}

function updatePreview(){
  const html=getGameHTML();
  const f=document.getElementById('previewFrame');
  f.srcdoc=html;
  f.onload=()=>{
    try{ f.contentWindow.postMessage(viewMode,'*'); }catch(e){}
  };
}

function toggleView(m){
  viewMode=m;
  document.getElementById('btnRules').classList.toggle('active',m==='rules');
  document.getElementById('btnGame').classList.toggle('active',m==='game');
  try{ document.getElementById('previewFrame').contentWindow.postMessage(m,'*'); }catch(e){}
}

function generateCode(){
  const srcdoc=getGameHTML();
  const iframeCode = `<iframe style="width:100%;height:100%;border:0" srcdoc='${escapeForSingleQuotedAttr(srcdoc)}'></iframe>`;
  document.getElementById('finalCode').value = iframeCode;
  document.getElementById('COPY_MODAL').style.display='flex';
}

/* Preview switching: menu/game */
window.addEventListener('message', (e)=>{});

/* INIT */
renderLevels();
updatePreview();
</script>

</body>
</html><!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Leap & Learn Editor ‚Äî Restored Game</title>
<style>
  :root { --primary: #7cf9ff; --dark: #0a1730; --panel: #142342; --text: #eaf6ff; --accent: #4dff88; }
  body { margin:0; display:flex; height:100vh; background: #050b1a; color: var(--text); font-family: 'Segoe UI', sans-serif; overflow:hidden; }

  /* SIDEBAR */
  #EDITOR { width: 460px; background: var(--dark); border-right: 1px solid #333; display:flex; flex-direction:column; z-index:10; box-shadow: 4px 0 15px rgba(0,0,0,0.3); }
  #EDITOR_HEADER { padding:15px; background:var(--panel); border-bottom:1px solid #333; display:flex; align-items:center; justify-content:space-between; }
  #EDITOR_HEADER h2 { margin:0; font-size:18px; color:var(--primary); }

  #TABS { display:flex; background:#000; flex-wrap:wrap; }
  .tab { flex:1; min-width:60px; padding:10px 5px; text-align:center; cursor:pointer; background:#111; color:#777; border-bottom:3px solid transparent; font-size:11px; font-weight:bold; transition:0.2s; }
  .tab:hover { color:#fff; background:#1a1a1a; }
  .tab.active { background:var(--panel); color:var(--primary); border-bottom:3px solid var(--primary); }

  #CONTROLS { flex:1; overflow-y:auto; padding:20px; }

  /* FORM ELEMENTS */
  .group { margin-bottom:25px; border-bottom:1px solid #222; padding-bottom:20px; }
  .group h3 { margin:0 0 15px; font-size:13px; color:var(--primary); text-transform:uppercase; letter-spacing:1px; opacity:0.8; }

  label { display:block; font-size:11px; margin-bottom:4px; margin-top:10px; color:#ccc; font-weight:600; }
  input[type="text"], input[type="number"], select, textarea {
    width:100%; box-sizing:border-box; padding:8px; background:#080f20; border:1px solid #333; color:#fff; border-radius:4px; font-size:12px;
  }
  input[type="color"] { width:100%; height:30px; border:none; background:none; cursor:pointer; padding:0; }

  .row { display:flex; gap:10px; align-items: flex-end; }
  .col { flex:1; }

  /* BULK EDITOR */
  .level-item { background:rgba(255,255,255,0.03); border:1px solid #333; margin-bottom:10px; border-radius:6px; overflow:hidden; }
  .level-header { padding:10px; background:rgba(255,255,255,0.05); cursor:pointer; font-weight:bold; display:flex; justify-content:space-between; align-items:center; font-size:13px; }
  .level-content { padding:10px; display:none; border-top:1px solid #333; }
  .level-content.show { display:block; }
  .bulk-container { display:flex; gap:10px; height:180px; }
  .bulk-col { flex:1; display:flex; flex-direction:column; }
  .bulk-area { flex:1; resize:none; font-family: monospace; font-size:11px; white-space:pre; background:#050a15; border:1px solid #444; color:#aaddff; padding:5px; }

  /* BUTTONS */
  .btn { width:100%; padding:12px; cursor:pointer; background:var(--primary); color:#000; font-weight:bold; border:none; border-radius:4px; margin-top:10px; }
  .btn:hover { filter:brightness(1.1); }
  .btn.danger { background:transparent; color:#ff3b3b; width:auto; padding:4px; margin:0; }

  /* PREVIEW */
  #PREVIEW_AREA { flex:1; background:#000; display:flex; flex-direction:column; }
  #PREVIEW_BAR { height:40px; background:#111; display:flex; align-items:center; justify-content:center; gap:20px; border-bottom:1px solid #333; }
  .view-btn { padding:5px 15px; border-radius:15px; background:#222; color:#888; cursor:pointer; font-size:12px; border:1px solid #333; }
  .view-btn.active { background:var(--primary); color:#000; font-weight:bold; border-color:var(--primary); }

  iframe { border:none; width:100%; flex:1; background:#0a1730; }

  /* COPY MODAL */
  #COPY_MODAL { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; display:none; align-items:center; justify-content:center; flex-direction:column; }
  #COPY_MODAL textarea { width:min(900px, 90vw); height:min(420px, 60vh); margin-bottom:15px; }
  .hint { font-size:11px; color:#9fb2d8; max-width:min(900px, 90vw); text-align:center; margin:0 0 10px; }
</style>
</head>
<body>

<div id="EDITOR">
  <div id="EDITOR_HEADER"><h2>üê∏ Leap & Learn Editor</h2></div>
  <div id="TABS">
    <div class="tab active" onclick="setTab('visuals')">–í–ò–ó–£–ê–õ</div>
    <div class="tab" onclick="setTab('fonts')">–®–†–ò–§–¢–´</div>
    <div class="tab" onclick="setTab('texts')">–¢–ï–ö–°–¢–´</div>
    <div class="tab" onclick="setTab('gameplay')">–ì–ï–ô–ú–ü–õ–ï–ô</div>
    <div class="tab" onclick="setTab('levels')">–£–†–û–í–ù–ò</div>
  </div>

  <div id="CONTROLS">
    <!-- VISUALS TAB -->
    <div id="tab-visuals">
      <div class="group">
        <h3>üé® –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –°—Ü–µ–Ω—ã</h3>
        <label>–õ–æ–∫–∞—Ü–∏—è</label>
        <select id="bgSelect" onchange="toggleCustom('bgSelect','bgCustom'); updatePreview()">
          <option value="river">–†–µ–∫–∞</option>
          <option value="lava">–õ–∞–≤–∞</option>
          <option value="swamp">–ë–æ–ª–æ—Ç–æ</option>
          <option value="custom">–°–≤–æ—è —Å—Å—ã–ª–∫–∞...</option>
        </select>
        <input type="text" id="bgCustom" style="display:none;margin-top:5px" oninput="updatePreview()" placeholder="https://...">

        <label>–ü–µ—Ä—Å–æ–Ω–∞–∂</label>
        <select id="charSelect" onchange="toggleCustom('charSelect','charCustom'); updatePreview()">
          <option value="frog">–õ—è–≥—É—à–∫–∞</option>
          <option value="chameleon">–•–∞–º–µ–ª–µ–æ–Ω</option>
          <option value="lizard">–Ø—â–µ—Ä–∏—Ü–∞</option>
          <option value="custom">–°–≤–æ—è —Å—Å—ã–ª–∫–∞...</option>
        </select>
        <input type="text" id="charCustom" style="display:none;margin-top:5px" oninput="updatePreview()" placeholder="https://...">

        <label>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
        <select id="platSelect" onchange="toggleCustom('platSelect','platCustom'); updatePreview()">
          <option value="lily">–õ–∏–ª–∏—è</option>
          <option value="stone">–ö–∞–º–µ–Ω—å</option>
          <option value="mound">–ö–æ—á–∫–∞</option>
          <option value="custom">–°–≤–æ—è —Å—Å—ã–ª–∫–∞...</option>
        </select>
        <input type="text" id="platCustom" style="display:none;margin-top:5px" oninput="updatePreview()" placeholder="https://...">
      </div>

      <div class="group">
        <h3>‚ú® –¶–≤–µ—Ç–∞ (–∫–∞–∫ –≤ –∏—Å—Ö–æ–¥–Ω–æ–π –∏–≥—Ä–µ)</h3>
        <label>–ù–µ–æ–Ω (main)</label>
        <input type="color" id="colNeon" value="#7cf9ff" oninput="updatePreview()">
        <div class="row">
          <div class="col">
            <label>Danger</label>
            <input type="color" id="colDanger" value="#ff3b3b" oninput="updatePreview()">
          </div>
          <div class="col">
            <label>Win</label>
            <input type="color" id="colWin" value="#ffe44d" oninput="updatePreview()">
          </div>
        </div>

        <label>–ù–µ–æ–Ω–æ–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ (glow)</label>
        <select id="neonGlow" onchange="updatePreview()">
          <option value="on" selected>–í–∫–ª—é—á–µ–Ω–æ</option>
          <option value="off">–í—ã–∫–ª—é—á–µ–Ω–æ</option>
        </select>

        <label>–§–∏–Ω–∞–ª—å–Ω—ã–π —Å–∞–ª—é—Ç</label>
        <select id="winFX" onchange="updatePreview()">
          <option value="confetti">–ö–æ–Ω—Ñ–µ—Ç—Ç–∏ (–†–∞–∑–Ω–æ—Ü–≤–µ—Ç–Ω—ã–µ)</option>
          <option value="sparks">–ò—Å–∫—Ä—ã (–ó–æ–ª–æ—Ç—ã–µ)</option>
          <option value="both" selected>–ö–æ–Ω—Ñ–µ—Ç—Ç–∏ + –ò—Å–∫—Ä—ã</option>
        </select>
      </div>

      <div class="group">
        <h3>üè† –≠–∫—Ä–∞–Ω –ü—Ä–∞–≤–∏–ª</h3>
        <label>–¶–≤–µ—Ç –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è —Ñ–æ–Ω–∞</label>
        <div class="row">
           <input type="color" id="colOverlay" value="#081022" oninput="updatePreview()">
           <input type="number" id="opOverlay" value="92" min="0" max="100" style="width:60px" oninput="updatePreview()" title="% –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏">
        </div>
      </div>
    </div>

    <!-- FONTS TAB -->
    <div id="tab-fonts" style="display:none">
      <div class="group">
        <h3>‚ùì –í–æ–ø—Ä–æ—Å</h3>
        <div class="row">
          <div class="col"><label>–¶–≤–µ—Ç</label><input type="color" id="qCol" value="#000000" oninput="updatePreview()"></div>
          <div class="col"><label>–†–∞–∑–º–µ—Ä</label><input type="number" id="qSize" value="26" oninput="updatePreview()"></div>
        </div>
        <label>–®—Ä–∏—Ñ—Ç</label>
        <select id="qFont" onchange="updatePreview()">
           <option value="Arial, sans-serif" selected>Arial</option>
           <option value="'Courier New', monospace">Courier New</option>
           <option value="'Verdana', sans-serif">Verdana</option>
           <option value="'Comic Sans MS', cursive">Comic Sans</option>
        </select>
      </div>

      <div class="group">
        <h3>üçÄ –û—Ç–≤–µ—Ç—ã (–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ)</h3>
        <div class="row">
          <div class="col"><label>–¶–≤–µ—Ç</label><input type="color" id="ansCol" value="#141414" oninput="updatePreview()"></div>
          <div class="col"><label>–†–∞–∑–º–µ—Ä</label><input type="number" id="ansSize" value="18" oninput="updatePreview()"></div>
        </div>
      </div>

      <div class="group">
        <h3>‚è±Ô∏è –¢–∞–π–º–µ—Ä</h3>
        <div class="row">
          <div class="col"><label>–¶–≤–µ—Ç —Ü–∏—Ñ—Ä</label><input type="color" id="timeCol" value="#053149" oninput="updatePreview()"></div>
          <div class="col"><label>–†–∞–∑–º–µ—Ä</label><input type="number" id="timeSize" value="20" oninput="updatePreview()"></div>
        </div>
      </div>
    </div>

    <!-- TEXTS TAB -->
    <div id="tab-texts" style="display:none">
      <div class="group">
        <h3>–ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</h3>
        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä—ã</label><input type="text" id="txtTitle" value="Leap & Learn" oninput="updatePreview()">
        <label>–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label><input type="text" id="txtSub" value="Fast quiz game ‚Ä¢ platforms, combos and speed" oninput="updatePreview()">
        <label>–¢–µ–∫—Å—Ç –ø—Ä–∞–≤–∏–ª (—Å–ø–∏—Å–æ–∫, HTML –º–æ–∂–Ω–æ)</label>
        <textarea id="txtRules" oninput="updatePreview()" rows="4"><li>Pick the correct answer ‚Äî move forward.</li><li>Timer difficulty: <b>10s ‚Üí 7s ‚Üí 5s</b>.</li><li>Combos increase your score; a mistake breaks the combo.</li></textarea>
        <label>–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –°—Ç–∞—Ä—Ç</label><input type="text" id="btnStartTxt" value="‚ñ∂ START" oninput="updatePreview()">
      </div>

      <div class="group">
        <h3>–§–∏–Ω–∞–ª</h3>
        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ü–æ–±–µ–¥—ã</label><input type="text" id="txtWin" value="CONGRATULATIONS!" oninput="updatePreview()">
        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ü—Ä–æ–∏–≥—Ä—ã—à–∞</label><input type="text" id="txtLose" value="YOU LOST!" oninput="updatePreview()">
        <label>–ö–Ω–æ–ø–∫–∞ –î–∞–ª–µ–µ</label><input type="text" id="btnNextTxt" value="‚è≠ Next Level" oninput="updatePreview()">
        <label>–ö–Ω–æ–ø–∫–∞ Finish</label><input type="text" id="btnFinishTxt" value="üèÅ Finish" oninput="updatePreview()">
        <label>–ö–Ω–æ–ø–∫–∞ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</label><input type="text" id="btnRetryTxt" value="üîÅ Play again" oninput="updatePreview()">
      </div>
    </div>

    <!-- GAMEPLAY TAB -->
    <div id="tab-gameplay" style="display:none">
      <div class="group">
        <h3>‚è±Ô∏è –¢–∞–π–º–µ—Ä (–∫–∞–∫ –≤ –∏—Å—Ö–æ–¥–Ω–æ–π –∏–≥—Ä–µ)</h3>
        <div class="row">
          <div class="col"><label>t1 (–ø–µ—Ä–≤—ã–µ 3 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö)</label><input type="number" id="t1" value="10" oninput="updatePreview()"></div>
          <div class="col"><label>t2 (—Å 4 –ø–æ 6)</label><input type="number" id="t2" value="7" oninput="updatePreview()"></div>
          <div class="col"><label>t3 (–ø–æ—Å–ª–µ 6)</label><input type="number" id="t3" value="5" oninput="updatePreview()"></div>
        </div>
      </div>

      <div class="group">
        <h3>üîä –ó–≤—É–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</h3>
        <p style="font-size:10px;color:#888;margin:0 0 8px">–ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º ‚Äî –±—É–¥—É—Ç —Å–∏–Ω—Ç-–∑–≤—É–∫–∏ –∫–∞–∫ –≤ —Ç–≤–æ—ë–º –∏—Å—Ö–æ–¥–Ω–æ–º –∫–æ–¥–µ.</p>
        <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (URL .mp3/.wav)</label><input type="text" id="audOk" oninput="updatePreview()">
        <label>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (URL .mp3/.wav)</label><input type="text" id="audWrong" oninput="updatePreview()">
        <label>–§–∏–Ω–∞–ª: –ü–æ–±–µ–¥–∞ (URL)</label><input type="text" id="audFinalWin" oninput="updatePreview()">
        <label>–§–∏–Ω–∞–ª: –ü—Ä–æ–∏–≥—Ä—ã—à (URL)</label><input type="text" id="audFinalLose" oninput="updatePreview()">
      </div>
    </div>

    <!-- LEVELS TAB -->
    <div id="tab-levels" style="display:none">
      <div id="levelsContainer"></div>
      <button class="btn" style="background:#333; color:#fff; border:1px dashed #555" onclick="addLevel()">+ –î–û–ë–ê–í–ò–¢–¨ –£–†–û–í–ï–ù–¨</button>
      <p style="font-size:10px;color:#8ea3cd;line-height:1.35;margin:10px 0 0">
        –í–û–ü–†–û–°–´: –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ = 1 –≤–æ–ø—Ä–æ—Å.<br>
        –û–¢–í–ï–¢–´: —Å—Ç—Ä–æ–∫–∞ –∫ —Å—Ç—Ä–æ–∫–µ, —Ñ–æ—Ä–º–∞—Ç: <b>–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π | –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π | –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π</b>
      </p>
    </div>

    <br>
    <button class="btn" style="background:var(--accent); padding:16px;" onclick="generateCode()">üìã –ö–û–ü–ò–†–û–í–ê–¢–¨ IFRAME –î–õ–Ø GENIALLY</button>
  </div>
</div>

<div id="PREVIEW_AREA">
  <div id="PREVIEW_BAR">
    <div class="view-btn active" id="btnRules" onclick="toggleView('rules')">üëÅÔ∏è –ú–µ–Ω—é</div>
    <div class="view-btn" id="btnGame" onclick="toggleView('game')">üéÆ –ò–≥—Ä–∞—Ç—å</div>
  </div>
  <iframe id="previewFrame" sandbox="allow-scripts"></iframe>
</div>

<div id="COPY_MODAL">
  <h2 style="color:#fff;margin:0 0 8px">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥:</h2>
  <div class="hint">–≠—Ç–æ –∫–æ–Ω–µ—á–Ω—ã–π iframe(srcdoc). –í Genially –≤—Å—Ç–∞–≤–ª—è–π —Ü–µ–ª–∏–∫–æ–º.</div>
  <textarea id="finalCode" onclick="this.select()"></textarea>
  <button class="btn" style="width:220px" onclick="document.getElementById('COPY_MODAL').style.display='none'">–ó–ê–ö–†–´–¢–¨</button>
</div>

<script>
/* ASSETS DB (—Ç–≤–æ–∏ —Å—Å—ã–ª–∫–∏) */
const ASSETS={
  bg:{
    river:"https://img.genially.com/67961b32a116fb001568a75e/c0c9010f-c3dd-42c1-b7c1-65024fa3aec6.png",
    lava:"https://img.genially.com/67961b32a116fb001568a75e/fa2ab459-fec9-4ccd-97e3-254427b4ade0.png",
    swamp:"https://img.genially.com/67961b32a116fb001568a75e/02b52ad4-9d31-4b21-a305-8fec6e8a4487.png"
  },
  char:{
    frog:"https://img.genially.com/67961b32a116fb001568a75e/3074df22-5c73-4ad2-b0b2-491c6fc247f3.png",
    chameleon:"https://img.genially.com/67961b32a116fb001568a75e/74b56fcf-5354-43dd-9c9a-f50facc9a9bf.png",
    lizard:"https://img.genially.com/67961b32a116fb001568a75e/0feda2a1-485a-4654-8640-bf1adcc9f9ec.png"
  },
  plat:{
    lily:"https://img.genially.com/67961b32a116fb001568a75e/ed6c6e82-953b-43d4-947d-e46227b760f0.png",
    stone:"https://img.genially.com/67961b32a116fb001568a75e/bad37c6d-f04c-45c0-b954-807d79ec3a95.png",
    mound:"https://img.genially.com/67961b32a116fb001568a75e/c6775617-bde5-43e4-9da8-5332d928807e.png"
  }
};

let levels=[{
  name:"Level 1",
  q:"I ____ ready.\nShe ____ got a car.\nThey ____ at home.\nIt ____ cold outside.",
  a:"am | is | are\nhas | have | is have\nare | is | be\nis | are | am"
}];
let viewMode='rules';

function setTab(t){
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  event.target.classList.add('active');
  document.querySelectorAll('#CONTROLS > div').forEach(d=>d.style.display='none');
  document.getElementById('tab-'+t).style.display='block';
}
function toggleCustom(selId, inputId){
  document.getElementById(inputId).style.display = (document.getElementById(selId).value==='custom') ? 'block' : 'none';
}

function renderLevels(){
  const c=document.getElementById('levelsContainer');
  c.innerHTML='';
  levels.forEach((l,i)=>{
    const qn = l.q.split('\n').filter(x=>x.trim()).length;
    const d=document.createElement('div');
    d.className='level-item';
    d.innerHTML=`
      <div class="level-header" onclick="this.nextElementSibling.classList.toggle('show')">
        <span>${escapeHtml(l.name)} (${qn})</span>
        <button class="btn danger" onclick="event.stopPropagation();remLevel(${i})">üóëÔ∏è</button>
      </div>
      <div class="level-content">
        <label>–ò–º—è</label>
        <input value="${escapeAttr(l.name)}" oninput="levels[${i}].name=this.value;renderLevels();upd()">
        <div class="bulk-container">
          <div class="bulk-col">
            <label>–í–û–ü–†–û–°–´</label>
            <textarea class="bulk-area" oninput="levels[${i}].q=this.value;upd()">${escapeHtml(l.q)}</textarea>
          </div>
          <div class="bulk-col">
            <label>–û–¢–í–ï–¢–´ (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π | –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π | –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π)</label>
            <textarea class="bulk-area" oninput="levels[${i}].a=this.value;upd()">${escapeHtml(l.a)}</textarea>
          </div>
        </div>
      </div>
    `;
    c.appendChild(d);
  });
}
function addLevel(){
  levels.push({name:`Level ${levels.length+1}`, q:"", a:""});
  renderLevels(); upd();
}
function remLevel(i){
  if(levels.length<=1){ alert("–ù—É–∂–µ–Ω —Ö–æ—Ç—è –±—ã 1 —É—Ä–æ–≤–µ–Ω—å."); return; }
  if(confirm("–£–¥–∞–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å?")){
    levels.splice(i,1);
    renderLevels(); upd();
  }
}

/* helpers */
function escapeHtml(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function escapeAttr(s){
  return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;');
}
function toRgba(hex, alpha01){
  const h = (hex||"#000000").replace('#','').trim();
  const full = (h.length===3) ? h.split('').map(ch=>ch+ch).join('') : h;
  const r = parseInt(full.slice(0,2),16)||0;
  const g = parseInt(full.slice(2,4),16)||0;
  const b = parseInt(full.slice(4,6),16)||0;
  const a = Math.max(0, Math.min(1, alpha01));
  return `rgba(${r},${g},${b},${a})`;
}

/* PARSE bulk levels -> LEVELS structure from original game */
function parseLevels(){
  const parsed = levels.map((lvl, idx)=>{
    const qs = String(lvl.q||"").split('\n').map(s=>s.trim()).filter(Boolean);
    const as = String(lvl.a||"").split('\n').map(s=>s.trim()).filter(Boolean);

    const questions = qs.map((text, i)=>{
      const line = as[i] || "Correct | Wrong A | Wrong B";
      const parts = line.split('|').map(x=>x.trim()).filter(Boolean);
      const a1 = parts[0] ?? "Correct";
      const a2 = parts[1] ?? "Wrong A";
      const a3 = parts[2] ?? "Wrong B";
      return { text, answers:[a1,a2,a3], correct:0 };
    });

    return {
      name: (lvl.name||`Level ${idx+1}`).trim() || `Level ${idx+1}`,
      questions: questions.length ? questions : [{text:"Add questions in editor", answers:["OK","...","..."], correct:0}]
    };
  });

  return parsed.length ? parsed : [{
    name:"Level 1",
    questions:[{text:"I ____ running.", answers:["am","is","are"], correct:0}]
  }];
}

/* Escape srcdoc for single-quoted attribute */
function escapeForSingleQuotedAttr(s){
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/'/g,'&#39;');
}

/* ===== RESTORED ORIGINAL GAME TEMPLATE (with CFG bridge) ===== */
function getGameHTML(){
  const g=(id)=>document.getElementById(id).value;

  const bgSel=g('bgSelect');
  const chSel=g('charSelect');
  const plSel=g('platSelect');

  const bg = (bgSel==='custom' ? g('bgCustom') : ASSETS.bg[bgSel]) || ASSETS.bg.river;
  const ch = (chSel==='custom' ? g('charCustom') : ASSETS.char[chSel]) || ASSETS.char.frog;
  const pl = (plSel==='custom' ? g('platCustom') : ASSETS.plat[plSel]) || ASSETS.plat.lily;

  const LEVELS = parseLevels();

  const cfg = {
    assets:{ bg, hero: ch, platform: pl },
    colors:{
      neon: document.getElementById('colNeon').value,
      danger: document.getElementById('colDanger').value,
      win: document.getElementById('colWin').value,
      question: document.getElementById('qCol').value
    },
    fonts:{
      qFont: document.getElementById('qFont').value,
      qSize: parseInt(document.getElementById('qSize').value,10)||26,
      ansColor: document.getElementById('ansCol').value,
      ansSize: parseInt(document.getElementById('ansSize').value,10)||18,
      timeColor: document.getElementById('timeCol').value,
      timeSize: parseInt(document.getElementById('timeSize').value,10)||20
    },
    overlay:{
      color: document.getElementById('colOverlay').value,
      op: Math.max(0, Math.min(100, parseInt(document.getElementById('opOverlay').value,10)||92))
    },
    neonGlow: (document.getElementById('neonGlow').value || 'on') === 'on',
    timers:{
      t1: Math.max(3, parseInt(document.getElementById('t1').value,10)||10),
      t2: Math.max(2, parseInt(document.getElementById('t2').value,10)||7),
      t3: Math.max(1, parseInt(document.getElementById('t3').value,10)||5),
    },
    texts:{
      title: document.getElementById('txtTitle').value || "Leap & Learn",
      sub: document.getElementById('txtSub').value || "",
      rules: document.getElementById('txtRules').value || "",
      btnStart: document.getElementById('btnStartTxt').value || "‚ñ∂ START",
      win: document.getElementById('txtWin').value || "CONGRATULATIONS!",
      lose: document.getElementById('txtLose').value || "YOU LOST!",
      btnNext: document.getElementById('btnNextTxt').value || "‚è≠ Next Level",
      btnFinish: document.getElementById('btnFinishTxt').value || "üèÅ Finish",
      btnRetry: document.getElementById('btnRetryTxt').value || "üîÅ Play again"
    },
    sounds:{
      ok: (document.getElementById('audOk').value||"").trim(),
      wrong: (document.getElementById('audWrong').value||"").trim(),
      finalWin: (document.getElementById('audFinalWin').value||"").trim(),
      finalLose: (document.getElementById('audFinalLose').value||"").trim()
    },
    winFX: document.getElementById('winFX').value || "both",
    levels: LEVELS
  };

  const overlayRgba = toRgba(cfg.overlay.color, cfg.overlay.op/100);

  // IMPORTANT: we must avoid literal </script> in a template string
  const jsStart = "<script>";
  const jsEnd = "</script>";

  const html = `<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Leap & Learn</title>

<style>
:root{
  --neon-main:${cfg.colors.neon};
  --danger:${cfg.colors.danger};
  --win:${cfg.colors.win};
}
html,body{margin:0;width:100%;height:100%;overflow:hidden;font-family:Arial;background:#0a1730}

/* GAME */
#GAME{position:relative;width:100%;height:100%}
#GAME.shake{animation:shake .25s}
@keyframes shake{
  0%{transform:translate(0)}
  25%{transform:translate(-4px,3px)}
  50%{transform:translate(4px,-3px)}
  75%{transform:translate(-3px,2px)}
  100%{transform:translate(0)}
}

/* BACKGROUND */
#BG{position:absolute;inset:0;z-index:0;background:url("${cfg.assets.bg}") center/cover no-repeat}

/* UI */
#QUESTION{
  position:absolute;top:26px;width:100%;text-align:center;
  font-size:${cfg.fonts.qSize}px;z-index:20;
  color:${cfg.colors.question};
  text-shadow:0 2px 0 rgba(0,0,0,.35);
  font-family:${cfg.fonts.qFont};
}
#TIMER{
  position:absolute;top:70px;left:50%;transform:translateX(-50%);
  width:80px;height:80px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  background:#fff;border:2px solid var(--neon-main);
  box-shadow:${cfg.neonGlow ? "0 0 18px var(--neon-main)" : "none"};
  z-index:20;font-weight:900;
  color:${cfg.fonts.timeColor};
  font-size:${cfg.fonts.timeSize}px;
}
#TIMER.danger{
  border-color:var(--danger);color:var(--danger);
  box-shadow:${cfg.neonGlow ? "0 0 25px var(--danger)" : "none"};
  animation:pulse .8s infinite;
}
@keyframes pulse{50%{transform:translateX(-50%) scale(1.12)}}
#LIVES{position:absolute;top:30px;right:30px;font-size:26px;z-index:20}
#SCORE{position:absolute;top:30px;left:30px;font-size:20px;font-weight:900;z-index:20;color:#fff;text-shadow:0 2px 0 rgba(0,0,0,.35)}

/* COMBO */
#COMBO{
  position:absolute;top:165px;left:50%;transform:translateX(-50%);
  z-index:20;padding:10px 16px;border-radius:18px;
  background:rgba(255,255,255,.88);
  border:2px solid var(--neon-main);
  box-shadow:${cfg.neonGlow ? "0 0 18px rgba(124,249,255,.65), inset 0 0 14px rgba(124,249,255,.25)" : "none"};
  font-weight:900;color:#043149;display:none;gap:10px;align-items:center;
}
#COMBO.show{display:inline-flex}
#COMBO_BOLT{width:18px;height:18px;border-radius:6px;background:rgba(124,249,255,.25);box-shadow:${cfg.neonGlow ? "0 0 14px rgba(124,249,255,.75)" : "none"};display:inline-block}
#COMBO.pulse{animation:comboPulse .55s ease}
@keyframes comboPulse{
  0%{transform:translateX(-50%) scale(1)}
  40%{transform:translateX(-50%) scale(1.12)}
  100%{transform:translateX(-50%) scale(1)}
}

/* BUTTONS */
.btn{
  padding:12px 34px;border-radius:16px;font-weight:900;
  background:#fff;border:2px solid var(--neon-main);
  box-shadow:${cfg.neonGlow ? "0 0 15px var(--neon-main)" : "none"};
  cursor:pointer;color:#043149;
}
.btn:active{transform:translateY(1px)}
.btn.dark{
  background:rgba(255,255,255,.10);
  color:#eaf6ff;
  border:2px solid rgba(124,249,255,.55);
  box-shadow:${cfg.neonGlow ? "0 0 16px rgba(124,249,255,.25)" : "none"};
}

/* START SCREEN */
#START_SCREEN{
  position:absolute;inset:0;z-index:60;
  display:flex;align-items:center;justify-content:center;
  background:${overlayRgba};
}
#START_CARD{
  width:min(760px, calc(100vw - 40px));
  border-radius:26px;
  background:linear-gradient(180deg, rgba(10,20,50,.92), rgba(5,10,25,.92));
  border:2px solid rgba(124,249,255,.75);
  box-shadow:${cfg.neonGlow ? "0 0 30px rgba(124,249,255,.55), inset 0 0 24px rgba(124,249,255,.18)" : "none"};
  padding:18px 18px 16px;
  position:relative;overflow:hidden;color:#eaf6ff;
}
#START_TOP{position:relative;display:flex;align-items:center;gap:14px;padding:6px 6px 10px}
#START_ICON{
  width:64px;height:64px;flex:0 0 auto;
  background:url("${cfg.assets.hero}") no-repeat center/contain;
  filter:${cfg.neonGlow ? "drop-shadow(0 0 14px rgba(124,249,255,.55))" : "none"};
}
#START_TITLE{font-weight:900;font-size:34px;color:#eaf6ff;text-shadow:${cfg.neonGlow ? "0 0 18px rgba(124,249,255,.55)" : "none"};margin:0;line-height:1.05}
#START_SUB{margin:2px 0 0;color:#bfe9ff;opacity:.9;font-weight:700}
.panel{
  background:rgba(255,255,255,.08);
  border:1px solid rgba(124,249,255,.35);
  border-radius:18px;
  box-shadow:${cfg.neonGlow ? "0 0 12px rgba(124,249,255,.18)" : "none"};
  padding:12px 12px 10px;margin-top:10px;
}
.panel h3{margin:0 0 8px;font-size:14px;letter-spacing:.08em;text-transform:uppercase;opacity:.9;color:#eaf6ff}
.rules{margin:0;color:#cfefff;font-weight:700;line-height:1.35;font-size:14px}
.rules li{margin:6px 0}
#START_BOTTOM{position:relative;display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px;flex-wrap:wrap}
.badge{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 12px;border-radius:16px;
  border:1px solid rgba(124,249,255,.35);
  box-shadow:${cfg.neonGlow ? "0 0 12px rgba(124,249,255,.18)" : "none"};
  background:rgba(255,255,255,.08);
  color:#eaf6ff;font-weight:900;font-size:14px;
}
.badge small{opacity:.8;font-weight:900;color:#bfe9ff}

/* dropdowns (dark list) */
select{
  border-radius:14px;border:1px solid rgba(124,249,255,.45);
  background:rgba(255,255,255,.10);
  padding:8px 10px;font-weight:900;color:#eaf6ff;outline:none;
  box-shadow: inset 0 0 14px rgba(124,249,255,.10);
}
select option{color:#0b1630;background:#eaf6ff;font-weight:900}

/* END */
#END{
  position:absolute;inset:0;z-index:50;
  background:rgba(8,16,34,.92);
  display:none;align-items:center;justify-content:center;flex-direction:column;
}
#END.show{display:flex}
#END_TEXT{font-size:58px;font-weight:900;margin:0 0 10px;animation:sway 2.5s ease-in-out infinite;text-align:center}
.win{color:var(--win);text-shadow:${cfg.neonGlow ? "0 0 12px var(--win),0 0 34px var(--win)" : "none"}}
.lose{color:var(--danger);text-shadow:${cfg.neonGlow ? "0 0 12px var(--danger),0 0 34px var(--danger)" : "none"}}
@keyframes sway{0%{transform:rotate(0)}25%{transform:rotate(2deg)}50%{transform:rotate(0)}75%{transform:rotate(-2deg)}100%{transform:rotate(0)}}
#LEVEL_BANNER{
  margin:0 0 10px;padding:14px 18px;border-radius:20px;
  background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
  border:1px solid rgba(255,228,77,.55);
  box-shadow:${cfg.neonGlow ? "0 0 24px rgba(255,228,77,.35), inset 0 0 18px rgba(255,228,77,.12)" : "none"};
  color:#fff7cf;font-weight:900;letter-spacing:.06em;text-transform:uppercase;text-align:center;
}
#LEVEL_NAME{margin:0 0 10px;color:#bfe9ff;font-weight:900;opacity:.95;text-shadow:${cfg.neonGlow ? "0 0 12px rgba(124,249,255,.25)" : "none"}}
#HINT_LINE{margin:0 0 16px;color:#cfefff;opacity:.9;font-weight:900;text-align:center}

/* SCORECARD */
#SCORECARD{
  width:min(620px, calc(100vw - 40px));
  background:rgba(255,255,255,.10);
  border:2px solid rgba(124,249,255,.55);
  box-shadow:${cfg.neonGlow ? "0 0 22px rgba(124,249,255,.45), inset 0 0 16px rgba(124,249,255,.15)" : "none"};
  border-radius:22px;
  padding:18px 18px 14px;
  margin:6px 0 16px;
  position:relative;
  overflow:hidden;
  color:#eaf6ff;
}
#SCOREGRID{position:relative;display:grid;grid-template-columns:1fr 1fr;gap:10px 14px;align-items:stretch}
.row{
  display:flex;align-items:center;justify-content:space-between;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(124,249,255,.35);
  border-radius:16px;padding:12px 14px;
  box-shadow:${cfg.neonGlow ? "0 0 10px rgba(124,249,255,.18)" : "none"};
}
.label{font-size:13px;letter-spacing:.08em;text-transform:uppercase;opacity:.9}
.value{font-size:22px;font-weight:900;text-shadow:${cfg.neonGlow ? "0 0 12px rgba(124,249,255,.25)" : "none"}}
#FINAL_LINE{
  position:relative;margin-top:12px;
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px;border-radius:18px;
  background:rgba(255,255,255,.10);
  border:2px solid rgba(124,249,255,.55);
  box-shadow:${cfg.neonGlow ? "0 0 18px rgba(124,249,255,.35), inset 0 0 14px rgba(124,249,255,.12)" : "none"};
}
#FINAL_LABEL{font-weight:900;font-size:13px;letter-spacing:.08em;text-transform:uppercase;opacity:.95}
#FINAL_SCORE{font-weight:900;font-size:30px;text-shadow:${cfg.neonGlow ? "0 0 16px rgba(124,249,255,.35)" : "none"}}
#END_BTNS{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}

/* PLAYER */
#FROG{
  position:absolute;left:160px;top:50%;
  width:110px;height:110px;
  background:url("${cfg.assets.hero}") no-repeat center/contain;
  transform:translate(-50%,-65%);
  z-index:15;
  transition:transform .6s ease,opacity .6s ease;
  pointer-events:none;
}
#FROG.jump{transform:translate(-50%,-95%) scale(1.05)}
#FROG.sink{transform:translate(-50%,-10%) scale(.6);opacity:0}

/* PLATFORMS */
#PLATFORMS{position:absolute;inset:0;z-index:10}
.platform{position:absolute;width:150px;height:150px;transition:transform .5s,opacity .6s}
.lily{
  width:150px;height:150px;
  background:url("${cfg.assets.platform}") no-repeat center/contain;
  display:flex;align-items:center;justify-content:center;
  font-weight:900;
  color:${cfg.fonts.ansColor};
  font-size:${cfg.fonts.ansSize}px;
  text-shadow:0 2px 0 rgba(255,255,255,.65), 0 0 10px rgba(0,0,0,.35);
  animation:float 3.5s ease-in-out infinite;
  transition:transform .5s, filter .2s;
}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(6px)}}
.platform.answer{cursor:pointer}
.platform.fade{opacity:0}
.platform.fade .lily{transform:scale(.6)}
.platform.wrong .lily{filter:drop-shadow(0 0 18px red)}
@keyframes wobble{
  0%{transform:translateY(0) rotate(0deg)}
  25%{transform:translateY(1px) rotate(-3deg)}
  50%{transform:translateY(0) rotate(3deg)}
  75%{transform:translateY(1px) rotate(-2deg)}
  100%{transform:translateY(0) rotate(0deg)}
}
.platform.wobble .lily{
  animation:float 3.5s ease-in-out infinite, wobble .35s ease-in-out 0s 3;
}

/* FX ABOVE ALL */
#FX{position:absolute;inset:0;pointer-events:none;z-index:200}

/* waves + bubbles */
.splash{position:absolute;width:90px;height:34px;background:rgba(255,255,255,.92);border-radius:50%;animation:splash .45s forwards;filter:drop-shadow(0 0 10px rgba(255,255,255,.25))}
@keyframes splash{to{transform:scale(2.2);opacity:0}}
.ripple{position:absolute;border:3px solid rgba(255,255,255,.92);border-radius:50%;animation:ripple 1.45s forwards;filter:drop-shadow(0 0 10px rgba(255,255,255,.15))}
@keyframes ripple{to{transform:scale(2.2);opacity:0}}
.bubble{position:absolute;border-radius:50%;background:rgba(255,255,255,.88);animation:bubble 1.7s forwards;filter:drop-shadow(0 0 10px rgba(255,255,255,.15))}
@keyframes bubble{to{transform:translate(var(--dx),var(--dy));opacity:0}}

/* confetti + sparks */
.confetti{position:absolute;width:10px;height:14px;border-radius:4px;opacity:.95;animation:confFall 2.25s ease-in forwards;filter:drop-shadow(0 0 12px rgba(124,249,255,.55))}
@keyframes confFall{
  0%{transform:translate3d(0,0,0) rotate(0deg);opacity:1}
  100%{transform:translate3d(var(--dx), calc(100vh + 140px), 0) rotate(720deg);opacity:0}
}
.spark{
  position:absolute;width:8px;height:8px;border-radius:50%;
  background:rgba(255,255,255,.95);
  box-shadow:0 0 22px rgba(124,249,255,.95);
  animation:spark 760ms ease-out forwards;
}
@keyframes spark{
  0%{transform:translate(0,0) scale(1);opacity:1}
  100%{transform:translate(var(--dx),var(--dy)) scale(.25);opacity:0}
}
</style>
</head>

<body>
<div id="GAME">
  <div id="BG"></div>

  <div id="SCORE">‚≠ê 0</div>
  <div id="QUESTION"></div>
  <div id="TIMER">00:10</div>
  <div id="COMBO"><span id="COMBO_BOLT"></span><span id="COMBO_TXT">COMBO x1.0</span></div>
  <div id="LIVES"></div>

  <!-- START SCREEN -->
  <div id="START_SCREEN">
    <div id="START_CARD">
      <div id="START_TOP">
        <div id="START_ICON"></div>
        <div>
          <h1 id="START_TITLE">${escapeHtml(cfg.texts.title)}</h1>
          <div id="START_SUB">${escapeHtml(cfg.texts.sub)}</div>
        </div>
      </div>

      <div class="panel">
        <h3>How to Play</h3>
        <ul class="rules" id="RULES_LIST">${cfg.texts.rules}</ul>
      </div>

      <div id="START_BOTTOM">
        <div class="badge">
          <span>Mode:</span>
          <select id="LEVEL">
            <option value="all" selected>All Levels (1‚Üí${cfg.levels.length})</option>
          </select>
          <small>campaign or single</small>
        </div>

        <div class="badge">
          <span>Difficulty:</span>
          <select id="DIFF">
            <option value="classic" selected>Classic</option>
            <option value="easy">Easy</option>
            <option value="hard">Hard</option>
          </select>
          <small>+ combos & penalties</small>
        </div>

        <button id="START_BTN" class="btn">${escapeHtml(cfg.texts.btnStart)}</button>
      </div>
    </div>
  </div>

  <!-- END SCREEN -->
  <div id="END">
    <div id="END_TEXT"></div>
    <div id="LEVEL_BANNER">LEVEL COMPLETE</div>
    <div id="LEVEL_NAME">Level 1</div>
    <div id="HINT_LINE"></div>

    <div id="SCORECARD">
      <div id="SCOREGRID">
        <div class="row"><div class="label">Questions</div><div id="STAT_Q" class="value">0/0</div></div>
        <div class="row"><div class="label">Lives</div><div id="STAT_L" class="value">‚ù§Ô∏è0</div></div>
        <div class="row"><div class="label">Base</div><div id="STAT_B" class="value">‚≠ê 0</div></div>
        <div class="row"><div class="label">Time Bonus</div><div id="STAT_T" class="value">‚≠ê 0</div></div>
        <div class="row"><div class="label">Combo Bonus</div><div id="STAT_C" class="value">‚≠ê 0</div></div>
        <div class="row"><div class="label">Penalties</div><div id="STAT_P" class="value">‚≠ê 0</div></div>
      </div>
      <div id="FINAL_LINE">
        <div id="FINAL_LABEL">Total Score</div>
        <div id="FINAL_SCORE">‚≠ê Score: 0</div>
      </div>
    </div>

    <div id="END_BTNS">
      <button id="NEXT_LEVEL" class="btn">${escapeHtml(cfg.texts.btnNext)}</button>
      <button id="FINISH" class="btn dark">${escapeHtml(cfg.texts.btnFinish)}</button>
      <button id="RETRY" class="btn">${escapeHtml(cfg.texts.btnRetry)}</button>
    </div>
  </div>

  <div id="FX"></div>
  <div id="FROG"></div>
  <div id="PLATFORMS"></div>
</div>

${jsStart}
/* ---------------------------
   RESTORED GAME CORE (from your original)
   + CFG bridge injected by editor
---------------------------- */
const CFG = ${JSON.stringify(cfg)};
const LEVELS = (CFG.levels||[]);

/* SETTINGS (original-like) */
const BASE=100;
const MULT=10;
const WRONG_PENALTY=80;
const LIVES_START=5;

const DIFF_PRESETS={
  classic:{t1:CFG.timers.t1, t2:CFG.timers.t2, t3:CFG.timers.t3},
  easy:{t1:CFG.timers.t1+2, t2:CFG.timers.t2+2, t3:CFG.timers.t3+2},
  hard:{t1:Math.max(3,CFG.timers.t1-1), t2:Math.max(2,CFG.timers.t2-1), t3:Math.max(1,CFG.timers.t3-1)},
};

/* ELEMENTS */
const Q=QUESTION, T=TIMER, L=LIVES, S=SCORE, P=PLATFORMS;
const FX=document.getElementById("FX");
const GAME=document.getElementById("GAME");
const FROG=document.getElementById("FROG");

const START_SCREEN=document.getElementById("START_SCREEN");
const START_BTN=document.getElementById("START_BTN");
const DIFF=document.getElementById("DIFF");
const LEVEL=document.getElementById("LEVEL");

const COMBO_UI=document.getElementById("COMBO");
const COMBO_TXT=document.getElementById("COMBO_TXT");

const END=document.getElementById("END");
const END_TEXT=document.getElementById("END_TEXT");
const FINAL_SCORE=document.getElementById("FINAL_SCORE");
const RETRY=document.getElementById("RETRY");
const FINISH=document.getElementById("FINISH");
const NEXT_LEVEL=document.getElementById("NEXT_LEVEL");
const LEVEL_BANNER=document.getElementById("LEVEL_BANNER");
const LEVEL_NAME=document.getElementById("LEVEL_NAME");
const HINT_LINE=document.getElementById("HINT_LINE");

const STAT_Q=document.getElementById("STAT_Q");
const STAT_L=document.getElementById("STAT_L");
const STAT_B=document.getElementById("STAT_B");
const STAT_T=document.getElementById("STAT_T");
const STAT_C=document.getElementById("STAT_C");
const STAT_P=document.getElementById("STAT_P");

/* STATE */
let QUESTIONS=[];
let q=0, lives=LIVES_START, score=0, started=false, locked=false;
let timer=null, timeLeft=0;
let baseSum=0, timeBonusSum=0, comboBonusSum=0, penaltySum=0;
let correctCount=0, combo=0, maxCombo=0;
let diffKey="classic";

/* LEVEL / CAMPAIGN */
let levelIndex=0;
let campaignMode=false;
let campaignCompleted=false;
let finishStage=0;

/* GRAND TOTALS */
let grandScore=0, grandBase=0, grandTime=0, grandCombo=0, grandPenalty=0;
let grandDone=0, grandTotal=0;

/* AUDIO (original synth, with optional custom files) */
const ctx=new (AudioContext||webkitAudioContext)();

function playUrl(url){
  try{
    const a = new Audio(url);
    a.volume = 1;
    a.play().catch(()=>{});
  }catch(e){}
}

function okSound(){
  if(CFG.sounds.ok){ playUrl(CFG.sounds.ok); return; }
  const t=ctx.currentTime;
  [523,659,784].forEach((f,i)=>{
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.frequency.value=f;
    g.gain.setValueAtTime(0,t+i*.12);
    g.gain.linearRampToValueAtTime(.25,t+i*.12+.05);
    g.gain.exponentialRampToValueAtTime(.001,t+i*.12+.4);
    o.connect(g);g.connect(ctx.destination);
    o.start(t+i*.12);o.stop(t+i*.12+.45);
  });
}
function loseFinalSound(){
  if(CFG.sounds.finalLose){ playUrl(CFG.sounds.finalLose); return; }
  const o=ctx.createOscillator(),g=ctx.createGain();
  o.type="sawtooth";
  o.frequency.setValueAtTime(220,ctx.currentTime);
  o.frequency.exponentialRampToValueAtTime(70,ctx.currentTime+1.4);
  g.gain.setValueAtTime(.4,ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+1.4);
  o.connect(g);g.connect(ctx.destination);
  o.start();o.stop(ctx.currentTime+1.5);
}
function waterFailSound(){
  if(CFG.sounds.wrong){ playUrl(CFG.sounds.wrong); return; }
  const b=ctx.createBuffer(1,ctx.sampleRate*.9,ctx.sampleRate);
  const d=b.getChannelData(0);
  for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*(1-i/d.length);
  const s=ctx.createBufferSource(),g=ctx.createGain();
  g.gain.value=.6;
  s.buffer=b;
  s.connect(g);g.connect(ctx.destination);
  s.start();
}

/* fanfare (original-like) */
function fanfareSound(strength=1){
  if(CFG.sounds.finalWin){ playUrl(CFG.sounds.finalWin); return; }
  const t=ctx.currentTime;
  const master=ctx.createGain();
  master.gain.setValueAtTime(0.0,t);
  master.gain.linearRampToValueAtTime(0.95*strength,t+0.05);
  master.gain.exponentialRampToValueAtTime(0.001,t+2.8);
  master.connect(ctx.destination);

  function tone(freq, start, dur, type="sawtooth", gain=0.34){
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=type; o.frequency.value=freq;
    g.gain.setValueAtTime(0, t+start);
    g.gain.linearRampToValueAtTime(gain*strength, t+start+0.03);
    g.gain.exponentialRampToValueAtTime(0.001, t+start+dur);
    o.connect(g); g.connect(master);
    o.start(t+start); o.stop(t+start+dur+0.02);
  }
  const C5=523.25, E5=659.25, G5=783.99, C6=1046.5, E6=1318.5;
  [C5,E5,G5].forEach(f=>tone(f,0.00,0.70,"sawtooth",0.30));
  [E5,G5,C6].forEach(f=>tone(f,0.55,0.80,"sawtooth",0.28));
  [G5,C6,E6].forEach(f=>tone(f,1.15,1.05,"sawtooth",0.25));
  const arp=[C5,E5,G5,C6,E5,G5,C6,E6];
  arp.forEach((f,i)=>tone(f,0.15+i*0.10,0.22,"triangle",0.20));
}
function playWinSound(){ fanfareSound(1.0); }
function playTotalSound(){ fanfareSound(1.25); }

/* FX helpers (waves/bubbles + confetti/sparks) */
function waterFX(bubbles=false){
  const x=160, y=innerHeight/2+64;

  const s=document.createElement("div");
  s.className="splash";
  s.style.left=(x-45)+"px";
  s.style.top=(y-17)+"px";
  FX.appendChild(s);
  setTimeout(()=>s.remove(),520);

  for(let i=0;i<3;i++){
    const r=document.createElement("div");
    r.className="ripple";
    const size=64+i*40;
    r.style.width=r.style.height=size+"px";
    r.style.left=(x-size/2)+"px";
    r.style.top=(y-size/2)+"px";
    FX.appendChild(r);
    setTimeout(()=>r.remove(),1550);
  }

  if(bubbles){
    for(let i=0;i<20;i++){
      const b=document.createElement("div");
      b.className="bubble";
      const ss=6+Math.random()*12;
      b.style.width=b.style.height=ss+"px";
      b.style.left=(x + Math.random()*140 - 70)+"px";
      b.style.top=(y + Math.random()*34 - 17)+"px";
      b.style.setProperty("--dx",(Math.random()*140-70)+"px");
      b.style.setProperty("--dy",(-140-Math.random()*120)+"px");
      FX.appendChild(b);
      setTimeout(()=>b.remove(),1750);
    }
  }
}
function confettiBurst(power=1){
  const count=Math.floor(180*power);
  for(let i=0;i<count;i++){
    const c=document.createElement("div");
    c.className="confetti";
    const x=Math.random()*innerWidth;
    c.style.left=x+"px";
    c.style.top=(-30 - Math.random()*200)+"px";
    c.style.setProperty("--dx",(Math.random()*420-210)+"px");
    c.style.background = `hsla(${Math.random()*360}, 98%, 62%, .99)`;
    FX.appendChild(c);
    setTimeout(()=>c.remove(),2700);
  }
}
function sparkBurst(cx,cy, power=1){
  const n=Math.floor(64*power);
  for(let i=0;i<n;i++){
    const sp=document.createElement("div");
    sp.className="spark";
    sp.style.left=(cx-4)+"px";
    sp.style.top=(cy-4)+"px";
    sp.style.setProperty("--dx",(Math.random()*520-260)+"px");
    sp.style.setProperty("--dy",(Math.random()*-360-40)+"px");
    sp.style.background = `hsla(${Math.random()*360}, 98%, 72%, .99)`;
    sp.style.boxShadow = `0 0 28px hsla(${Math.random()*360}, 98%, 72%, .98)`;
    FX.appendChild(sp);
    setTimeout(()=>sp.remove(),1100);
  }
}

/* helpers */
function frogJump(){FROG.classList.add("jump");setTimeout(()=>FROG.classList.remove("jump"),300)}
function cameraShake(){GAME.classList.add("shake");setTimeout(()=>GAME.classList.remove("shake"),300)}
function fmt(s){ return "00:"+String(s).padStart(2,"0"); }

/* shuffle */
function shuffle(arr){
  const a=arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* shuffle answers & keep correct */
function randomizeQuestion(qObj){
  const packs = qObj.answers.map((txt,idx)=>({txt, idx}));
  const shuffled = shuffle(packs);
  const newAnswers = shuffled.map(x=>x.txt);
  const newCorrect = shuffled.findIndex(x=>x.idx===qObj.correct);
  return { text:qObj.text, answers:newAnswers, correct:newCorrect };
}

function totalQuestionsInAllLevels(){
  return LEVELS.reduce((s,l)=>s+(l.questions?.length||0),0);
}

/* difficulty */
function getRoundTime(){
  const d=DIFF_PRESETS[diffKey] || DIFF_PRESETS.classic;
  if(correctCount<3) return d.t1;
  if(correctCount<6) return d.t2;
  return d.t3;
}

/* combo */
function comboMultiplier(){
  const m = 1 + combo*0.12;
  return Math.min(2.0, Math.round(m*10)/10);
}
function updateComboUI(){
  if(combo<=0){
    COMBO_UI.classList.remove("show","pulse");
    return;
  }
  COMBO_UI.classList.add("show","pulse");
  setTimeout(()=>COMBO_UI.classList.remove("pulse"), 560);
  COMBO_TXT.textContent = `COMBO x${comboMultiplier().toFixed(1)}`;
}

/* timer */
function startTimer(){
  clearInterval(timer);
  timeLeft=getRoundTime();
  T.classList.remove("danger");
  T.textContent=fmt(timeLeft);

  timer=setInterval(()=>{
    timeLeft--;
    if(timeLeft<=0){ clearInterval(timer); fail("time"); return; }
    T.textContent=fmt(timeLeft);
    if(timeLeft<=3) T.classList.add("danger");
  },1000);
}

/* build questions */
function buildQuestionsForLevel(idx){
  const lvl = LEVELS[idx] || LEVELS[0];
  const randomized = (lvl.questions||[]).map(q=>randomizeQuestion(q));
  QUESTIONS = shuffle(randomized);
}

/* render */
function render(){
  locked=!started;
  P.innerHTML="";
  FROG.classList.remove("sink");

  Q.textContent=QUESTIONS[q]?.text || "";
  L.textContent="‚ù§Ô∏è".repeat(lives);
  S.textContent="‚≠ê "+score;

  updateComboUI();

  const STEP=190,y=innerHeight/2;
  const count=Math.ceil((innerWidth-160)/STEP)+4;

  for(let i=0;i<count;i++){
    const d=document.createElement("div");
    d.className="platform";
    d.style.left=160+STEP*i-75+"px";
    d.style.top=y-75+"px";

    const lily=document.createElement("div");
    lily.className="lily";

    if(i>0 && QUESTIONS[q] && i<=QUESTIONS[q].answers.length){
      lily.textContent=QUESTIONS[q].answers[i-1];
      d.classList.add("answer");
      d.onclick=()=>pick(i,d);
    }

    d.appendChild(lily);
    P.appendChild(d);
  }
}

/* pick */
function pick(i,el){
  if(!started||locked) return;
  locked=true;
  clearInterval(timer);
  frogJump();

  document.querySelectorAll(".platform")
    .forEach(p=>p.style.transform=`translateX(${-(el.offsetLeft+75-160)}px)`);

  setTimeout(()=>{
    const isCorrect = (i-1===QUESTIONS[q].correct);
    if(isCorrect){
      okSound();
      waterFX(false);

      const basePts = BASE;
      const timePts = timeLeft*MULT;

      baseSum += basePts;
      timeBonusSum += timePts;

      combo++;
      maxCombo = Math.max(maxCombo, combo);

      const mult = comboMultiplier();
      const comboBonus = Math.round((basePts + timePts) * (mult-1));
      comboBonusSum += comboBonus;

      score += basePts + timePts + comboBonus;
      correctCount++;

      sparkBurst(innerWidth/2, innerHeight*0.35, 0.9);

      q++;
      if(q>=QUESTIONS.length) showEnd(true);
      else startRound();
    }else{
      fail("wrong");
    }
  },500);
}

/* fail */
function fail(reason){
  lives--;

  if(combo>0) combo=0;
  updateComboUI();

  const penalty = WRONG_PENALTY;
  penaltySum += penalty;
  score = Math.max(0, score - penalty);

  waterFailSound();
  waterFX(true);
  cameraShake();
  FROG.classList.add("sink");

  document.querySelectorAll(".platform").forEach(p=>{
    p.classList.add("fade","wrong","wobble");
    setTimeout(()=>p.classList.remove("wobble"), 900);
  });

  setTimeout(()=>{ lives<=0 ? showEnd(false) : startRound(); },900);
}

/* round */
function startRound(){
  locked=false;
  render();
  startTimer();
}

/* table fill */
function fillLevelTable(){
  const done = Math.min(q, QUESTIONS.length);
  STAT_Q.textContent = `${done}/${QUESTIONS.length}`;
  STAT_L.textContent = "‚ù§Ô∏è" + lives;
  STAT_B.textContent = "‚≠ê " + baseSum;
  STAT_T.textContent = "‚≠ê " + timeBonusSum;
  STAT_C.textContent = "‚≠ê " + comboBonusSum;
  STAT_P.textContent = "‚≠ê " + penaltySum;
  FINAL_SCORE.textContent="‚≠ê Score: "+score;
}

/* grand push */
function pushLevelToGrand(){
  grandScore += score;
  grandBase  += baseSum;
  grandTime  += timeBonusSum;
  grandCombo += comboBonusSum;
  grandPenalty += penaltySum;
  grandDone += Math.min(q, QUESTIONS.length);
}

/* total results */
function showTotalResults(){
  LEVEL_BANNER.textContent = "TOTAL RESULTS";
  LEVEL_NAME.textContent = "Game Completed";
  HINT_LINE.textContent = "";

  END_TEXT.textContent = "GAME COMPLETED!";
  END_TEXT.className = "win";

  STAT_Q.textContent = `${grandDone}/${grandTotal}`;
  STAT_L.textContent = "‚ù§Ô∏è" + lives;
  STAT_B.textContent = "‚≠ê " + grandBase;
  STAT_T.textContent = "‚≠ê " + grandTime;
  STAT_C.textContent = "‚≠ê " + grandCombo;
  STAT_P.textContent = "‚≠ê " + grandPenalty;
  FINAL_SCORE.textContent = "‚≠ê Score: " + grandScore;

  NEXT_LEVEL.style.display="none";
  FINISH.textContent = "üè† Back to Menu";

  playTotalSound();

  if(CFG.winFX==="confetti" || CFG.winFX==="both") confettiBurst(1.8);
  if(CFG.winFX==="sparks" || CFG.winFX==="both") sparkBurst(innerWidth/2, innerHeight*0.22, 1.7);
  setTimeout(()=>{ if(CFG.winFX==="confetti" || CFG.winFX==="both") confettiBurst(1.4); }, 220);
  setTimeout(()=>{ if(CFG.winFX==="sparks" || CFG.winFX==="both") sparkBurst(innerWidth/2, innerHeight*0.30, 1.8); }, 340);
  setTimeout(()=>{ if(CFG.winFX==="sparks" || CFG.winFX==="both") sparkBurst(innerWidth/2, innerHeight*0.38, 1.4); }, 560);
}

/* end */
function showEnd(win){
  clearInterval(timer);
  END.classList.add("show");

  const lvlName = (LEVELS[levelIndex]?.name) || `Level ${levelIndex+1}`;
  LEVEL_NAME.textContent = campaignMode ? `${lvlName} (Campaign)` : lvlName;

  finishStage=0;
  FINISH.textContent=CFG.texts.btnFinish || "üèÅ Finish";

  const last = (levelIndex >= LEVELS.length-1);

  if(win){
    END_TEXT.textContent=CFG.texts.win || "CONGRATULATIONS!";
    END_TEXT.className="win";
    LEVEL_BANNER.textContent="LEVEL COMPLETE";

    playWinSound();

    if(CFG.winFX==="confetti" || CFG.winFX==="both") confettiBurst(1.2);
    if(CFG.winFX==="sparks" || CFG.winFX==="both") sparkBurst(innerWidth/2, innerHeight*0.22, 1.2);

    if(campaignMode && last){
      campaignCompleted=true;
      HINT_LINE.textContent = "All levels cleared ‚Äî press Finish to see Total Results";
      NEXT_LEVEL.style.display="none";
    }else{
      campaignCompleted=false;
      HINT_LINE.textContent = "";
      NEXT_LEVEL.style.display = (last ? "none" : "inline-block");
    }
  }else{
    END_TEXT.textContent=CFG.texts.lose || "YOU LOST!";
    END_TEXT.className="lose";
    LEVEL_BANNER.textContent="TRY AGAIN";
    HINT_LINE.textContent="";
    campaignCompleted=false;
    NEXT_LEVEL.style.display="none";
    loseFinalSound();
  }

  fillLevelTable();
}

/* reset */
function resetState(){
  q=0; lives=LIVES_START; score=0; started=false; locked=false;
  baseSum=0; timeBonusSum=0; comboBonusSum=0; penaltySum=0;
  correctCount=0; combo=0; maxCombo=0;
  clearInterval(timer);
  END.classList.remove("show");
  END_TEXT.className="";
  COMBO_UI.classList.remove("show","pulse");
  T.classList.remove("danger");

  finishStage=0;
  campaignCompleted=false;
  HINT_LINE.textContent="";
  FINISH.textContent=CFG.texts.btnFinish || "üèÅ Finish";

  T.textContent=fmt(getRoundTime());
}

/* start level */
function startLevel(idx){
  levelIndex = Math.max(0, Math.min(LEVELS.length-1, idx));
  buildQuestionsForLevel(levelIndex);

  resetState();
  START_SCREEN.style.display="none";
  started=true;

  render();
  startRound();
}

/* start campaign */
function startCampaign(){
  campaignMode=true;
  levelIndex=0;

  grandScore=0; grandBase=0; grandTime=0; grandCombo=0; grandPenalty=0;
  grandDone=0;
  grandTotal = totalQuestionsInAllLevels();

  startLevel(0);
}

/* EVENTS */
DIFF.onchange=()=>{
  diffKey = DIFF.value || "classic";
  if(!started){
    correctCount=0;
    T.textContent = fmt(getRoundTime());
  }
};

START_BTN.onclick=()=>{
  ctx.resume();
  const v = (LEVEL.value||"all");
  if(v==="all") startCampaign();
  else{
    campaignMode=false;
    grandScore=grandBase=grandTime=grandCombo=grandPenalty=grandDone=0;
    grandTotal=0;
    startLevel(parseInt(v,10)||0);
  }
};

RETRY.onclick=()=>{
  resetState();
  campaignMode=false;
  START_SCREEN.style.display="flex";
  render();
};

NEXT_LEVEL.onclick=()=>{
  ctx.resume();
  if(campaignMode) pushLevelToGrand();
  const next = levelIndex+1;
  if(next >= LEVELS.length) return;
  startLevel(next);
};

FINISH.onclick=()=>{
  ctx.resume();

  if(campaignMode && campaignCompleted && finishStage===0){
    pushLevelToGrand();
    finishStage=1;
    showTotalResults();
    return;
  }

  resetState();
  campaignMode=false;
  START_SCREEN.style.display="flex";
  render();
};

window.addEventListener("resize", ()=>{
  if(started && !END.classList.contains("show")) render();
});

/* INIT: build mode select options dynamically */
(function initMenu(){
  const sel = document.getElementById("LEVEL");
  // keep first option (all)
  while(sel.options.length>1) sel.remove(1);
  for(let i=0;i<LEVELS.length;i++){
    const opt=document.createElement("option");
    opt.value=String(i);
    opt.textContent=`Level ${i+1}`;
    sel.appendChild(opt);
  }
  diffKey = DIFF.value || "classic";
  T.textContent = fmt(getRoundTime());
  render();
})();
${jsEnd}
</body>
</html>`;

  // IMPORTANT: prevent breaking the editor generator
  return html.replaceAll("</script>", "<\\/script>");
}

/* ===== PREVIEW + COPY ===== */
let updTimer;
function upd(){
  clearTimeout(updTimer);
  updTimer=setTimeout(updatePreview,250);
}

function updatePreview(){
  const html=getGameHTML();
  const f=document.getElementById('previewFrame');
  f.srcdoc=html;
  f.onload=()=>{
    try{ f.contentWindow.postMessage(viewMode,'*'); }catch(e){}
  };
}

function toggleView(m){
  viewMode=m;
  document.getElementById('btnRules').classList.toggle('active',m==='rules');
  document.getElementById('btnGame').classList.toggle('active',m==='game');
  try{ document.getElementById('previewFrame').contentWindow.postMessage(m,'*'); }catch(e){}
}

function generateCode(){
  const srcdoc=getGameHTML();
  const iframeCode = `<iframe style="width:100%;height:100%;border:0" srcdoc='${escapeForSingleQuotedAttr(srcdoc)}'></iframe>`;
  document.getElementById('finalCode').value = iframeCode;
  document.getElementById('COPY_MODAL').style.display='flex';
}

/* Preview switching: menu/game */
window.addEventListener('message', (e)=>{});

/* INIT */
renderLevels();
updatePreview();
</script>

</body>
</html>
