<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Leap & Learn ‚Äî –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–¥–ª—è GitHub / Genially)</title>
  <style>
    :root{
      --bg0:#050a14;
      --panel:#0b1630;
      --panel2:#0a1a38;
      --line:rgba(124,249,255,.35);
      --neon:#7cf9ff;
      --txt:#eaf6ff;
      --mut:#bfe9ff;
      --warn:#ff3b3b;
      --ok:#ffe44d;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:radial-gradient(1200px 900px at 20% 10%, rgba(124,249,255,.14), transparent 55%), radial-gradient(900px 700px at 80% 25%, rgba(255,228,77,.09), transparent 55%), linear-gradient(180deg, #040812, #070c18); color:var(--txt); overflow:hidden}
    #APP{height:100%;display:grid;grid-template-columns: 420px 1fr; gap:14px; padding:14px}
    @media (max-width:1100px){
      body{overflow:auto}
      #APP{grid-template-columns:1fr; height:auto; min-height:100%}
      #PREVIEW_WRAP{height:66vh}
    }

    .card{
      border-radius:18px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:0 0 24px rgba(124,249,255,.12), inset 0 0 18px rgba(124,249,255,.06);
      overflow:hidden;
      min-height:0;
    }
    .head{
      padding:12px 14px;
      border-bottom:1px solid rgba(124,249,255,.22);
      display:flex;align-items:center;justify-content:space-between; gap:10px;
      background:linear-gradient(90deg, rgba(124,249,255,.10), transparent);
    }
    .title{
      margin:0;
      font-weight:900;
      letter-spacing:.02em;
      text-shadow:0 0 16px rgba(124,249,255,.25);
      font-size:16px;
    }
    .sub{
      font-size:12px; color:rgba(191,233,255,.9); font-weight:800; opacity:.95
    }
    .body{
      padding:12px 14px;
      overflow:auto;
      max-height:100%;
    }

    .grid{display:grid; gap:10px}
    .row{display:grid;grid-template-columns: 1fr 1fr; gap:10px}
    .row3{display:grid;grid-template-columns: 1fr 1fr 1fr; gap:10px}
    label{display:block; font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:rgba(191,233,255,.9); font-weight:900; margin:2px 0 6px}
    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(124,249,255,.35);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      padding:10px 10px;
      outline:none;
      box-shadow: inset 0 0 14px rgba(124,249,255,.06);
      font-weight:800;
    }
    textarea{min-height:120px; resize:vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; line-height:1.35}
    input[type="color"]{
      width:100%;
      height:42px;
      border-radius:14px;
      border:1px solid rgba(124,249,255,.35);
      background:rgba(255,255,255,.06);
      padding:6px;
    }
    .hint{font-size:12px;color:rgba(191,233,255,.85);font-weight:700;line-height:1.35}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid rgba(124,249,255,.28);
      background:rgba(255,255,255,.05);
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      color:rgba(234,246,255,.95);
      box-shadow:0 0 12px rgba(124,249,255,.10);
    }
    .btn{
      border-radius:14px;
      border:1px solid rgba(124,249,255,.55);
      background:rgba(255,255,255,.08);
      color:var(--txt);
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 0 18px rgba(124,249,255,.18), inset 0 0 12px rgba(124,249,255,.08);
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:rgba(124,249,255,.12);
      border-color:rgba(124,249,255,.9);
      box-shadow:0 0 22px rgba(124,249,255,.25), inset 0 0 12px rgba(124,249,255,.10);
    }
    .btn.warn{
      border-color:rgba(255,59,59,.8);
      background:rgba(255,59,59,.10);
      box-shadow:0 0 18px rgba(255,59,59,.18), inset 0 0 12px rgba(255,59,59,.06);
    }
    .btn.ok{
      border-color:rgba(255,228,77,.85);
      background:rgba(255,228,77,.10);
      box-shadow:0 0 18px rgba(255,228,77,.16), inset 0 0 12px rgba(255,228,77,.06);
    }
    .toolbar{display:flex;flex-wrap:wrap; gap:10px; align-items:center}
    .sep{height:1px; background:rgba(124,249,255,.18); margin:12px 0}

    #PREVIEW_WRAP{height:100%; min-height:0}
    #PREVIEW{width:100%; height:100%; border:0; border-radius:14px; background:#000}
    #CODE{min-height:160px}
    .small{font-size:11px; opacity:.9}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .k{display:inline-block; padding:2px 8px; border-radius:10px; border:1px solid rgba(124,249,255,.45); background:rgba(255,255,255,.06); box-shadow:0 0 12px rgba(124,249,255,.10); font-weight:900}
    .pill{display:inline-flex; gap:8px; flex-wrap:wrap}
    .levelCard{
      border-radius:16px;
      border:1px solid rgba(124,249,255,.28);
      background:rgba(255,255,255,.04);
      padding:10px 10px 12px;
      box-shadow:0 0 14px rgba(124,249,255,.10);
    }
    .levelTop{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .lvlName{font-weight:900}
  </style>
</head>
<body>
<div id="APP">
  <!-- LEFT: SETTINGS -->
  <div class="card">
    <div class="head">
      <div>
        <div class="title">Leap & Learn ‚Äî –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫</div>
        <div class="sub">GitHub Pages ‚Üí –≤—Å—Ç–∞–≤–ª—è–π —ç—Ç—É –ø–∞–Ω–µ–ª—å –≤ Genially –∫–∞–∫ iframe</div>
      </div>
      <div class="chip" title="–ò–≥—Ä–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏">LIVE ‚Ä¢ PREVIEW</div>
    </div>

    <div class="body">
      <div class="grid">

        <div class="toolbar">
          <button class="btn primary" id="BTN_COPY">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe –∏–≥—Ä—ã</button>
          <button class="btn" id="BTN_COPY_PANEL">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe –ø–∞–Ω–µ–ª–∏</button>
          <button class="btn warn" id="BTN_RESET">‚Ü∫ –°–±—Ä–æ—Å</button>
        </div>

        <div class="hint">
          <div class="pill">
            <span class="k">1</span> –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–π –≤—Å—ë —Å–ª–µ–≤–∞ ‚Üí
            <span class="k">2</span> –°–ø—Ä–∞–≤–∞ –≤–∏–¥–∏—à—å –∏–≥—Ä—É ‚Üí
            <span class="k">3</span> –ù–∞–∂–º–∏ ‚Äú–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe –∏–≥—Ä—ã‚Äù –∏ –≤—Å—Ç–∞–≤—å –≤ Genially
          </div>
          <div class="small" style="margin-top:6px">
            –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: —Ü–≤–µ—Ç–∞ —ç–∫—Ä–∞–Ω–æ–≤, —É—Ä–æ–≤–Ω–∏/–≤–æ–ø—Ä–æ—Å—ã, —Å–ª–æ–∂–Ω–æ—Å—Ç—å (—Å–µ–∫—É–Ω–¥—ã), —Ü–≤–µ—Ç–∞ –ø–∞–Ω–µ–ª–µ–π/—Ç–∞–π–º–µ—Ä–∞ + –Ω–µ–æ–Ω–æ–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞,
            —à—Ä–∏—Ñ—Ç, –∑–≤—É–∫–∏ (—Å–∏–Ω—Ç/URL/–∑–∞–≥—Ä—É–∑–∫–∞), —Ç–µ–∫—Å—Ç—ã —Ñ–∏–Ω–∞–ª–∞, —Ñ–æ–Ω—ã (—Ä–µ–∫–∞/–ª–∞–≤–∞/–±–æ–ª–æ—Ç–æ) –∏–ª–∏ —Å–≤–æ–π —Ñ–æ–Ω, –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.
          </div>
        </div>

        <div class="sep"></div>

        <!-- VISUALS -->
        <div class="grid">
          <div class="title" style="font-size:13px">üé® –í–Ω–µ—à–Ω–∏–π –≤–∏–¥</div>

          <div class="row">
            <div>
              <label>–§–æ–Ω –ª–æ–∫–∞—Ü–∏–∏ (–ø—Ä–µ—Å–µ—Ç—ã)</label>
              <select id="BG_PRESET">
                <option value="river">–†–µ–∫–∞</option>
                <option value="lava" selected>–õ–∞–≤–∞</option>
                <option value="swamp">–ë–æ–ª–æ—Ç–æ</option>
                <option value="custom">–°–≤–æ–π (–∑–∞–≥—Ä—É–∑–∫–∞/URL)</option>
              </select>
            </div>
            <div>
              <label>–°–≤–æ–π —Ñ–æ–Ω (URL)</label>
              <input id="BG_URL" type="text" placeholder="https://...png" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π —Ñ–æ–Ω (—Ñ–∞–π–ª)</label>
              <input id="BG_FILE" type="file" accept="image/*" />
              <div class="small">–§–∞–π–ª –±—É–¥–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω –∫–∞–∫ data:URL (–º–æ–∂–µ—Ç —Å–∏–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–¥).</div>
            </div>
            <div>
              <label>–ü–µ—Ä—Å–æ–Ω–∞–∂</label>
              <select id="CHAR_PRESET">
                <option value="frog">–õ—è–≥—É—à–∫–∞</option>
                <option value="chameleon" selected>–•–∞–º–µ–ª–µ–æ–Ω</option>
                <option value="lizard">–Ø—â–µ—Ä–∏—Ü–∞</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
              <select id="PLAT_PRESET">
                <option value="lily" selected>–õ–∏–ª–∏—è</option>
                <option value="stone">–ö–∞–º–µ–Ω—å</option>
                <option value="hummock">–ë–æ–ª–æ—Ç–Ω–∞—è –∫–æ—á–∫–∞</option>
              </select>
            </div>
            <div>
              <label>–¶–≤–µ—Ç –ø–∞–Ω–µ–ª–µ–π (–∫–∞—Ä—Ç–æ—á–∫–∏/–ø–∞–Ω–µ–ª–∏)</label>
              <input id="PANEL_COLOR" type="color" value="#0b1630" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>–¶–≤–µ—Ç —Ç–∞–π–º–µ—Ä–∞ / —Ä–∞–º–∫–∏</label>
              <input id="TIMER_COLOR" type="color" value="#7cf9ff" />
            </div>
            <div>
              <label>–ù–µ–æ–Ω–æ–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞</label>
              <select id="NEON_ON">
                <option value="1" selected>–í–∫–ª—é—á–∏—Ç—å</option>
                <option value="0">–í—ã–∫–ª—é—á–∏—Ç—å</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>–¶–≤–µ—Ç —Å—Ç–∞—Ä—Ç-—ç–∫—Ä–∞–Ω–∞ (overlay)</label>
              <input id="START_OVERLAY" type="color" value="#081022" />
            </div>
            <div>
              <label>–¶–≤–µ—Ç —Ñ–∏–Ω–∞–ª-—ç–∫—Ä–∞–Ω–∞ (overlay)</label>
              <input id="END_OVERLAY" type="color" value="#081022" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
              <input id="FONT_COLOR" type="color" value="#eaf6ff" />
            </div>
            <div>
              <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞ (px)</label>
              <input id="Q_FONT_SIZE" type="number" min="16" max="48" step="1" value="26" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä—ã</label>
              <input id="GAME_TITLE" type="text" value="Leap & Learn" />
            </div>
            <div>
              <label>–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ</label>
              <input id="GAME_SUB" type="text" value="Fast quiz game ‚Ä¢ platforms, combos and speed" />
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <!-- DIFFICULTY -->
        <div class="grid">
          <div class="title" style="font-size:13px">‚è±Ô∏è –°–ª–æ–∂–Ω–æ—Å—Ç—å (—Å–µ–∫—É–Ω–¥—ã)</div>

          <div class="row">
            <div>
              <label>–ü—Ä–µ—Å–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</label>
              <select id="DIFF_PRESET">
                <option value="classic" selected>Classic (10‚Üí7‚Üí5)</option>
                <option value="easy">Easy (12‚Üí9‚Üí7)</option>
                <option value="hard">Hard (9‚Üí6‚Üí4)</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            <div>
              <label>–®—Ç—Ä–∞—Ñ –∑–∞ –æ—à–∏–±–∫—É</label>
              <input id="WRONG_PENALTY" type="number" min="0" max="9999" step="1" value="80" />
            </div>
          </div>

          <div class="row3">
            <div>
              <label>T1 (–¥–æ 3 –≤–µ—Ä–Ω—ã—Ö)</label>
              <input id="T1" type="number" min="1" max="99" step="1" value="10" />
            </div>
            <div>
              <label>T2 (3‚Äì5 –≤–µ—Ä–Ω—ã—Ö)</label>
              <input id="T2" type="number" min="1" max="99" step="1" value="7" />
            </div>
            <div>
              <label>T3 (6+ –≤–µ—Ä–Ω—ã—Ö)</label>
              <input id="T3" type="number" min="1" max="99" step="1" value="5" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>–ñ–∏–∑–Ω–∏ (—Å—Ç–∞—Ä—Ç)</label>
              <input id="LIVES" type="number" min="1" max="12" step="1" value="5" />
            </div>
            <div>
              <label>–ë–∞–∑–∞ –æ—á–∫–æ–≤ –∑–∞ –≤–µ—Ä–Ω—ã–π</label>
              <input id="BASE_SCORE" type="number" min="0" max="9999" step="1" value="100" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>–ë–æ–Ω—É—Å –∑–∞ —Å–µ–∫—É–Ω–¥—É (x)</label>
              <input id="TIME_MULT" type="number" min="0" max="999" step="1" value="10" />
            </div>
            <div class="hint">
              –¢–∞–π–º–µ—Ä —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∫—Ä–∞—Å–Ω—ã–º –ø—Ä–∏ <span class="k">‚â§ 3s</span>.
              –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Ü–≤–µ—Ç —Ç–∞–π–º–µ—Ä–∞ –≤—ã—à–µ.
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <!-- AUDIO -->
        <div class="grid">
          <div class="title" style="font-size:13px">üîä –ó–≤—É–∫–∏</div>
          <div class="hint small">
            –í–∞—Ä–∏–∞–Ω—Ç—ã: <span class="k">Synth</span> (–∫–∞–∫ –≤ —Ç–≤–æ—ë–º –∫–æ–¥–µ), <span class="k">URL</span> (mp3/wav/ogg), <span class="k">Upload</span> (–≤—Å—Ç—Ä–æ–∏—Ç—å data:URL).
          </div>

          <div class="row">
            <div>
              <label>–í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç</label>
              <select id="S_OK_TYPE">
                <option value="synth" selected>Synth</option>
                <option value="url">URL</option>
                <option value="upload">Upload</option>
                <option value="off">Off</option>
              </select>
              <input id="S_OK_URL" type="text" placeholder="https://...mp3" />
              <input id="S_OK_FILE" type="file" accept="audio/*" />
              <button class="btn" id="S_OK_TEST">‚ñ∂ Test</button>
            </div>
            <div>
              <label>–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç</label>
              <select id="S_BAD_TYPE">
                <option value="synth" selected>Synth (water/noise)</option>
                <option value="url">URL</option>
                <option value="upload">Upload</option>
                <option value="off">Off</option>
              </select>
              <input id="S_BAD_URL" type="text" placeholder="https://...mp3" />
              <input id="S_BAD_FILE" type="file" accept="audio/*" />
              <button class="btn" id="S_BAD_TEST">‚ñ∂ Test</button>
            </div>
          </div>

          <div class="row">
            <div>
              <label>–ü–æ–±–µ–¥–∞ (—Ñ–∏–Ω–∞–ª/—É—Ä–æ–≤–µ–Ω—å)</label>
              <select id="S_WIN_TYPE">
                <option value="synth" selected>Synth (fanfare)</option>
                <option value="url">URL</option>
                <option value="upload">Upload</option>
                <option value="off">Off</option>
              </select>
              <input id="S_WIN_URL" type="text" placeholder="https://...mp3" />
              <input id="S_WIN_FILE" type="file" accept="audio/*" />
              <button class="btn" id="S_WIN_TEST">‚ñ∂ Test</button>
            </div>
            <div>
              <label>–ü—Ä–æ–≤–∞–ª (—Ñ–∏–Ω–∞–ª)</label>
              <select id="S_LOSE_TYPE">
                <option value="synth" selected>Synth (down)</option>
                <option value="url">URL</option>
                <option value="upload">Upload</option>
                <option value="off">Off</option>
              </select>
              <input id="S_LOSE_URL" type="text" placeholder="https://...mp3" />
              <input id="S_LOSE_FILE" type="file" accept="audio/*" />
              <button class="btn" id="S_LOSE_TEST">‚ñ∂ Test</button>
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <!-- END TEXTS -->
        <div class="grid">
          <div class="title" style="font-size:13px">üèÅ –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã</div>
          <div class="row">
            <div>
              <label>–ü–æ–±–µ–¥–∞</label>
              <input id="TXT_WIN" type="text" value="CONGRATULATIONS!" />
            </div>
            <div>
              <label>–ü–æ—Ä–∞–∂–µ–Ω–∏–µ</label>
              <input id="TXT_LOSE" type="text" value="YOU LOST!" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>–¢–µ–∫—Å—Ç Total Results (–∫–∞–º–ø–∞–Ω–∏—è)</label>
              <input id="TXT_TOTAL" type="text" value="GAME COMPLETED!" />
            </div>
            <div>
              <label>–ü–æ–¥—Å–∫–∞–∑–∫–∞ –Ω–∞ —Ñ–∏–Ω–∞–ª–µ (–µ—Å–ª–∏ –Ω–∞–¥–æ)</label>
              <input id="TXT_HINT" type="text" value="All levels cleared ‚Äî press Finish to see Total Results" />
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <!-- LEVELS -->
        <div class="grid">
          <div class="title" style="font-size:13px">üìö –£—Ä–æ–≤–Ω–∏ –∏ –∑–∞–¥–∞–Ω–∏—è</div>
          <div class="row">
            <div>
              <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–≤–Ω–µ–π</label>
              <input id="LEVEL_COUNT" type="number" min="1" max="12" step="1" value="3" />
              <div class="small">–ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å 1‚Ä¶12 —É—Ä–æ–≤–Ω–µ–π. –ö–∞–º–ø–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø–æ—Ä—è–¥–∫—É.</div>
            </div>
            <div class="hint">
              –§–æ—Ä–º–∞—Ç –∑–∞–¥–∞—á (–Ω–∞ –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É 1 –≤–æ–ø—Ä–æ—Å):<br>
              <span class="mono">Question | A | B | C | correctIndex</span><br>
              –ü—Ä–∏–º–µ—Ä: <span class="mono">I ____ ready. | am | is | are | 0</span>
            </div>
          </div>

          <div id="LEVELS_WRAP" class="grid"></div>

          <button class="btn ok" id="BTN_REBUILD_LEVELS">üîß –ü—Ä–∏–º–µ–Ω–∏—Ç—å —É—Ä–æ–≤–Ω–∏ (–∏ –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä)</button>
        </div>

        <div class="sep"></div>

        <!-- GENERATED CODE -->
        <div class="grid">
          <div class="title" style="font-size:13px">üß© –ö–æ–¥ iframe –∏–≥—Ä—ã (–¥–ª—è Genially)</div>
          <textarea id="CODE" class="mono" readonly></textarea>
          <div class="small">
            –ï—Å–ª–∏ –∫–æ–¥ —Å—Ç–∞–ª –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–º –∏–∑-–∑–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ (—Ñ–æ–Ω/–∑–≤—É–∫–∏), –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å URL –≤–º–µ—Å—Ç–æ upload.
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- RIGHT: PREVIEW -->
  <div class="card" id="PREVIEW_WRAP">
    <div class="head">
      <div>
        <div class="title">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–≥—Ä—ã</div>
        <div class="sub">–≠—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–æ, —á—Ç–æ –æ–∫–∞–∂–µ—Ç—Å—è –≤ Genially</div>
      </div>
      <div class="toolbar">
        <button class="btn" id="BTN_REFRESH">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn" id="BTN_OPEN_SRC">üßæ –û—Ç–∫—Ä—ã—Ç—å srcdoc</button>
      </div>
    </div>
    <div class="body" style="padding:12px; height:100%">
      <iframe id="PREVIEW" sandbox="allow-scripts allow-forms allow-pointer-lock allow-popups allow-same-origin"></iframe>
    </div>
  </div>
</div>

<script>
/* =========================================================
   PRESETS (–∏–∑ —Ç–≤–æ–∏—Ö —Å—Å—ã–ª–æ–∫)
========================================================= */
const PRESETS = {
  bg: {
    river: "https://img.genially.com/67961b32a116fb001568a75e/c0c9010f-c3dd-42c1-b7c1-65024fa3aec6.png",
    lava:  "https://img.genially.com/67961b32a116fb001568a75e/fa2ab459-fec9-4ccd-97e3-254427b4ade0.png",
    swamp: "https://img.genially.com/67961b32a116fb001568a75e/02b52ad4-9d31-4b21-a305-8fec6e8a4487.png",
  },
  character: {
    frog: "https://img.genially.com/67961b32a116fb001568a75e/3074df22-5c73-4ad2-b0b2-491c6fc247f3.png",
    chameleon: "https://img.genially.com/67961b32a116fb001568a75e/74b56fcf-5354-43dd-9c9a-f50facc9a9bf.png",
    lizard: "https://img.genially.com/67961b32a116fb001568a75e/0feda2a1-485a-4654-8640-bf1adcc9f9ec.png",
  },
  platform: {
    lily: "https://img.genially.com/67961b32a116fb001568a75e/ed6c6e82-953b-43d4-947d-e46227b760f0.png",
    stone: "https://img.genially.com/67961b32a116fb001568a75e/bad37c6d-f04c-45c0-b954-807d79ec3a95.png",
    hummock: "https://img.genially.com/67961b32a116fb001568a75e/c6775617-bde5-43e4-9da8-5332d928807e.png",
  }
};

/* =========================================================
   DOM
========================================================= */
const $ = (id)=>document.getElementById(id);

const PREVIEW = $("PREVIEW");
const CODE = $("CODE");

const STATE = {
  bgCustomDataUrl: "",
  sounds: {
    okUpload: "", badUpload: "", winUpload: "", loseUpload: ""
  },
  levels: [] // built from UI
};

/* =========================================================
   DEFAULT LEVELS (–∏–∑ —Ç–≤–æ–µ–≥–æ –∫–æ–¥–∞, –Ω–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ —Å—Ç—Ä–æ–∫)
========================================================= */
function defaultLevelLines(){
  return [
`I ____ ready. | am | is | are | 0
She ____ got a car. | have | has | is have | 1
They ____ at home. | is | are | be | 1
It ____ cold outside. | is | are | am | 0
My sister ____ 10. | is | are | am | 0
Tom and Ben ____ friends. | is | are | am | 1
He ____ a teacher. | am | is | are | 1
We ____ happy today. | am | are | is | 1`,
`I ____ from Kazakhstan. | am | is | are | 0
She ____ not hungry. | is | are | am | 0
He ____ not at school. | is | are | am | 0
They ____ friends. | am | are | is | 1
We ____ students. | am | are | is | 1
It ____ a cat. | is | are | am | 0
I ____ happy. | am | is | are | 0
She ____ a doctor. | is | are | am | 0`,
`There ____ two books. | is | are | am | 1
These ____ my keys. | is | are | am | 1
That ____ my bag. | is | are | am | 0
I ____ late. | am | is | are | 0
We ____ not tired. | are | is | am | 0
He ____ not ready. | is | are | am | 0
They ____ not here. | are | is | am | 0
It ____ not sunny. | is | are | am | 0`
  ];
}

/* =========================================================
   LEVEL UI BUILD
========================================================= */
function buildLevelsUI(count){
  const wrap = $("LEVELS_WRAP");
  wrap.innerHTML = "";
  const lines = defaultLevelLines();

  for(let i=0;i<count;i++){
    const card = document.createElement("div");
    card.className = "levelCard";
    card.dataset.idx = String(i);

    const top = document.createElement("div");
    top.className = "levelTop";

    const left = document.createElement("div");
    left.style.flex="1";

    const nameLbl = document.createElement("label");
    nameLbl.textContent = `–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è ${i+1}`;
    const nameInp = document.createElement("input");
    nameInp.type = "text";
    nameInp.id = `LVL_NAME_${i}`;
    nameInp.value = `Level ${i+1}`;
    left.appendChild(nameLbl);
    left.appendChild(nameInp);

    const right = document.createElement("div");
    right.style.display="flex";
    right.style.gap="8px";
    right.style.alignItems="center";

    const btnFill = document.createElement("button");
    btnFill.className = "btn";
    btnFill.type="button";
    btnFill.textContent = "‚ú® –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–∏–º–µ—Ä–æ–º";
    btnFill.onclick = ()=>{
      const t = document.getElementById(`LVL_TXT_${i}`);
      t.value = (lines[i] || lines[0] || "").trim();
      updateAll();
    };

    right.appendChild(btnFill);
    top.appendChild(left);
    top.appendChild(right);

    const taLbl = document.createElement("label");
    taLbl.textContent = `–ó–∞–¥–∞–Ω–∏—è —É—Ä–æ–≤–Ω—è ${i+1} (–ø–æ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ)`;

    const ta = document.createElement("textarea");
    ta.id = `LVL_TXT_${i}`;
    ta.placeholder = `Question | A | B | C | correctIndex`;
    ta.value = (lines[i] || "").trim();

    ta.addEventListener("input", debounce(updateAll, 250));
    nameInp.addEventListener("input", debounce(updateAll, 250));

    card.appendChild(top);
    card.appendChild(document.createElement("div")).className="sep";
    card.appendChild(taLbl);
    card.appendChild(ta);

    const small = document.createElement("div");
    small.className="small";
    small.style.marginTop="6px";
    small.innerHTML = `correctIndex: <span class="k">0</span> / <span class="k">1</span> / <span class="k">2</span>. –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø—É—Å—Ç–∞—è ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è.`;
    card.appendChild(small);

    wrap.appendChild(card);
  }
}

/* =========================================================
   PARSE LEVELS
========================================================= */
function parseLevelText(text){
  const lines = String(text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const questions = [];
  for(const line of lines){
    const parts = line.split("|").map(x=>x.trim());
    if(parts.length < 5) continue;
    const q = parts[0];
    const a = parts[1], b = parts[2], c = parts[3];
    let ci = parseInt(parts[4],10);
    if(!Number.isFinite(ci)) ci = 0;
    ci = Math.max(0, Math.min(2, ci));
    questions.push({ text:q, answers:[a,b,c], correct:ci });
  }
  return questions;
}

function collectLevelsFromUI(){
  const count = clampInt($("LEVEL_COUNT").value, 1, 12, 3);
  const levels = [];
  for(let i=0;i<count;i++){
    const name = (document.getElementById(`LVL_NAME_${i}`)?.value || `Level ${i+1}`).trim() || `Level ${i+1}`;
    const txt = (document.getElementById(`LVL_TXT_${i}`)?.value || "");
    const questions = parseLevelText(txt);
    // –µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –¥–æ–±–∞–≤–∏–º —Ö–æ—Ç—è –±—ã 1, —á—Ç–æ–±—ã –∏–≥—Ä–∞ –Ω–µ –ª–æ–º–∞–ª–∞—Å—å
    if(questions.length === 0){
      questions.push({text:"(Empty level) Add your questions in the panel.", answers:["OK","OK","OK"], correct:0});
    }
    levels.push({ name, questions });
  }
  STATE.levels = levels;
  return levels;
}

/* =========================================================
   HELPERS
========================================================= */
function clampInt(v,min,max,def){
  const n = parseInt(v,10);
  if(!Number.isFinite(n)) return def;
  return Math.max(min, Math.min(max, n));
}
function escAttr(s){
  return String(s).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}
function escapeForSingleQuotedAttr(s){
  // for iframe srcdoc='...'
  return String(s)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/'/g,"&#39;");
}
function debounce(fn,ms){
  let t=null;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); };
}

/* =========================================================
   FILE TO DATA URL
========================================================= */
function readFileAsDataURL(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(String(r.result||""));
    r.onerror = ()=>reject(r.error||new Error("File read error"));
    r.readAsDataURL(file);
  });
}

/* =========================================================
   BUILD CONFIG FROM UI
========================================================= */
function getSoundConfig(prefix, uploadKey){
  const type = $(prefix+"_TYPE").value;
  const url = $(prefix+"_URL").value.trim();
  const up = STATE.sounds[uploadKey] || "";
  return { type, url, upload: up };
}

function resolveBgUrl(){
  const preset = $("BG_PRESET").value;
  const url = $("BG_URL").value.trim();
  if(preset === "custom"){
    if(url) return url;
    if(STATE.bgCustomDataUrl) return STATE.bgCustomDataUrl;
    return PRESETS.bg.lava;
  }
  return PRESETS.bg[preset] || PRESETS.bg.lava;
}

function resolveCharUrl(){
  const k = $("CHAR_PRESET").value;
  return PRESETS.character[k] || PRESETS.character.chameleon;
}
function resolvePlatUrl(){
  const k = $("PLAT_PRESET").value;
  return PRESETS.platform[k] || PRESETS.platform.lily;
}

function getDiff(){
  const preset = $("DIFF_PRESET").value;
  if(preset !== "custom"){
    const map = {
      classic:{t1:10,t2:7,t3:5},
      easy:{t1:12,t2:9,t3:7},
      hard:{t1:9,t2:6,t3:4},
    };
    const d = map[preset] || map.classic;
    $("T1").value = d.t1;
    $("T2").value = d.t2;
    $("T3").value = d.t3;
    return d;
  }
  return {
    t1: clampInt($("T1").value,1,99,10),
    t2: clampInt($("T2").value,1,99,7),
    t3: clampInt($("T3").value,1,99,5),
  };
}

function buildConfig(){
  const levels = collectLevelsFromUI();

  const cfg = {
    title: $("GAME_TITLE").value.trim() || "Leap & Learn",
    subtitle: $("GAME_SUB").value.trim() || "",
    visuals: {
      bgUrl: resolveBgUrl(),
      characterUrl: resolveCharUrl(),
      platformUrl: resolvePlatUrl(),
      panelColor: $("PANEL_COLOR").value,
      timerColor: $("TIMER_COLOR").value,
      neon: $("NEON_ON").value === "1",
      startOverlay: $("START_OVERLAY").value,
      endOverlay: $("END_OVERLAY").value,
      fontColor: $("FONT_COLOR").value,
      qFontSize: clampInt($("Q_FONT_SIZE").value,16,48,26),
    },
    gameplay: {
      lives: clampInt($("LIVES").value,1,12,5),
      baseScore: clampInt($("BASE_SCORE").value,0,9999,100),
      timeMult: clampInt($("TIME_MULT").value,0,999,10),
      wrongPenalty: clampInt($("WRONG_PENALTY").value,0,9999,80),
      diff: getDiff(),
    },
    texts: {
      win: $("TXT_WIN").value || "CONGRATULATIONS!",
      lose: $("TXT_LOSE").value || "YOU LOST!",
      total: $("TXT_TOTAL").value || "GAME COMPLETED!",
      hintCampaign: $("TXT_HINT").value || "",
    },
    sounds: {
      ok: getSoundConfig("S_OK","okUpload"),
      bad: getSoundConfig("S_BAD","badUpload"),
      win: getSoundConfig("S_WIN","winUpload"),
      lose: getSoundConfig("S_LOSE","loseUpload"),
    },
    levels
  };
  return cfg;
}

/* =========================================================
   GAME TEMPLATE (–ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ç–≤–æ–µ–≥–æ –∫–æ–¥–∞)
   ‚Äî –≤–Ω—É—Ç—Ä–∏ –±—É–¥–µ—Ç cfg JSON
========================================================= */
function buildGameSrcdoc(cfg){
  const cfgJson = JSON.stringify(cfg);

  // NOTE: —ç—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –∏–≥—Ä–∞. –í–Ω—É—Ç—Ä–∏:
  // - –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º cfg.visuals.bgUrl / characterUrl / platformUrl
  // - —Ü–≤–µ—Ç–∞ —ç–∫—Ä–∞–Ω–æ–≤, —Ç–∞–π–º–µ—Ä–∞, –ø–∞–Ω–µ–ª–µ–π, —Ç–µ–∫—Å—Ç–æ–≤
  // - —É—Ä–æ–≤–Ω–∏ –∏ –≤–æ–ø—Ä–æ—Å—ã
  // - –∑–≤—É–∫–∏: synth / url / upload / off
  return `<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>${escAttr(cfg.title)}</title>
<style>
:root{
  --neon-main:${cfg.visuals.timerColor};
  --danger:#ff3b3b;
  --win:#ffe44d;
  --panel:${cfg.visuals.panelColor};
  --txt:${cfg.visuals.fontColor};
  --startOverlay:${cfg.visuals.startOverlay};
  --endOverlay:${cfg.visuals.endOverlay};
  --neonOn:${cfg.visuals.neon ? 1 : 0};
}
html,body{margin:0;width:100%;height:100%;overflow:hidden;font-family:Arial;background:#0a1730;color:var(--txt)}
#GAME{position:relative;width:100%;height:100%}
#GAME.shake{animation:shake .25s}
@keyframes shake{0%{transform:translate(0)}25%{transform:translate(-4px,3px)}50%{transform:translate(4px,-3px)}75%{transform:translate(-3px,2px)}100%{transform:translate(0)}}
#BG{position:absolute;inset:0;z-index:0;background:url("${escAttr(cfg.visuals.bgUrl)}") center/cover no-repeat}

#QUESTION{position:absolute;top:26px;width:100%;text-align:center;font-size:${cfg.visuals.qFontSize}px;z-index:20;color:var(--txt);text-shadow:0 2px 0 rgba(0,0,0,.35);font-weight:900}
#TIMER{
  position:absolute;top:70px;left:50%;transform:translateX(-50%);
  width:80px;height:80px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  background:#fff;border:2px solid var(--neon-main);
  box-shadow:0 0 calc(18px * var(--neonOn)) var(--neon-main);
  z-index:20;font-weight:900;color:#053149;
}
#TIMER.danger{
  border-color:var(--danger);color:var(--danger);
  box-shadow:0 0 calc(25px * var(--neonOn)) var(--danger);
  animation:pulse .8s infinite;
}
@keyframes pulse{50%{transform:translateX(-50%) scale(1.12)}}
#LIVES{position:absolute;top:30px;right:30px;font-size:26px;z-index:20}
#SCORE{position:absolute;top:30px;left:30px;font-size:20px;font-weight:900;z-index:20;color:var(--txt);text-shadow:0 2px 0 rgba(0,0,0,.35)}

#COMBO{
  position:absolute;top:165px;left:50%;transform:translateX(-50%);
  z-index:20;padding:10px 16px;border-radius:18px;
  background:rgba(255,255,255,.88);
  border:2px solid var(--neon-main);
  box-shadow:0 0 calc(18px * var(--neonOn)) rgba(124,249,255,.65), inset 0 0 14px rgba(124,249,255,.25);
  font-weight:900;color:#043149;display:none;gap:10px;align-items:center;
}
#COMBO.show{display:inline-flex}
#COMBO_BOLT{width:18px;height:18px;border-radius:6px;background:rgba(124,249,255,.25);box-shadow:0 0 calc(14px * var(--neonOn)) rgba(124,249,255,.75);display:inline-block}
#COMBO.pulse{animation:comboPulse .55s ease}
@keyframes comboPulse{0%{transform:translateX(-50%) scale(1)}40%{transform:translateX(-50%) scale(1.12)}100%{transform:translateX(-50%) scale(1)}}

.btn{
  padding:12px 34px;border-radius:16px;font-weight:900;
  background:#fff;border:2px solid var(--neon-main);
  box-shadow:0 0 calc(15px * var(--neonOn)) var(--neon-main);
  cursor:pointer;color:#043149;
}
.btn:active{transform:translateY(1px)}
.btn.dark{
  background:rgba(255,255,255,.10);
  color:#eaf6ff;
  border:2px solid rgba(124,249,255,.55);
  box-shadow:0 0 calc(16px * var(--neonOn)) rgba(124,249,255,.25);
}
#START.hide{display:none}

#START_SCREEN{
  position:absolute;inset:0;z-index:60;
  display:flex;align-items:center;justify-content:center;
  background:color-mix(in srgb, var(--startOverlay) 92%, transparent);
}
#START_CARD{
  width:min(760px, calc(100vw - 40px));
  border-radius:26px;
  background:linear-gradient(180deg, rgba(10,20,50,.92), rgba(5,10,25,.92));
  border:2px solid rgba(124,249,255,.75);
  box-shadow:0 0 calc(30px * var(--neonOn)) rgba(124,249,255,.55), inset 0 0 24px rgba(124,249,255,.18);
  padding:18px 18px 16px;
  position:relative;overflow:hidden;color:#eaf6ff;
}
#START_CARD::before{
  content:"";position:absolute;inset:-40%;
  background:
    radial-gradient(circle at 30% 30%, rgba(124,249,255,.18), transparent 50%),
    radial-gradient(circle at 70% 60%, rgba(255,228,77,.12), transparent 55%),
    linear-gradient(90deg, transparent, rgba(124,249,255,.14), transparent);
  transform:rotate(10deg);
  animation:cardGlow 3.2s ease-in-out infinite;
  pointer-events:none;
}
@keyframes cardGlow{0%,100%{opacity:.55; transform:rotate(10deg) translateX(-10px)}50%{opacity:1; transform:rotate(10deg) translateX(10px)}}
#START_TOP{position:relative;display:flex;align-items:center;gap:14px;padding:6px 6px 10px}
#START_ICON{
  width:64px;height:64px;flex:0 0 auto;
  background:url("${escAttr(cfg.visuals.characterUrl)}") no-repeat center/contain;
  filter:drop-shadow(0 0 calc(14px * var(--neonOn)) rgba(124,249,255,.55));
}
#START_TITLE{font-weight:900;font-size:34px;color:#eaf6ff;text-shadow:0 0 calc(18px * var(--neonOn)) rgba(124,249,255,.55);margin:0;line-height:1.05}
#START_SUB{margin:2px 0 0;color:#bfe9ff;opacity:.9;font-weight:700}
.panel{
  background:rgba(255,255,255,.08);
  border:1px solid rgba(124,249,255,.35);
  border-radius:18px;
  box-shadow:0 0 calc(12px * var(--neonOn)) rgba(124,249,255,.18);
  padding:12px 12px 10px;margin-top:10px;
}
.panel h3{margin:0 0 8px;font-size:14px;letter-spacing:.08em;text-transform:uppercase;opacity:.9;color:#eaf6ff}
.rules{margin:0;color:#cfefff;font-weight:700;line-height:1.35;font-size:14px}
.rules li{margin:6px 0}
.kbd{display:inline-block;padding:2px 8px;border-radius:10px;border:1px solid rgba(124,249,255,.55);box-shadow:0 0 calc(10px * var(--neonOn)) rgba(124,249,255,.22);background:rgba(255,255,255,.10);font-weight:900;color:#eaf6ff}
#START_BOTTOM{position:relative;display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px;flex-wrap:wrap}
.badge{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 12px;border-radius:16px;
  border:1px solid rgba(124,249,255,.35);
  box-shadow:0 0 calc(12px * var(--neonOn)) rgba(124,249,255,.18);
  background:rgba(255,255,255,.08);
  color:#eaf6ff;font-weight:900;font-size:14px;
}
.badge small{opacity:.8;font-weight:900;color:#bfe9ff}
select{
  border-radius:14px;border:1px solid rgba(124,249,255,.45);
  background:rgba(255,255,255,.10);
  padding:8px 10px;font-weight:900;color:#eaf6ff;outline:none;
  box-shadow: inset 0 0 14px rgba(124,249,255,.10);
}
select option{color:#0b1630;background:#eaf6ff;font-weight:900}

#END{
  position:absolute;inset:0;z-index:50;
  background:color-mix(in srgb, var(--endOverlay) 92%, transparent);
  display:none;align-items:center;justify-content:center;
  flex-direction:column;
}
#END.show{display:flex}
#END_TEXT{font-size:58px;font-weight:900;margin:0 0 10px;animation:sway 2.5s ease-in-out infinite;text-align:center}
.win{color:var(--win);text-shadow:0 0 calc(12px * var(--neonOn)) var(--win),0 0 calc(34px * var(--neonOn)) var(--win}
.lose{color:var(--danger);text-shadow:0 0 calc(12px * var(--neonOn)) var(--danger),0 0 calc(34px * var(--neonOn)) var(--danger}
@keyframes sway{0%{transform:rotate(0deg)}25%{transform:rotate(2deg)}50%{transform:rotate(0deg)}75%{transform:rotate(-2deg)}100%{transform:rotate(0deg)}}
#LEVEL_BANNER{
  margin:0 0 10px;padding:14px 18px;border-radius:20px;
  background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
  border:1px solid rgba(255,228,77,.55);
  box-shadow:0 0 calc(24px * var(--neonOn)) rgba(255,228,77,.35), inset 0 0 18px rgba(255,228,77,.12);
  color:#fff7cf;font-weight:900;letter-spacing:.06em;text-transform:uppercase;text-align:center;
}
#LEVEL_NAME{margin:0 0 10px;color:#bfe9ff;font-weight:900;opacity:.95;text-shadow:0 0 calc(12px * var(--neonOn)) rgba(124,249,255,.25)}
#HINT_LINE{margin:0 0 16px;color:#cfefff;opacity:.9;font-weight:900;text-align:center}

#SCORECARD{
  width:min(620px, calc(100vw - 40px));
  background:rgba(255,255,255,.10);
  border:2px solid rgba(124,249,255,.55);
  box-shadow:0 0 calc(22px * var(--neonOn)) rgba(124,249,255,.45), inset 0 0 16px rgba(124,249,255,.15);
  border-radius:22px;
  padding:18px 18px 14px;
  margin:6px 0 16px;
  position:relative;
  overflow:hidden;
  color:#eaf6ff;
}
#SCOREGRID{position:relative;display:grid;grid-template-columns:1fr 1fr;gap:10px 14px;align-items:stretch}
.row{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.08);border:1px solid rgba(124,249,255,.35);border-radius:16px;padding:12px 14px;box-shadow:0 0 calc(10px * var(--neonOn)) rgba(124,249,255,.18)}
.label{font-size:13px;letter-spacing:.08em;text-transform:uppercase;opacity:.9}
.value{font-size:22px;font-weight:900;text-shadow:0 0 calc(12px * var(--neonOn)) rgba(124,249,255,.25)}
#FINAL_LINE{position:relative;margin-top:12px;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-radius:18px;background:rgba(255,255,255,.10);border:2px solid rgba(124,249,255,.55);box-shadow:0 0 calc(18px * var(--neonOn)) rgba(124,249,255,.35), inset 0 0 14px rgba(124,249,255,.12)}
#FINAL_LABEL{font-weight:900;font-size:13px;letter-spacing:.08em;text-transform:uppercase;opacity:.95}
#FINAL_SCORE{font-weight:900;font-size:30px;text-shadow:0 0 calc(16px * var(--neonOn)) rgba(124,249,255,.35)}
#END_BTNS{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}

#FROG{
  position:absolute;left:160px;top:50%;
  width:110px;height:110px;
  background:url("${escAttr(cfg.visuals.characterUrl)}") no-repeat center/contain;
  transform:translate(-50%,-65%);
  z-index:15;
  transition:transform .6s ease,opacity .6s ease;
  pointer-events:none;
}
#FROG.jump{transform:translate(-50%,-95%) scale(1.05)}
#FROG.sink{transform:translate(-50%,-10%) scale(.6);opacity:0}

#PLATFORMS{position:absolute;inset:0;z-index:10}
.platform{position:absolute;width:150px;height:150px;transition:transform .5s,opacity .6s}
.lily{
  width:150px;height:150px;
  background:url("${escAttr(cfg.visuals.platformUrl)}") no-repeat center/contain;
  display:flex;align-items:center;justify-content:center;
  font-weight:900;color:#141414;
  text-shadow:0 2px 0 rgba(255,255,255,.65), 0 0 10px rgba(0,0,0,.35);
  animation:float 3.5s ease-in-out infinite;
  transition:transform .5s, filter .2s;
}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(6px)}}
.platform.answer{cursor:pointer}
.platform.fade{opacity:0}
.platform.fade .lily{transform:scale(.6)}
.platform.wrong .lily{filter:drop-shadow(0 0 18px red)}
@keyframes wobble{0%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(1px) rotate(-3deg)}50%{transform:translateY(0) rotate(3deg)}75%{transform:translateY(1px) rotate(-2deg)}100%{transform:translateY(0) rotate(0deg)}}
.platform.wobble .lily{animation:float 3.5s ease-in-out infinite, wobble .35s ease-in-out 0s 3}

#FX{position:absolute;inset:0;pointer-events:none;z-index:200}
.splash{position:absolute;width:90px;height:34px;background:rgba(255,255,255,.92);border-radius:50%;animation:splash .45s forwards;filter:drop-shadow(0 0 10px rgba(255,255,255,.25))}
@keyframes splash{to{transform:scale(2.2);opacity:0}}
.ripple{position:absolute;border:3px solid rgba(255,255,255,.92);border-radius:50%;animation:ripple 1.45s forwards;filter:drop-shadow(0 0 10px rgba(255,255,255,.15))}
@keyframes ripple{to{transform:scale(2.2);opacity:0}}
.bubble{position:absolute;border-radius:50%;background:rgba(255,255,255,.88);animation:bubble 1.7s forwards;filter:drop-shadow(0 0 10px rgba(255,255,255,.15))}
@keyframes bubble{to{transform:translate(var(--dx),var(--dy));opacity:0}}
.confetti{position:absolute;width:10px;height:14px;border-radius:4px;opacity:.95;animation:confFall 2.25s ease-in forwards;filter:drop-shadow(0 0 calc(12px * var(--neonOn)) rgba(124,249,255,.55))}
@keyframes confFall{0%{transform:translate3d(0,0,0) rotate(0deg);opacity:1}100%{transform:translate3d(var(--dx), calc(100vh + 140px), 0) rotate(720deg);opacity:0}}
.spark{position:absolute;width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.95);box-shadow:0 0 calc(22px * var(--neonOn)) rgba(124,249,255,.95);animation:spark 760ms ease-out forwards}
@keyframes spark{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--dx),var(--dy)) scale(.25);opacity:0}}
</style>
</head>
<body>
<div id="GAME">
  <div id="BG"></div>
  <div id="SCORE">‚≠ê 0</div>
  <div id="QUESTION"></div>
  <div id="TIMER">00:10</div>
  <div id="COMBO"><span id="COMBO_BOLT"></span><span id="COMBO_TXT">COMBO x1.0</span></div>
  <div id="LIVES"></div>
  <div id="START" class="btn hide">‚ñ∂ Start</div>

  <div id="START_SCREEN">
    <div id="START_CARD">
      <div id="START_TOP">
        <div id="START_ICON"></div>
        <div>
          <h1 id="START_TITLE"></h1>
          <div id="START_SUB"></div>
        </div>
      </div>

      <div class="panel">
        <h3>How to Play</h3>
        <ul class="rules">
          <li>Pick the correct answer ‚Äî move forward.</li>
          <li>Timer difficulty adapts: <span class="kbd">T1 ‚Üí T2 ‚Üí T3</span>.</li>
          <li>Combos increase your score multiplier; a mistake breaks the combo and adds a penalty.</li>
          <li>Choose a level (or all levels) and press <span class="kbd">START</span>.</li>
        </ul>
      </div>

      <div id="START_BOTTOM">
        <div class="badge">
          <span>Mode:</span>
          <select id="LEVEL">
            <option value="all" selected>All Levels</option>
          </select>
          <small>campaign or single</small>
        </div>

        <div class="badge">
          <span>Difficulty:</span>
          <select id="DIFF">
            <option value="custom" selected>Custom</option>
          </select>
          <small>settings from panel</small>
        </div>

        <button id="START_BTN" class="btn">‚ñ∂ START</button>
      </div>
    </div>
  </div>

  <div id="END">
    <div id="END_TEXT"></div>
    <div id="LEVEL_BANNER">LEVEL COMPLETE</div>
    <div id="LEVEL_NAME">Level 1</div>
    <div id="HINT_LINE"></div>

    <div id="SCORECARD">
      <div id="SCOREGRID">
        <div class="row"><div class="label">Questions</div><div id="STAT_Q" class="value">0/0</div></div>
        <div class="row"><div class="label">Lives</div><div id="STAT_L" class="value">‚ù§Ô∏è0</div></div>
        <div class="row"><div class="label">Base</div><div id="STAT_B" class="value">‚≠ê 0</div></div>
        <div class="row"><div class="label">Time Bonus</div><div id="STAT_T" class="value">‚≠ê 0</div></div>
        <div class="row"><div class="label">Combo Bonus</div><div id="STAT_C" class="value">‚≠ê 0</div></div>
        <div class="row"><div class="label">Penalties</div><div id="STAT_P" class="value">‚≠ê 0</div></div>
      </div>
      <div id="FINAL_LINE">
        <div id="FINAL_LABEL">Total Score</div>
        <div id="FINAL_SCORE">‚≠ê Score: 0</div>
      </div>
    </div>

    <div id="END_BTNS">
      <button id="NEXT_LEVEL" class="btn">‚è≠ Next Level</button>
      <button id="FINISH" class="btn dark">üèÅ Finish</button>
      <button id="RETRY" class="btn">üîÅ Play again</button>
    </div>
  </div>

  <div id="FX"></div>
  <div id="FROG"></div>
  <div id="PLATFORMS"></div>
</div>

<script>
const CFG = ${cfgJson};

const LEVELS = (CFG.levels||[]).map(l=>({
  name: l.name || "Level",
  questions: (l.questions||[]).map(q=>({
    text: q.text || "",
    answers: Array.isArray(q.answers) ? q.answers.slice(0,3) : ["A","B","C"],
    correct: Math.max(0, Math.min(2, (q.correct|0)))
  }))
}));

const BASE = (CFG.gameplay?.baseScore|0) || 100;
const MULT = (CFG.gameplay?.timeMult|0) || 10;
const WRONG_PENALTY = (CFG.gameplay?.wrongPenalty|0) || 80;
const LIVES_START = (CFG.gameplay?.lives|0) || 5;
const DIFF_PRESETS = { custom: CFG.gameplay?.diff || {t1:10,t2:7,t3:5} };

const QUESTION = document.getElementById("QUESTION");
const TIMER = document.getElementById("TIMER");
const LIVES = document.getElementById("LIVES");
const SCORE = document.getElementById("SCORE");
const PLATFORMS = document.getElementById("PLATFORMS");
const FX = document.getElementById("FX");
const GAME = document.getElementById("GAME");
const FROG = document.getElementById("FROG");
const START_SCREEN = document.getElementById("START_SCREEN");
const START_BTN = document.getElementById("START_BTN");
const DIFF = document.getElementById("DIFF");
const LEVEL = document.getElementById("LEVEL");

const COMBO_UI = document.getElementById("COMBO");
const COMBO_TXT = document.getElementById("COMBO_TXT");

const END = document.getElementById("END");
const END_TEXT = document.getElementById("END_TEXT");
const FINAL_SCORE = document.getElementById("FINAL_SCORE");
const RETRY = document.getElementById("RETRY");
const FINISH = document.getElementById("FINISH");
const NEXT_LEVEL = document.getElementById("NEXT_LEVEL");
const LEVEL_BANNER = document.getElementById("LEVEL_BANNER");
const LEVEL_NAME = document.getElementById("LEVEL_NAME");
const HINT_LINE = document.getElementById("HINT_LINE");

const STAT_Q = document.getElementById("STAT_Q");
const STAT_L = document.getElementById("STAT_L");
const STAT_B = document.getElementById("STAT_B");
const STAT_T = document.getElementById("STAT_T");
const STAT_C = document.getElementById("STAT_C");
const STAT_P = document.getElementById("STAT_P");

document.getElementById("START_TITLE").textContent = CFG.title || "Leap & Learn";
document.getElementById("START_SUB").textContent = CFG.subtitle || "";

(function fillLevelSelect(){
  LEVEL.innerHTML = '<option value="all" selected>All Levels</option>';
  LEVELS.forEach((l,idx)=>{
    const o = document.createElement("option");
    o.value = String(idx);
    o.textContent = l.name || ("Level "+(idx+1));
    LEVEL.appendChild(o);
  });
})();

let QUESTIONS=[], q=0, lives=LIVES_START, score=0, started=false, locked=false;
let timer=null, timeLeft=0;
let baseSum=0, timeBonusSum=0, comboBonusSum=0, penaltySum=0;
let correctCount=0, combo=0, maxCombo=0;
let diffKey="custom";

let levelIndex=0;
let campaignMode=false;
let campaignCompleted=false;
let finishStage=0;

let grandScore=0, grandBase=0, grandTime=0, grandCombo=0, grandPenalty=0;
let grandDone=0, grandTotal=0;

const hasWebAudio = !!(window.AudioContext||window.webkitAudioContext);
const ctx = hasWebAudio ? new (AudioContext||webkitAudioContext)() : null;

function playByCfg(scfg, synthFn){
  try{
    if(!scfg || scfg.type==="off") return;
    if(scfg.type==="synth"){
      synthFn && synthFn();
      return;
    }
    const src = (scfg.type==="upload" ? (scfg.upload||"") : (scfg.url||""));
    if(!src) return;
    const a = new Audio(src);
    a.volume = 0.9;
    a.play().catch(()=>{});
  }catch(e){}
}

function okSoundSynth(){
  if(!ctx) return;
  const t=ctx.currentTime;
  [523,659,784].forEach((f,i)=>{
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.frequency.value=f;
    g.gain.setValueAtTime(0,t+i*.12);
    g.gain.linearRampToValueAtTime(.25,t+i*.12+.05);
    g.gain.exponentialRampToValueAtTime(.001,t+i*.12+.4);
    o.connect(g);g.connect(ctx.destination);
    o.start(t+i*.12);o.stop(t+i*.12+.45);
  });
}
function loseFinalSoundSynth(){
  if(!ctx) return;
  const o=ctx.createOscillator(),g=ctx.createGain();
  o.type="sawtooth";
  o.frequency.setValueAtTime(220,ctx.currentTime);
  o.frequency.exponentialRampToValueAtTime(70,ctx.currentTime+1.4);
  g.gain.setValueAtTime(.4,ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+1.4);
  o.connect(g);g.connect(ctx.destination);
  o.start();o.stop(ctx.currentTime+1.5);
}
function waterFailSoundSynth(){
  if(!ctx) return;
  const b=ctx.createBuffer(1,ctx.sampleRate*.9,ctx.sampleRate);
  const d=b.getChannelData(0);
  for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*(1-i/d.length);
  const s=ctx.createBufferSource(),g=ctx.createGain();
  g.gain.value=.6;
  s.buffer=b;
  s.connect(g);g.connect(ctx.destination);
  s.start();
}
function fanfareSoundSynth(strength=1){
  if(!ctx) return;
  const t=ctx.currentTime;
  const master=ctx.createGain();
  master.gain.setValueAtTime(0.0,t);
  master.gain.linearRampToValueAtTime(0.95*strength,t+0.05);
  master.gain.exponentialRampToValueAtTime(0.001,t+2.8);
  master.connect(ctx.destination);

  function tone(freq, start, dur, type="sawtooth", gain=0.34){
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=type; o.frequency.value=freq;
    g.gain.setValueAtTime(0, t+start);
    g.gain.linearRampToValueAtTime(gain*strength, t+start+0.03);
    g.gain.exponentialRampToValueAtTime(0.001, t+start+dur);
    o.connect(g); g.connect(master);
    o.start(t+start); o.stop(t+start+dur+0.02);
  }
  const C5=523.25, E5=659.25, G5=783.99, C6=1046.5, E6=1318.5;
  [C5,E5,G5].forEach(f=>tone(f,0.00,0.70,"sawtooth",0.30));
  [E5,G5,C6].forEach(f=>tone(f,0.55,0.80,"sawtooth",0.28));
  [G5,C6,E6].forEach(f=>tone(f,1.15,1.05,"sawtooth",0.25));
  const arp=[C5,E5,G5,C6,E5,G5,C6,E6];
  arp.forEach((f,i)=>tone(f,0.15+i*0.10,0.22,"triangle",0.20));
}

function playOk(){ playByCfg(CFG.sounds?.ok, okSoundSynth); }
function playBad(){ playByCfg(CFG.sounds?.bad, waterFailSoundSynth); }
function playWin(){ playByCfg(CFG.sounds?.win, ()=>fanfareSoundSynth(1.0)); }
function playLose(){ playByCfg(CFG.sounds?.lose, loseFinalSoundSynth); }
function playTotal(){ playByCfg(CFG.sounds?.win, ()=>fanfareSoundSynth(1.25)); }

function waterFX(bubbles=false){
  const x=160, y=innerHeight/2+64;
  const s=document.createElement("div");
  s.className="splash";
  s.style.left=(x-45)+"px";
  s.style.top=(y-17)+"px";
  FX.appendChild(s);
  setTimeout(()=>s.remove(),520);

  for(let i=0;i<3;i++){
    const r=document.createElement("div");
    r.className="ripple";
    const size=64+i*40;
    r.style.width=r.style.height=size+"px";
    r.style.left=(x-size/2)+"px";
    r.style.top=(y-size/2)+"px";
    FX.appendChild(r);
    setTimeout(()=>r.remove(),1550);
  }

  if(bubbles){
    for(let i=0;i<20;i++){
      const b=document.createElement("div");
      b.className="bubble";
      const ss=6+Math.random()*12;
      b.style.width=b.style.height=ss+"px";
      b.style.left=(x + Math.random()*140 - 70)+"px";
      b.style.top=(y + Math.random()*34 - 17)+"px";
      b.style.setProperty("--dx",(Math.random()*140-70)+"px");
      b.style.setProperty("--dy",(-140-Math.random()*120)+"px");
      FX.appendChild(b);
      setTimeout(()=>b.remove(),1750);
    }
  }
}
function confettiBurst(power=1){
  const count=Math.floor(180*power);
  for(let i=0;i<count;i++){
    const c=document.createElement("div");
    c.className="confetti";
    const x=Math.random()*innerWidth;
    c.style.left=x+"px";
    c.style.top=(-30 - Math.random()*200)+"px";
    c.style.setProperty("--dx",(Math.random()*420-210)+"px");
    c.style.background = \`hsla(\${Math.random()*360}, 98%, 62%, .99)\`;
    FX.appendChild(c);
    setTimeout(()=>c.remove(),2700);
  }
}
function sparkBurst(cx,cy, power=1){
  const n=Math.floor(64*power);
  for(let i=0;i<n;i++){
    const sp=document.createElement("div");
    sp.className="spark";
    sp.style.left=(cx-4)+"px";
    sp.style.top=(cy-4)+"px";
    sp.style.setProperty("--dx",(Math.random()*520-260)+"px");
    sp.style.setProperty("--dy",(Math.random()*-360-40)+"px");
    sp.style.background = \`hsla(\${Math.random()*360}, 98%, 72%, .99)\`;
    sp.style.boxShadow = \`0 0 28px hsla(\${Math.random()*360}, 98%, 72%, .98)\`;
    FX.appendChild(sp);
    setTimeout(()=>sp.remove(),1100);
  }
}
function frogJump(){FROG.classList.add("jump");setTimeout(()=>FROG.classList.remove("jump"),300)}
function cameraShake(){GAME.classList.add("shake");setTimeout(()=>GAME.classList.remove("shake"),300)}
function fmt(s){ return "00:"+String(s).padStart(2,"0"); }

function shuffle(arr){
  const a=arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function randomizeQuestion(qObj){
  const packs = qObj.answers.map((txt,idx)=>({txt, idx}));
  const shuffled = shuffle(packs);
  const newAnswers = shuffled.map(x=>x.txt);
  const newCorrect = shuffled.findIndex(x=>x.idx===qObj.correct);
  return { text:qObj.text, answers:newAnswers, correct:newCorrect };
}
function totalQuestionsInAllLevels(){
  return LEVELS.reduce((s,l)=>s+(l.questions?.length||0),0);
}
function getRoundTime(){
  const d=DIFF_PRESETS[diffKey] || {t1:10,t2:7,t3:5};
  if(correctCount<3) return d.t1;
  if(correctCount<6) return d.t2;
  return d.t3;
}
function comboMultiplier(){
  const m = 1 + combo*0.12;
  return Math.min(2.0, Math.round(m*10)/10);
}
function updateComboUI(){
  if(combo<=0){
    COMBO_UI.classList.remove("show","pulse");
    return;
  }
  COMBO_UI.classList.add("show","pulse");
  setTimeout(()=>COMBO_UI.classList.remove("pulse"), 560);
  COMBO_TXT.textContent = \`COMBO x\${comboMultiplier().toFixed(1)}\`;
}
function startTimer(){
  clearInterval(timer);
  timeLeft=getRoundTime();
  TIMER.classList.remove("danger");
  TIMER.textContent=fmt(timeLeft);

  timer=setInterval(()=>{
    timeLeft--;
    if(timeLeft<=0){ clearInterval(timer); fail("time"); return; }
    TIMER.textContent=fmt(timeLeft);
    if(timeLeft<=3) TIMER.classList.add("danger");
  },1000);
}
function buildQuestionsForLevel(idx){
  const lvl = LEVELS[idx] || LEVELS[0];
  const randomized = (lvl.questions||[]).map(q=>randomizeQuestion(q));
  QUESTIONS = shuffle(randomized);
}

function render(){
  locked=!started;
  PLATFORMS.innerHTML="";
  FROG.classList.remove("sink");

  QUESTION.textContent=QUESTIONS[q]?.text || "";
  LIVES.textContent="‚ù§Ô∏è".repeat(lives);
  SCORE.textContent="‚≠ê "+score;

  updateComboUI();

  const STEP=190,y=innerHeight/2;
  const count=Math.ceil((innerWidth-160)/STEP)+4;

  for(let i=0;i<count;i++){
    const d=document.createElement("div");
    d.className="platform";
    d.style.left=160+STEP*i-75+"px";
    d.style.top=y-75+"px";

    const lily=document.createElement("div");
    lily.className="lily";

    if(i>0 && QUESTIONS[q] && i<=QUESTIONS[q].answers.length){
      lily.textContent=QUESTIONS[q].answers[i-1];
      d.classList.add("answer");
      d.onclick=()=>pick(i,d);
    }

    d.appendChild(lily);
    PLATFORMS.appendChild(d);
  }
}

function pick(i,el){
  if(!started||locked) return;
  locked=true;
  clearInterval(timer);
  frogJump();

  document.querySelectorAll(".platform")
    .forEach(p=>p.style.transform=\`translateX(\${-(el.offsetLeft+75-160)}px)\`);

  setTimeout(()=>{
    const isCorrect = (i-1===QUESTIONS[q].correct);
    if(isCorrect){
      playOk();
      waterFX(false);

      const basePts = BASE;
      const timePts = timeLeft*MULT;

      baseSum += basePts;
      timeBonusSum += timePts;

      combo++;
      maxCombo = Math.max(maxCombo, combo);

      const mult = comboMultiplier();
      const comboBonus = Math.round((basePts + timePts) * (mult-1));
      comboBonusSum += comboBonus;

      score += basePts + timePts + comboBonus;
      correctCount++;

      sparkBurst(innerWidth/2, innerHeight*0.35, 0.9);

      q++;
      if(q>=QUESTIONS.length) showEnd(true);
      else startRound();
    }else{
      fail("wrong");
    }
  },500);
}

function fail(reason){
  lives--;

  if(combo>0) combo=0;
  updateComboUI();

  const penalty = WRONG_PENALTY;
  penaltySum += penalty;
  score = Math.max(0, score - penalty);

  playBad();
  waterFX(true);
  cameraShake();
  FROG.classList.add("sink");

  document.querySelectorAll(".platform").forEach(p=>{
    p.classList.add("fade","wrong","wobble");
    setTimeout(()=>p.classList.remove("wobble"), 900);
  });

  setTimeout(()=>{ lives<=0 ? showEnd(false) : startRound(); },900);
}

function startRound(){
  locked=false;
  render();
  startTimer();
}

function fillLevelTable(){
  const done = Math.min(q, QUESTIONS.length);
  STAT_Q.textContent = \`\${done}/\${QUESTIONS.length}\`;
  STAT_L.textContent = "‚ù§Ô∏è" + lives;
  STAT_B.textContent = "‚≠ê " + baseSum;
  STAT_T.textContent = "‚≠ê " + timeBonusSum;
  STAT_C.textContent = "‚≠ê " + comboBonusSum;
  STAT_P.textContent = "‚≠ê " + penaltySum;
  FINAL_SCORE.textContent="‚≠ê Score: "+score;
}

function pushLevelToGrand(){
  grandScore += score;
  grandBase  += baseSum;
  grandTime  += timeBonusSum;
  grandCombo += comboBonusSum;
  grandPenalty += penaltySum;
  grandDone += Math.min(q, QUESTIONS.length);
}

function showTotalResults(){
  LEVEL_BANNER.textContent = "TOTAL RESULTS";
  LEVEL_NAME.textContent = "Game Completed";
  HINT_LINE.textContent = "";

  END_TEXT.textContent = (CFG.texts?.total || "GAME COMPLETED!");
  END_TEXT.className = "win";

  STAT_Q.textContent = \`\${grandDone}/\${grandTotal}\`;
  STAT_L.textContent = "‚ù§Ô∏è" + lives;
  STAT_B.textContent = "‚≠ê " + grandBase;
  STAT_T.textContent = "‚≠ê " + grandTime;
  STAT_C.textContent = "‚≠ê " + grandCombo;
  STAT_P.textContent = "‚≠ê " + grandPenalty;
  FINAL_SCORE.textContent = "‚≠ê Score: " + grandScore;

  NEXT_LEVEL.style.display="none";
  FINISH.textContent = "üè† Back to Menu";

  playTotal();
  confettiBurst(1.8);
  sparkBurst(innerWidth/2, innerHeight*0.22, 1.7);
  setTimeout(()=>confettiBurst(1.4), 220);
  setTimeout(()=>sparkBurst(innerWidth/2, innerHeight*0.30, 1.8), 340);
  setTimeout(()=>sparkBurst(innerWidth/2, innerHeight*0.38, 1.4), 560);
}

function showEnd(win){
  clearInterval(timer);
  END.classList.add("show");

  const lvlName = (LEVELS[levelIndex]?.name) || \`Level \${levelIndex+1}\`;
  LEVEL_NAME.textContent = campaignMode ? \`\${lvlName} (Campaign)\` : lvlName;

  finishStage=0;
  FINISH.textContent="üèÅ Finish";

  const last = (levelIndex >= LEVELS.length-1);

  if(win){
    END_TEXT.textContent = (CFG.texts?.win || "CONGRATULATIONS!");
    END_TEXT.className="win";
    LEVEL_BANNER.textContent="LEVEL COMPLETE";

    playWin();
    confettiBurst(1.2);
    sparkBurst(innerWidth/2, innerHeight*0.22, 1.2);
    setTimeout(()=>confettiBurst(1.0), 220);
    setTimeout(()=>sparkBurst(innerWidth/2, innerHeight*0.35, 1.1), 420);

    if(campaignMode && last){
      campaignCompleted=true;
      HINT_LINE.textContent = (CFG.texts?.hintCampaign || "");
      NEXT_LEVEL.style.display="none";
    }else{
      campaignCompleted=false;
      HINT_LINE.textContent = "";
      NEXT_LEVEL.style.display = (last ? "none" : "inline-block");
    }
  }else{
    END_TEXT.textContent = (CFG.texts?.lose || "YOU LOST!");
    END_TEXT.className="lose";
    LEVEL_BANNER.textContent="TRY AGAIN";
    HINT_LINE.textContent="";
    campaignCompleted=false;
    NEXT_LEVEL.style.display="none";
    playLose();
  }

  fillLevelTable();
}

function resetState(){
  q=0; lives=LIVES_START; score=0; started=false; locked=false;
  baseSum=0; timeBonusSum=0; comboBonusSum=0; penaltySum=0;
  correctCount=0; combo=0; maxCombo=0;
  clearInterval(timer);
  END.classList.remove("show");
  END_TEXT.className="";
  COMBO_UI.classList.remove("show","pulse");
  TIMER.classList.remove("danger");

  finishStage=0;
  campaignCompleted=false;
  HINT_LINE.textContent="";
  FINISH.textContent="üèÅ Finish";

  TIMER.textContent=fmt(getRoundTime());
}

function startLevel(idx){
  levelIndex = Math.max(0, Math.min(LEVELS.length-1, idx));
  buildQuestionsForLevel(levelIndex);

  resetState();
  START_SCREEN.style.display="none";
  started=true;

  render();
  startRound();
}

function startCampaign(){
  campaignMode=true;
  levelIndex=0;

  grandScore=0; grandBase=0; grandTime=0; grandCombo=0; grandPenalty=0;
  grandDone=0;
  grandTotal = totalQuestionsInAllLevels();

  startLevel(0);
}

DIFF.onchange=()=>{ diffKey="custom"; };

START_BTN.onclick=()=>{
  if(ctx) ctx.resume().catch(()=>{});
  const v = (LEVEL.value||"all");
  if(v==="all") startCampaign();
  else{
    campaignMode=false;
    grandScore=grandBase=grandTime=grandCombo=grandPenalty=grandDone=0;
    grandTotal=0;
    startLevel(parseInt(v,10)||0);
  }
};

RETRY.onclick=()=>{
  resetState();
  campaignMode=false;
  START_SCREEN.style.display="flex";
  render();
};

NEXT_LEVEL.onclick=()=>{
  if(ctx) ctx.resume().catch(()=>{});
  if(campaignMode) pushLevelToGrand();
  const next = levelIndex+1;
  if(next >= LEVELS.length) return;
  startLevel(next);
};

FINISH.onclick=()=>{
  if(ctx) ctx.resume().catch(()=>{});

  if(campaignMode && campaignCompleted && finishStage===0){
    pushLevelToGrand();
    finishStage=1;
    showTotalResults();
    return;
  }

  resetState();
  campaignMode=false;
  START_SCREEN.style.display="flex";
  render();
};

window.addEventListener("resize", ()=>{
  if(started && !END.classList.contains("show")) render();
});

diffKey="custom";
TIMER.textContent = fmt(getRoundTime());
render();
</script>
</body>
</html>`;
}

/* =========================================================
   UPDATE PREVIEW + GENERATED IFRAME
========================================================= */
function updateAll(){
  // keep level count synced
  const cnt = clampInt($("LEVEL_COUNT").value, 1, 12, 3);
  const currentCards = document.querySelectorAll("[id^='LVL_TXT_']").length;
  if(currentCards !== cnt){
    buildLevelsUI(cnt);
  }
  const cfg = buildConfig();
  const srcdoc = buildGameSrcdoc(cfg);

  PREVIEW.srcdoc = srcdoc;

  const iframeCode =
`<iframe style="width:100%;height:100%;border:0" srcdoc='${escapeForSingleQuotedAttr(srcdoc)}'></iframe>`;
  CODE.value = iframeCode;
}

/* =========================================================
   SOUND TEST (–≤ –ø–∞–Ω–µ–ª–∏)
========================================================= */
async function panelSoundTest(which){
  // We test using panel-side audio, so user can hear before copying.
  // Synth tests mimic the game.
  const type = $(which+"_TYPE").value;
  const url = $(which+"_URL").value.trim();
  const uploadKey = ({
    "S_OK":"okUpload","S_BAD":"badUpload","S_WIN":"winUpload","S_LOSE":"loseUpload"
  })[which];

  // small synth set
  const has = !!(window.AudioContext||window.webkitAudioContext);
  const c = has ? new (AudioContext||webkitAudioContext)() : null;

  function okSynth(){
    if(!c) return;
    const t=c.currentTime;
    [523,659,784].forEach((f,i)=>{
      const o=c.createOscillator(),g=c.createGain();
      o.frequency.value=f;
      g.gain.setValueAtTime(0,t+i*.12);
      g.gain.linearRampToValueAtTime(.25,t+i*.12+.05);
      g.gain.exponentialRampToValueAtTime(.001,t+i*.12+.4);
      o.connect(g);g.connect(c.destination);
      o.start(t+i*.12);o.stop(t+i*.12+.45);
    });
  }
  function badSynth(){
    if(!c) return;
    const b=c.createBuffer(1,c.sampleRate*.9,c.sampleRate);
    const d=b.getChannelData(0);
    for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*(1-i/d.length);
    const s=c.createBufferSource(),g=c.createGain();
    g.gain.value=.6; s.buffer=b; s.connect(g); g.connect(c.destination); s.start();
  }
  function loseSynth(){
    if(!c) return;
    const o=c.createOscillator(),g=c.createGain();
    o.type="sawtooth";
    o.frequency.setValueAtTime(220,c.currentTime);
    o.frequency.exponentialRampToValueAtTime(70,c.currentTime+1.2);
    g.gain.setValueAtTime(.35,c.currentTime);
    g.gain.exponentialRampToValueAtTime(.001,c.currentTime+1.2);
    o.connect(g);g.connect(c.destination);
    o.start();o.stop(c.currentTime+1.25);
  }
  function winSynth(){
    if(!c) return;
    const t=c.currentTime;
    const master=c.createGain();
    master.gain.setValueAtTime(0.0,t);
    master.gain.linearRampToValueAtTime(0.95,t+0.05);
    master.gain.exponentialRampToValueAtTime(0.001,t+2.2);
    master.connect(c.destination);
    function tone(freq,start,dur,type="sawtooth",gain=0.28){
      const o=c.createOscillator(),g=c.createGain();
      o.type=type;o.frequency.value=freq;
      g.gain.setValueAtTime(0,t+start);
      g.gain.linearRampToValueAtTime(gain,t+start+0.03);
      g.gain.exponentialRampToValueAtTime(0.001,t+start+dur);
      o.connect(g);g.connect(master);
      o.start(t+start);o.stop(t+start+dur+0.02);
    }
    const C5=523.25,E5=659.25,G5=783.99,C6=1046.5;
    [C5,E5,G5].forEach(f=>tone(f,0.0,0.6,"sawtooth",0.26));
    [E5,G5,C6].forEach(f=>tone(f,0.45,0.7,"triangle",0.22));
  }

  try{
    if(type==="off") return;
    if(type==="synth"){
      if(which==="S_OK") okSynth();
      if(which==="S_BAD") badSynth();
      if(which==="S_WIN") winSynth();
      if(which==="S_LOSE") loseSynth();
      return;
    }
    const src = (type==="upload") ? (STATE.sounds[uploadKey]||"") : url;
    if(!src) return;
    const a = new Audio(src);
    a.volume = 0.95;
    await a.play();
  }catch(e){}
}

/* =========================================================
   EVENTS
========================================================= */
$("BTN_REBUILD_LEVELS").onclick = ()=>updateAll();

$("LEVEL_COUNT").addEventListener("input", debounce(()=>{ buildLevelsUI(clampInt($("LEVEL_COUNT").value,1,12,3)); updateAll(); }, 120));
$("BG_PRESET").addEventListener("change", updateAll);
$("BG_URL").addEventListener("input", debounce(updateAll, 250));
$("CHAR_PRESET").addEventListener("change", updateAll);
$("PLAT_PRESET").addEventListener("change", updateAll);
$("PANEL_COLOR").addEventListener("input", updateAll);
$("TIMER_COLOR").addEventListener("input", updateAll);
$("NEON_ON").addEventListener("change", updateAll);
$("START_OVERLAY").addEventListener("input", updateAll);
$("END_OVERLAY").addEventListener("input", updateAll);
$("FONT_COLOR").addEventListener("input", updateAll);
$("Q_FONT_SIZE").addEventListener("input", debounce(updateAll, 200));
$("GAME_TITLE").addEventListener("input", debounce(updateAll, 200));
$("GAME_SUB").addEventListener("input", debounce(updateAll, 200));

$("DIFF_PRESET").addEventListener("change", ()=>{
  // set values immediately, then update
  getDiff();
  updateAll();
});
["T1","T2","T3","WRONG_PENALTY","LIVES","BASE_SCORE","TIME_MULT"].forEach(id=>{
  $(id).addEventListener("input", debounce(()=>{
    $("DIFF_PRESET").value="custom";
    updateAll();
  }, 200));
});

["TXT_WIN","TXT_LOSE","TXT_TOTAL","TXT_HINT"].forEach(id=>{
  $(id).addEventListener("input", debounce(updateAll, 200));
});

$("BTN_REFRESH").onclick = ()=>updateAll();

$("BTN_OPEN_SRC").onclick = ()=>{
  const w = window.open("", "_blank");
  if(!w) return;
  w.document.open();
  w.document.write("<pre style='white-space:pre-wrap;word-break:break-word;font:12px ui-monospace,monospace; padding:16px; background:#0b1020; color:#eaf6ff;'>" +
    escAttr(PREVIEW.srcdoc || "") + "</pre>");
  w.document.close();
};

$("BTN_COPY").onclick = async ()=>{
  try{
    await navigator.clipboard.writeText(CODE.value);
  }catch(e){
    CODE.focus();
    CODE.select();
    document.execCommand("copy");
  }
};

$("BTN_COPY_PANEL").onclick = async ()=>{
  // This assumes user will host this panel on GitHub Pages:
  // They can paste their own URL here after deployment.
  const hintUrl = "https://YOUR-USERNAME.github.io/Leap-and-Learn-Panel/";
  const panelIframe = `<iframe style="width:100%;height:720px;border:0" src="${hintUrl}"></iframe>`;
  try{
    await navigator.clipboard.writeText(panelIframe);
  }catch(e){
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –°–∫–æ–ø–∏—Ä—É–π –≤—Ä—É—á–Ω—É—é –∏–∑ alert.");
  }
  alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ (—à–∞–±–ª–æ–Ω). –ó–∞–º–µ–Ω–∏ YOUR-USERNAME –∏ –ø—É—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π GitHub Pages URL:\n\n"+panelIframe);
};

$("BTN_RESET").onclick = ()=>{
  // quick hard reset
  location.reload();
};

$("BG_FILE").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const dataUrl = await readFileAsDataURL(f);
  STATE.bgCustomDataUrl = dataUrl;
  $("BG_PRESET").value = "custom";
  $("BG_URL").value = "";
  updateAll();
});

// Sound file uploads
$("S_OK_FILE").addEventListener("change", async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  STATE.sounds.okUpload = await readFileAsDataURL(f);
  $("S_OK_TYPE").value="upload";
  updateAll();
});
$("S_BAD_FILE").addEventListener("change", async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  STATE.sounds.badUpload = await readFileAsDataURL(f);
  $("S_BAD_TYPE").value="upload";
  updateAll();
});
$("S_WIN_FILE").addEventListener("change", async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  STATE.sounds.winUpload = await readFileAsDataURL(f);
  $("S_WIN_TYPE").value="upload";
  updateAll();
});
$("S_LOSE_FILE").addEventListener("change", async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  STATE.sounds.loseUpload = await readFileAsDataURL(f);
  $("S_LOSE_TYPE").value="upload";
  updateAll();
});

["S_OK","S_BAD","S_WIN","S_LOSE"].forEach(prefix=>{
  $(prefix+"_TYPE").addEventListener("change", updateAll);
  $(prefix+"_URL").addEventListener("input", debounce(updateAll, 250));
});

$("S_OK_TEST").onclick = ()=>panelSoundTest("S_OK");
$("S_BAD_TEST").onclick = ()=>panelSoundTest("S_BAD");
$("S_WIN_TEST").onclick = ()=>panelSoundTest("S_WIN");
$("S_LOSE_TEST").onclick = ()=>panelSoundTest("S_LOSE");

/* =========================================================
   INIT
========================================================= */
(function init(){
  // build initial levels UI based on default count
  buildLevelsUI(clampInt($("LEVEL_COUNT").value,1,12,3));

  // make sure correct diff preset values are shown
  $("DIFF_PRESET").value = "classic";
  getDiff();

  // initial build
  updateAll();
})();
</script>


========================================================== 
</body>
</html>
