<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Leap & Learn Editor - The Original</title>
<style>
  :root { --primary: #7cf9ff; --dark: #0a1730; --panel: #142342; --text: #eaf6ff; }
  body { margin:0; display:flex; height:100vh; background: #050b1a; color: var(--text); font-family: 'Segoe UI', sans-serif; overflow:hidden; }
  
  /* EDITOR SIDEBAR */
  #EDITOR { width: 480px; background: var(--dark); border-right: 1px solid #333; display:flex; flex-direction:column; z-index:10; box-shadow: 4px 0 15px rgba(0,0,0,0.5); }
  #EDITOR_HEADER { padding:15px; background:var(--panel); border-bottom:1px solid #333; display:flex; align-items:center; justify-content:space-between; }
  #EDITOR_HEADER h2 { margin:0; font-size:18px; color:var(--primary); }
  
  #TABS { display:flex; background:#000; flex-wrap:wrap; }
  .tab { flex:1; min-width:70px; padding:10px 5px; text-align:center; cursor:pointer; background:#111; color:#777; border-bottom:3px solid transparent; font-size:11px; font-weight:bold; transition:0.2s; }
  .tab:hover { color:#fff; background:#1a1a1a; }
  .tab.active { background:var(--panel); color:var(--primary); border-bottom:3px solid var(--primary); }
  
  #CONTROLS { flex:1; overflow-y:auto; padding:20px; }
  
  /* FORM ELEMENTS */
  .group { margin-bottom:25px; border-bottom:1px solid #222; padding-bottom:20px; }
  .group h3 { margin:0 0 15px; font-size:13px; color:var(--primary); text-transform:uppercase; letter-spacing:1px; opacity:0.8; }
  
  label { display:block; font-size:11px; margin-bottom:4px; margin-top:10px; color:#ccc; font-weight:600; }
  input[type="text"], input[type="number"], select, textarea { 
    width:100%; box-sizing:border-box; padding:8px; background:#080f20; border:1px solid #333; color:#fff; border-radius:4px; font-size:12px;
  }
  input[type="color"] { width:100%; height:30px; border:none; background:none; cursor:pointer; padding:0; }
  input[type="checkbox"] { transform: scale(1.5); margin-right: 10px; cursor: pointer; }
  
  .row { display:flex; gap:10px; align-items: center; }
  .col { flex:1; }

  /* BULK EDITOR */
  .level-item { background:rgba(255,255,255,0.03); border:1px solid #333; margin-bottom:10px; border-radius:6px; overflow:hidden; }
  .level-header { padding:10px; background:rgba(255,255,255,0.05); cursor:pointer; font-weight:bold; display:flex; justify-content:space-between; align-items:center; font-size:13px; }
  .level-content { padding:10px; display:none; border-top:1px solid #333; }
  .level-content.show { display:block; }
  .bulk-container { display:flex; gap:10px; height:180px; }
  .bulk-col { flex:1; display:flex; flex-direction:column; }
  .bulk-area { flex:1; resize:none; font-family: monospace; font-size:11px; white-space:pre; background:#050a15; border:1px solid #444; color:#aaddff; padding:5px; }

  /* BUTTONS */
  .btn { width:100%; padding:12px; cursor:pointer; background:var(--primary); color:#000; font-weight:bold; border:none; border-radius:4px; margin-top:10px; }
  .btn:hover { filter:brightness(1.1); }
  .btn.danger { background:transparent; color:#ff3b3b; width:auto; padding:4px; margin:0; }

  /* PREVIEW */
  #PREVIEW_AREA { flex:1; background:#000; display:flex; flex-direction:column; }
  #PREVIEW_BAR { height:40px; background:#111; display:flex; align-items:center; justify-content:center; gap:20px; border-bottom:1px solid #333; }
  .view-btn { padding:5px 15px; border-radius:15px; background:#222; color:#888; cursor:pointer; font-size:12px; border:1px solid #333; }
  .view-btn.active { background:var(--primary); color:#000; font-weight:bold; border-color:var(--primary); }
  iframe { border:none; width:100%; flex:1; background:#0a1730; }
  
  /* COPY MODAL */
  #COPY_MODAL { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; display:none; align-items:center; justify-content:center; flex-direction:column; }
  #COPY_MODAL textarea { width:600px; height:300px; margin-bottom:15px; }
</style>
</head>
<body>

<div id="EDITOR">
  <div id="EDITOR_HEADER"><h2>üê∏ Leap & Learn: Original Engine</h2></div>
  <div id="TABS">
    <div class="tab active" onclick="setTab('visuals')">–í–ò–ó–£–ê–õ</div>
    <div class="tab" onclick="setTab('fonts')">–®–†–ò–§–¢–´</div>
    <div class="tab" onclick="setTab('texts')">–¢–ï–ö–°–¢–´</div>
    <div class="tab" onclick="setTab('gameplay')">–ì–ï–ô–ú–ü–õ–ï–ô</div>
    <div class="tab" onclick="setTab('levels')">–£–†–û–í–ù–ò</div>
  </div>
  
  <div id="CONTROLS">
    <!-- VISUALS TAB -->
    <div id="tab-visuals">
      <div class="group">
        <h3>üé® –°—Ü–µ–Ω–∞</h3>
        <label>–õ–æ–∫–∞—Ü–∏—è</label>
        <select id="bgSelect" onchange="toggleCustom('bgSelect','bgCustom'); updatePreview()">
          <option value="river">–†–µ–∫–∞</option>
          <option value="lava">–õ–∞–≤–∞</option>
          <option value="swamp">–ë–æ–ª–æ—Ç–æ</option>
          <option value="custom">–°–≤–æ—è —Å—Å—ã–ª–∫–∞...</option>
        </select>
        <input type="text" id="bgCustom" style="display:none;margin-top:5px" oninput="updatePreview()" placeholder="https://...">

        <label>–ü–µ—Ä—Å–æ–Ω–∞–∂</label>
        <select id="charSelect" onchange="toggleCustom('charSelect','charCustom'); updatePreview()">
          <option value="frog">–õ—è–≥—É—à–∫–∞</option>
          <option value="chameleon">–•–∞–º–µ–ª–µ–æ–Ω</option>
          <option value="lizard">–Ø—â–µ—Ä–∏—Ü–∞</option>
          <option value="custom">–°–≤–æ—è —Å—Å—ã–ª–∫–∞...</option>
        </select>
        <input type="text" id="charCustom" style="display:none;margin-top:5px" oninput="updatePreview()" placeholder="https://...">

        <label>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
        <select id="platSelect" onchange="toggleCustom('platSelect','platCustom'); updatePreview()">
          <option value="lily">–õ–∏–ª–∏—è</option>
          <option value="stone">–ö–∞–º–µ–Ω—å</option>
          <option value="mound">–ö–æ—á–∫–∞</option>
          <option value="custom">–°–≤–æ—è —Å—Å—ã–ª–∫–∞...</option>
        </select>
        <input type="text" id="platCustom" style="display:none;margin-top:5px" oninput="updatePreview()" placeholder="https://...">
      </div>
      <div class="group">
        <h3>‚ú® –¶–≤–µ—Ç–∞</h3>
        <label>–ù–µ–æ–Ω–æ–≤—ã–π –∞–∫—Ü–µ–Ω—Ç</label>
        <input type="color" id="colNeon" value="#7cf9ff" oninput="updatePreview()">
      </div>
      <div class="group">
        <h3>üè† –≠–∫—Ä–∞–Ω –ü—Ä–∞–≤–∏–ª</h3>
        <div class="row" style="margin-top:10px;">
           <input type="checkbox" id="transparentBg" onchange="updatePreview()">
           <label for="transparentBg" style="margin:0; color:#fff">–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω (–í–∏–¥–Ω–∞ —Ä–µ–∫–∞)</label>
        </div>
        <br>
        <label>–ï—Å–ª–∏ –Ω–µ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π, —Ç–æ —Ü–≤–µ—Ç:</label>
        <div class="row">
           <input type="color" id="colOverlay" value="#0a1730" oninput="updatePreview()">
           <input type="number" id="opOverlay" value="95" min="0" max="100" style="width:60px" oninput="updatePreview()" title="% –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏">
        </div>
      </div>
    </div>

    <!-- FONTS TAB -->
    <div id="tab-fonts" style="display:none">
      <div class="group">
        <h3>‚ùì –í–æ–ø—Ä–æ—Å</h3>
        <div class="row">
          <div class="col"><label>–¶–≤–µ—Ç</label><input type="color" id="qCol" value="#0b1630" oninput="updatePreview()"></div>
          <div class="col"><label>–†–∞–∑–º–µ—Ä</label><input type="number" id="qSize" value="40" oninput="updatePreview()"></div>
        </div>
        <label>–®—Ä–∏—Ñ—Ç</label>
        <select id="qFont" onchange="updatePreview()">
           <option value="Arial, sans-serif">Arial</option>
           <option value="'Courier New', monospace">Courier New</option>
           <option value="'Verdana', sans-serif">Verdana</option>
           <option value="'Comic Sans MS', cursive">Comic Sans</option>
        </select>
      </div>

      <div class="group">
        <h3>üçÄ –û—Ç–≤–µ—Ç—ã</h3>
        <div class="row">
          <div class="col"><label>–¶–≤–µ—Ç</label><input type="color" id="ansCol" value="#141414" oninput="updatePreview()"></div>
          <div class="col"><label>–†–∞–∑–º–µ—Ä</label><input type="number" id="ansSize" value="18" oninput="updatePreview()"></div>
        </div>
      </div>

      <div class="group">
        <h3>‚è±Ô∏è –¢–∞–π–º–µ—Ä</h3>
        <div class="row">
          <div class="col"><label>–¶–≤–µ—Ç —Ü–∏—Ñ—Ä</label><input type="color" id="timeCol" value="#053149" oninput="updatePreview()"></div>
          <div class="col"><label>–†–∞–∑–º–µ—Ä</label><input type="number" id="timeSize" value="20" oninput="updatePreview()"></div>
        </div>
      </div>

      <div class="group">
        <h3>‚ñ∂ –ö–Ω–æ–ø–∫–∏ (Start/Next)</h3>
        <div class="row">
          <div class="col"><label>–¢–µ–∫—Å—Ç</label><input type="color" id="btnCol" value="#043149" oninput="updatePreview()"></div>
          <div class="col"><label>–§–æ–Ω</label><input type="color" id="btnBg" value="#ffffff" oninput="updatePreview()"></div>
        </div>
      </div>
    </div>

    <!-- TEXTS TAB -->
    <div id="tab-texts" style="display:none">
      <div class="group">
        <h3>–ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</h3>
        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä—ã</label><input type="text" id="txtTitle" value="Leap & Learn" oninput="updatePreview()">
        <label>–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label><input type="text" id="txtSub" value="Fast quiz game" oninput="updatePreview()">
        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∞–≤–∏–ª</label><input type="text" id="txtRulesH" value="How to Play" oninput="updatePreview()">
        <label>–¢–µ–∫—Å—Ç –ø—Ä–∞–≤–∏–ª (HTML)</label>
        <textarea id="txtRules" oninput="updatePreview()" rows="3"><li>Pick correct answer.</li><li>Watch the timer!</li></textarea>
        <label>–ö–Ω–æ–ø–∫–∞ –°—Ç–∞—Ä—Ç</label><input type="text" id="btnStartTxt" value="‚ñ∂ START" oninput="updatePreview()">
      </div>
      <div class="group">
        <h3>–§–∏–Ω–∞–ª</h3>
        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ü–æ–±–µ–¥—ã</label><input type="text" id="txtWin" value="CONGRATULATIONS!" oninput="updatePreview()">
        <label>–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label><input type="text" id="txtLevelComp" value="LEVEL COMPLETE" oninput="updatePreview()">
        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ü—Ä–æ–∏–≥—Ä—ã—à–∞</label><input type="text" id="txtLose" value="YOU LOST!" oninput="updatePreview()">
        <label>–ö–Ω–æ–ø–∫–∞ –î–∞–ª–µ–µ</label><input type="text" id="btnNextTxt" value="‚è≠ Next Level" oninput="updatePreview()">
        <label>–ö–Ω–æ–ø–∫–∞ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</label><input type="text" id="btnRetryTxt" value="üîÅ Play again" oninput="updatePreview()">
      </div>
    </div>

    <!-- GAMEPLAY TAB -->
    <div id="tab-gameplay" style="display:none">
      <div class="group">
        <h3>‚è±Ô∏è –¢–∞–π–º–µ—Ä</h3>
        <div class="row">
          <div class="col"><label>–°—Ç–∞—Ä—Ç (—Å–µ–∫)</label><input type="number" id="t1" value="10"></div>
          <div class="col"><label>–°–µ—Ä–µ–¥–∏–Ω–∞</label><input type="number" id="t2" value="7"></div>
          <div class="col"><label>–§–∏–Ω–∞–ª</label><input type="number" id="t3" value="5"></div>
        </div>
      </div>
      <div class="group">
        <h3>üîä –ó–≤—É–∫–∏</h3>
        <p style="font-size:10px;color:#888">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–≤—É–∫–∏ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –∫–æ–¥–∞ (—Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä)!</p>
        <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (URL)</label><input type="text" id="audWin">
        <label>–û—à–∏–±–∫–∞ / –ü–ª—é—Ö (URL)</label><input type="text" id="audFail">
        <label>–§–∏–Ω–∞–ª: –ü–æ–±–µ–¥–∞ (URL)</label><input type="text" id="audFinalWin">
        <label>–§–∏–Ω–∞–ª: –ü—Ä–æ–∏–≥—Ä—ã—à (URL)</label><input type="text" id="audFinalLose">
      </div>
    </div>

    <!-- LEVELS TAB -->
    <div id="tab-levels" style="display:none">
      <div id="levelsContainer"></div>
      <button class="btn" style="background:#333; color:#fff; border:1px dashed #555" onclick="addLevel()">+ –î–û–ë–ê–í–ò–¢–¨ –£–†–û–í–ï–ù–¨</button>
    </div>

    <br>
    <button class="btn" style="background:var(--accent); padding:16px;" onclick="generateCode()">üìã –ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î –î–õ–Ø GENIALLY</button>
  </div>
</div>

<div id="PREVIEW_AREA">
  <div id="PREVIEW_BAR">
    <div class="view-btn active" id="btnRules" onclick="toggleView('rules')">üëÅÔ∏è –ü—Ä–∞–≤–∏–ª–∞</div>
    <div class="view-btn" id="btnGame" onclick="toggleView('game')">üéÆ –ò–≥—Ä–∞</div>
  </div>
  <iframe id="previewFrame"></iframe>
</div>

<div id="COPY_MODAL">
  <h2 style="color:#fff">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥:</h2>
  <textarea id="finalCode" onclick="this.select()"></textarea>
  <button class="btn" style="width:200px" onclick="document.getElementById('COPY_MODAL').style.display='none'">–ó–ê–ö–†–´–¢–¨</button>
</div>

<script>
/* ASSETS DB */
const ASSETS={
  bg:{river:"https://img.genially.com/67961b32a116fb001568a75e/c0c9010f-c3dd-42c1-b7c1-65024fa3aec6.png",lava:"https://img.genially.com/67961b32a116fb001568a75e/fa2ab459-fec9-4ccd-97e3-254427b4ade0.png",swamp:"https://img.genially.com/67961b32a116fb001568a75e/02b52ad4-9d31-4b21-a305-8fec6e8a4487.png"},
  char:{frog:"https://img.genially.com/67961b32a116fb001568a75e/3074df22-5c73-4ad2-b0b2-491c6fc247f3.png",chameleon:"https://img.genially.com/67961b32a116fb001568a75e/74b56fcf-5354-43dd-9c9a-f50facc9a9bf.png",lizard:"https://img.genially.com/67961b32a116fb001568a75e/0feda2a1-485a-4654-8640-bf1adcc9f9ec.png"},
  plat:{lily:"https://img.genially.com/67961b32a116fb001568a75e/ed6c6e82-953b-43d4-947d-e46227b760f0.png",stone:"https://img.genially.com/67961b32a116fb001568a75e/bad37c6d-f04c-45c0-b954-807d79ec3a95.png",mound:"https://img.genially.com/67961b32a116fb001568a75e/c6775617-bde5-43e4-9da8-5332d928807e.png"}
};

let levels=[{name:"Level 1",q:"I ____ a new bike.\nShe ____ got a brother.\nWe ____ a big house.\nHe ____ blue eyes.\nThey ____ two cats.\nIt ____ got long ears.\n____ you got a pen?\n____ she got a sister?",a:"have got | has got | is got\nhas | have | is\nhave got | has got | are got\nhas got | have got | haven't\nhave got | has got | is got\nhas | have | had\nHave | Has | Do\nHas | Have | Does"}];
let viewMode='rules';

/* EDITOR UI */
function setTab(t){document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));event.target.classList.add('active');document.querySelectorAll('#CONTROLS > div').forEach(d=>d.style.display='none');document.getElementById('tab-'+t).style.display='block';}
function toggleCustom(s,i){document.getElementById(i).style.display=(document.getElementById(s).value==='custom')?'block':'none';}

function renderLevels(){
  const c=document.getElementById('levelsContainer');c.innerHTML='';
  levels.forEach((l,i)=>{
    const d=document.createElement('div');d.className='level-item';
    const qc = l.q.split('\n').filter(x=>x.trim()).length;
    d.innerHTML=`<div class="level-header" onclick="this.nextElementSibling.classList.toggle('show')"><span>${l.name} (${qc})</span><button class="btn danger" onclick="event.stopPropagation();remLevel(${i})">üóëÔ∏è</button></div>
    <div class="level-content"><label>–ò–º—è</label><input value="${l.name}" oninput="levels[${i}].name=this.value;renderLevels()">
    <div class="bulk-container"><div class="bulk-col"><label>–í–û–ü–†–û–°–´</label><textarea class="bulk-area" oninput="levels[${i}].q=this.value;upd()">${l.q}</textarea></div>
    <div class="bulk-col"><label>–û–¢–í–ï–¢–´ (–í–µ—Ä–Ω—ã–π | –ù–µ–≤–µ—Ä–Ω—ã–π | –ù–µ–≤–µ—Ä–Ω—ã–π)</label><textarea class="bulk-area" oninput="levels[${i}].a=this.value;upd()">${l.a}</textarea></div></div></div>`;
    c.appendChild(d);
  });
}
function addLevel(){levels.push({name:"New Level",q:"",a:""});renderLevels();upd();}
function remLevel(i){if(confirm("Del?")){levels.splice(i,1);renderLevels();upd();}}

/* GENERATOR */
function getGameHTML(){
  const g=(id)=>document.getElementById(id).value;
  const bg=g('bgSelect')==='custom'?g('bgCustom'):ASSETS.bg[g('bgSelect')];
  const ch=g('charSelect')==='custom'?g('charCustom'):ASSETS.char[g('charSelect')];
  const pl=g('platSelect')==='custom'?g('platCustom'):ASSETS.plat[g('platSelect')];
  
  const isTransparent = document.getElementById('transparentBg').checked;
  const overlayCol = isTransparent ? 'rgba(0,0,0,0)' : g('colOverlay');
  const overlayOp = isTransparent ? 0 : (g('opOverlay')/100);

  // PARSE
  const parsedLevels = levels.map(l=>{
    const qs=l.q.split('\n').filter(x=>x.trim()), as=l.a.split('\n').filter(x=>x.trim());
    return { name:l.name, questions: qs.map((txt,i)=>{
       const ans = (as[i]||"True|False").split('|').map(x=>x.trim());
       return {text:txt, answers:ans, correct:0}; 
    })};
  });

  // GAME CSS
  const css = `
<style>
:root{
  --neon-main:${g('colNeon')};
  --font-q:${g('qFont')}; --col-q:${g('qCol')}; --sz-q:${g('qSize')}px;
  --font-ans:${g('qFont')}; --col-ans:${g('ansCol')}; --sz-ans:${g('ansSize')}px;
  --col-tm:${g('timeCol')}; --sz-tm:${g('timeSize')}px;
  --col-btn:${g('btnCol')}; --bg-btn:${g('btnBg')};
  --overlay: ${overlayCol}; --overlay-op: ${overlayOp};
  --danger:#ff3b3b;
  --win:#ffe44d;
}
html,body{margin:0;width:100%;height:100%;overflow:hidden;font-family:Arial;background:#0a1730}
#GAME{position:relative;width:100%;height:100%}
#GAME.shake{animation:shake .25s}
@keyframes shake{0%{transform:translate(0)}25%{transform:translate(-4px,3px)}50%{transform:translate(4px,-3px)}75%{transform:translate(-3px,2px)}100%{transform:translate(0)}}
#BG{position:absolute;inset:0;z-index:0;background:url("${bg}") center/cover no-repeat}

/* UI */
#SCORE{position:absolute;top:30px;left:30px;font-size:20px;font-weight:900;z-index:20;color:#fff;text-shadow:0 2px 0 rgba(0,0,0,.35)}
#TIMER{
  position:absolute;top:26px;left:120px;transform:none;
  height:38px;border-radius:18px;display:flex;align-items:center;justify-content:center;gap:10px;padding:0 14px;
  background:rgba(255,255,255,.95); border:2px solid var(--neon-main); box-shadow:0 0 18px var(--neon-main);
  z-index:20; font-weight:900; 
  color:var(--col-tm); font-size:var(--sz-tm);
}
#CLOCK_ICON{width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;filter:drop-shadow(0 0 10px var(--neon-main))}
#TIMER.danger{border-color:var(--danger);color:var(--danger);box-shadow:0 0 25px var(--danger);animation:timerPulse .8s infinite}
@keyframes timerPulse{50%{transform:scale(1.07)}}
#LIVES{position:absolute;top:30px;right:30px;font-size:26px;z-index:20}

/* QUESTION */
#QUESTION{position:absolute;top:18px;width:100%;display:flex;justify-content:center;z-index:20}
#QUESTION_TXT{
  padding:10px 18px;border-radius:18px;background:rgba(255,255,255,.72);
  border:1px solid rgba(124,249,255,.40);box-shadow:0 0 18px rgba(124,249,255,.25);
  font-weight:900; text-shadow:0 2px 0 rgba(0,0,0,.18);
  color:var(--col-q); font-family:var(--font-q); font-size:var(--sz-q);
}

/* COMBO */
#COMBO{position:absolute;top:165px;left:50%;transform:translateX(-50%);z-index:20;padding:10px 16px;border-radius:18px;background:rgba(255,255,255,.88);border:2px solid var(--neon-main);font-weight:900;color:#043149;display:none;gap:10px;align-items:center}
#COMBO.show{display:inline-flex}
#COMBO_BOLT{width:18px;height:18px;border-radius:6px;background:rgba(124,249,255,.25);box-shadow:0 0 14px rgba(124,249,255,.75);display:inline-block}
#COMBO.pulse{animation:comboPulse .55s ease}
@keyframes comboPulse{0%{transform:translateX(-50%) translateY(10px) scale(.92); opacity:0} 40%{transform:translateX(-50%) translateY(0px) scale(1.14); opacity:1} 100%{transform:translateX(-50%) translateY(0px) scale(1); opacity:1}}
#COMBO.shine{animation:comboShine .85s ease-in-out infinite}
@keyframes comboShine{0%,100%{box-shadow:0 0 22px rgba(124,249,255,.75)} 50%{box-shadow:0 0 34px var(--neon-main)}}

/* BUTTONS */
.btn{
  padding:12px 34px;border-radius:16px;font-weight:900;border:2px solid var(--neon-main);box-shadow:0 0 15px var(--neon-main);cursor:pointer;
  color:var(--col-btn); background:var(--bg-btn); font-size:16px; margin-top:10px;
}
.btn:active{transform:translateY(1px)}
.btn.dark{background:rgba(255,255,255,.10);color:#eaf6ff;border:2px solid rgba(124,249,255,.55)}

/* START SCREEN */
#START_SCREEN{position:absolute;inset:0;z-index:60;display:flex;align-items:center;justify-content:center;background:var(--overlay);opacity:var(--overlay-op)}
#START_CARD{
  width:min(760px, calc(100vw - 40px));
  border-radius:26px;
  background:linear-gradient(180deg, rgba(10,20,50,.92), rgba(5,10,25,.92));
  border:2px solid var(--neon-main);
  box-shadow:0 0 30px var(--neon-main);
  padding:24px;
  color:#eaf6ff;
  position:relative;
}
#START_CARD::before{content:"";position:absolute;inset:-40%;background:radial-gradient(circle at 30% 30%, rgba(124,249,255,.18), transparent 50%);transform:rotate(10deg);animation:cardGlow 3.2s ease-in-out infinite;pointer-events:none}
@keyframes cardGlow{0%,100%{opacity:.55;transform:rotate(10deg) translateX(-10px)} 50%{opacity:1;transform:rotate(10deg) translateX(10px)}}
#START_ICON{width:80px;height:80px;background:url("${ch}") no-repeat center/contain}

/* END SCREEN */
#END{position:absolute;inset:0;z-index:50;background:rgba(8,16,34,.92);display:none;align-items:center;justify-content:center;flex-direction:column}
#END.show{display:flex}
#END_TEXT{font-size:50px;font-weight:900;margin:0 0 10px;text-align:center; z-index:201; position:relative}
#LEVEL_BANNER{z-index:201; position:relative; margin-bottom:10px;padding:14px 18px;border-radius:20px;background:rgba(255,255,255,.1);border:1px solid var(--win);color:#fff7cf;font-weight:900}
#HINT_LINE{margin-bottom:10px;color:#cfefff}
#SCORECARD{
  width:min(600px, calc(100vw - 40px));
  background:rgba(255,255,255,.10);
  border:2px solid var(--neon-main);
  border-radius:22px;
  padding:18px;
  margin:10px 0 16px;
  color:#eaf6ff;
  z-index:201; position:relative;
}
.row{display:flex;justify-content:space-between;background:rgba(255,255,255,.08);padding:10px 14px;border-radius:12px;margin-bottom:6px;border:1px solid rgba(124,249,255,.35)}
.value{font-weight:900}
#FINAL_LINE{margin-top:10px;border-top:2px solid var(--neon-main);padding-top:10px;display:flex;justify-content:space-between;font-size:1.2em;font-weight:bold}
.win{color:var(--win);text-shadow:0 0 12px var(--win)}
.lose{color:var(--danger);text-shadow:0 0 12px var(--danger)}
#END_BTNS{z-index:201; position:relative; display:flex; gap:10px;}

/* GAME OBJECTS */
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(6px)}}
#FROG_WRAP{position:absolute;left:calc(160px - 17mm + 15mm - 11mm);top:calc(50% + 13mm - 11mm);width:110px;height:110px;z-index:15;pointer-events:none;animation:float 3.5s ease-in-out infinite}
#FROG{width:110px;height:110px;background:url("${ch}") no-repeat center/contain;position:absolute;left:50%;top:50%;transform:translate(-50%,-65%);transition:transform .6s ease,opacity .6s ease}
#FROG.jump{transform:translate(-50%,-95%) scale(1.05)}
#FROG.sink{transform:translate(-50%,-10%) scale(.6);opacity:0}
/* GLOW AURA */
#FROG.aura::after{
  content:"";position:absolute;left:50%;top:52%;width:140px;height:140px;transform:translate(-50%,-50%);
  border-radius:50%;
  background:radial-gradient(circle,rgba(255,228,77,.4),transparent 70%);
  box-shadow:0 0 40px var(--neon-main), inset 0 0 20px var(--neon-main);
  animation:pulse .5s ease-in-out 2;
}
@keyframes pulse{0%{transform:translate(-50%,-50%) scale(.9);opacity:.8} 50%{transform:translate(-50%,-50%) scale(1.1);opacity:1} 100%{transform:translate(-50%,-50%) scale(.9);opacity:.8}}

#PLATFORMS{position:absolute;inset:0;z-index:10}
.platform{position:absolute;width:150px;height:150px;transition:transform .5s,opacity .6s}
.lily{
  width:150px;height:150px;background:url("${pl}") no-repeat center/contain;display:flex;align-items:center;justify-content:center;
  font-weight:900; animation:float 3.5s ease-in-out infinite;
  color:var(--col-ans); font-family:var(--font-ans); font-size:var(--sz-ans);
  text-shadow:0 2px 0 rgba(255,255,255,.65), 0 0 10px rgba(0,0,0,.35);
  cursor:pointer;
}
.platform.fade{opacity:0}
.platform.wrong .lily{filter:drop-shadow(0 0 18px red)}
.wobble .lily{animation:wobble .35s ease-in-out 3}
@keyframes wobble{0%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(1px) rotate(-3deg)}50%{transform:translateY(0) rotate(3deg)}75%{transform:translateY(1px) rotate(-2deg)}100%{transform:translateY(0) rotate(0deg)}}

/* FX - Z-INDEX 300 to be on top of everything */
#FX{position:absolute;inset:0;pointer-events:none;z-index:300}

/* Confetti */
.confetti{position:absolute;width:12px;height:12px;background:#f0f;animation:fall 2.5s linear forwards}
@keyframes fall{to{transform:translateY(100vh) rotate(720deg)}}

/* Spark */
.spark{position:absolute;width:8px;height:8px;background:#ff0;border-radius:50%;box-shadow:0 0 20px #ff0;animation:spark 1s ease-out forwards}
@keyframes spark{to{transform:translate(var(--dx),var(--dy));opacity:0}}

/* Bubble */
.bubble{position:absolute;border-radius:50%;background:rgba(255,255,255,.8);animation:bubble 2s forwards;box-shadow:0 0 10px rgba(255,255,255,0.5)}
@keyframes bubble{to{transform:translate(var(--dx),var(--dy));opacity:0}}

/* Splash */
.splash{position:absolute;width:90px;height:34px;background:rgba(255,255,255,0.9);border-radius:50%;animation:splash .5s forwards;filter:drop-shadow(0 0 10px #fff)}
@keyframes splash{to{transform:scale(2.2);opacity:0}}
.ripple{position:absolute;border:3px solid rgba(255,255,255,0.9);border-radius:50%;animation:ripple 1.5s forwards}
@keyframes ripple{to{transform:scale(2.5);opacity:0}}
.goldSpark{position:absolute;width:6px;height:6px;border-radius:50%;background:rgba(255,228,77,.98);box-shadow:0 0 18px rgba(255,228,77,.95), 0 0 10px rgba(255,228,77,.65);animation:goldSpark 820ms ease-out forwards}
@keyframes goldSpark{0%{transform:translate(0,0) scale(1);opacity:1} 100%{transform:translate(var(--dx),var(--dy)) scale(.2);opacity:0}}
</style>`;

  // GAME JS - SAFE SCRIPT
  const jsStart = "<scr" + "ipt>";
  const jsEnd = "</scr" + "ipt>";
  const js = jsStart + `
const LEVELS=${JSON.stringify(parsedLevels)};
const CFG={
  t1:${g('t1')},t2:${g('t2')},t3:${g('t3')},
  win:"${g('audWin')}",fail:"${g('audFail')}",fWin:"${g('audFinalWin')}",fLose:"${g('audFinalLose')}",
  txtWin:"${g('txtWin')}",txtLose:"${g('txtLose')}",txtLvl:"${g('txtLevelComp')}"
};
const TEXTS={
  h:"${g('txtTitle')}",s:"${g('txtSub')}",rh:"${g('txtRulesH')}",r:\`${g('txtRules')}\`,
  b1:"${g('btnStartTxt')}",b2:"${g('btnNextTxt')}",b3:"${g('btnRetryTxt')}"
};

// --- RESTORED ORIGINAL VARS ---
const BASE=100; const MULT=10; const WRONG_PENALTY=80; const LIVES_START=5;
const Q_TXT=document.getElementById("QUESTION_TXT"); const T=document.getElementById("TIMER"); const T_TXT=document.getElementById("TIMER_TXT"); const L=document.getElementById("LIVES"), S=document.getElementById("SCORE"), P=document.getElementById("PLATFORMS"); const FX=document.getElementById("FX"); const GAME=document.getElementById("GAME"); const FROG=document.getElementById("FROG");
const START_SCREEN=document.getElementById("START_SCREEN"); const START_BTN=document.getElementById("START_BTN");
const COMBO_UI=document.getElementById("COMBO"); const COMBO_TXT=document.getElementById("COMBO_TXT");
const END=document.getElementById("END"); const END_TEXT=document.getElementById("END_TEXT"); const FINAL_SCORE=document.getElementById("FINAL_SCORE"); const RETRY=document.getElementById("RETRY"); const FINISH=document.getElementById("FINISH"); const NEXT_LEVEL=document.getElementById("NEXT_LEVEL"); const LEVEL_BANNER=document.getElementById("LEVEL_BANNER"); const LEVEL_NAME=document.getElementById("LEVEL_NAME"); const HINT_LINE=document.getElementById("HINT_LINE");
const STAT_Q=document.getElementById("STAT_Q"); const STAT_L=document.getElementById("STAT_L"); const STAT_B=document.getElementById("STAT_B"); const STAT_T=document.getElementById("STAT_T"); const STAT_C=document.getElementById("STAT_C"); const STAT_P=document.getElementById("STAT_P");

let QUESTIONS=[]; let q=0, lives=LIVES_START, score=0, started=false, locked=false; let timer=null, timeLeft=0;
let baseSum=0, timeBonusSum=0, comboBonusSum=0, penaltySum=0; let correctCount=0, combo=0, maxCombo=0;
let levelIndex=0; let campaignMode=false; let campaignCompleted=false; let finishStage=0;
let grandScore=0, grandBase=0, grandTime=0, grandCombo=0, grandPenalty=0; let grandDone=0, grandTotal=0;

const ctx=new (AudioContext||webkitAudioContext)();

function okSound(){
  const t=ctx.currentTime;
  [523,659,784].forEach((f,i)=>{const o=ctx.createOscillator(),g=ctx.createGain();o.frequency.value=f;g.gain.setValueAtTime(0,t+i*.12);g.gain.linearRampToValueAtTime(.25,t+i*.12+.05);g.gain.exponentialRampToValueAtTime(.001,t+i*.12+.4);o.connect(g);g.connect(ctx.destination);o.start(t+i*.12);o.stop(t+i*.12+.45);});
}
function tickSound(){
  const t=ctx.currentTime; const o=ctx.createOscillator(), g=ctx.createGain(); o.type="square"; o.frequency.setValueAtTime(1800, t); g.gain.setValueAtTime(0.0001, t); g.gain.linearRampToValueAtTime(0.12, t+0.01); g.gain.exponentialRampToValueAtTime(0.0001, t+0.08); o.connect(g); g.connect(ctx.destination); o.start(t); o.stop(t+0.09);
}
function comboJoySound(){
  const t=ctx.currentTime; const master=ctx.createGain(); master.gain.setValueAtTime(0.0001,t); master.gain.linearRampToValueAtTime(0.35,t+0.02); master.gain.exponentialRampToValueAtTime(0.0001,t+0.35); master.connect(ctx.destination);
  const notes=[880,1175,1568]; notes.forEach((f,i)=>{const o=ctx.createOscillator(), g=ctx.createGain(); o.type="triangle"; o.frequency.setValueAtTime(f,t+i*0.06); g.gain.setValueAtTime(0.0001,t+i*0.06); g.gain.linearRampToValueAtTime(0.22,t+i*0.06+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+i*0.06+0.20); o.connect(g); g.connect(master); o.start(t+i*0.06); o.stop(t+i*0.06+0.22);});
}
function turboSound(intensity=1){
  const t=ctx.currentTime; const master=ctx.createGain(); master.gain.setValueAtTime(0.0001,t); master.gain.linearRampToValueAtTime(0.22*intensity,t+0.02); master.gain.exponentialRampToValueAtTime(0.0001,t+0.28); master.connect(ctx.destination);
  const buf=ctx.createBuffer(1, ctx.sampleRate*0.25, ctx.sampleRate); const data=buf.getChannelData(0); for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*(1-i/data.length);
  const src=ctx.createBufferSource(); src.buffer=buf; const bp=ctx.createBiquadFilter(); bp.type="bandpass"; bp.Q.value=0.9; bp.frequency.setValueAtTime(300,t); bp.frequency.exponentialRampToValueAtTime(1800,t+0.22); src.connect(bp); bp.connect(master); src.start(t);
}
function cameraKick(strength=1){
  const dx = 2.2*strength; const dy = -1.2*strength;
  try{GAME.animate([{ transform:"translate(0,0)" }, { transform:\`translate(\${dx}px,\${dy}px)\` }, { transform:"translate(0,0)" }], { duration:140, easing:"ease-out" });}catch(e){}
}
function loseFinalSound(){
  const o=ctx.createOscillator(),g=ctx.createGain(); o.type="sawtooth"; o.frequency.setValueAtTime(220,ctx.currentTime); o.frequency.exponentialRampToValueAtTime(70,ctx.currentTime+1.4); g.gain.setValueAtTime(.4,ctx.currentTime); g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+1.4); o.connect(g);g.connect(ctx.destination); o.start();o.stop(ctx.currentTime+1.5);
}
function waterFailSound(){
  const b=ctx.createBuffer(1,ctx.sampleRate*.9,ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*(1-i/d.length);
  const s=ctx.createBufferSource(),g=ctx.createGain(); g.gain.value=.6; s.buffer=b; s.connect(g);g.connect(ctx.destination); s.start();
}
function fanfareSound(strength=1){
  const t=ctx.currentTime; const master=ctx.createGain(); master.gain.setValueAtTime(0.0,t); master.gain.linearRampToValueAtTime(0.95*strength,t+0.05); master.gain.exponentialRampToValueAtTime(0.001,t+2.8); master.connect(ctx.destination);
  function tone(freq, start, dur, type="sawtooth", gain=0.34){ const o=ctx.createOscillator(), g=ctx.createGain(); o.type=type; o.frequency.value=freq; g.gain.setValueAtTime(0, t+start); g.gain.linearRampToValueAtTime(gain*strength, t+start+0.03); g.gain.exponentialRampToValueAtTime(0.001, t+start+dur); o.connect(g); g.connect(master); o.start(t+start); o.stop(t+start+dur+0.02);}
  const C5=523.25, E5=659.25, G5=783.99, C6=1046.5, E6=1318.5; [C5,E5,G5].forEach(f=>tone(f,0.00,0.70,"sawtooth",0.30)); [E5,G5,C6].forEach(f=>tone(f,0.55,0.80,"sawtooth",0.28)); [G5,C6,E6].forEach(f=>tone(f,1.15,1.05,"sawtooth",0.25)); const arp=[C5,E5,G5,C6,E5,G5,C6,E6]; arp.forEach((f,i)=>tone(f,0.15+i*0.10,0.22,"triangle",0.20));
}
function playWinSound(){ if(CFG.win) new Audio(CFG.win).play(); else fanfareSound(1.0); }
function playTotalSound(){ fanfareSound(1.25); }

function waterFX(bubbles=false){
  const x=160, y=window.innerHeight/2+64;
  const s=document.createElement("div"); s.className="splash"; s.style.left=(x-45)+"px"; s.style.top=(y-17)+"px"; FX.appendChild(s); setTimeout(()=>s.remove(),520);
  for(let i=0;i<3;i++){const r=document.createElement("div"); r.className="ripple"; const size=64+i*40; r.style.width=r.style.height=size+"px"; r.style.left=(x-size/2)+"px"; r.style.top=(y-size/2)+"px"; FX.appendChild(r); setTimeout(()=>r.remove(),1550);}
  if(bubbles){for(let i=0;i<20;i++){const b=document.createElement("div"); b.className="bubble"; const ss=6+Math.random()*12; b.style.width=b.style.height=ss+"px"; b.style.left=(x + Math.random()*140 - 70)+"px"; b.style.top=(y + Math.random()*34 - 17)+"px"; b.style.setProperty("--dx",(Math.random()*140-70)+"px"); b.style.setProperty("--dy",(-140-Math.random()*120)+"px"); FX.appendChild(b); setTimeout(()=>b.remove(),1750);}}
}
function confettiBurst(power=1){
  const count=Math.floor(180*power); for(let i=0;i<count;i++){const c=document.createElement("div"); c.className="confetti"; const x=Math.random()*window.innerWidth; c.style.left=x+"px"; c.style.top=(-30 - Math.random()*200)+"px"; c.style.setProperty("--dx",(Math.random()*420-210)+"px"); c.style.background = \`hsla(\${Math.random()*360}, 98%, 62%, .99)\`; FX.appendChild(c); setTimeout(()=>c.remove(),2700);}
}
function sparkBurst(cx,cy, power=1){
  const n=Math.floor(64*power); for(let i=0;i<n;i++){const sp=document.createElement("div"); sp.className="spark"; sp.style.left=(cx-4)+"px"; sp.style.top=(cy-4)+"px"; sp.style.setProperty("--dx",(Math.random()*520-260)+"px"); sp.style.setProperty("--dy",(Math.random()*-360-40)+"px"); sp.style.background = \`hsla(\${Math.random()*360}, 98%, 72%, .99)\`; sp.style.boxShadow = \`0 0 28px hsla(\${Math.random()*360}, 98%, 72%, .98)\`; FX.appendChild(sp); setTimeout(()=>sp.remove(),1100);}
}
function comboEnergyFX(strength=1){
  const r = FROG.getBoundingClientRect(); const cx = r.left + r.width*0.50; const cy = r.top  + r.height*0.56;
  const count = Math.floor(14 + strength*10); for(let i=0;i<count;i++){const p=document.createElement("div"); p.className="goldSpark"; p.style.left=(cx + (Math.random()*40-20))+"px"; p.style.top =(cy + (Math.random()*36-18))+"px"; const dx = (Math.random()*220-110) * (0.45 + strength*0.15); const dy = (Math.random()*-180-30) * (0.55 + strength*0.12); p.style.setProperty("--dx", dx+"px"); p.style.setProperty("--dy", dy+"px"); FX.appendChild(p); setTimeout(()=>p.remove(), 900);}
}
function showComboAura(){
  const c = combo; const strength = Math.min(1.0, 0.45 + c*0.12); const dur = Math.min(1000, 600 + c*80);
  const blur1 = Math.min(46, 18 + c*6); const blur2 = Math.min(92, 40 + c*10); const scale = Math.min(1.35, 1.02 + c*0.04); const opacity = Math.min(0.95, 0.55 + c*0.08);
  FROG.style.setProperty("--auraBlur1", blur1+"px"); FROG.style.setProperty("--auraBlur2", blur2+"px"); FROG.style.setProperty("--auraScale",  scale.toFixed(2)); FROG.style.setProperty("--auraOpacity", opacity.toFixed(2));
  FROG.classList.remove("aura"); void FROG.offsetWidth; FROG.classList.add("aura"); setTimeout(()=>FROG.classList.remove("aura"), dur);
  comboEnergyFX(strength); turboSound(0.75 + strength*0.55); cameraKick(0.55 + strength*0.35);
}
function frogJump(){FROG.classList.add("jump");setTimeout(()=>FROG.classList.remove("jump"),300)}
function cameraShake(){GAME.classList.add("shake");setTimeout(()=>GAME.classList.remove("shake"),300)}
function fmt(s){ return "00:"+String(s).padStart(2,"0"); }
function shuffle(arr){const a=arr.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a;}
function randomizeQuestion(qObj){const packs = qObj.answers.map((txt,idx)=>({txt, idx})); const shuffled = shuffle(packs); const newAnswers = shuffled.map(x=>x.txt); const newCorrect = shuffled.findIndex(x=>x.idx===qObj.correct); return { text:qObj.text, answers:newAnswers, correct:newCorrect };}
function totalQuestionsInAllLevels(){return LEVELS.reduce((s,l)=>s+(l.questions?.length||0),0);}
function getRoundTime(){const d={t1:CFG.t1,t2:CFG.t2,t3:CFG.t3}; if(correctCount<3) return d.t1; if(correctCount<6) return d.t2; return d.t3;}
function comboMultiplier(){const m = 1 + combo*0.12; return Math.min(2.0, Math.round(m*10)/10);}
function updateComboUI(){if(combo<=0){COMBO_UI.classList.remove("show","pulse","shine"); return;} COMBO_UI.classList.add("show","pulse","shine"); setTimeout(()=>COMBO_UI.classList.remove("pulse"), 560); COMBO_TXT.textContent = \`COMBO x\${comboMultiplier().toFixed(1)}\`;}
function startTimer(){clearInterval(timer); timeLeft=getRoundTime(); T.classList.remove("danger"); T_TXT.textContent=fmt(timeLeft); timer=setInterval(()=>{timeLeft--; if(timeLeft<=0){ clearInterval(timer); fail("time"); return; } T_TXT.textContent=fmt(timeLeft); if(timeLeft<=3){ T.classList.add("danger"); tickSound(); } else T.classList.remove("danger");},1000);}
function buildQuestionsForLevel(idx){const lvl = LEVELS[idx] || LEVELS[0]; const randomized = (lvl.questions||[]).map(q=>randomizeQuestion(q)); QUESTIONS = shuffle(randomized);}
function render(){locked=!started; P.innerHTML=""; FROG.classList.remove("sink"); Q_TXT.textContent=QUESTIONS[q]?.text || ""; L.textContent="‚ù§Ô∏è".repeat(lives); S.textContent="‚≠ê "+score; updateComboUI(); const STEP=190, y=window.innerHeight/2 + 76; const count=Math.ceil((window.innerWidth-160)/STEP)+4; for(let i=0;i<count;i++){const d=document.createElement("div"); d.className="platform"; d.style.left=160+STEP*i-75+"px"; d.style.top=y-75+"px"; const lily=document.createElement("div"); lily.className="lily"; if(i>0 && QUESTIONS[q] && i<=QUESTIONS[q].answers.length){lily.textContent=QUESTIONS[q].answers[i-1]; d.classList.add("answer"); d.onclick=()=>pick(i,d);} d.appendChild(lily); P.appendChild(d);}}
function pick(i,el){if(!started||locked) return; locked=true; clearInterval(timer); frogJump(); document.querySelectorAll(".platform").forEach(p=>p.style.transform=\`translateX(\${-(el.offsetLeft+75-160)}px)\`); setTimeout(()=>{const isCorrect = (i-1===QUESTIONS[q].correct); if(isCorrect){okSound(); waterFX(false); const basePts = BASE; const timePts = timeLeft*MULT; baseSum += basePts; timeBonusSum += timePts; combo++; maxCombo = Math.max(maxCombo, combo); const mult = comboMultiplier(); const comboBonus = Math.round((basePts + timePts) * (mult-1)); comboBonusSum += comboBonus; score += basePts + timePts + comboBonus; correctCount++; if(combo>=2){comboJoySound(); showComboAura();} sparkBurst(window.innerWidth/2, window.innerHeight*0.35, 0.9); q++; if(q>=QUESTIONS.length) showEnd(true); else startRound();}else{fail("wrong");}},500);}
function fail(reason){lives--; if(combo>0) combo=0; updateComboUI(); const penalty = WRONG_PENALTY; penaltySum += penalty; score = Math.max(0, score - penalty); FROG.classList.remove("aura"); if(CFG.fail) new Audio(CFG.fail).play(); else waterFailSound(); waterFX(true); cameraShake(); FROG.classList.add("sink"); document.querySelectorAll(".platform").forEach(p=>{p.classList.add("fade","wrong","wobble"); setTimeout(()=>p.classList.remove("wobble"), 900);}); setTimeout(()=>{ lives<=0 ? showEnd(false) : startRound(); },900);}
function startRound(){locked=false; render(); startTimer();}
function fillLevelTable(){const done = Math.min(q, QUESTIONS.length); STAT_Q.textContent = \`\${done}/\${QUESTIONS.length}\`; STAT_L.textContent = "‚ù§Ô∏è" + lives; STAT_B.textContent = "‚≠ê " + baseSum; STAT_T.textContent = "‚≠ê " + timeBonusSum; STAT_C.textContent = "‚≠ê " + comboBonusSum; STAT_P.textContent = "‚≠ê " + penaltySum; FINAL_SCORE.textContent="‚≠ê Score: "+score;}
function pushLevelToGrand(){grandScore += score; grandBase  += baseSum; grandTime  += timeBonusSum; grandCombo += comboBonusSum; grandPenalty += penaltySum; grandDone += Math.min(q, QUESTIONS.length);}
function showTotalResults(){LEVEL_BANNER.textContent = "TOTAL RESULTS"; LEVEL_NAME.textContent = "Game Completed"; HINT_LINE.textContent = ""; END_TEXT.textContent = "GAME COMPLETED!"; END_TEXT.className = "win"; STAT_Q.textContent = \`\${grandDone}/\${grandTotal}\`; STAT_L.textContent = "‚ù§Ô∏è" + lives; STAT_B.textContent = "‚≠ê " + grandBase; STAT_T.textContent = "‚≠ê " + grandTime; STAT_C.textContent = "‚≠ê " + grandCombo; STAT_P.textContent = "‚≠ê " + grandPenalty; FINAL_SCORE.textContent = "‚≠ê Score: " + grandScore; NEXT_LEVEL.style.display="none"; FINISH.textContent = "üè† Back to Menu"; playTotalSound(); confettiBurst(1.8); sparkBurst(window.innerWidth/2, window.innerHeight*0.22, 1.7); setTimeout(()=>confettiBurst(1.4), 220); setTimeout(()=>sparkBurst(window.innerWidth/2, window.innerHeight*0.30, 1.8), 340); setTimeout(()=>sparkBurst(window.innerWidth/2, window.innerHeight*0.38, 1.4), 560);}
function showEnd(win){clearInterval(timer); END.classList.add("show"); const lvlName = (LEVELS[levelIndex]?.name) || \`Level \${levelIndex+1}\`; LEVEL_NAME.textContent = campaignMode ? \`\${lvlName} (Campaign)\` : lvlName; finishStage=0; FINISH.textContent="üèÅ Finish"; const last = (levelIndex >= LEVELS.length-1); if(win){END_TEXT.textContent="${g('txtWin')}"; END_TEXT.className="win"; LEVEL_BANNER.textContent="LEVEL COMPLETE"; playWinSound(); confettiBurst(1.2); sparkBurst(window.innerWidth/2, window.innerHeight*0.22, 1.2); setTimeout(()=>confettiBurst(1.0), 220); setTimeout(()=>sparkBurst(window.innerWidth/2, window.innerHeight*0.35, 1.1), 420); if(campaignMode && last){campaignCompleted=true; HINT_LINE.textContent = "All levels cleared ‚Äî press Finish to see Total Results"; NEXT_LEVEL.style.display="none";}else{campaignCompleted=false; HINT_LINE.textContent = ""; NEXT_LEVEL.style.display = (last ? "none" : "inline-block");}}else{END_TEXT.textContent="${g('txtLose')}"; END_TEXT.className="lose"; LEVEL_BANNER.textContent="TRY AGAIN"; HINT_LINE.textContent=""; campaignCompleted=false; NEXT_LEVEL.style.display="none"; if(CFG.fLose) new Audio(CFG.fLose).play(); else loseFinalSound();} fillLevelTable();}
function resetState(){q=0; lives=LIVES_START; score=0; started=false; locked=false; baseSum=0; timeBonusSum=0; comboBonusSum=0; penaltySum=0; correctCount=0; combo=0; maxCombo=0; clearInterval(timer); END.classList.remove("show"); END_TEXT.className=""; COMBO_UI.classList.remove("show","pulse","shine"); T.classList.remove("danger"); FROG.classList.remove("aura"); finishStage=0; campaignCompleted=false; HINT_LINE.textContent=""; FINISH.textContent="üèÅ Finish"; T_TXT.textContent=fmt(getRoundTime());}
function startLevel(idx){levelIndex = Math.max(0, Math.min(LEVELS.length-1, idx)); buildQuestionsForLevel(levelIndex); resetState(); START_SCREEN.style.display="none"; started=true; render(); startRound();}
function startCampaign(){campaignMode=true; levelIndex=0; grandScore=0; grandBase=0; grandTime=0; grandCombo=0; grandPenalty=0; grandDone=0; grandTotal = totalQuestionsInAllLevels(); startLevel(0);}
START_BTN.onclick=()=>{ctx.resume(); startCampaign();};
RETRY.onclick=()=>{resetState(); campaignMode=false; START_SCREEN.style.display="flex"; render();};
NEXT_LEVEL.onclick=()=>{ctx.resume(); if(campaignMode) pushLevelToGrand(); const next = levelIndex+1; if(next >= LEVELS.length) return; startLevel(next);};
FINISH.onclick=()=>{ctx.resume(); if(campaignMode && campaignCompleted && finishStage===0){pushLevelToGrand(); finishStage=1; showTotalResults(); return;} resetState(); campaignMode=false; START_SCREEN.style.display="flex"; render();};
window.addEventListener("resize", ()=>{if(started && !END.classList.contains("show")) render();});
T_TXT.textContent = fmt(getRoundTime()); render();
// --- ORIGINAL ENGINE END ---
<` + `/script>
</body>
</html>`;
}

function upd() {
  document.getElementById('frame').srcdoc = getHTML();
}
function genCode() {
  document.getElementById('finalCode').value = `<iframe style="width:100%;height:100%;border:0" srcdoc='${getHTML().replace(/'/g, "&#39;")}'></iframe>`;
  document.getElementById('MODAL').style.display = 'flex';
}

// Init
renderLevels();
upd();
</script>
</body>
</html>
