<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Leap & Learn: Ultimate Editor</title>
<style>
  /* --- СТИЛИ РЕДАКТОРА (ТВОЙ ИНТЕРФЕЙС) --- */
  :root { --primary: #7cf9ff; --dark: #0a1730; --panel: #142342; --text: #eaf6ff; --accent: #4dff88; }
  body { margin:0; display:flex; height:100vh; background: #050b1a; color: var(--text); font-family: 'Segoe UI', sans-serif; overflow:hidden; }
  
  /* БОКОВАЯ ПАНЕЛЬ */
  #EDITOR { width: 480px; min-width: 480px; background: var(--dark); border-right: 1px solid #333; display:flex; flex-direction:column; z-index:10; box-shadow: 4px 0 15px rgba(0,0,0,0.3); }
  #EDITOR_HEADER { padding:15px; background:var(--panel); border-bottom:1px solid #333; display:flex; align-items:center; justify-content:space-between; }
  #EDITOR_HEADER h2 { margin:0; font-size:18px; color:var(--primary); letter-spacing: 1px; }
  
  #TABS { display:flex; background:#000; flex-wrap:wrap; border-bottom: 1px solid #333; }
  .tab { flex:1; min-width:60px; padding:12px 5px; text-align:center; font-size:11px; font-weight:bold; cursor:pointer; opacity:0.6; transition:0.2s; border-bottom:2px solid transparent; text-transform:uppercase; }
  .tab:hover { opacity:1; background:rgba(255,255,255,0.05); }
  .tab.active { opacity:1; border-bottom-color:var(--primary); background:rgba(124,249,255,0.1); color: var(--primary); }
  
  #CONTENT { flex:1; overflow-y:auto; padding:20px; scrollbar-width:thin; scrollbar-color: #334155 #0a1730; }
  .group { background:var(--panel); border:1px solid #2a3b5a; border-radius:8px; padding:15px; margin-bottom:15px; position:relative; }
  .group h3 { margin:0 0 15px 0; font-size:12px; text-transform:uppercase; color:var(--primary); border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:8px; }
  
  .row { display:flex; gap:10px; align-items:center; margin-bottom:10px; }
  label { display:block; font-size:11px; color:#aaa; margin-bottom:4px; }
  input, select, textarea { width:100%; box-sizing:border-box; background:#050b1a; border:1px solid #334155; color:#fff; padding:8px; border-radius:4px; font-family:monospace; font-size:12px; }
  input:focus, textarea:focus { border-color:var(--primary); outline:none; }
  input[type="color"] { height:35px; padding:0; cursor:pointer; }
  textarea { resize:vertical; min-height:60px; }

  .btn { width:100%; padding:10px; background:var(--primary); color:#000; border:none; border-radius:4px; cursor:pointer; font-weight:bold; text-transform:uppercase; font-size:12px; transition:0.2s; }
  .btn:hover { filter:brightness(1.1); box-shadow: 0 0 10px rgba(124,249,255,0.3); }
  .btn-copy { background:#fff; width:auto; padding:5px 15px; font-size:10px; }
  .btn-del { background:#ff3b3b; color:#fff; width:auto; padding:5px 10px; margin-left:10px; }
  .btn-add { background:var(--accent); margin-top:10px; }

  /* ПРЕВЬЮ */
  #PREVIEW { flex:1; background:#000; position:relative; display:flex; flex-direction:column; }
  iframe { border:none; width:100%; flex:1; }
  
  /* МОДАЛКА УРОВНЕЙ */
  #MODAL { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:1000; align-items:center; justify-content:center; }
  .modal-box { width:90%; max-width:800px; height:80vh; background:var(--panel); border:2px solid var(--primary); border-radius:10px; padding:20px; display:flex; flex-direction:column; }
  .cols { display:flex; gap:20px; flex:1; height:100%; }
  .col { flex:1; display:flex; flex-direction:column; }
  .col h4 { color:var(--primary); margin:0 0 10px 0; }
  .col textarea { flex:1; font-size:13px; line-height:1.5; }
</style>
</head>
<body>

<div id="EDITOR">
  <div id="EDITOR_HEADER">
    <h2>LEAP & LEARN: PRO</h2>
    <button class="btn btn-copy" onclick="copyCode()">КОПИРОВАТЬ КОД</button>
  </div>

  <div id="TABS">
    <div class="tab active" onclick="tab('main')">ГЛАВНАЯ</div>
    <div class="tab" onclick="tab('hero')">ГЕРОЙ</div>
    <div class="tab" onclick="tab('levels')">УРОВНИ</div>
    <div class="tab" onclick="tab('style')">СТИЛЬ</div>
  </div>

  <div id="CONTENT">
    <div id="t-main" class="pane">
      <div class="group">
        <h3>Геймплей</h3>
        <label>Время на вопрос (сек)</label>
        <input type="number" id="g_time" value="15" oninput="upd()">
        <label>Количество жизней</label>
        <input type="number" id="g_lives" value="3" oninput="upd()">
      </div>
      <div class="group">
        <h3>Звуки (URL .mp3)</h3>
        <label>Правильный ответ</label>
        <input type="text" id="s_ok" oninput="upd()">
        <label>Ошибка</label>
        <input type="text" id="s_no" oninput="upd()">
        <label>Победа (Финал)</label>
        <input type="text" id="s_win" oninput="upd()">
      </div>
    </div>

    <div id="t-hero" class="pane" style="display:none">
      <div class="group">
        <h3>Фон и Платформы</h3>
        <label>Фон игры (URL)</label>
        <input type="text" id="bg_url" value="https://img.genially.com/67961b32a116fb001568a75e/c0c9010f-c3dd-42c1-b7c1-65024fa3aec6.png" oninput="upd()">
        <label>Платформа (URL)</label>
        <input type="text" id="plat_url" value="https://img.genially.com/67961b32a116fb001568a75e/ed6c6e82-953b-43d4-947d-e46227b760f0.png" oninput="upd()">
      </div>
      <div class="group">
        <h3>Персонаж</h3>
        <label>Картинка героя (URL)</label>
        <input type="text" id="hero_url" value="https://img.genially.com/67961b32a116fb001568a75e/3074df22-5c73-4ad2-b0b2-491c6fc247f3.png" oninput="upd()">
      </div>
    </div>

    <div id="t-levels" class="pane" style="display:none">
      <div id="lvls_list"></div>
      <button class="btn btn-add" onclick="addLvl()">+ ДОБАВИТЬ УРОВЕНЬ</button>
    </div>

    <div id="t-style" class="pane" style="display:none">
      <div class="group">
        <h3>Цвета интерфейса</h3>
        <div class="row">
          <input type="color" id="c_ui" value="#7cf9ff" oninput="upd()">
          <label>Основной неон</label>
        </div>
        <div class="row">
          <input type="color" id="c_bg" value="#050b1a" oninput="upd()">
          <label>Фон экранов</label>
        </div>
        <div class="row">
          <input type="color" id="c_font" value="#ffffff" oninput="upd()">
          <label>Цвет текста</label>
        </div>
      </div>
      <div class="group">
        <h3>Текст</h3>
        <label>Размер вопроса (px)</label>
        <input type="number" id="f_size" value="32" oninput="upd()">
      </div>
    </div>
  </div>
</div>

<div id="PREVIEW">
  <iframe id="gameFrame"></iframe>
</div>

<div id="MODAL">
  <div class="modal-box">
    <h2 style="margin:0 0 15px 0; color:var(--primary)">Редактирование уровня</h2>
    <div class="cols">
      <div class="col">
        <h4>Вопросы (1 строка = 1 вопрос)</h4>
        <textarea id="m_q" placeholder="2 + 2 =&#10;Столица Франции?"></textarea>
      </div>
      <div class="col">
        <h4>Ответы (Верный|Неверный|Неверный)</h4>
        <textarea id="m_a" placeholder="4|5|1&#10;Париж|Лондон|Берлин"></textarea>
      </div>
    </div>
    <div class="row" style="margin-top:20px; justify-content:flex-end;">
      <button class="btn" style="width:200px" onclick="saveLvl()">СОХРАНИТЬ</button>
    </div>
  </div>
</div>

<script>
// --- ЛОГИКА РЕДАКТОРА ---
let levels = [
  { name: "Уровень 1", q: ["Сколько будет 2 + 2?", "Корень из 9?"], a: ["4|5|22", "3|9|81"] }
];
let curLvlIdx = 0;

function tab(id){
  document.querySelectorAll('.pane').forEach(e=>e.style.display='none');
  document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
  document.getElementById('t-'+id).style.display='block';
  event.currentTarget.classList.add('active');
}

function addLvl(){
  levels.push({ name: "Уровень "+(levels.length+1), q:[], a:[] });
  renderLvls();
  upd();
}

function renderLvls(){
  const c = document.getElementById('lvls_list');
  c.innerHTML = "";
  levels.forEach((l, i)=>{
    const d = document.createElement('div');
    d.className = 'group';
    d.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:bold; color:#fff">${l.name}</span>
        <div>
           <button class="btn btn-copy" onclick="editLvl(${i})">✏️ ЗАДАНИЯ</button>
           <button class="btn btn-del" onclick="delLvl(${i})">✕</button>
        </div>
      </div>
      <div style="margin-top:5px; font-size:10px; opacity:0.7">Вопросов: ${l.q.length}</div>
    `;
    c.appendChild(d);
  });
}

function delLvl(i){
  if(confirm("Удалить этот уровень?")) {
    levels.splice(i, 1);
    renderLvls();
    upd();
  }
}

function editLvl(i){
  curLvlIdx = i;
  document.getElementById('m_q').value = levels[i].q.join('\n');
  document.getElementById('m_a').value = levels[i].a.join('\n');
  document.getElementById('MODAL').style.display = 'flex';
}

function saveLvl(){
  levels[curLvlIdx].q = document.getElementById('m_q').value.split('\n').filter(l=>l.trim()!=='');
  levels[curLvlIdx].a = document.getElementById('m_a').value.split('\n').filter(l=>l.trim()!=='');
  document.getElementById('MODAL').style.display = 'none';
  renderLvls();
  upd();
}

function copyCode(){
  const html = getGameHTML();
  navigator.clipboard.writeText(html).then(()=>alert("Код игры скопирован в буфер!"));
}

// ГЕНЕРАЦИЯ КОДА ИГРЫ
function upd(){
  const html = getGameHTML();
  document.getElementById('gameFrame').srcdoc = html;
}

function getGameHTML(){
  // Сбор данных из инпутов
  const cfg = {
    bg: document.getElementById('bg_url').value,
    hero: document.getElementById('hero_url').value,
    plat: document.getElementById('plat_url').value,
    colorUI: document.getElementById('c_ui').value,
    colorBG: document.getElementById('c_bg').value,
    colorFont: document.getElementById('c_font').value,
    fontSize: document.getElementById('f_size').value,
    time: parseInt(document.getElementById('g_time').value) || 15,
    lives: parseInt(document.getElementById('g_lives').value) || 3,
    sfx: {
      ok: document.getElementById('s_ok').value,
      no: document.getElementById('s_no').value,
      win: document.getElementById('s_win').value
    },
    levels: levels
  };

  // ВОТ ЗДЕСЬ НАЧИНАЕТСЯ САМА ИГРА (ВНУТРЕННИЙ ДВИЖОК)
  return `
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
  :root { --main: ${cfg.colorUI}; --bg: ${cfg.colorBG}; --txt: ${cfg.colorFont}; }
  body { margin:0; overflow:hidden; font-family:'Segoe UI', sans-serif; background:var(--bg); color:var(--txt); user-select:none; }
  
  /* СЛОИ */
  #WORLD { position:absolute; inset:0; background:url('${cfg.bg}') center/cover no-repeat; z-index:1; }
  #UI { position:absolute; inset:0; z-index:10; pointer-events:none; }
  #OVERLAY { position:absolute; inset:0; z-index:100; display:flex; flex-direction:column; align-items:center; justify-content:center; background:rgba(0,0,0,0.9); transition: opacity 0.5s; }
  #FX_CANVAS { position:absolute; inset:0; z-index:999; pointer-events:none; }

  /* HUD */
  .hud-bar { position:absolute; top:20px; left:20px; display:flex; gap:15px; pointer-events:auto; }
  .stat { background:rgba(0,0,0,0.6); padding:10px 20px; border:2px solid var(--main); border-radius:30px; font-weight:bold; font-size:20px; box-shadow: 0 0 15px var(--main); display:flex; align-items:center; gap:10px; }
  
  /* ИГРОВЫЕ ОБЪЕКТЫ */
  #HERO { position:absolute; bottom:20%; left:10%; width:120px; height:120px; background:url('${cfg.hero}') center/contain no-repeat; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index:5; }
  #QUESTION { position:absolute; top:20%; width:100%; text-align:center; font-size:${cfg.fontSize}px; font-weight:900; text-shadow: 0 4px 8px #000; pointer-events:auto; padding:0 50px; box-sizing:border-box; }
  
  #PLATFORMS { position:absolute; bottom:20%; left:0; width:100%; display:flex; justify-content:center; gap:50px; pointer-events:auto; z-index:4; }
  .plat { 
    width:160px; height:100px; 
    background:url('${cfg.plat}') center/contain no-repeat; 
    display:flex; align-items:center; justify-content:center; 
    cursor:pointer; font-weight:bold; color:#000; font-size:18px; 
    padding-top:20px; text-align:center; transition: transform 0.2s;
    text-shadow: none;
  }
  .plat:hover { transform: translateY(-5px) scale(1.1); }
  .plat:active { transform: scale(0.95); }

  /* ТАБЛИЦЫ И КНОПКИ */
  .card { background:rgba(20, 30, 50, 0.9); border:2px solid var(--main); border-radius:20px; padding:40px; text-align:center; box-shadow: 0 0 50px var(--main); max-width:500px; width:90%; position:relative; pointer-events:auto; }
  h1 { margin:0 0 20px 0; font-size:40px; color:var(--main); text-shadow: 0 0 10px var(--main); }
  .btn-big { background:var(--main); color:#000; border:none; padding:15px 40px; font-size:24px; font-weight:900; border-radius:10px; cursor:pointer; margin-top:30px; text-transform:uppercase; box-shadow: 0 0 20px var(--main); transition:0.3s; }
  .btn-big:hover { transform: scale(1.05); background:#fff; }

  /* ТАБЛИЦА РЕЗУЛЬТАТОВ */
  .score-table { width:100%; margin-top:20px; font-size:20px; }
  .score-row { display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.2); }
  .score-row.total { border-top:2px solid var(--main); border-bottom:none; font-weight:bold; color:var(--main); font-size:26px; margin-top:15px; padding-top:15px; }

  /* АНИМАЦИИ */
  @keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-5px)} 50%{transform:translateX(5px)} 100%{transform:translateX(0)} }
  .shaking { animation: shake 0.3s; }
</style>
</head>
<body>

<div id="WORLD">
  <div id="HERO"></div>
  <div id="PLATFORMS"></div>
</div>

<div id="UI">
  <div class="hud-bar">
    <div class="stat">❤️ <span id="val_lives">0</span></div>
    <div class="stat">⏱️ <span id="val_time">0</span></div>
    <div class="stat">⭐ <span id="val_score">0</span></div>
  </div>
  <div id="QUESTION"></div>
</div>

<div id="OVERLAY">
  <div id="SCREEN_START" class="card">
    <h1>LEAP & LEARN</h1>
    <p>Пройди все уровни, отвечая правильно!</p>
    <button class="btn-big" onclick="game.start()">ИГРАТЬ</button>
  </div>
  
  <div id="SCREEN_LEVEL" class="card" style="display:none">
    <h1>УРОВЕНЬ ПРОЙДЕН!</h1>
    <div id="level_stats" class="score-table"></div>
    <button class="btn-big" onclick="game.nextLevel()">ДАЛЕЕ</button>
  </div>

  <div id="SCREEN_END" class="card" style="display:none">
    <h1 id="end_title"></h1>
    <div id="end_stats" class="score-table"></div>
    <button class="btn-big" onclick="location.reload()">ЗАНОВО</button>
  </div>
</div>

<canvas id="FX_CANVAS"></canvas>

<script>
/* --- ДВИЖОК ИГРЫ --- */
const DATA = ${JSON.stringify(cfg)};
const AUD = {
  ok: new Audio(DATA.sfx.ok),
  no: new Audio(DATA.sfx.no),
  win: new Audio(DATA.sfx.win)
};

// СИСТЕМА ЧАСТИЦ (ФЕЙЕРВЕРКИ)
const cvs = document.getElementById('FX_CANVAS');
const ctx = cvs.getContext('2d');
let particles = [];

function resize(){ cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
window.onresize = resize;
resize();

class Particle {
  constructor(x, y, color){
    this.x = x; this.y = y;
    this.vx = (Math.random()-0.5)*10;
    this.vy = (Math.random()-0.5)*10;
    this.life = 1;
    this.color = color;
  }
  upd(){
    this.x += this.vx; this.y += this.vy;
    this.vy += 0.1; // Гравитация
    this.life -= 0.02;
  }
  draw(){
    ctx.globalAlpha = this.life;
    ctx.fillStyle = this.color;
    ctx.beginPath(); ctx.arc(this.x, this.y, 4, 0, Math.PI*2); ctx.fill();
  }
}

function boom(x, y){
  const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
  const c = colors[Math.floor(Math.random()*colors.length)];
  for(let i=0; i<30; i++) particles.push(new Particle(x, y, c));
}

function loop(){
  ctx.clearRect(0,0,cvs.width, cvs.height);
  particles.forEach((p,i) => {
    p.upd(); p.draw();
    if(p.life<=0) particles.splice(i,1);
  });
  requestAnimationFrame(loop);
}
loop();

// ЛОГИКА ИГРЫ
const game = {
  lvlIdx: 0,
  qIdx: 0,
  score: 0,
  lives: DATA.lives,
  timer: null,
  timeLeft: 0,
  lvlScore: 0, // Очки за текущий уровень

  start(){
    document.getElementById('SCREEN_START').style.display = 'none';
    document.getElementById('OVERLAY').style.opacity = 0;
    setTimeout(()=>document.getElementById('OVERLAY').style.display='none', 500);
    this.lvlIdx = 0;
    this.score = 0;
    this.lives = DATA.lives;
    this.startLevel();
  },

  startLevel(){
    this.qIdx = 0;
    this.lvlScore = 0;
    this.loadQuestion();
  },

  loadQuestion(){
    clearInterval(this.timer);
    const lvl = DATA.levels[this.lvlIdx];
    if(!lvl) return this.endGame(true);

    // Обновляем UI
    document.getElementById('val_lives').innerText = this.lives;
    document.getElementById('val_score').innerText = this.score;
    
    // Текст вопроса
    document.getElementById('QUESTION').innerText = lvl.q[this.qIdx];
    
    // Платформы
    const pBox = document.getElementById('PLATFORMS');
    pBox.innerHTML = '';
    const rawA = lvl.a[this.qIdx].split('|');
    const ans = rawA.map((txt, i) => ({ txt, ok: i===0 }));
    // Перемешиваем
    ans.sort(() => Math.random() - 0.5);

    ans.forEach(a => {
      const el = document.createElement('div');
      el.className = 'plat';
      el.innerText = a.txt;
      el.onclick = (e) => this.check(a.ok, e.clientX, e.clientY);
      pBox.appendChild(el);
    });

    // Таймер
    this.timeLeft = DATA.time;
    document.getElementById('val_time').innerText = this.timeLeft;
    this.timer = setInterval(()=>{
      this.timeLeft--;
      document.getElementById('val_time').innerText = this.timeLeft;
      if(this.timeLeft <= 0) this.check(false);
    }, 1000);
  },

  check(isOk, x, y){
    clearInterval(this.timer);
    if(isOk){
      // Верно
      if(x && y) boom(x, y); // Салют в месте клика
      if(AUD.ok) AUD.ok.play();
      
      const timeBonus = this.timeLeft * 10;
      const turnScore = 100 + timeBonus;
      this.lvlScore += turnScore;
      this.score += turnScore;
      
      this.qIdx++;
      if(this.qIdx >= DATA.levels[this.lvlIdx].q.length) {
        this.showLevelEnd();
      } else {
        setTimeout(()=>this.loadQuestion(), 1000);
      }
    } else {
      // Ошибка
      if(AUD.no) AUD.no.play();
      document.body.classList.add('shaking');
      setTimeout(()=>document.body.classList.remove('shaking'), 300);
      
      this.lives--;
      document.getElementById('val_lives').innerText = this.lives;
      
      if(this.lives <= 0) this.endGame(false);
      else setTimeout(()=>this.loadQuestion(), 1000);
    }
  },

  showLevelEnd(){
    const overlay = document.getElementById('OVERLAY');
    overlay.style.display = 'flex';
    setTimeout(()=>overlay.style.opacity = 1, 10);
    
    document.getElementById('SCREEN_LEVEL').style.display = 'block';
    
    const lifeBonus = this.lives * 50;
    const totalLvl = this.lvlScore + lifeBonus;
    this.score += lifeBonus; // Добавляем бонус к общему счету

    // Рисуем таблицу
    document.getElementById('level_stats').innerHTML = \`
      <div class="score-row"><span>За ответы:</span> <span>\${this.lvlScore}</span></div>
      <div class="score-row"><span>Бонус жизней:</span> <span>\${lifeBonus}</span></div>
      <div class="score-row total"><span>ИТОГО:</span> <span>\${totalLvl}</span></div>
    \`;

    // Запускаем много салютов
    let fw = setInterval(()=>boom(Math.random()*cvs.width, Math.random()*cvs.height*0.5), 300);
    setTimeout(()=>clearInterval(fw), 3000);
  },

  nextLevel(){
    document.getElementById('SCREEN_LEVEL').style.display = 'none';
    document.getElementById('OVERLAY').style.opacity = 0;
    setTimeout(()=>document.getElementById('OVERLAY').style.display='none', 500);
    
    this.lvlIdx++;
    if(this.lvlIdx >= DATA.levels.length) this.endGame(true);
    else this.startLevel();
  },

  endGame(win){
    const overlay = document.getElementById('OVERLAY');
    overlay.style.display = 'flex';
    setTimeout(()=>overlay.style.opacity = 1, 10);
    
    document.getElementById('SCREEN_END').style.display = 'block';
    document.getElementById('end_title').innerText = win ? "ПОБЕДА!" : "ИГРА ОКОНЧЕНА";
    document.getElementById('end_title').style.color = win ? "#ffd700" : "#ff3b3b";
    
    document.getElementById('end_stats').innerHTML = \`
      <div class="score-row"><span>Уровень:</span> <span>\${this.lvlIdx + (win?1:0)} / \${DATA.levels.length}</span></div>
      <div class="score-row total"><span>ФИНАЛЬНЫЙ СЧЕТ:</span> <span>\${this.score}</span></div>
    \`;

    if(win){
      if(AUD.win) AUD.win.play();
      setInterval(()=>boom(Math.random()*cvs.width, Math.random()*cvs.height), 500);
    }
  }
};
</script>
</body>
</html>
  `;
}

// Инициализация при старте
renderLvls();
upd();
</script>

</body>
</html>
