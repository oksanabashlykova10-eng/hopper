<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Leap & Learn Editor ‚Äî Working Preview</title>

<style>
  :root { --primary:#7cf9ff; --dark:#0a1730; --text:#eaf6ff; }
  *{box-sizing:border-box}
  body{
    margin:0;height:100vh;display:flex;overflow:hidden;
    background:#050b1a;color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }

  /* LEFT */
  #EDITOR{
    width:460px;min-width:420px;max-width:520px;
    background:var(--dark);
    border-right:1px solid rgba(255,255,255,.08);
    display:flex;flex-direction:column;
    box-shadow:4px 0 18px rgba(0,0,0,.35);
  }
  #EDITOR_HEADER{
    padding:14px 16px;
    background:linear-gradient(180deg, rgba(20,35,66,.95), rgba(10,23,48,.95));
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  #EDITOR_HEADER h2{ margin:0;font-size:16px;letter-spacing:.04em;color:var(--primary); }

  #TABS{ display:flex;background:#050812;flex-wrap:wrap; }
  .tab{
    flex:1;min-width:70px;padding:10px 6px;text-align:center;cursor:pointer;
    color:#8ea3cd;background:rgba(255,255,255,.03);
    border-bottom:3px solid transparent;
    font-size:11px;font-weight:800;letter-spacing:.08em;
    transition:.15s;user-select:none;
  }
  .tab:hover{ background:rgba(255,255,255,.06);color:#d7e6ff; }
  .tab.active{
    background:rgba(20,35,66,.8);
    color:var(--primary);
    border-bottom-color:var(--primary);
  }
  #CONTROLS{ flex:1;overflow:auto;padding:16px; }

  .group{
    margin-bottom:18px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.03);
    border-radius:14px;
    padding:12px 12px 10px;
  }
  .group h3{
    margin:0 0 8px;font-size:12px;color:var(--primary);
    letter-spacing:.10em;text-transform:uppercase;opacity:.9;
  }
  label{ display:block;font-size:11px;margin:10px 0 4px;color:#b9c8ea;font-weight:800; }
  input[type="text"], input[type="number"], select, textarea{
    width:100%;padding:9px 10px;background:#070f22;
    border:1px solid rgba(255,255,255,.12);
    color:#fff;border-radius:10px;font-size:12px;outline:none;
  }
  input[type="color"]{ width:100%;height:32px;border:none;background:none;padding:0;cursor:pointer; }
  textarea{
    resize:vertical;min-height:92px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  }
  .row{ display:flex;gap:10px;align-items:flex-end; }
  .col{ flex:1; }

  /* LEVELS */
  .level-item{
    border:1px solid rgba(255,255,255,.10);
    border-radius:14px;overflow:hidden;margin-bottom:12px;background:rgba(0,0,0,.18);
  }
  .level-header{
    padding:10px 10px;background:rgba(255,255,255,.05);cursor:pointer;
    display:flex;align-items:center;justify-content:space-between;
    font-weight:900;font-size:12px;letter-spacing:.06em;
  }
  .level-header span{ color:#d9e9ff; }
  .level-content{ display:none;padding:10px;border-top:1px solid rgba(255,255,255,.08); }
  .level-content.show{ display:block; }
  .bulk-container{ display:flex;gap:10px; }
  .bulk-col{ flex:1;display:flex;flex-direction:column; }
  .bulk-col label{ margin-top:0; }

  /* BUTTONS */
  .btn{
    width:100%;border:none;border-radius:14px;padding:12px 12px;
    font-weight:900;cursor:pointer;background:var(--primary);
    color:#00131c;box-shadow:0 10px 24px rgba(124,249,255,.12);
  }
  .btn:hover{ filter:brightness(1.05); }
  .btn.secondary{
    background:rgba(255,255,255,.07);color:#eaf6ff;
    border:1px dashed rgba(255,255,255,.18);box-shadow:none;
  }
  .btn.danger{
    width:auto;padding:6px 10px;border-radius:12px;
    background:rgba(255,59,59,.12);color:#ff7a7a;
    border:1px solid rgba(255,59,59,.35);box-shadow:none;font-weight:900;
  }

  .note{ font-size:10px;color:#95addc;line-height:1.35;margin:8px 0 0; }

  /* RIGHT PREVIEW */
  #PREVIEW_AREA{ flex:1;display:flex;flex-direction:column;background:#000; }
  #PREVIEW_BAR{
    height:44px;background:rgba(255,255,255,.04);
    border-bottom:1px solid rgba(255,255,255,.10);
    display:flex;align-items:center;justify-content:space-between;padding:0 12px;gap:10px;
  }
  #PREVIEW_BAR .title{ font-weight:900;letter-spacing:.06em;font-size:12px;color:#cfe6ff;opacity:.95; }
  .view-btns{ display:flex;gap:8px; }
  .view-btn{
    padding:7px 12px;border-radius:999px;background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.10);color:#b9c8ea;
    font-weight:900;cursor:pointer;font-size:12px;user-select:none;
  }
  .view-btn.active{
    background:rgba(124,249,255,.14);border-color:rgba(124,249,255,.55);color:var(--primary);
  }
  iframe{ border:none;width:100%;flex:1;background:#0a1730; }

  /* COPY MODAL */
  #COPY_MODAL{
    position:fixed;inset:0;background:rgba(0,0,0,.88);
    display:none;align-items:center;justify-content:center;z-index:999;padding:22px;
  }
  #COPY_CARD{
    width:min(980px,96vw);
    background:rgba(8,16,34,.96);
    border:1px solid rgba(124,249,255,.25);
    border-radius:18px;
    box-shadow:0 30px 90px rgba(0,0,0,.55);
    padding:14px;
  }
  #COPY_CARD h2{ margin:0 0 6px;font-size:14px;color:#eaf6ff;letter-spacing:.06em; }
  #COPY_CARD .hint{ font-size:11px;color:#9fb2d8;margin:0 0 10px; }
  #finalCode{
    width:100%;
    height:min(420px,60vh);
    background:#050a15;border:1px solid rgba(255,255,255,.12);
    border-radius:12px;color:#bfe9ff;padding:10px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    font-size:11px;
  }
  #COPY_BTNS{ display:flex;gap:10px;margin-top:10px;flex-wrap:wrap; }
  #COPY_BTNS .btn{ width:auto;padding:10px 14px;border-radius:14px; }
  #COPY_BTNS .btn.secondary{ border-style:solid; }
</style>
</head>
<body>

<div id="EDITOR">
  <div id="EDITOR_HEADER"><h2>üê∏ Leap & Learn Editor</h2></div>

  <div id="TABS">
    <div class="tab active" data-tab="visuals">–í–ò–ó–£–ê–õ</div>
    <div class="tab" data-tab="fonts">–®–†–ò–§–¢–´</div>
    <div class="tab" data-tab="texts">–¢–ï–ö–°–¢–´</div>
    <div class="tab" data-tab="gameplay">–ì–ï–ô–ú–ü–õ–ï–ô</div>
    <div class="tab" data-tab="levels">–£–†–û–í–ù–ò</div>
  </div>

  <div id="CONTROLS">

    <div class="tab-page" id="tab-visuals">
      <div class="group">
        <h3>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å—Ü–µ–Ω—ã</h3>

        <label>–õ–æ–∫–∞—Ü–∏—è (—Ñ–æ–Ω)</label>
        <select id="bgSelect">
          <option value="river">–†–µ–∫–∞</option>
          <option value="lava">–õ–∞–≤–∞</option>
          <option value="swamp">–ë–æ–ª–æ—Ç–æ</option>
          <option value="custom">–°–≤–æ—è —Å—Å—ã–ª–∫–∞‚Ä¶</option>
        </select>
        <input type="text" id="bgCustom" style="display:none;margin-top:8px" placeholder="https://..." />

        <label>–ü–µ—Ä—Å–æ–Ω–∞–∂</label>
        <select id="charSelect">
          <option value="frog">–õ—è–≥—É—à–∫–∞</option>
          <option value="chameleon">–•–∞–º–µ–ª–µ–æ–Ω</option>
          <option value="lizard">–Ø—â–µ—Ä–∏—Ü–∞</option>
          <option value="custom">–°–≤–æ—è —Å—Å—ã–ª–∫–∞‚Ä¶</option>
        </select>
        <input type="text" id="charCustom" style="display:none;margin-top:8px" placeholder="https://..." />

        <label>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
        <select id="platSelect">
          <option value="lily">–õ–∏–ª–∏—è</option>
          <option value="stone">–ö–∞–º–µ–Ω—å</option>
          <option value="mound">–ö–æ—á–∫–∞</option>
          <option value="custom">–°–≤–æ—è —Å—Å—ã–ª–∫–∞‚Ä¶</option>
        </select>
        <input type="text" id="platCustom" style="display:none;margin-top:8px" placeholder="https://..." />

        <div class="note">–ú–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ PNG/JPG (–Ω–∞–ø—Ä–∏–º–µ—Ä –∏–∑ Genially), —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ—ë.</div>
      </div>

      <div class="group">
        <h3>–¶–≤–µ—Ç–∞ –∏ –Ω–µ–æ–Ω</h3>
        <label>–ù–µ–æ–Ω (main)</label>
        <input type="color" id="colNeon" value="#7cf9ff" />

        <div class="row">
          <div class="col">
            <label>Danger</label>
            <input type="color" id="colDanger" value="#ff3b3b" />
          </div>
          <div class="col">
            <label>Win</label>
            <input type="color" id="colWin" value="#ffe44d" />
          </div>
        </div>

        <label>–ù–µ–æ–Ω–æ–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ (glow)</label>
        <select id="neonGlow">
          <option value="on" selected>–í–∫–ª—é—á–µ–Ω–æ</option>
          <option value="off">–í—ã–∫–ª—é—á–µ–Ω–æ</option>
        </select>

        <label>–§–∏–Ω–∞–ª—å–Ω—ã–π —Å–∞–ª—é—Ç</label>
        <select id="winFX">
          <option value="both" selected>–ö–æ–Ω—Ñ–µ—Ç—Ç–∏ + –ò—Å–∫—Ä—ã</option>
          <option value="confetti">–¢–æ–ª—å–∫–æ –∫–æ–Ω—Ñ–µ—Ç—Ç–∏</option>
          <option value="sparks">–¢–æ–ª—å–∫–æ –∏—Å–∫—Ä—ã</option>
        </select>
      </div>

      <div class="group">
        <h3>–ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –º–µ–Ω—é</h3>
        <div class="row">
          <div class="col">
            <label>–¶–≤–µ—Ç</label>
            <input type="color" id="colOverlay" value="#081022" />
          </div>
          <div class="col" style="max-width:120px">
            <label>–ù–µ–ø—Ä–æ–∑—Ä. %</label>
            <input type="number" id="opOverlay" value="92" min="0" max="100" />
          </div>
        </div>
      </div>
    </div>

    <div class="tab-page" id="tab-fonts" style="display:none">
      <div class="group">
        <h3>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</h3>
        <div class="row">
          <div class="col">
            <label>–¶–≤–µ—Ç</label>
            <input type="color" id="qCol" value="#000000" />
          </div>
          <div class="col">
            <label>–†–∞–∑–º–µ—Ä</label>
            <input type="number" id="qSize" value="26" min="12" max="60" />
          </div>
        </div>
        <label>–®—Ä–∏—Ñ—Ç</label>
        <select id="qFont">
          <option value="Arial, sans-serif" selected>Arial</option>
          <option value="'Verdana', sans-serif">Verdana</option>
          <option value="'Trebuchet MS', sans-serif">Trebuchet</option>
          <option value="'Courier New', monospace">Courier New</option>
          <option value="'Comic Sans MS', cursive">Comic Sans</option>
        </select>
      </div>

      <div class="group">
        <h3>–û—Ç–≤–µ—Ç—ã –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ</h3>
        <div class="row">
          <div class="col">
            <label>–¶–≤–µ—Ç</label>
            <input type="color" id="ansCol" value="#141414" />
          </div>
          <div class="col">
            <label>–†–∞–∑–º–µ—Ä</label>
            <input type="number" id="ansSize" value="18" min="10" max="40" />
          </div>
        </div>
      </div>

      <div class="group">
        <h3>–¢–∞–π–º–µ—Ä</h3>
        <div class="row">
          <div class="col">
            <label>–¶–≤–µ—Ç —Ü–∏—Ñ—Ä</label>
            <input type="color" id="timeCol" value="#053149" />
          </div>
          <div class="col">
            <label>–†–∞–∑–º–µ—Ä</label>
            <input type="number" id="timeSize" value="20" min="12" max="40" />
          </div>
        </div>
      </div>
    </div>

    <div class="tab-page" id="tab-texts" style="display:none">
      <div class="group">
        <h3>–ú–µ–Ω—é</h3>
        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä—ã</label>
        <input type="text" id="txtTitle" value="Leap & Learn" />

        <label>–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
        <input type="text" id="txtSub" value="Fast quiz game ‚Ä¢ platforms, combos and speed" />

        <label>–ü—Ä–∞–≤–∏–ª–∞ (HTML –¥–ª—è —Å–ø–∏—Å–∫–∞ li –º–æ–∂–Ω–æ)</label>
        <textarea id="txtRules" rows="5"><li>Pick the correct answer ‚Äî move forward.</li><li>Timer difficulty: <b>10s ‚Üí 7s ‚Üí 5s</b>.</li><li>Combos increase your score multiplier; a mistake breaks the combo.</li></textarea>

        <label>–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ Start</label>
        <input type="text" id="btnStartTxt" value="‚ñ∂ START" />
      </div>

      <div class="group">
        <h3>–§–∏–Ω–∞–ª</h3>
        <label>–¢–µ–∫—Å—Ç –ø–æ–±–µ–¥—ã</label>
        <input type="text" id="txtWin" value="CONGRATULATIONS!" />

        <label>–¢–µ–∫—Å—Ç –ø—Ä–æ–∏–≥—Ä—ã—à–∞</label>
        <input type="text" id="txtLose" value="YOU LOST!" />

        <label>–ö–Ω–æ–ø–∫–∞ Next Level</label>
        <input type="text" id="btnNextTxt" value="‚è≠ Next Level" />

        <label>–ö–Ω–æ–ø–∫–∞ Finish</label>
        <input type="text" id="btnFinishTxt" value="üèÅ Finish" />

        <label>–ö–Ω–æ–ø–∫–∞ Play again</label>
        <input type="text" id="btnRetryTxt" value="üîÅ Play again" />
      </div>
    </div>

    <div class="tab-page" id="tab-gameplay" style="display:none">
      <div class="group">
        <h3>–¢–∞–π–º–µ—Ä (t1 ‚Üí t2 ‚Üí t3)</h3>
        <div class="row">
          <div class="col">
            <label>t1 (–ø–µ—Ä–≤—ã–µ 3 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö)</label>
            <input type="number" id="t1" value="10" min="1" max="30" />
          </div>
          <div class="col">
            <label>t2 (4‚Äì6 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö)</label>
            <input type="number" id="t2" value="7" min="1" max="30" />
          </div>
          <div class="col">
            <label>t3 (–ø–æ—Å–ª–µ 6)</label>
            <input type="number" id="t3" value="5" min="1" max="30" />
          </div>
        </div>
      </div>

      <div class="group">
        <h3>–ó–≤—É–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</h3>
        <div class="note">–ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å–∏–Ω—Ç-–∑–≤—É–∫–∏.</div>

        <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (URL .mp3/.wav)</label>
        <input type="text" id="audOk" placeholder="https://..." />

        <label>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (URL .mp3/.wav)</label>
        <input type="text" id="audWrong" placeholder="https://..." />

        <label>–§–∏–Ω–∞–ª –ø–æ–±–µ–¥—ã (URL)</label>
        <input type="text" id="audFinalWin" placeholder="https://..." />

        <label>–§–∏–Ω–∞–ª –ø—Ä–æ–∏–≥—Ä—ã—à–∞ (URL)</label>
        <input type="text" id="audFinalLose" placeholder="https://..." />
      </div>
    </div>

    <div class="tab-page" id="tab-levels" style="display:none">
      <div class="group">
        <h3>–£—Ä–æ–≤–Ω–∏ –∏ –∑–∞–¥–∞–Ω–∏—è</h3>
        <div class="note">
          –í–æ–ø—Ä–æ—Å—ã: 1 —Å—Ç—Ä–æ–∫–∞ = 1 –≤–æ–ø—Ä–æ—Å.<br/>
          –û—Ç–≤–µ—Ç—ã: —Å—Ç—Ä–æ–∫–∞ –∫ —Å—Ç—Ä–æ–∫–µ: <b>–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π | –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π | –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π</b>
        </div>
      </div>
      <div id="levelsContainer"></div>
      <button class="btn secondary" type="button" id="btnAddLevel">+ –î–û–ë–ê–í–ò–¢–¨ –£–†–û–í–ï–ù–¨</button>
    </div>

    <div class="group">
      <button class="btn" type="button" id="btnCopy">üìã –°–ö–û–ü–ò–†–û–í–ê–¢–¨ IFRAME –î–õ–Ø GENIALLY</button>
      <div class="note">–í Genially –≤—Å—Ç–∞–≤–ª—è–π —Ü–µ–ª–∏–∫–æ–º (iframe srcdoc).</div>
    </div>

  </div>
</div>

<div id="PREVIEW_AREA">
  <div id="PREVIEW_BAR">
    <div class="title">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</div>
    <div class="view-btns">
      <div class="view-btn active" id="btnMenu">–ú–µ–Ω—é</div>
      <div class="view-btn" id="btnPlay">–ò–≥—Ä–∞—Ç—å</div>
    </div>
  </div>
  <iframe id="previewFrame" sandbox="allow-scripts allow-forms allow-pointer-lock"></iframe>
</div>

<div id="COPY_MODAL">
  <div id="COPY_CARD">
    <h2>–ì–æ—Ç–æ–≤—ã–π iframe (–≤—Å—Ç–∞–≤—å –≤ Genially)</h2>
    <div class="hint">–ö–ª–∏–∫ –ø–æ –ø–æ–ª—é ‚Äî –≤—ã–¥–µ–ª–∏—Ç –≤–µ—Å—å –∫–æ–¥.</div>
    <textarea id="finalCode" readonly></textarea>
    <div id="COPY_BTNS">
      <button class="btn" type="button" id="btnSelectAll">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
      <button class="btn secondary" type="button" id="btnClose">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<script>
/* ===== ASSETS ===== */
const ASSETS = {
  bg:{
    river:"https://img.genially.com/67961b32a116fb001568a75e/c0c9010f-c3dd-42c1-b7c1-65024fa3aec6.png",
    lava:"https://img.genially.com/67961b32a116fb001568a75e/fa2ab459-fec9-4ccd-97e3-254427b4ade0.png",
    swamp:"https://img.genially.com/67961b32a116fb001568a75e/02b52ad4-9d31-4b21-a305-8fec6e8a4487.png"
  },
  char:{
    frog:"https://img.genially.com/67961b32a116fb001568a75e/3074df22-5c73-4ad2-b0b2-491c6fc247f3.png",
    chameleon:"https://img.genially.com/67961b32a116fb001568a75e/74b56fcf-5354-43dd-9c9a-f50facc9a9bf.png",
    lizard:"https://img.genially.com/67961b32a116fb001568a75e/0feda2a1-485a-4654-8640-bf1adcc9f9ec.png"
  },
  plat:{
    lily:"https://img.genially.com/67961b32a116fb001568a75e/ed6c6e82-953b-43d4-947d-e46227b760f0.png",
    stone:"https://img.genially.com/67961b32a116fb001568a75e/bad37c6d-f04c-45c0-b954-807d79ec3a95.png",
    mound:"https://img.genially.com/67961b32a116fb001568a75e/c6775617-bde5-43e4-9da8-5332d928807e.png"
  }
};

/* ===== LEVELS STATE ===== */
let levels = [{
  name:"Level 1",
  q:"I ____ ready.\nShe ____ got a car.\nThey ____ at home.\nIt ____ cold outside.",
  a:"am | is | are\nhas | have | is have\nare | is | be\nis | are | am"
}];

/* ===== helpers ===== */
function $(id){ return document.getElementById(id); }
function toggleCustom(sel, inp){ inp.style.display = (sel.value==="custom") ? "block" : "none"; }
function escapeHtml(s){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function escapeAttr(s){ return String(s).replace(/&/g,"&amp;").replace(/"/g,"&quot;"); }
function toRgba(hex, alpha01){
  const h=(hex||"#000000").replace("#","").trim();
  const full=(h.length===3)?h.split("").map(ch=>ch+ch).join(""):h;
  const r=parseInt(full.slice(0,2),16)||0;
  const g=parseInt(full.slice(2,4),16)||0;
  const b=parseInt(full.slice(4,6),16)||0;
  const a=Math.max(0,Math.min(1,alpha01));
  return `rgba(${r},${g},${b},${a})`;
}
function escapeForSingleQuotedAttr(s){
  return String(s).replace(/&/g,"&amp;").replace(/'/g,"&#39;");
}
/* –í–ê–ñ–ù–û: –Ω–µ –¥–∞—ë–º –ø–æ—è–≤–∏—Ç—å—Å—è </script> –≤–Ω—É—Ç—Ä–∏ —Å–∫—Ä–∏–ø—Ç–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
function safeCloseScript(html){
  return String(html).replace(/<\/script>/gi, "</scr" + "ipt>");
}

/* ===== UI: levels ===== */
function renderLevels(){
  const c=$("levelsContainer");
  c.innerHTML="";
  levels.forEach((lvl,i)=>{
    const qCount=String(lvl.q||"").split("\n").map(x=>x.trim()).filter(Boolean).length;
    const wrap=document.createElement("div");
    wrap.className="level-item";
    wrap.innerHTML=`
      <div class="level-header">
        <span>${escapeHtml(lvl.name)} (${qCount})</span>
        <button class="btn danger" type="button" data-del="${i}">üóëÔ∏è</button>
      </div>
      <div class="level-content">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è</label>
        <input type="text" value="${escapeAttr(lvl.name)}" data-name="${i}">
        <div class="bulk-container">
          <div class="bulk-col">
            <label>–í–û–ü–†–û–°–´ (–ø–æ —Å—Ç—Ä–æ–∫–∞–º)</label>
            <textarea data-q="${i}">${escapeHtml(lvl.q||"")}</textarea>
          </div>
          <div class="bulk-col">
            <label>–û–¢–í–ï–¢–´ (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π | –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π | –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π)</label>
            <textarea data-a="${i}">${escapeHtml(lvl.a||"")}</textarea>
          </div>
        </div>
        <div class="note">–í –∏–≥—Ä–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–∞–Ω–¥–æ–º–Ω–æ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞—é—Ç—Å—è, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.</div>
      </div>
    `;
    c.appendChild(wrap);

    const header=wrap.querySelector(".level-header");
    const content=wrap.querySelector(".level-content");
    header.addEventListener("click",(e)=>{
      if(e.target && e.target.matches("button[data-del]")) return;
      content.classList.toggle("show");
    });

    wrap.querySelector("button[data-del]").addEventListener("click",(e)=>{
      e.stopPropagation();
      const idx=parseInt(e.currentTarget.getAttribute("data-del"),10);
      if(levels.length<=1){ alert("–ù—É–∂–µ–Ω —Ö–æ—Ç—è –±—ã 1 —É—Ä–æ–≤–µ–Ω—å."); return; }
      if(confirm("–£–¥–∞–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å?")){
        levels.splice(idx,1);
        renderLevels();
        schedulePreviewUpdate();
      }
    });

    wrap.querySelector("input[data-name]").addEventListener("input",(e)=>{
      levels[i].name=e.currentTarget.value;
      schedulePreviewUpdate();
    });
    wrap.querySelector("textarea[data-q]").addEventListener("input",(e)=>{
      levels[i].q=e.currentTarget.value;
      schedulePreviewUpdate();
    });
    wrap.querySelector("textarea[data-a]").addEventListener("input",(e)=>{
      levels[i].a=e.currentTarget.value;
      schedulePreviewUpdate();
    });
  });
}

function parseLevels(){
  return levels.map((lvl,idx)=>{
    const qs=String(lvl.q||"").split("\n").map(s=>s.trim()).filter(Boolean);
    const as=String(lvl.a||"").split("\n").map(s=>s.trim()).filter(Boolean);

    const questions=qs.map((text,i)=>{
      const line=as[i]||"Correct | Wrong A | Wrong B";
      const parts=line.split("|").map(x=>x.trim());
      const a1=parts[0]||"Correct";
      const a2=parts[1]||"Wrong A";
      const a3=parts[2]||"Wrong B";
      return {text, answers:[a1,a2,a3], correct:0};
    });

    return {
      name:(lvl.name||`Level ${idx+1}`).trim()||`Level ${idx+1}`,
      questions: questions.length ? questions : [{text:"Add questions in editor", answers:["OK","...","..."], correct:0}]
    };
  });
}

/* ===== GAME HTML builder (safe) ===== */
function getGameHTML(forcePlay=false){
  const bgSel=$("bgSelect").value;
  const chSel=$("charSelect").value;
  const plSel=$("platSelect").value;

  const bg=(bgSel==="custom"?$("bgCustom").value.trim():ASSETS.bg[bgSel])||ASSETS.bg.river;
  const hero=(chSel==="custom"?$("charCustom").value.trim():ASSETS.char[chSel])||ASSETS.char.frog;
  const platform=(plSel==="custom"?$("platCustom").value.trim():ASSETS.plat[plSel])||ASSETS.plat.lily;

  const cfg={
    assets:{bg,hero,platform},
    colors:{
      neon:$("colNeon").value,
      danger:$("colDanger").value,
      win:$("colWin").value,
      question:$("qCol").value
    },
    fonts:{
      qFont:$("qFont").value,
      qSize:parseInt($("qSize").value,10)||26,
      ansColor:$("ansCol").value,
      ansSize:parseInt($("ansSize").value,10)||18,
      timeColor:$("timeCol").value,
      timeSize:parseInt($("timeSize").value,10)||20
    },
    overlay:{
      color:$("colOverlay").value,
      op:Math.max(0,Math.min(100,parseInt($("opOverlay").value,10)||92))
    },
    neonGlow:($("neonGlow").value==="on"),
    timers:{
      t1:Math.max(1,parseInt($("t1").value,10)||10),
      t2:Math.max(1,parseInt($("t2").value,10)||7),
      t3:Math.max(1,parseInt($("t3").value,10)||5),
    },
    texts:{
      title:$("txtTitle").value||"Leap & Learn",
      sub:$("txtSub").value||"",
      rules:$("txtRules").value||"",
      btnStart:$("btnStartTxt").value||"‚ñ∂ START",
      win:$("txtWin").value||"CONGRATULATIONS!",
      lose:$("txtLose").value||"YOU LOST!",
      btnNext:$("btnNextTxt").value||"‚è≠ Next Level",
      btnFinish:$("btnFinishTxt").value||"üèÅ Finish",
      btnRetry:$("btnRetryTxt").value||"üîÅ Play again"
    },
    sounds:{
      ok:($("audOk").value||"").trim(),
      wrong:($("audWrong").value||"").trim(),
      finalWin:($("audFinalWin").value||"").trim(),
      finalLose:($("audFinalLose").value||"").trim()
    },
    winFX:$("winFX").value||"both",
    levels:parseLevels(),
    forcePlay: !!forcePlay
  };

  const overlayRgba = toRgba(cfg.overlay.color, cfg.overlay.op/100);
  const closeScript = "</scr" + "ipt>";  // <-- –ö–õ–Æ–ß–ï–í–û–ï (–Ω–µ –¥–∞—ë–º </script> –ø–æ—è–≤–∏—Ç—å—Å—è –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ)

  const html = `<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Leap & Learn</title>
<style>
:root{
  --neon-main:${cfg.colors.neon};
  --danger:${cfg.colors.danger};
  --win:${cfg.colors.win};
}
html,body{margin:0;width:100%;height:100%;overflow:hidden;font-family:Arial;background:#0a1730}
#GAME{position:relative;width:100%;height:100%}
#GAME.shake{animation:shake .25s}
@keyframes shake{0%{transform:translate(0)}25%{transform:translate(-4px,3px)}50%{transform:translate(4px,-3px)}75%{transform:translate(-3px,2px)}100%{transform:translate(0)}}
#BG{position:absolute;inset:0;z-index:0;background:url("${cfg.assets.bg}") center/cover no-repeat}
#QUESTION{
  position:absolute;top:26px;width:100%;text-align:center;
  font-size:${cfg.fonts.qSize}px;z-index:20;
  color:${cfg.colors.question};text-shadow:0 2px 0 rgba(0,0,0,.35);
  font-family:${cfg.fonts.qFont};
}
#TIMER{
  position:absolute;top:70px;left:50%;transform:translateX(-50%);
  width:80px;height:80px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  background:#fff;border:2px solid var(--neon-main);
  box-shadow:${cfg.neonGlow ? "0 0 18px var(--neon-main)" : "none"};
  z-index:20;font-weight:900;color:${cfg.fonts.timeColor};
  font-size:${cfg.fonts.timeSize}px;
}
#TIMER.danger{
  border-color:var(--danger);color:var(--danger);
  box-shadow:${cfg.neonGlow ? "0 0 25px var(--danger)" : "none"};
  animation:pulse .8s infinite;
}
@keyframes pulse{50%{transform:translateX(-50%) scale(1.12)}}
#LIVES{position:absolute;top:30px;right:30px;font-size:26px;z-index:20}
#SCORE{position:absolute;top:30px;left:30px;font-size:20px;font-weight:900;z-index:20;color:#fff;text-shadow:0 2px 0 rgba(0,0,0,.35)}
#COMBO{
  position:absolute;top:165px;left:50%;transform:translateX(-50%);
  z-index:20;padding:10px 16px;border-radius:18px;
  background:rgba(255,255,255,.88);
  border:2px solid var(--neon-main);
  box-shadow:${cfg.neonGlow ? "0 0 18px rgba(124,249,255,.65), inset 0 0 14px rgba(124,249,255,.25)" : "none"};
  font-weight:900;color:#043149;display:none;gap:10px;align-items:center;
}
#COMBO.show{display:inline-flex}
#COMBO_BOLT{width:18px;height:18px;border-radius:6px;background:rgba(124,249,255,.25);box-shadow:${cfg.neonGlow ? "0 0 14px rgba(124,249,255,.75)" : "none"};display:inline-block}
#COMBO.pulse{animation:comboPulse .55s ease}
@keyframes comboPulse{0%{transform:translateX(-50%) scale(1)}40%{transform:translateX(-50%) scale(1.12)}100%{transform:translateX(-50%) scale(1)}}
.btn{padding:12px 34px;border-radius:16px;font-weight:900;background:#fff;border:2px solid var(--neon-main);box-shadow:${cfg.neonGlow ? "0 0 15px var(--neon-main)" : "none"};cursor:pointer;color:#043149}
.btn.dark{background:rgba(255,255,255,.10);color:#eaf6ff;border:2px solid rgba(124,249,255,.55);box-shadow:${cfg.neonGlow ? "0 0 16px rgba(124,249,255,.25)" : "none"}}
#START_SCREEN{position:absolute;inset:0;z-index:60;display:flex;align-items:center;justify-content:center;background:${overlayRgba}}
#START_CARD{
  width:min(760px, calc(100vw - 40px));
  border-radius:26px;
  background:linear-gradient(180deg, rgba(10,20,50,.92), rgba(5,10,25,.92));
  border:2px solid rgba(124,249,255,.75);
  box-shadow:${cfg.neonGlow ? "0 0 30px rgba(124,249,255,.55), inset 0 0 24px rgba(124,249,255,.18)" : "none"};
  padding:18px 18px 16px;position:relative;overflow:hidden;color:#eaf6ff;
}
#START_TOP{position:relative;display:flex;align-items:center;gap:14px;padding:6px 6px 10px}
#START_ICON{width:64px;height:64px;flex:0 0 auto;background:url("${cfg.assets.hero}") no-repeat center/contain;filter:${cfg.neonGlow ? "drop-shadow(0 0 14px rgba(124,249,255,.55))" : "none"}}
#START_TITLE{font-weight:900;font-size:34px;color:#eaf6ff;text-shadow:${cfg.neonGlow ? "0 0 18px rgba(124,249,255,.55)" : "none"};margin:0;line-height:1.05}
#START_SUB{margin:2px 0 0;color:#bfe9ff;opacity:.9;font-weight:700}
.panel{background:rgba(255,255,255,.08);border:1px solid rgba(124,249,255,.35);border-radius:18px;box-shadow:${cfg.neonGlow ? "0 0 12px rgba(124,249,255,.18)" : "none"};padding:12px 12px 10px;margin-top:10px}
.panel h3{margin:0 0 8px;font-size:14px;letter-spacing:.08em;text-transform:uppercase;opacity:.9;color:#eaf6ff}
.rules{margin:0;color:#cfefff;font-weight:700;line-height:1.35;font-size:14px}
.rules li{margin:6px 0}
#START_BOTTOM{position:relative;display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:16px;border:1px solid rgba(124,249,255,.35);box-shadow:${cfg.neonGlow ? "0 0 12px rgba(124,249,255,.18)" : "none"};background:rgba(255,255,255,.08);color:#eaf6ff;font-weight:900;font-size:14px}
.badge small{opacity:.8;font-weight:900;color:#bfe9ff}
select{border-radius:14px;border:1px solid rgba(124,249,255,.45);background:rgba(255,255,255,.10);padding:8px 10px;font-weight:900;color:#eaf6ff;outline:none;box-shadow: inset 0 0 14px rgba(124,249,255,.10)}
select option{color:#0b1630;background:#eaf6ff;font-weight:900}
#END{position:absolute;inset:0;z-index:50;background:rgba(8,16,34,.92);display:none;align-items:center;justify-content:center;flex-direction:column}
#END.show{display:flex}
#END_TEXT{font-size:58px;font-weight:900;margin:0 0 10px;animation:sway 2.5s ease-in-out infinite;text-align:center}
.win{color:var(--win);text-shadow:${cfg.neonGlow ? "0 0 12px var(--win),0 0 34px var(--win)" : "none"}}
.lose{color:var(--danger);text-shadow:${cfg.neonGlow ? "0 0 12px var(--danger),0 0 34px var(--danger)" : "none"}}
@keyframes sway{0%{transform:rotate(0)}25%{transform:rotate(2deg)}50%{transform:rotate(0)}75%{transform:rotate(-2deg)}100%{transform:rotate(0)}}
#END_BTNS{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
#FROG{position:absolute;left:160px;top:50%;width:110px;height:110px;background:url("${cfg.assets.hero}") no-repeat center/contain;transform:translate(-50%,-65%);z-index:15;transition:transform .6s ease,opacity .6s ease;pointer-events:none}
#FROG.jump{transform:translate(-50%,-95%) scale(1.05)}
#FROG.sink{transform:translate(-50%,-10%) scale(.6);opacity:0}
#PLATFORMS{position:absolute;inset:0;z-index:10}
.platform{position:absolute;width:150px;height:150px;transition:transform .5s,opacity .6s}
.lily{
  width:150px;height:150px;background:url("${cfg.assets.platform}") no-repeat center/contain;
  display:flex;align-items:center;justify-content:center;font-weight:900;
  color:${cfg.fonts.ansColor};font-size:${cfg.fonts.ansSize}px;
  text-shadow:0 2px 0 rgba(255,255,255,.65), 0 0 10px rgba(0,0,0,.35);
  animation:float 3.5s ease-in-out infinite;transition:transform .5s, filter .2s;
}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(6px)}}
.platform.answer{cursor:pointer}
.platform.fade{opacity:0}
.platform.fade .lily{transform:scale(.6)}
#FX{position:absolute;inset:0;pointer-events:none;z-index:200}
</style>
</head>
<body>
<div id="GAME">
  <div id="BG"></div>
  <div id="SCORE">‚≠ê 0</div>
  <div id="QUESTION"></div>
  <div id="TIMER">00:10</div>
  <div id="COMBO"><span id="COMBO_BOLT"></span><span id="COMBO_TXT">COMBO x1.0</span></div>
  <div id="LIVES"></div>

  <div id="START_SCREEN">
    <div id="START_CARD">
      <div id="START_TOP">
        <div id="START_ICON"></div>
        <div>
          <h1 id="START_TITLE">${escapeHtml(cfg.texts.title)}</h1>
          <div id="START_SUB">${escapeHtml(cfg.texts.sub)}</div>
        </div>
      </div>
      <div class="panel">
        <h3>How to Play</h3>
        <ul class="rules">${cfg.texts.rules}</ul>
      </div>
      <div id="START_BOTTOM">
        <div class="badge">
          <span>Mode:</span>
          <select id="LEVEL">
            <option value="all" selected>All Levels (1‚Üí${cfg.levels.length})</option>
            ${cfg.levels.map((_,i)=>`<option value="${i}">Level ${i+1}</option>`).join("")}
          </select>
          <small>campaign or single</small>
        </div>
        <div class="badge">
          <span>Difficulty:</span>
          <select id="DIFF">
            <option value="classic" selected>Classic</option>
            <option value="easy">Easy</option>
            <option value="hard">Hard</option>
          </select>
          <small>+ combos & penalties</small>
        </div>
        <button id="START_BTN" class="btn">${escapeHtml(cfg.texts.btnStart)}</button>
      </div>
    </div>
  </div>

  <div id="END">
    <div id="END_TEXT"></div>
    <div id="END_BTNS">
      <button id="RETRY" class="btn">${escapeHtml(cfg.texts.btnRetry)}</button>
    </div>
  </div>

  <div id="FX"></div>
  <div id="FROG"></div>
  <div id="PLATFORMS"></div>
</div>

<script>
const CFG = ${JSON.stringify(cfg)};

const LEVELS = (CFG.levels||[]);
const BASE=100, MULT=10, WRONG_PENALTY=80, LIVES_START=5;

const DIFF_PRESETS={
  classic:{t1:CFG.timers.t1,t2:CFG.timers.t2,t3:CFG.timers.t3},
  easy:{t1:CFG.timers.t1+2,t2:CFG.timers.t2+2,t3:CFG.timers.t3+2},
  hard:{t1:Math.max(1,CFG.timers.t1-1),t2:Math.max(1,CFG.timers.t2-1),t3:Math.max(1,CFG.timers.t3-1)},
};

const Q=QUESTION, T=TIMER, L=LIVES, S=SCORE, P=PLATFORMS;
const GAME=document.getElementById("GAME");
const FROG=document.getElementById("FROG");
const START_SCREEN=document.getElementById("START_SCREEN");
const START_BTN=document.getElementById("START_BTN");
const DIFF=document.getElementById("DIFF");
const LEVEL=document.getElementById("LEVEL");
const COMBO_UI=document.getElementById("COMBO");
const COMBO_TXT=document.getElementById("COMBO_TXT");
const END=document.getElementById("END");
const END_TEXT=document.getElementById("END_TEXT");
const RETRY=document.getElementById("RETRY");

let QUESTIONS=[], q=0, lives=LIVES_START, score=0, started=false, locked=false;
let timer=null, timeLeft=0, correctCount=0, combo=0, diffKey="classic";

const ctx=new (AudioContext||webkitAudioContext)();
function okSound(){
  const t=ctx.currentTime;
  [523,659,784].forEach((f,i)=>{
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.frequency.value=f;
    g.gain.setValueAtTime(0,t+i*.12);
    g.gain.linearRampToValueAtTime(.25,t+i*.12+.05);
    g.gain.exponentialRampToValueAtTime(.001,t+i*.12+.4);
    o.connect(g);g.connect(ctx.destination);
    o.start(t+i*.12);o.stop(t+i*.12+.45);
  });
}
function waterFailSound(){
  const b=ctx.createBuffer(1,ctx.sampleRate*.9,ctx.sampleRate);
  const d=b.getChannelData(0);
  for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*(1-i/d.length);
  const s=ctx.createBufferSource(),g=ctx.createGain();
  g.gain.value=.6;
  s.buffer=b;s.connect(g);g.connect(ctx.destination);s.start();
}

function fmt(s){ return "00:"+String(s).padStart(2,"0"); }
function shuffle(arr){
  const a=arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function randomizeQuestion(qObj){
  const packs=qObj.answers.map((txt,idx)=>({txt,idx}));
  const shuffled=shuffle(packs);
  const newAnswers=shuffled.map(x=>x.txt);
  const newCorrect=shuffled.findIndex(x=>x.idx===qObj.correct);
  return {text:qObj.text, answers:newAnswers, correct:newCorrect};
}
function buildQuestionsForLevel(idx){
  const lvl=LEVELS[idx]||LEVELS[0];
  const randomized=(lvl.questions||[]).map(q=>randomizeQuestion(q));
  QUESTIONS=shuffle(randomized);
}

function getRoundTime(){
  const d=DIFF_PRESETS[diffKey]||DIFF_PRESETS.classic;
  if(correctCount<3) return d.t1;
  if(correctCount<6) return d.t2;
  return d.t3;
}
function comboMultiplier(){
  const m=1+combo*0.12;
  return Math.min(2.0, Math.round(m*10)/10);
}
function updateComboUI(){
  if(combo<=0){ COMBO_UI.classList.remove("show"); return; }
  COMBO_UI.classList.add("show");
  COMBO_TXT.textContent=\`COMBO x\${comboMultiplier().toFixed(1)}\`;
}

function startTimer(){
  clearInterval(timer);
  timeLeft=getRoundTime();
  T.classList.remove("danger");
  T.textContent=fmt(timeLeft);
  timer=setInterval(()=>{
    timeLeft--;
    if(timeLeft<=0){ clearInterval(timer); fail("time"); return; }
    T.textContent=fmt(timeLeft);
    if(timeLeft<=3) T.classList.add("danger");
  },1000);
}

function render(){
  locked=!started;
  P.innerHTML="";
  Q.textContent=QUESTIONS[q]?.text||"";
  L.textContent="‚ù§Ô∏è".repeat(lives);
  S.textContent="‚≠ê "+score;
  updateComboUI();

  const STEP=190, y=innerHeight/2;
  const count=Math.ceil((innerWidth-160)/STEP)+4;

  for(let i=0;i<count;i++){
    const d=document.createElement("div");
    d.className="platform";
    d.style.left=160+STEP*i-75+"px";
    d.style.top=y-75+"px";
    const lily=document.createElement("div");
    lily.className="lily";

    if(i>0 && QUESTIONS[q] && i<=QUESTIONS[q].answers.length){
      lily.textContent=QUESTIONS[q].answers[i-1];
      d.classList.add("answer");
      d.onclick=()=>pick(i,d);
    }

    d.appendChild(lily);
    P.appendChild(d);
  }
}

function pick(i,el){
  if(!started||locked) return;
  locked=true;
  clearInterval(timer);
  document.querySelectorAll(".platform")
    .forEach(p=>p.style.transform=\`translateX(\${-(el.offsetLeft+75-160)}px)\`);
  setTimeout(()=>{
    const isCorrect=(i-1===QUESTIONS[q].correct);
    if(isCorrect){
      okSound();
      const basePts=BASE;
      const timePts=timeLeft*MULT;

      combo++;
      const mult=comboMultiplier();
      const comboBonus=Math.round((basePts+timePts)*(mult-1));

      score += basePts + timePts + comboBonus;
      correctCount++;
      q++;
      if(q>=QUESTIONS.length){ showEnd(true); }
      else startRound();
    }else{
      fail("wrong");
    }
  },500);
}

function fail(){
  lives--;
  combo=0;
  updateComboUI();
  score=Math.max(0, score-WRONG_PENALTY);
  waterFailSound();

  if(lives<=0) showEnd(false);
  else startRound();
}

function startRound(){
  locked=false;
  render();
  startTimer();
}

function showEnd(win){
  clearInterval(timer);
  END.classList.add("show");
  END_TEXT.textContent = win ? CFG.texts.win : CFG.texts.lose;
  END_TEXT.className = win ? "win" : "lose";
}

function resetAndMenu(){
  clearInterval(timer);
  started=false; locked=false;
  lives=LIVES_START; score=0; q=0; combo=0; correctCount=0;
  END.classList.remove("show");
  START_SCREEN.style.display="flex";
  T.textContent=fmt(getRoundTime());
  render();
}

DIFF.onchange=()=>{ diffKey=DIFF.value||"classic"; if(!started){ T.textContent=fmt(getRoundTime()); } };

START_BTN.onclick=()=>{
  ctx.resume();
  const v=LEVEL.value||"all";
  if(v==="all"){ buildQuestionsForLevel(0); } // —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –∫–∞–º–ø–∞–Ω–∏—è –≤ –ø—Ä–µ–≤—å—é
  else buildQuestionsForLevel(parseInt(v,10)||0);

  START_SCREEN.style.display="none";
  started=true;
  q=0; score=0; lives=LIVES_START; combo=0; correctCount=0;
  render(); startRound();
};

RETRY.onclick=()=>{ resetAndMenu(); };

window.addEventListener("resize", ()=>{ if(started && !END.classList.contains("show")) render(); });

/* INIT */
diffKey=DIFF.value||"classic";
buildQuestionsForLevel(0);
T.textContent=fmt(getRoundTime());
render();

/* –∞–≤—Ç–æ-—Å—Ç–∞—Ä—Ç –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ò–≥—Ä–∞—Ç—å" –≤ –ø—Ä–µ–≤—å—é */
if(CFG.forcePlay){
  setTimeout(()=>START_BTN.click(), 60);
}
${closeScript}
</body>
</html>`;

  return safeCloseScript(html);
}

/* ===== PREVIEW UPDATE ===== */
let previewMode = "menu"; // "menu" or "play"
let previewTimer = null;

function updatePreview(){
  const frame = $("previewFrame");
  const html = getGameHTML(previewMode==="play");
  frame.srcdoc = html; // <-- –≤–∞–∂–Ω–æ: —Å—Ç–∞–≤–∏–º srcdoc —Å–≤–æ–π—Å—Ç–≤–æ–º (–±–µ–∑ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)
}

function schedulePreviewUpdate(){
  clearTimeout(previewTimer);
  previewTimer = setTimeout(updatePreview, 120);
}

/* ===== tabs ===== */
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const key=t.getAttribute("data-tab");
    document.querySelectorAll(".tab-page").forEach(p=>p.style.display="none");
    $("tab-"+key).style.display="block";
  });
});

/* ===== custom toggles ===== */
$("bgSelect").addEventListener("change", ()=>{ toggleCustom($("bgSelect"),$("bgCustom")); schedulePreviewUpdate(); });
$("charSelect").addEventListener("change", ()=>{ toggleCustom($("charSelect"),$("charCustom")); schedulePreviewUpdate(); });
$("platSelect").addEventListener("change", ()=>{ toggleCustom($("platSelect"),$("platCustom")); schedulePreviewUpdate(); });

["bgCustom","charCustom","platCustom","colNeon","colDanger","colWin","neonGlow","winFX","colOverlay","opOverlay",
 "qCol","qSize","qFont","ansCol","ansSize","timeCol","timeSize",
 "txtTitle","txtSub","txtRules","btnStartTxt","txtWin","txtLose","btnNextTxt","btnFinishTxt","btnRetryTxt",
 "t1","t2","t3","audOk","audWrong","audFinalWin","audFinalLose"
].forEach(id=>{
  const el=$(id);
  el.addEventListener("input", schedulePreviewUpdate);
  el.addEventListener("change", schedulePreviewUpdate);
});

/* ===== levels add/remove ===== */
$("btnAddLevel").addEventListener("click", ()=>{
  levels.push({ name:`Level ${levels.length+1}`, q:"", a:"" });
  renderLevels();
  schedulePreviewUpdate();
});

/* ===== preview mode buttons ===== */
function setPreviewMode(mode){
  previewMode = mode;
  $("btnMenu").classList.toggle("active", mode==="menu");
  $("btnPlay").classList.toggle("active", mode==="play");
  updatePreview();
}
$("btnMenu").addEventListener("click", ()=>setPreviewMode("menu"));
$("btnPlay").addEventListener("click", ()=>setPreviewMode("play"));

/* ===== copy iframe ===== */
$("btnCopy").addEventListener("click", ()=>{
  const html = getGameHTML(false);
  const srcdoc = escapeForSingleQuotedAttr(html);
  const code = `<iframe style="width:100%;height:100%;border:0" srcdoc='${srcdoc}'></iframe>`;
  $("finalCode").value = code;
  $("COPY_MODAL").style.display="flex";
});
$("btnSelectAll").addEventListener("click", ()=>{
  $("finalCode").focus();
  $("finalCode").select();
});
$("btnClose").addEventListener("click", ()=>{ $("COPY_MODAL").style.display="none"; });

/* ===== INIT ===== */
renderLevels();
toggleCustom($("bgSelect"),$("bgCustom"));
toggleCustom($("charSelect"),$("charCustom"));
toggleCustom($("platSelect"),$("platCustom"));
updatePreview();
</script>
</body>
</html>
