<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Leap & Learn Editor - Pro</title>
<style>
  :root { --primary: #7cf9ff; --dark: #0a1730; --panel: #142342; --text: #eaf6ff; --accent: #4dff88; }
  body { margin:0; display:flex; height:100vh; background: #050b1a; color: var(--text); font-family: 'Segoe UI', sans-serif; overflow:hidden; }
  
  /* SIDEBAR */
  #EDITOR { width: 420px; background: var(--dark); border-right: 1px solid #333; display:flex; flex-direction:column; z-index:10; box-shadow: 4px 0 15px rgba(0,0,0,0.3); }
  #EDITOR_HEADER { padding:15px; background:var(--panel); border-bottom:1px solid #333; display:flex; align-items:center; justify-content:space-between; }
  #EDITOR_HEADER h2 { margin:0; font-size:18px; color:var(--primary); display:flex; align-items:center; gap:10px; }
  
  #TABS { display:flex; background:#000; }
  .tab { flex:1; padding:12px; text-align:center; cursor:pointer; background:#111; color:#777; border-bottom:3px solid transparent; font-size:12px; font-weight:bold; letter-spacing: 1px; transition:0.2s; }
  .tab:hover { color:#fff; background:#1a1a1a; }
  .tab.active { background:var(--panel); color:var(--primary); border-bottom:3px solid var(--primary); }
  
  #CONTROLS { flex:1; overflow-y:auto; padding:20px; }
  
  /* FORM ELEMENTS */
  .group { margin-bottom:25px; border-bottom:1px solid #222; padding-bottom:20px; }
  .group h3 { margin:0 0 15px; font-size:13px; color:var(--primary); text-transform:uppercase; letter-spacing:1px; opacity:0.8; }
  
  label { display:block; font-size:12px; margin-bottom:6px; margin-top:12px; color:#ccc; font-weight:500; }
  input[type="text"], input[type="number"], select, textarea { 
    width:100%; box-sizing:border-box; padding:10px; background:#080f20; border:1px solid #333; color:#fff; border-radius:6px; font-size:13px; font-family: inherit; transition:0.2s;
  }
  input:focus, textarea:focus, select:focus { border-color:var(--primary); outline:none; }
  input[type="color"] { width:100%; height:35px; border:none; background:none; cursor:pointer; padding:0; }
  
  .row { display:flex; gap:10px; }
  .col { flex:1; }

  /* LEVEL EDITOR (BULK) */
  .level-item { background:rgba(255,255,255,0.03); border:1px solid #333; margin-bottom:15px; border-radius:8px; overflow:hidden; transition:0.2s; }
  .level-item:hover { border-color:#555; }
  
  .level-header { 
    padding:12px 15px; background:rgba(255,255,255,0.05); cursor:pointer; 
    font-weight:bold; display:flex; align-items:center; justify-content:space-between; user-select:none;
  }
  .level-header:hover { background:rgba(255,255,255,0.08); }
  .level-content { padding:15px; display:none; border-top:1px solid #333; }
  .level-content.show { display:block; }

  .bulk-container { display:flex; gap:10px; height:200px; }
  .bulk-col { flex:1; display:flex; flex-direction:column; }
  .bulk-col label { color:var(--accent); font-size:11px; margin-bottom:4px; }
  .bulk-area { 
    flex:1; resize:none; font-family: 'Consolas', 'Courier New', monospace; font-size:12px; line-height:1.4; 
    white-space:pre; overflow-x:auto; background:#050a15; border:1px solid #444; color:#aaddff;
  }
  .hint { font-size:10px; color:#666; margin-top:4px; font-style:italic; }

  /* ICONS & BUTTONS */
  .btn { width:100%; padding:12px; cursor:pointer; background:var(--primary); color:#000; font-weight:bold; border:none; border-radius:6px; margin-top:10px; transition:0.2s; }
  .btn:hover { filter:brightness(1.1); transform:translateY(-1px); }
  .btn.danger { background:transparent; color:#ff3b3b; width:auto; padding:5px; margin:0; }
  .btn.danger:hover { color:#ff6b6b; transform:scale(1.1); }
  
  .icon-trash { width:20px; height:20px; fill:currentColor; }

  /* PREVIEW AREA */
  #PREVIEW_AREA { flex:1; background:#000; position:relative; display:flex; flex-direction:column; }
  #PREVIEW_BAR { 
    height:50px; background:#111; display:flex; align-items:center; justify-content:center; gap:20px; 
    border-bottom:1px solid #333; padding:0 15px;
  }
  #PREVIEW_BAR span { font-size:12px; color:#555; font-weight:bold; text-transform:uppercase; }
  
  .view-btn { 
    background:#222; color:#ccc; border:1px solid #444; padding:6px 15px; border-radius:20px; cursor:pointer; font-size:12px; display:flex; align-items:center; gap:6px; transition:0.2s;
  }
  .view-btn:hover { background:#333; color:#fff; }
  .view-btn.active { background:var(--primary); color:#000; border-color:var(--primary); font-weight:bold; }

  iframe { border:none; width:100%; flex:1; background:#0a1730; }
  
  /* COPY MODAL */
  #COPY_MODAL { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; display:none; align-items:center; justify-content:center; flex-direction:column; backdrop-filter:blur(5px); }
  #COPY_MODAL h2 { color:#fff; margin-bottom:15px; }
  #COPY_MODAL textarea { width:600px; height:300px; margin-bottom:15px; border:2px solid var(--accent); }
</style>
</head>
<body>

<!-- EDITOR SIDEBAR -->
<div id="EDITOR">
  <div id="EDITOR_HEADER">
    <h2>üê∏ Leap & Learn Editor</h2>
  </div>
  
  <div id="TABS">
    <div class="tab active" onclick="setTab('visuals')">–í–ò–ó–£–ê–õ</div>
    <div class="tab" onclick="setTab('gameplay')">–ì–ï–ô–ú–ü–õ–ï–ô</div>
    <div class="tab" onclick="setTab('levels')">–£–†–û–í–ù–ò</div>
  </div>
  
  <div id="CONTROLS">
    
    <!-- VISUALS TAB -->
    <div id="tab-visuals">
      <div class="group">
        <h3>üé® –ì–ª–æ–±–∞–ª—å–Ω—ã–π –°—Ç–∏–ª—å</h3>
        <label>–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç (–ù–µ–æ–Ω/–†–∞–º–∫–∏)</label>
        <input type="color" id="colNeon" value="#7cf9ff" oninput="updatePreview()">
      </div>

      <div class="group">
        <h3>üè† –≠–∫—Ä–∞–Ω –ü—Ä–∞–≤–∏–ª (–°—Ç–∞—Ä—Ç)</h3>
        <label>–¶–≤–µ—Ç —Ñ–æ–Ω–∞ (–∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ)</label>
        <input type="color" id="colStartBg" value="#081022" oninput="updatePreview()">
        
        <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∞–≤–∏–ª</label>
        <input type="color" id="colStartText" value="#eaf6ff" oninput="updatePreview()">

        <div class="row">
          <div class="col">
             <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞</label>
             <input type="number" id="fsStart" value="14" oninput="updatePreview()">
          </div>
          <div class="col">
             <label>–®—Ä–∏—Ñ—Ç</label>
             <select id="fontStart" onchange="updatePreview()">
               <option value="Arial, sans-serif">Arial</option>
               <option value="'Courier New', monospace">Courier</option>
               <option value="'Times New Roman', serif">Times</option>
               <option value="'Verdana', sans-serif">Verdana</option>
             </select>
          </div>
        </div>
      </div>

      <div class="group">
        <h3>üéÆ –≠–∫—Ä–∞–Ω –ò–≥—Ä—ã</h3>
        <label>–õ–æ–∫–∞—Ü–∏—è (–§–æ–Ω)</label>
        <select id="bgSelect" onchange="toggleCustom('bgSelect','bgCustom'); updatePreview()">
          <option value="river">–†–µ–∫–∞</option>
          <option value="lava">–õ–∞–≤–∞</option>
          <option value="swamp">–ë–æ–ª–æ—Ç–æ</option>
          <option value="custom">–°–≤–æ—è —Å—Å—ã–ª–∫–∞...</option>
        </select>
        <input type="text" id="bgCustom" placeholder="https://..." style="display:none; margin-top:5px;" oninput="updatePreview()">

        <label>–ü–µ—Ä—Å–æ–Ω–∞–∂</label>
        <select id="charSelect" onchange="toggleCustom('charSelect','charCustom'); updatePreview()">
          <option value="frog">–õ—è–≥—É—à–∫–∞</option>
          <option value="chameleon">–•–∞–º–µ–ª–µ–æ–Ω</option>
          <option value="lizard">–Ø—â–µ—Ä–∏—Ü–∞</option>
          <option value="custom">–°–≤–æ—è —Å—Å—ã–ª–∫–∞...</option>
        </select>
        <input type="text" id="charCustom" placeholder="https://..." style="display:none; margin-top:5px;" oninput="updatePreview()">

        <label>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
        <select id="platSelect" onchange="toggleCustom('platSelect','platCustom'); updatePreview()">
          <option value="lily">–õ–∏–ª–∏—è (–ö—É–≤—à–∏–Ω–∫–∞)</option>
          <option value="stone">–ö–∞–º–µ–Ω—å</option>
          <option value="mound">–ë–æ–ª–æ—Ç–Ω–∞—è –∫–æ—á–∫–∞</option>
          <option value="custom">–°–≤–æ—è —Å—Å—ã–ª–∫–∞...</option>
        </select>
        <input type="text" id="platCustom" placeholder="https://..." style="display:none; margin-top:5px;" oninput="updatePreview()">
        
        <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞</label>
        <div class="row">
           <div class="col"><input type="color" id="colQText" value="#0b1630" oninput="updatePreview()"></div>
           <div class="col"><input type="number" id="fsQ" value="40" placeholder="px" oninput="updatePreview()"></div>
        </div>
      </div>
    </div>

    <!-- GAMEPLAY TAB -->
    <div id="tab-gameplay" style="display:none">
      <div class="group">
        <h3>‚è±Ô∏è –¢–∞–π–º–µ—Ä (–°–ª–æ–∂–Ω–æ—Å—Ç—å)</h3>
        <div class="row">
          <div class="col"><label>–°—Ç–∞—Ä—Ç (—Å–µ–∫)</label><input type="number" id="time1" value="10" oninput="updatePreview()"></div>
          <div class="col"><label>–°–µ—Ä–µ–¥–∏–Ω–∞</label><input type="number" id="time2" value="7" oninput="updatePreview()"></div>
          <div class="col"><label>–§–∏–Ω–∞–ª</label><input type="number" id="time3" value="5" oninput="updatePreview()"></div>
        </div>
        <div class="hint">–í—Ä–µ–º—è —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ 3 –∏ 6 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–¥—Ä—è–¥.</div>
      </div>

      <div class="group">
        <h3>üîä –ê—É–¥–∏–æ (–°—Å—ã–ª–∫–∏ mp3)</h3>
        <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</label>
        <input type="text" id="audWin" placeholder="–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–≤—É–∫">
        <label>–û—à–∏–±–∫–∞ (–ü–ª—é—Ö –≤ –≤–æ–¥—É)</label>
        <input type="text" id="audFail" placeholder="–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–≤—É–∫">
        <label>–ü–æ–±–µ–¥–∞ (–§–∏–Ω–∞–ª)</label>
        <input type="text" id="audFinalWin" placeholder="–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–≤—É–∫">
        <label>–ü—Ä–æ–∏–≥—Ä—ã—à (–§–∏–Ω–∞–ª)</label>
        <input type="text" id="audFinalLose" placeholder="–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–≤—É–∫">
      </div>

      <div class="group">
        <h3>üèÜ –¢–µ–∫—Å—Ç—ã –§–∏–Ω–∞–ª–∞</h3>
        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ü–æ–±–µ–¥—ã</label>
        <input type="text" id="txtWin" value="CONGRATULATIONS!" oninput="updatePreview()">
        <label>–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ –ü–æ–±–µ–¥—ã</label>
        <input type="text" id="subWin" value="LEVEL COMPLETE" oninput="updatePreview()">
        
        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ü–æ—Ä–∞–∂–µ–Ω–∏—è</label>
        <input type="text" id="txtLose" value="YOU LOST!" oninput="updatePreview()">
        <label>–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ –ü–æ—Ä–∞–∂–µ–Ω–∏—è</label>
        <input type="text" id="subLose" value="TRY AGAIN" oninput="updatePreview()">
      </div>
    </div>

    <!-- LEVELS TAB -->
    <div id="tab-levels" style="display:none">
      <div id="levelsContainer"></div>
      <button class="btn" style="background:#333; color:#fff; border:1px dashed #555" onclick="addLevel()">+ –î–û–ë–ê–í–ò–¢–¨ –£–†–û–í–ï–ù–¨</button>
    </div>

    <br><br>
    <button class="btn" style="background:var(--accent); padding:16px; font-size:14px;" onclick="generateCode()">üìã –ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î –î–õ–Ø GENIALLY</button>
  </div>
</div>

<!-- PREVIEW AREA -->
<div id="PREVIEW_AREA">
  <div id="PREVIEW_BAR">
    <span>–†–µ–∂–∏–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞:</span>
    <div class="view-btn active" id="btnViewRules" onclick="toggleView('rules')">üëÅÔ∏è –≠–∫—Ä–∞–Ω –ø—Ä–∞–≤–∏–ª</div>
    <div class="view-btn" id="btnViewGame" onclick="toggleView('game')">üéÆ –≠–∫—Ä–∞–Ω –∏–≥—Ä—ã</div>
  </div>
  <iframe id="previewFrame"></iframe>
</div>

<!-- COPY MODAL -->
<div id="COPY_MODAL">
  <h2>–ì–æ—Ç–æ–≤–æ! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥:</h2>
  <textarea id="finalCode" onclick="this.select()"></textarea>
  <button class="btn" style="width:200px" onclick="document.getElementById('COPY_MODAL').style.display='none'">–ó–ê–ö–†–´–¢–¨</button>
</div>

<script>
// --- ASSETS ---
const ASSETS = {
  bg: {
    river: "https://img.genially.com/67961b32a116fb001568a75e/c0c9010f-c3dd-42c1-b7c1-65024fa3aec6.png",
    lava: "https://img.genially.com/67961b32a116fb001568a75e/fa2ab459-fec9-4ccd-97e3-254427b4ade0.png",
    swamp: "https://img.genially.com/67961b32a116fb001568a75e/02b52ad4-9d31-4b21-a305-8fec6e8a4487.png"
  },
  char: {
    frog: "https://img.genially.com/67961b32a116fb001568a75e/3074df22-5c73-4ad2-b0b2-491c6fc247f3.png",
    chameleon: "https://img.genially.com/67961b32a116fb001568a75e/74b56fcf-5354-43dd-9c9a-f50facc9a9bf.png",
    lizard: "https://img.genially.com/67961b32a116fb001568a75e/0feda2a1-485a-4654-8640-bf1adcc9f9ec.png"
  },
  plat: {
    lily: "https://img.genially.com/67961b32a116fb001568a75e/ed6c6e82-953b-43d4-947d-e46227b760f0.png",
    stone: "https://img.genially.com/67961b32a116fb001568a75e/bad37c6d-f04c-45c0-b954-807d79ec3a95.png",
    mound: "https://img.genially.com/67961b32a116fb001568a75e/c6775617-bde5-43e4-9da8-5332d928807e.png"
  }
};

// --- STATE ---
// We store raw text for bulk editing
let levelsData = [
  {
    name: "–£—Ä–æ–≤–µ–Ω—å 1",
    qText: "2 + 2 = ?\nCapital of France?\nRed + Blue = ?",
    aText: "4 | 5 | 22\nParis | London | Berlin\nPurple | Green | Orange"
  }
];

let currentView = 'rules';

// --- EDITOR LOGIC ---
function setTab(name) {
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  event.target.classList.add('active');
  document.querySelectorAll('#CONTROLS > div').forEach(d=>d.style.display='none');
  document.getElementById('tab-'+name).style.display='block';
}

function toggleCustom(selectId, inputId) {
  const val = document.getElementById(selectId).value;
  document.getElementById(inputId).style.display = (val === 'custom') ? 'block' : 'none';
}

// --- LEVEL RENDERER ---
function renderLevels() {
  const c = document.getElementById('levelsContainer');
  c.innerHTML = '';
  
  levelsData.forEach((lvl, idx) => {
    const div = document.createElement('div');
    div.className = 'level-item';
    
    // Count questions by lines
    const qCount = lvl.qText.split('\n').filter(l=>l.trim()).length;
    
    div.innerHTML = `
      <div class="level-header" onclick="toggleLevel(this)">
        <span>${lvl.name} <small style="opacity:0.6; margin-left:10px">(${qCount} –≤–æ–ø—Ä.)</small></span>
        <div style="display:flex; align-items:center; gap:10px">
           <button class="btn danger" onclick="event.stopPropagation(); removeLevel(${idx})" title="–£–¥–∞–ª–∏—Ç—å">
             <svg class="icon-trash" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
           </button>
           <span style="font-size:10px">‚ñº</span>
        </div>
      </div>
      <div class="level-content">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è</label>
        <input type="text" value="${lvl.name}" oninput="levelsData[${idx}].name=this.value; updateHeader(this, ${idx})">
        
        <div class="bulk-container">
          <div class="bulk-col">
             <label>–í–û–ü–†–û–°–´ (–ø–æ –æ–¥–Ω–æ–º—É –≤ —Å—Ç—Ä–æ–∫–µ)</label>
             <textarea class="bulk-area" placeholder="–í–æ–ø—Ä–æ—Å 1..." oninput="levelsData[${idx}].qText=this.value; updatePreviewDelayed()">${lvl.qText}</textarea>
          </div>
          <div class="bulk-col">
             <label>–û–¢–í–ï–¢–´ (–í–µ—Ä–Ω—ã–π | –ù–µ–≤–µ—Ä–Ω—ã–π | –ù–µ–≤–µ—Ä–Ω—ã–π)</label>
             <textarea class="bulk-area" placeholder="–í–µ—Ä–Ω—ã–π | –û—à–∏–±–∫–∞ | –û—à–∏–±–∫–∞" oninput="levelsData[${idx}].aText=this.value; updatePreviewDelayed()">${lvl.aText}</textarea>
          </div>
        </div>
        <div class="hint">–í –∏–≥—Ä–µ –æ—Ç–≤–µ—Ç—ã –ø–µ—Ä–µ–º–µ—à–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ó–¥–µ—Å—å –ø–∏—à–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–≤—ã–º.</div>
      </div>
    `;
    c.appendChild(div);
  });
}

function toggleLevel(header) {
  const content = header.nextElementSibling;
  content.classList.toggle('show');
}

function updateHeader(input, idx) {
  // Just updates the header text immediately
  const count = levelsData[idx].qText.split('\n').filter(l=>l.trim()).length;
  input.closest('.level-content').previousElementSibling.querySelector('span').innerHTML = `${input.value} <small style="opacity:0.6; margin-left:10px">(${count} –≤–æ–ø—Ä.)</small>`;
}

function addLevel() {
  levelsData.push({
    name: "–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å " + (levelsData.length + 1),
    qText: "",
    aText: ""
  });
  renderLevels();
  // Open the new level
  setTimeout(() => {
    const items = document.querySelectorAll('.level-content');
    if(items.length) items[items.length-1].classList.add('show');
  }, 50);
}

function removeLevel(idx) {
  if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —É—Ä–æ–≤–µ–Ω—å?")) {
    levelsData.splice(idx, 1);
    renderLevels();
    updatePreview();
  }
}

// --- PARSING & GENERATION ---
function parseLevels() {
  return levelsData.map(lvl => {
    const qLines = lvl.qText.split('\n').filter(l => l.trim() !== '');
    const aLines = lvl.aText.split('\n').filter(l => l.trim() !== '');
    
    const questions = qLines.map((qText, i) => {
      const rawAns = aLines[i] ? aLines[i].split('|') : ["True", "False"];
      // Trim answers
      const answers = rawAns.map(a => a.trim());
      // In Bulk mode, we assume index 0 is correct. Game engine randomizes later.
      return { text: qText.trim(), answers: answers, correct: 0 };
    });
    
    return { name: lvl.name, questions: questions };
  });
}

function getGameHTML() {
  const getVal = (id) => document.getElementById(id).value;
  
  // Visuals
  const bgType = getVal('bgSelect');
  const bgUrl = bgType==='custom' ? getVal('bgCustom') : ASSETS.bg[bgType];
  const charType = getVal('charSelect');
  const charUrl = charType==='custom' ? getVal('charCustom') : ASSETS.char[charType];
  const platType = getVal('platSelect');
  const platUrl = platType==='custom' ? getVal('platCustom') : ASSETS.plat[platType];
  
  const colNeon = getVal('colNeon');
  
  // Start Screen Vars
  const colStartBg = getVal('colStartBg'); // e.g. #0a1730 or rgba...
  const colStartText = getVal('colStartText');
  const fsStart = getVal('fsStart');
  const fontStart = getVal('fontStart');

  // Game Vars
  const colQText = getVal('colQText');
  const fsQ = getVal('fsQ');

  const times = { 
    t1: parseInt(getVal('time1')), 
    t2: parseInt(getVal('time2')), 
    t3: parseInt(getVal('time3')) 
  };
  
  const audioCfg = {
    win: getVal('audWin'), fail: getVal('audFail'),
    finalWin: getVal('audFinalWin'), finalLose: getVal('audFinalLose')
  };

  const textCfg = {
    winH: getVal('txtWin'), winS: getVal('subWin'),
    loseH: getVal('txtLose'), loseS: getVal('subLose')
  };
  
  const parsedLevels = parseLevels();

  // Create opacity from hex for start bg if needed, but simple hex is fine
  // We'll convert hex to rgba for the overlay if user picked a solid color
  // Actually CSS handles colors fine.
  
  return `<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Leap & Learn</title>
<style>
:root{
  --neon: ${colNeon};
  --bg-img: url("${bgUrl}");
  --char-img: url("${charUrl}");
  --plat-img: url("${platUrl}");
  
  /* Start Screen */
  --start-bg: ${colStartBg};
  --start-text: ${colStartText};
  --start-font: ${fontStart};
  --start-fs: ${fsStart}px;

  /* Game */
  --q-col: ${colQText};
  --q-fs: ${fsQ}px;
}
html,body{margin:0;width:100%;height:100%;overflow:hidden;font-family:Arial,sans-serif;background:#000}
#GAME{position:relative;width:100%;height:100%}
#BG{position:absolute;inset:0;z-index:0;background:var(--bg-img) center/cover no-repeat}

/* UI */
#TIMER{position:absolute;top:20px;left:20px;padding:8px 16px;background:#fff;border-radius:20px;border:2px solid var(--neon);box-shadow:0 0 15px var(--neon);font-weight:900;z-index:20;font-size:18px}
#TIMER.danger{color:red;border-color:red;box-shadow:0 0 20px red;animation:pulse .5s infinite}
#SCORE{position:absolute;top:24px;right:20px;font-size:22px;color:#fff;font-weight:900;z-index:20;text-shadow:0 2px 0 #000}
#LIVES{position:absolute;top:60px;right:20px;font-size:20px;z-index:20}

#QUESTION{position:absolute;top:80px;width:100%;display:flex;justify-content:center;z-index:20;pointer-events:none}
#QUESTION_TXT{
  background:rgba(255,255,255,0.9); padding:15px 25px; border-radius:15px; 
  border:2px solid var(--neon); box-shadow:0 0 20px var(--neon);
  color:var(--q-col); font-size:var(--q-fs); font-weight:bold; text-align:center;
}

/* START SCREEN */
#START_SCREEN{
  position:absolute;inset:0;z-index:50;
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.4); /* Dim slightly to show BG behind if desired */
}
/* The main card */
#START_CARD{
  width:min(700px, 90%);
  background:var(--start-bg);
  color:var(--start-text);
  font-family:var(--start-font);
  border:2px solid var(--neon);
  box-shadow:0 0 30px var(--neon), inset 0 0 20px rgba(0,0,0,0.5);
  border-radius:20px;
  padding:30px;
  position:relative;
  text-align:left;
}
#START_CARD h1{ margin:0 0 10px; font-size:2.5em; text-shadow:0 0 10px var(--neon); }
.rules-box{ font-size:var(--start-fs); line-height:1.5; margin-bottom:20px; opacity:0.9; }
.rules-box ul{ padding-left:20px; }

/* END SCREEN */
#END{position:absolute;inset:0;z-index:50;background:rgba(0,0,0,0.9);display:none;flex-direction:column;align-items:center;justify-content:center;color:#fff}
#END.show{display:flex}
.end-title{font-size:50px;font-weight:900;margin:0;text-shadow:0 0 20px var(--neon)}
.end-sub{font-size:20px;opacity:0.8;margin-bottom:30px;text-transform:uppercase;letter-spacing:2px;color:var(--neon)}

/* GAME OBJECTS */
#FROG{width:100px;height:100px;background:var(--char-img) center/contain no-repeat;position:absolute;left:50%;top:50%;transform:translate(-50%,-65%);z-index:15;transition:transform .4s, opacity .4s}
#FROG.jump{animation:jump .4s ease-in-out}
#FROG.sink{transform:translate(-50%,10%) scale(0);opacity:0}
@keyframes jump{0%{transform:translate(-50%,-65%)}50%{transform:translate(-50%,-120%) scale(1.1)}100%{transform:translate(-50%,-65%)}}

#PLATFORMS{position:absolute;inset:0;z-index:10}
.plat{position:absolute;width:140px;height:140px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .3s}
.plat:hover{transform:scale(1.05)}
.lily{width:100%;height:100%;background:var(--plat-img) center/contain no-repeat;display:flex;align-items:center;justify-content:center;padding-bottom:10px;box-sizing:border-box}
.ans-text{font-weight:bold;color:#000;background:rgba(255,255,255,0.8);padding:4px 8px;border-radius:6px;font-size:16px;pointer-events:none}

.btn{padding:12px 30px;font-size:18px;font-weight:bold;background:#fff;border:none;border-radius:30px;cursor:pointer;box-shadow:0 0 15px var(--neon);transition:.2s}
.btn:hover{transform:scale(1.1)}

@keyframes pulse{50%{transform:scale(1.1)}}
</style>
</head>
<body>
<div id="GAME">
  <div id="BG"></div>
  <div id="TIMER">00:00</div>
  <div id="SCORE">‚≠ê 0</div>
  <div id="LIVES">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
  <div id="QUESTION"><div id="QUESTION_TXT">Loading...</div></div>
  
  <div id="START_SCREEN">
    <div id="START_CARD">
       <div style="display:flex;align-items:center;gap:20px;margin-bottom:20px">
         <div style="width:80px;height:80px;background:var(--char-img) center/contain no-repeat"></div>
         <div>
           <h1>Leap & Learn</h1>
           <div style="opacity:0.8">Interactive Quiz Game</div>
         </div>
       </div>
       <div class="rules-box">
         <b>How to Play:</b>
         <ul>
           <li>Read the question at the top.</li>
           <li>Click the platform with the correct answer.</li>
           <li>Watch out for the timer!</li>
         </ul>
       </div>
       <div style="text-align:right">
         <button class="btn" onclick="startGame()">‚ñ∂ START GAME</button>
       </div>
    </div>
  </div>

  <div id="END">
    <div id="END_TITLE" class="end-title"></div>
    <div id="END_SUB" class="end-sub"></div>
    <div style="font-size:24px;margin-bottom:20px">Score: <span id="FINAL_SCORE">0</span></div>
    <button class="btn" onclick="location.reload()">üîÅ PLAY AGAIN</button>
  </div>

  <div id="PLATFORMS"></div>
  <div id="FROG"></div>
</div>

<script>
const LEVELS = ${JSON.stringify(parsedLevels)};
const CFG_TIME = ${JSON.stringify(times)};
const CFG_AUDIO = ${JSON.stringify(audioCfg)};
const CFG_TEXT = ${JSON.stringify(textCfg)};

/* GAME LOGIC */
let lvlIdx=0, qIdx=0, score=0, lives=5, timer=null, timeLeft=0;
let questions=[], correctCount=0;
let isGame=false;

const UI={
  start: document.getElementById('START_SCREEN'),
  game: document.getElementById('GAME'),
  end: document.getElementById('END'),
  q: document.getElementById('QUESTION_TXT'),
  p: document.getElementById('PLATFORMS'),
  frog: document.getElementById('FROG'),
  timer: document.getElementById('TIMER'),
  score: document.getElementById('SCORE'),
  lives: document.getElementById('LIVES')
};

// Auto-start for preview mode if needed
window.onload = function(){
  // If the editor asks to show game immediately
  if(window.location.hash === '#game') startGame();
}

function playSound(key){
  if(CFG_AUDIO[key]) new Audio(CFG_AUDIO[key]).play().catch(()=>{});
}

function shuffle(array) {
  return array.sort(() => Math.random() - 0.5);
}

function startGame(){
  UI.start.style.display='none';
  isGame=true;
  loadLevel(0);
}

function loadLevel(idx){
  if(idx >= LEVELS.length){ showEnd(true); return; }
  lvlIdx = idx;
  // Deep copy questions
  questions = JSON.parse(JSON.stringify(LEVELS[idx].questions));
  // Randomize question order
  questions = shuffle(questions);
  qIdx=0;
  startRound();
}

function startRound(){
  if(qIdx >= questions.length){ loadLevel(lvlIdx+1); return; }
  
  const qData = questions[qIdx];
  UI.q.textContent = qData.text;
  UI.score.textContent = "‚≠ê " + score;
  UI.lives.textContent = "‚ù§Ô∏è".repeat(lives);
  UI.frog.classList.remove('jump','sink');
  
  // Timer logic
  let t = (correctCount<3)?CFG_TIME.t1 : (correctCount<6)?CFG_TIME.t2 : CFG_TIME.t3;
  timeLeft = t;
  UI.timer.textContent = "00:"+String(timeLeft).padStart(2,'0');
  UI.timer.className = "";
  
  clearInterval(timer);
  timer = setInterval(()=>{
    timeLeft--;
    if(timeLeft<=3) UI.timer.className="danger";
    UI.timer.textContent = "00:"+String(timeLeft).padStart(2,'0');
    if(timeLeft<=0) fail();
  },1000);

  // Platforms
  UI.p.innerHTML = "";
  // Prepare answers: {text, isCorrect}
  let ansObjs = qData.answers.map((a,i) => ({ txt:a, isCorrect:(i===qData.correct) }));
  ansObjs = shuffle(ansObjs); // Shuffle positions

  // Draw 3 platforms centered
  const startX = window.innerWidth/2 - 180;
  ansObjs.slice(0,3).forEach((ans, i) => {
    const d = document.createElement('div');
    d.className = 'plat';
    d.style.left = (startX + i*180) + "px";
    d.style.top = (window.innerHeight/2 + 60) + "px";
    
    d.innerHTML = \`<div class="lily"><div class="ans-text">\${ans.txt}</div></div>\`;
    d.onclick = () => {
      if(!isGame) return;
      clearInterval(timer);
      UI.frog.classList.add('jump');
      // Move platforms
      const offset = d.offsetLeft - (window.innerWidth/2 - 50);
      const all = document.querySelectorAll('.plat');
      all.forEach(p => p.style.transform = \`translateX(\${-offset}px)\`);
      
      setTimeout(()=>{
        if(ans.isCorrect){
           score+=100; correctCount++;
           playSound('win');
           qIdx++; startRound();
        } else {
           fail();
        }
      }, 400);
    };
    UI.p.appendChild(d);
  });
}

function fail(){
  clearInterval(timer);
  lives--;
  playSound('fail');
  UI.frog.classList.add('sink');
  if(lives<=0) showEnd(false);
  else setTimeout(startRound, 1000);
}

function showEnd(win){
  isGame=false;
  UI.end.classList.add('show');
  document.getElementById('FINAL_SCORE').textContent = score;
  const t = document.getElementById('END_TITLE');
  const s = document.getElementById('END_SUB');
  
  if(win){
    t.textContent = CFG_TEXT.winH; s.textContent = CFG_TEXT.winS;
    t.style.color = "#ffe44d";
    playSound('finalWin');
  } else {
    t.textContent = CFG_TEXT.loseH; s.textContent = CFG_TEXT.loseS;
    t.style.color = "#ff3b3b";
    playSound('finalLose');
  }
}

// Msg listener for editor preview
window.addEventListener('message', e => {
   if(e.data === 'showRules') { UI.start.style.display='flex'; UI.end.classList.remove('show'); isGame=false; }
   if(e.data === 'showGame') { startGame(); }
});

<\/script>
</body>
</html>`;
}

// --- PREVIEW HANDLING ---
let typingTimer;
function updatePreviewDelayed() {
  clearTimeout(typingTimer);
  typingTimer = setTimeout(updatePreview, 800);
}

function updatePreview() {
  const html = getGameHTML();
  const frame = document.getElementById('previewFrame');
  frame.srcdoc = html;
  
  // Restore view mode after load
  frame.onload = () => {
    if(currentView === 'game') {
      frame.contentWindow.postMessage('showGame', '*');
    }
  };
}

function toggleView(mode) {
  currentView = mode;
  document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
  
  if(mode === 'rules') {
    document.getElementById('btnViewRules').classList.add('active');
    document.getElementById('previewFrame').contentWindow.postMessage('showRules', '*');
  } else {
    document.getElementById('btnViewGame').classList.add('active');
    document.getElementById('previewFrame').contentWindow.postMessage('showGame', '*');
  }
}

function generateCode() {
  const html = getGameHTML();
  // We don't want the #hash hack in the final code
  const iframeCode = `<iframe style="width:100%;height:100%;border:0" srcdoc='${html.replace(/'/g, "&#39;")}'></iframe>`;
  document.getElementById('finalCode').value = iframeCode;
  document.getElementById('COPY_MODAL').style.display = 'flex';
}

// Init
renderLevels();
updatePreview();
</script>
</body>
</html>
