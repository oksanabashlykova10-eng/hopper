<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Leap & Learn: Ultimate Editor Fixed</title>
<style>
  /* --- –°–¢–ò–õ–ò –†–ï–î–ê–ö–¢–û–†–ê (–¢–ï–ú–ù–´–ô UI) --- */
  :root { --accent: #7cf9ff; --bg: #050b1a; --panel: #142342; --text: #eaf6ff; --green: #4dff88; }
  body { margin:0; display:flex; height:100vh; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; overflow:hidden; }
  
  /* –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ */
  #EDITOR { width: 480px; min-width: 480px; background: #0a1730; border-right: 1px solid #333; display:flex; flex-direction:column; z-index:20; box-shadow: 5px 0 20px rgba(0,0,0,0.5); }
  .head-bar { padding:15px 20px; background:var(--panel); border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; }
  h2 { margin:0; font-size:16px; color:var(--accent); letter-spacing:1px; text-transform:uppercase; }
  
  /* –¢–ê–ë–´ */
  .tabs { display:flex; background:#000; }
  .tab { flex:1; padding:15px 0; text-align:center; font-size:11px; font-weight:bold; cursor:pointer; opacity:0.5; transition:0.3s; border-bottom:3px solid transparent; color:#fff; text-transform:uppercase; }
  .tab:hover { opacity:0.8; background:rgba(255,255,255,0.05); }
  .tab.active { opacity:1; border-bottom-color:var(--accent); background:rgba(124,249,255,0.1); color:var(--accent); }
  
  /* –ö–û–ù–¢–ï–ù–¢ */
  .content-area { flex:1; overflow-y:auto; padding:20px; }
  .group { background:var(--panel); border:1px solid #2a3b5a; border-radius:8px; padding:15px; margin-bottom:15px; }
  .group h3 { margin:0 0 12px 0; font-size:12px; color:var(--accent); border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px; text-transform:uppercase; }
  
  label { display:block; font-size:11px; color:#aaa; margin-bottom:5px; margin-top:10px; }
  input, select, textarea { width:100%; box-sizing:border-box; background:#050b1a; border:1px solid #334155; color:#fff; padding:8px; border-radius:4px; font-size:13px; font-family:monospace; }
  input:focus { border-color:var(--accent); outline:none; }
  input[type="color"] { height:35px; padding:2px; cursor:pointer; }
  
  .btn { width:100%; padding:10px; background:var(--accent); color:#000; border:none; border-radius:4px; cursor:pointer; font-weight:bold; margin-top:10px; transition:0.2s; }
  .btn:hover { filter:brightness(1.1); }
  .btn-copy { width:auto; padding:5px 15px; background:#fff; font-size:11px; }
  .btn-del { background:#ff3b3b; color:#fff; width:30px; margin:0; }

  /* –ü–†–ê–í–ê–Ø –ß–ê–°–¢–¨ (–ü–†–ï–í–¨–Æ) */
  #PREVIEW { flex:1; background:#000; position:relative; }
  iframe { width:100%; height:100%; border:none; }
  
  /* –ú–û–î–ê–õ–ö–ê */
  #MODAL { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; align-items:center; justify-content:center; }
  .modal-box { width:800px; height:80%; background:var(--panel); border:2px solid var(--accent); padding:30px; display:flex; flex-direction:column; border-radius:10px; }
  .cols { display:flex; gap:20px; flex:1; height:100%; }
  .col { flex:1; display:flex; flex-direction:column; }
  textarea { flex:1; resize:none; line-height:1.5; }
</style>
</head>
<body>

<div id="EDITOR">
  <div class="head-bar">
    <h2>Leap Editor</h2>
    <button class="btn btn-copy" onclick="copyCode()">üìã –ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î</button>
  </div>
  
  <div class="tabs">
    <div class="tab active" onclick="setTab('main', this)">–ì–ª–∞–≤–Ω–∞—è</div>
    <div class="tab" onclick="setTab('hero', this)">–í–∏–∑—É–∞–ª</div>
    <div class="tab" onclick="setTab('lvls', this)">–£—Ä–æ–≤–Ω–∏</div>
  </div>

  <div class="content-area">
    <div id="t-main" class="pane">
      <div class="group">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã</h3>
        <label>–í—Ä–µ–º—è –Ω–∞ –≤–æ–ø—Ä–æ—Å (—Å–µ–∫)</label>
        <input type="number" id="g_time" value="15" oninput="upd()">
        <label>–ñ–∏–∑–Ω–∏</label>
        <input type="number" id="g_lives" value="3" oninput="upd()">
      </div>
      <div class="group">
        <h3>–ó–≤—É–∫–∏ (URL mp3)</h3>
        <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</label>
        <input type="text" id="s_ok" oninput="upd()">
        <label>–û—à–∏–±–∫–∞</label>
        <input type="text" id="s_no" oninput="upd()">
        <label>–ü–æ–±–µ–¥–∞</label>
        <input type="text" id="s_win" oninput="upd()">
      </div>
    </div>

    <div id="t-hero" class="pane" style="display:none">
      <div class="group">
        <h3>–ü–µ—Ä—Å–æ–Ω–∞–∂ –∏ –º–∏—Ä</h3>
        <label>–§–æ–Ω (URL)</label>
        <input type="text" id="bg_url" value="https://img.genially.com/67961b32a116fb001568a75e/c0c9010f-c3dd-42c1-b7c1-65024fa3aec6.png" oninput="upd()">
        <label>–ì–µ—Ä–æ–π (URL)</label>
        <input type="text" id="h_url" value="https://img.genially.com/67961b32a116fb001568a75e/3074df22-5c73-4ad2-b0b2-491c6fc247f3.png" oninput="upd()">
        <label>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ (URL)</label>
        <input type="text" id="p_url" value="https://img.genially.com/67961b32a116fb001568a75e/ed6c6e82-953b-43d4-947d-e46227b760f0.png" oninput="upd()">
      </div>
      <div class="group">
        <h3>–¶–≤–µ—Ç–∞</h3>
        <label>–¶–≤–µ—Ç –Ω–µ–æ–Ω–∞</label>
        <input type="color" id="c_ui" value="#7cf9ff" oninput="upd()">
        <label>–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞</label>
        <input type="number" id="f_size" value="32" oninput="upd()">
      </div>
    </div>

    <div id="t-lvls" class="pane" style="display:none">
      <div id="lvl-list"></div>
      <button class="btn" style="background:var(--green); color:#000" onclick="addLvl()">+ –î–û–ë–ê–í–ò–¢–¨ –£–†–û–í–ï–ù–¨</button>
    </div>
  </div>
</div>

<div id="PREVIEW">
  <iframe id="gameFrame"></iframe>
</div>

<div id="MODAL">
  <div class="modal-box">
    <h2 style="margin-bottom:15px; color:var(--accent)">–†–µ–¥–∞–∫—Ç–æ—Ä —É—Ä–æ–≤–Ω—è</h2>
    <div class="cols">
      <div class="col">
        <label>–í–æ–ø—Ä–æ—Å—ã (–æ–¥–∏–Ω –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label>
        <textarea id="m_q"></textarea>
      </div>
      <div class="col">
        <label>–û—Ç–≤–µ—Ç—ã (–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π|–ù–µ–≤–µ—Ä–Ω—ã–π|–ù–µ–≤–µ—Ä–Ω—ã–π)</label>
        <textarea id="m_a"></textarea>
      </div>
    </div>
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
      <button class="btn" style="background:#555; width:150px" onclick="document.getElementById('MODAL').style.display='none'">–û–¢–ú–ï–ù–ê</button>
      <button class="btn" style="width:150px" onclick="saveLvl()">–°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>
  </div>
</div>

<script>
// --- JS –†–ï–î–ê–ö–¢–û–†–ê ---
let levels = [
  {name:"–£—Ä–æ–≤–µ–Ω—å 1", q:["2 + 2 = ?", "–°—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏?"], a:["4|5|10", "–ü–∞—Ä–∏–∂|–†–∏–º|–ë–µ—Ä–ª–∏–Ω"]}
];
let actLvl = 0;

function setTab(name, el){
  document.querySelectorAll('.pane').forEach(x=>x.style.display='none');
  document.getElementById('t-'+name).style.display='block';
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  el.classList.add('active');
}

function renderLvl(){
  const list = document.getElementById('lvl-list');
  list.innerHTML = '';
  levels.forEach((l, i)=>{
    const div = document.createElement('div');
    div.className = 'group';
    div.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center">
        <b>${l.name}</b>
        <div style="display:flex; gap:5px">
          <button class="btn" style="margin:0; width:auto; padding:5px 10px; font-size:10px" onclick="editLvl(${i})">‚úèÔ∏è</button>
          <button class="btn btn-del" onclick="delLvl(${i})">‚úï</button>
        </div>
      </div>
      <div style="font-size:10px; margin-top:5px; opacity:0.6">${l.q.length} –≤–æ–ø—Ä–æ—Å–æ–≤</div>
    `;
    list.appendChild(div);
  });
  upd();
}

function addLvl(){ levels.push({name:"–£—Ä–æ–≤–µ–Ω—å "+(levels.length+1), q:["?"], a:["Wait|No|No"]}); renderLvl(); }
function delLvl(i){ if(levels.length>1 && confirm("–£–¥–∞–ª–∏—Ç—å?")) { levels.splice(i,1); renderLvl(); } }
function editLvl(i){
  actLvl = i;
  document.getElementById('m_q').value = levels[i].q.join('\n');
  document.getElementById('m_a').value = levels[i].a.join('\n');
  document.getElementById('MODAL').style.display = 'flex';
}
function saveLvl(){
  levels[actLvl].q = document.getElementById('m_q').value.split('\n').filter(x=>x.trim());
  levels[actLvl].a = document.getElementById('m_a').value.split('\n').filter(x=>x.trim());
  document.getElementById('MODAL').style.display = 'none';
  renderLvl();
}
function copyCode(){
  const code = getGameCode();
  navigator.clipboard.writeText(code).then(()=>alert("–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!"));
}

function upd(){
  document.getElementById('gameFrame').srcdoc = getGameCode();
}

// --- –ì–ï–ù–ï–†–ê–¢–û–† –ò–ì–†–´ (–°–ê–ú–û–ï –í–ê–ñ–ù–û–ï) ---
function getGameCode(){
  const cfg = {
    bg: document.getElementById('bg_url').value,
    hero: document.getElementById('h_url').value,
    plat: document.getElementById('p_url').value,
    color: document.getElementById('c_ui').value,
    fsize: document.getElementById('f_size').value,
    time: document.getElementById('g_time').value,
    lives: document.getElementById('g_lives').value,
    sfx: {
      ok: document.getElementById('s_ok').value,
      no: document.getElementById('s_no').value,
      win: document.getElementById('s_win').value
    },
    levels: levels
  };

  return `<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
  :root { --main: ${cfg.color}; }
  body { margin:0; overflow:hidden; font-family:'Segoe UI', sans-serif; background:#000; color:#fff; user-select:none; }
  
  #GAME { position:absolute; inset:0; background:url('${cfg.bg}') center/cover no-repeat; }
  
  /* –ò–ù–¢–ï–†–§–ï–ô–° */
  .hud { position:absolute; top:20px; left:20px; display:flex; gap:15px; z-index:10; }
  .hud-box { background:rgba(0,0,0,0.7); padding:10px 20px; border:2px solid var(--main); border-radius:20px; font-weight:bold; font-size:20px; box-shadow: 0 0 10px var(--main); }
  
  #Q_BOX { position:absolute; top:15%; width:100%; text-align:center; font-size:${cfg.fsize}px; font-weight:900; text-shadow:0 4px 10px #000; padding:0 40px; box-sizing:border-box; z-index:5; }
  
  /* –ò–ì–†–û–í–û–ï –ü–û–õ–ï */
  #HERO { position:absolute; bottom:20%; left:10%; width:120px; height:120px; background:url('${cfg.hero}') center/contain no-repeat; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index:5; }
  #PLATS { position:absolute; bottom:20%; width:100%; display:flex; justify-content:center; gap:60px; z-index:4; }
  .plat { width:150px; height:100px; background:url('${cfg.plat}') center/contain no-repeat; display:flex; align-items:center; justify-content:center; color:#000; font-weight:bold; font-size:18px; cursor:pointer; padding-top:15px; transition:0.2s; text-align:center; }
  .plat:hover { transform:scale(1.1) translateY(-10px); }
  
  /* –û–ö–ù–ê –ò –¢–ê–ë–õ–ò–¶–´ */
  .screen { position:fixed; inset:0; background:rgba(0,0,0,0.92); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:100; opacity:0; pointer-events:none; transition:0.5s; }
  .screen.active { opacity:1; pointer-events:auto; }
  
  .card { background:#142342; border:3px solid var(--main); padding:40px; border-radius:20px; text-align:center; width:500px; box-shadow: 0 0 50px rgba(124,249,255,0.2); position:relative; z-index:101; }
  h1 { color:var(--main); margin:0 0 20px 0; font-size:36px; text-transform:uppercase; }
  
  /* –¢–ê–ë–õ–ò–¶–ê –°–ß–ï–¢–ê */
  .stats-table { width:100%; margin:20px 0; background:rgba(0,0,0,0.3); border-radius:10px; padding:15px; }
  .row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.1); font-size:18px; }
  .row.total { border-top:2px solid var(--main); border-bottom:none; margin-top:10px; padding-top:15px; color:var(--main); font-weight:bold; font-size:24px; }
  
  .btn { background:var(--main); color:#000; padding:15px 40px; border:none; border-radius:10px; font-size:20px; font-weight:bold; cursor:pointer; margin-top:20px; transition:0.3s; text-transform:uppercase; }
  .btn:hover { transform:scale(1.05); box-shadow:0 0 20px var(--main); }

  /* –≠–§–§–ï–ö–¢–´ */
  #FX { position:fixed; inset:0; pointer-events:none; z-index:9999; } /* –°–ê–ú–´–ô –í–ï–†–•–ù–ò–ô –°–õ–û–ô */
  .shake { animation: shake 0.4s; }
  @keyframes shake { 0%{transform:translate(0)} 25%{transform:translate(-5px, 5px)} 50%{transform:translate(5px, -5px)} 100%{transform:translate(0)} }
</style>
</head>
<body>

<div id="GAME">
  <div class="hud">
    <div class="hud-box">‚ù§Ô∏è <span id="ui_lives">0</span></div>
    <div class="hud-box">‚è±Ô∏è <span id="ui_time">0</span></div>
    <div class="hud-box">‚≠ê <span id="ui_score">0</span></div>
  </div>
  <div id="Q_BOX"></div>
  <div id="HERO"></div>
  <div id="PLATS"></div>
</div>

<div id="S_START" class="screen active">
  <div class="card">
    <h1>Leap & Learn</h1>
    <p>–û—Ç–≤–µ—á–∞–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ, —á—Ç–æ–±—ã –ø—Ä—ã–≥–∞—Ç—å –¥–∞–ª—å—à–µ!</p>
    <button class="btn" onclick="Game.init()">–ò–ì–†–ê–¢–¨</button>
  </div>
</div>

<div id="S_LEVEL" class="screen">
  <div class="card">
    <h1>–£–†–û–í–ï–ù–¨ –ü–†–û–ô–î–ï–ù!</h1>
    <div class="stats-table" id="lvl_stats"></div>
    <button class="btn" onclick="Game.nextLevel()">–î–ê–õ–ï–ï</button>
  </div>
</div>

<div id="S_END" class="screen">
  <div class="card">
    <h1 id="end_msg"></h1>
    <div class="stats-table" id="end_stats"></div>
    <button class="btn" onclick="location.reload()">–ó–ê–ù–û–í–û</button>
  </div>
</div>

<canvas id="FX"></canvas>

<script>
const CFG = ${JSON.stringify(cfg)};
const AUD = { ok: new Audio(CFG.sfx.ok), no: new Audio(CFG.sfx.no), win: new Audio(CFG.sfx.win) };

// --- –î–í–ò–ñ–û–ö –°–ê–õ–Æ–¢–ê (–ù–ê –í–ï–°–¨ –≠–ö–†–ê–ù) ---
const cvs = document.getElementById('FX');
const ctx = cvs.getContext('2d');
let particles = [];
function resize(){ cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
window.onresize = resize; resize();

function boom(x, y, amt=30){
  const colors = ['#f00','#0f0','#00f','#ff0','#0ff','#f0f','#fff'];
  for(let i=0; i<amt; i++){
    particles.push({
      x, y, 
      vx: (Math.random()-0.5)*10, 
      vy: (Math.random()-0.5)*10,
      life: 1, 
      color: colors[Math.floor(Math.random()*colors.length)]
    });
  }
}

function loop(){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  for(let i=particles.length-1; i>=0; i--){
    let p = particles[i];
    p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life -= 0.02;
    ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
    ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill();
    if(p.life<=0) particles.splice(i,1);
  }
  requestAnimationFrame(loop);
}
loop();

// --- –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ---
const Game = {
  lvl: 0, q: 0, score: 0, lives: 3, time: 0, timer: null,
  lvlScore: 0, // –û—á–∫–∏ —á–∏—Å—Ç–æ –∑–∞ —ç—Ç–æ—Ç —É—Ä–æ–≤–µ–Ω—å

  init(){
    document.getElementById('S_START').classList.remove('active');
    this.lvl = 0; this.score = 0; this.lives = parseInt(CFG.lives);
    this.startLvl();
  },

  startLvl(){
    this.q = 0; this.lvlScore = 0;
    this.nextQ();
  },

  nextQ(){
    clearInterval(this.timer);
    const lData = CFG.levels[this.lvl];
    if(!lData) return this.endGame(true);

    // UI
    document.getElementById('ui_lives').innerText = this.lives;
    document.getElementById('ui_score').innerText = this.score;
    document.getElementById('Q_BOX').innerText = lData.q[this.q];

    // –ü–õ–ê–¢–§–û–†–ú–´
    const box = document.getElementById('PLATS'); box.innerHTML = '';
    const raw = lData.a[this.q].split('|');
    const opts = raw.map((t,i)=>({t, ok:i===0})).sort(()=>Math.random()-0.5);
    
    opts.forEach(o => {
      const el = document.createElement('div');
      el.className = 'plat'; el.innerText = o.t;
      el.onclick = (e) => this.check(o.ok, e.clientX, e.clientY);
      box.appendChild(el);
    });

    // –¢–ê–ô–ú–ï–†
    this.time = parseInt(CFG.time);
    document.getElementById('ui_time').innerText = this.time;
    this.timer = setInterval(()=>{
      this.time--;
      document.getElementById('ui_time').innerText = this.time;
      if(this.time<=0) this.check(false);
    }, 1000);
  },

  check(isOk, x, y){
    clearInterval(this.timer);
    if(isOk){
      if(AUD.ok) AUD.ok.play();
      if(x) boom(x,y); // –ú–∞–ª–µ–Ω—å–∫–∏–π —Å–∞–ª—é—Ç –ø—Ä–∏ –∫–ª–∏–∫–µ
      
      const pts = 100 + (this.time * 10);
      this.lvlScore += pts; 
      this.score += pts;
      
      this.q++;
      if(this.q >= CFG.levels[this.lvl].q.length) this.finishLvl();
      else this.nextQ();
      
    } else {
      if(AUD.no) AUD.no.play();
      document.body.classList.add('shake');
      setTimeout(()=>document.body.classList.remove('shake'), 400);
      this.lives--;
      document.getElementById('ui_lives').innerText = this.lives;
      if(this.lives<=0) this.endGame(false);
      else this.nextQ();
    }
  },

  finishLvl(){
    // –ü–æ–¥—Å—á–µ—Ç –±–æ–Ω—É—Å–æ–≤
    const lifeBonus = this.lives * 100;
    const total = this.lvlScore + lifeBonus;
    this.score += lifeBonus;

    const div = document.getElementById('lvl_stats');
    div.innerHTML = \`
      <div class="row"><span>–û—á–∫–∏ –∑–∞ –æ—Ç–≤–µ—Ç—ã:</span> <span>\${this.lvlScore}</span></div>
      <div class="row"><span>–ë–æ–Ω—É—Å –∂–∏–∑–Ω–µ–π:</span> <span>+\${lifeBonus}</span></div>
      <div class="row total"><span>–ò–¢–û–ì–û:</span> <span>\${total}</span></div>
    \`;

    document.getElementById('S_LEVEL').classList.add('active');
    
    // –ë–æ–ª—å—à–æ–π —Å–∞–ª—é—Ç
    let fw = setInterval(()=>boom(Math.random()*cvs.width, Math.random()*cvs.height*0.6), 200);
    setTimeout(()=>clearInterval(fw), 2500);
  },

  nextLevel(){
    document.getElementById('S_LEVEL').classList.remove('active');
    this.lvl++;
    if(this.lvl >= CFG.levels.length) this.endGame(true);
    else this.startLvl();
  },

  endGame(win){
    document.getElementById('S_LEVEL').classList.remove('active');
    document.getElementById('S_END').classList.add('active');
    
    document.getElementById('end_msg').innerText = win ? "–ü–û–ë–ï–î–ê!" : "GAME OVER";
    document.getElementById('end_msg').style.color = win ? "#ffe44d" : "#ff3b3b";
    
    document.getElementById('end_stats').innerHTML = \`
      <div class="row"><span>–ü—Ä–æ–π–¥–µ–Ω–æ —É—Ä–æ–≤–Ω–µ–π:</span> <span>\${this.lvl + (win?0:1)} / \${CFG.levels.length}</span></div>
      <div class="row total"><span>–§–ò–ù–ê–õ–¨–ù–´–ô –°–ß–ï–¢:</span> <span>\${this.score}</span></div>
    \`;

    if(win){
      if(AUD.win) AUD.win.play();
      setInterval(()=>boom(Math.random()*cvs.width, Math.random()*cvs.height), 400);
    }
  }
};
<\/script>
</body>
</html>`;
}

renderLvl();
</script>
</body>
</html>
