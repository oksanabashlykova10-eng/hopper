<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Leap & Learn Editor - Fixed</title>
<style>
  :root { --primary: #7cf9ff; --dark: #0a1730; --panel: #142342; --text: #eaf6ff; --accent: #4dff88; }
  body { margin:0; display:flex; height:100vh; background: #050b1a; color: var(--text); font-family: 'Segoe UI', sans-serif; overflow:hidden; }
  
  /* SIDEBAR */
  #EDITOR { width: 440px; background: var(--dark); border-right: 1px solid #333; display:flex; flex-direction:column; z-index:10; box-shadow: 4px 0 15px rgba(0,0,0,0.3); }
  #EDITOR_HEADER { padding:15px; background:var(--panel); border-bottom:1px solid #333; display:flex; align-items:center; justify-content:space-between; }
  #EDITOR_HEADER h2 { margin:0; font-size:18px; color:var(--primary); }
  
  #TABS { display:flex; background:#000; }
  .tab { flex:1; padding:12px; text-align:center; cursor:pointer; background:#111; color:#777; border-bottom:3px solid transparent; font-size:12px; font-weight:bold; transition:0.2s; }
  .tab:hover { color:#fff; background:#1a1a1a; }
  .tab.active { background:var(--panel); color:var(--primary); border-bottom:3px solid var(--primary); }
  
  #CONTROLS { flex:1; overflow-y:auto; padding:20px; }
  
  /* FORM ELEMENTS */
  .group { margin-bottom:25px; border-bottom:1px solid #222; padding-bottom:20px; }
  .group h3 { margin:0 0 15px; font-size:13px; color:var(--primary); text-transform:uppercase; letter-spacing:1px; opacity:0.8; }
  
  label { display:block; font-size:11px; margin-bottom:4px; margin-top:10px; color:#ccc; font-weight:600; }
  input[type="text"], input[type="number"], select, textarea { 
    width:100%; box-sizing:border-box; padding:8px; background:#080f20; border:1px solid #333; color:#fff; border-radius:4px; font-size:12px;
  }
  input[type="color"] { width:100%; height:30px; border:none; background:none; cursor:pointer; padding:0; }
  
  .row { display:flex; gap:10px; align-items: flex-end; }
  .col { flex:1; }

  /* BULK EDITOR */
  .level-item { background:rgba(255,255,255,0.03); border:1px solid #333; margin-bottom:10px; border-radius:6px; overflow:hidden; }
  .level-header { padding:10px; background:rgba(255,255,255,0.05); cursor:pointer; font-weight:bold; display:flex; justify-content:space-between; align-items:center; font-size:13px; }
  .level-content { padding:10px; display:none; border-top:1px solid #333; }
  .level-content.show { display:block; }

  .bulk-container { display:flex; gap:10px; height:180px; }
  .bulk-col { flex:1; display:flex; flex-direction:column; }
  .bulk-area { flex:1; resize:none; font-family: monospace; font-size:11px; white-space:pre; background:#050a15; border:1px solid #444; color:#aaddff; padding:5px; }
  .hint { font-size:10px; color:#666; margin-top:4px; font-style:italic; }

  /* BUTTONS */
  .btn { width:100%; padding:12px; cursor:pointer; background:var(--primary); color:#000; font-weight:bold; border:none; border-radius:4px; margin-top:10px; }
  .btn:hover { filter:brightness(1.1); }
  .btn.danger { background:transparent; color:#ff3b3b; width:auto; padding:4px; margin:0; }

  /* PREVIEW */
  #PREVIEW_AREA { flex:1; background:#000; display:flex; flex-direction:column; }
  #PREVIEW_BAR { height:40px; background:#111; display:flex; align-items:center; justify-content:center; gap:20px; border-bottom:1px solid #333; }
  .view-btn { padding:5px 15px; border-radius:15px; background:#222; color:#888; cursor:pointer; font-size:12px; border:1px solid #333; }
  .view-btn.active { background:var(--primary); color:#000; font-weight:bold; border-color:var(--primary); }
  iframe { border:none; width:100%; flex:1; background:#000; }
  
  /* COPY MODAL */
  #COPY_MODAL { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; display:none; align-items:center; justify-content:center; flex-direction:column; }
  #COPY_MODAL textarea { width:600px; height:300px; margin-bottom:15px; }
</style>
</head>
<body>

<div id="EDITOR">
  <div id="EDITOR_HEADER"><h2>üê∏ Leap & Learn Editor</h2></div>
  <div id="TABS">
    <div class="tab active" onclick="setTab('visuals')">–í–ò–ó–£–ê–õ</div>
    <div class="tab" onclick="setTab('fonts')">–®–†–ò–§–¢–´</div>
    <div class="tab" onclick="setTab('gameplay')">–ì–ï–ô–ú–ü–õ–ï–ô</div>
    <div class="tab" onclick="setTab('levels')">–£–†–û–í–ù–ò</div>
  </div>
  
  <div id="CONTROLS">
    <!-- VISUALS TAB -->
    <div id="tab-visuals">
      <div class="group">
        <h3>üé® –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h3>
        <label>–õ–æ–∫–∞—Ü–∏—è</label>
        <select id="bgSelect" onchange="toggleCustom('bgSelect','bgCustom'); updatePreview()">
          <option value="river">–†–µ–∫–∞</option>
          <option value="lava">–õ–∞–≤–∞</option>
          <option value="swamp">–ë–æ–ª–æ—Ç–æ</option>
          <option value="custom">–°–≤–æ—è —Å—Å—ã–ª–∫–∞...</option>
        </select>
        <input type="text" id="bgCustom" style="display:none;margin-top:5px" oninput="updatePreview()" placeholder="https://...">

        <label>–ü–µ—Ä—Å–æ–Ω–∞–∂</label>
        <select id="charSelect" onchange="toggleCustom('charSelect','charCustom'); updatePreview()">
          <option value="frog">–õ—è–≥—É—à–∫–∞</option>
          <option value="chameleon">–•–∞–º–µ–ª–µ–æ–Ω</option>
          <option value="lizard">–Ø—â–µ—Ä–∏—Ü–∞</option>
          <option value="custom">–°–≤–æ—è —Å—Å—ã–ª–∫–∞...</option>
        </select>
        <input type="text" id="charCustom" style="display:none;margin-top:5px" oninput="updatePreview()" placeholder="https://...">

        <label>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
        <select id="platSelect" onchange="toggleCustom('platSelect','platCustom'); updatePreview()">
          <option value="lily">–õ–∏–ª–∏—è</option>
          <option value="stone">–ö–∞–º–µ–Ω—å</option>
          <option value="mound">–ö–æ—á–∫–∞</option>
          <option value="custom">–°–≤–æ—è —Å—Å—ã–ª–∫–∞...</option>
        </select>
        <input type="text" id="platCustom" style="display:none;margin-top:5px" oninput="updatePreview()" placeholder="https://...">
      </div>
      <div class="group">
        <h3>üåà –¶–≤–µ—Ç–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</h3>
        <label>–ù–µ–æ–Ω–æ–≤—ã–π –∞–∫—Ü–µ–Ω—Ç</label>
        <input type="color" id="colNeon" value="#7cf9ff" oninput="updatePreview()">
        <label>–§–æ–Ω —Å—Ç–∞—Ä—Ç/—Ñ–∏–Ω–∏—à (–∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ)</label>
        <div class="row">
           <input type="color" id="colOverlay" value="#0a1730" oninput="updatePreview()">
           <input type="number" id="opOverlay" value="92" min="0" max="100" style="width:60px" oninput="updatePreview()" title="% –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏">
        </div>
      </div>
    </div>

    <!-- FONTS TAB -->
    <div id="tab-fonts" style="display:none">
      <div class="group">
        <h3>‚ùì –¢–µ–∫—Å—Ç –í–æ–ø—Ä–æ—Å–∞</h3>
        <div class="row">
          <div class="col"><label>–¶–≤–µ—Ç</label><input type="color" id="qCol" value="#0b1630" oninput="updatePreview()"></div>
          <div class="col"><label>–†–∞–∑–º–µ—Ä</label><input type="number" id="qSize" value="40" oninput="updatePreview()"></div>
        </div>
        <label>–®—Ä–∏—Ñ—Ç</label>
        <select id="qFont" onchange="updatePreview()">
           <option value="Arial, sans-serif">Arial</option>
           <option value="'Courier New', monospace">Courier New</option>
           <option value="Georgia, serif">Georgia</option>
           <option value="'Verdana', sans-serif">Verdana</option>
           <option value="'Tahoma', sans-serif">Tahoma</option>
           <option value="'Comic Sans MS', cursive">Comic Sans</option>
        </select>
      </div>

      <div class="group">
        <h3>üçÄ –¢–µ–∫—Å—Ç –û—Ç–≤–µ—Ç–æ–≤ (–ù–∞ –ª–∏—Å—Ç—å—è—Ö)</h3>
        <div class="row">
          <div class="col"><label>–¶–≤–µ—Ç</label><input type="color" id="ansCol" value="#141414" oninput="updatePreview()"></div>
          <div class="col"><label>–†–∞–∑–º–µ—Ä</label><input type="number" id="ansSize" value="18" oninput="updatePreview()"></div>
        </div>
        <label>–®—Ä–∏—Ñ—Ç</label>
        <select id="ansFont" onchange="updatePreview()">
           <option value="Arial, sans-serif">Arial</option>
           <option value="'Courier New', monospace">Courier New</option>
           <option value="'Verdana', sans-serif">Verdana</option>
           <option value="'Comic Sans MS', cursive">Comic Sans</option>
        </select>
      </div>

      <div class="group">
        <h3>‚è±Ô∏è –¢–∞–π–º–µ—Ä</h3>
        <div class="row">
          <div class="col"><label>–¶–≤–µ—Ç —Ü–∏—Ñ—Ä</label><input type="color" id="timeCol" value="#053149" oninput="updatePreview()"></div>
          <div class="col"><label>–†–∞–∑–º–µ—Ä</label><input type="number" id="timeSize" value="20" oninput="updatePreview()"></div>
        </div>
        <label>–®—Ä–∏—Ñ—Ç</label>
        <select id="timeFont" onchange="updatePreview()">
           <option value="Arial, sans-serif">Arial</option>
           <option value="'Courier New', monospace">Courier New</option>
           <option value="'Verdana', sans-serif">Verdana</option>
        </select>
      </div>

      <div class="group">
        <h3>‚ñ∂ –ö–Ω–æ–ø–∫–∏ (Start, Next)</h3>
        <div class="row">
          <div class="col"><label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label><input type="color" id="btnCol" value="#043149" oninput="updatePreview()"></div>
          <div class="col"><label>–†–∞–∑–º–µ—Ä</label><input type="number" id="btnSize" value="16" oninput="updatePreview()"></div>
        </div>
        <div class="row">
          <div class="col"><label>–¶–≤–µ—Ç —Ñ–æ–Ω–∞</label><input type="color" id="btnBg" value="#ffffff" oninput="updatePreview()"></div>
          <div class="col"><label>–®—Ä–∏—Ñ—Ç</label>
            <select id="btnFont" onchange="updatePreview()">
              <option value="Arial, sans-serif">Arial</option>
              <option value="'Verdana', sans-serif">Verdana</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- GAMEPLAY TAB -->
    <div id="tab-gameplay" style="display:none">
      <div class="group">
        <h3>‚è±Ô∏è –°–ª–æ–∂–Ω–æ—Å—Ç—å (–¢–∞–π–º–µ—Ä)</h3>
        <div class="row">
          <div class="col"><label>–°—Ç–∞—Ä—Ç (—Å–µ–∫)</label><input type="number" id="t1" value="10"></div>
          <div class="col"><label>–°–µ—Ä–µ–¥–∏–Ω–∞</label><input type="number" id="t2" value="7"></div>
          <div class="col"><label>–§–∏–Ω–∞–ª</label><input type="number" id="t3" value="5"></div>
        </div>
      </div>
      <div class="group">
        <h3>üîä –ó–≤—É–∫–∏ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</h3>
        <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (URL)</label><input type="text" id="audWin">
        <label>–û—à–∏–±–∫–∞ (URL)</label><input type="text" id="audFail">
        <label>–§–∏–Ω–∞–ª: –ü–æ–±–µ–¥–∞ (URL)</label><input type="text" id="audFinalWin">
        <label>–§–∏–Ω–∞–ª: –ü—Ä–æ–∏–≥—Ä—ã—à (URL)</label><input type="text" id="audFinalLose">
      </div>
      <div class="group">
        <h3>üèÜ –¢–µ–∫—Å—Ç—ã</h3>
        <label>–ü–æ–±–µ–¥–∞ (–ó–∞–≥–æ–ª–æ–≤–æ–∫)</label><input type="text" id="txtWin" value="CONGRATULATIONS!" oninput="updatePreview()">
        <label>–ü–æ—Ä–∞–∂–µ–Ω–∏–µ (–ó–∞–≥–æ–ª–æ–≤–æ–∫)</label><input type="text" id="txtLose" value="YOU LOST!" oninput="updatePreview()">
      </div>
    </div>

    <!-- LEVELS TAB -->
    <div id="tab-levels" style="display:none">
      <div id="levelsContainer"></div>
      <button class="btn" style="background:#333; color:#fff; border:1px dashed #555" onclick="addLevel()">+ –î–û–ë–ê–í–ò–¢–¨ –£–†–û–í–ï–ù–¨</button>
    </div>

    <br>
    <button class="btn" style="background:var(--accent); padding:16px;" onclick="generateCode()">üìã –ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î –î–õ–Ø GENIALLY</button>
  </div>
</div>

<div id="PREVIEW_AREA">
  <div id="PREVIEW_BAR">
    <div class="view-btn active" id="btnRules" onclick="toggleView('rules')">üëÅÔ∏è –ü—Ä–∞–≤–∏–ª–∞</div>
    <div class="view-btn" id="btnGame" onclick="toggleView('game')">üéÆ –ò–≥—Ä–∞</div>
  </div>
  <iframe id="previewFrame"></iframe>
</div>

<div id="COPY_MODAL">
  <h2 style="color:#fff">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥:</h2>
  <textarea id="finalCode" onclick="this.select()"></textarea>
  <button class="btn" style="width:200px" onclick="document.getElementById('COPY_MODAL').style.display='none'">–ó–ê–ö–†–´–¢–¨</button>
</div>

<script>
/* ASSETS DB */
const ASSETS={
  bg:{river:"https://img.genially.com/67961b32a116fb001568a75e/c0c9010f-c3dd-42c1-b7c1-65024fa3aec6.png",lava:"https://img.genially.com/67961b32a116fb001568a75e/fa2ab459-fec9-4ccd-97e3-254427b4ade0.png",swamp:"https://img.genially.com/67961b32a116fb001568a75e/02b52ad4-9d31-4b21-a305-8fec6e8a4487.png"},
  char:{frog:"https://img.genially.com/67961b32a116fb001568a75e/3074df22-5c73-4ad2-b0b2-491c6fc247f3.png",chameleon:"https://img.genially.com/67961b32a116fb001568a75e/74b56fcf-5354-43dd-9c9a-f50facc9a9bf.png",lizard:"https://img.genially.com/67961b32a116fb001568a75e/0feda2a1-485a-4654-8640-bf1adcc9f9ec.png"},
  plat:{lily:"https://img.genially.com/67961b32a116fb001568a75e/ed6c6e82-953b-43d4-947d-e46227b760f0.png",stone:"https://img.genially.com/67961b32a116fb001568a75e/bad37c6d-f04c-45c0-b954-807d79ec3a95.png",mound:"https://img.genially.com/67961b32a116fb001568a75e/c6775617-bde5-43e4-9da8-5332d928807e.png"}
};

let levels=[{name:"Level 1",q:"2 + 2 = ?",a:"4 | 5 | 22"}];
let viewMode='rules';

/* EDITOR UI */
function setTab(t){document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));event.target.classList.add('active');document.querySelectorAll('#CONTROLS > div').forEach(d=>d.style.display='none');document.getElementById('tab-'+t).style.display='block';}
function toggleCustom(s,i){document.getElementById(i).style.display=(document.getElementById(s).value==='custom')?'block':'none';}

function renderLevels(){
  const c=document.getElementById('levelsContainer');c.innerHTML='';
  levels.forEach((l,i)=>{
    const d=document.createElement('div');d.className='level-item';
    const qc = l.q.split('\n').filter(x=>x.trim()).length;
    d.innerHTML=`<div class="level-header" onclick="this.nextElementSibling.classList.toggle('show')"><span>${l.name} (${qc})</span><button class="btn danger" onclick="event.stopPropagation();remLevel(${i})">üóëÔ∏è</button></div>
    <div class="level-content"><label>–ò–º—è</label><input value="${l.name}" oninput="levels[${i}].name=this.value;renderLevels()">
    <div class="bulk-container"><div class="bulk-col"><label>–í–û–ü–†–û–°–´</label><textarea class="bulk-area" oninput="levels[${i}].q=this.value;upd()">${l.q}</textarea></div>
    <div class="bulk-col"><label>–û–¢–í–ï–¢–´ (–í–µ—Ä–Ω—ã–π | –ù–µ–≤–µ—Ä–Ω—ã–π | –ù–µ–≤–µ—Ä–Ω—ã–π)</label><textarea class="bulk-area" oninput="levels[${i}].a=this.value;upd()">${l.a}</textarea></div></div></div>`;
    c.appendChild(d);
  });
}
function addLevel(){levels.push({name:"New Level",q:"",a:""});renderLevels();upd();}
function remLevel(i){if(confirm("Del?")){levels.splice(i,1);renderLevels();upd();}}

/* GENERATOR - FIXED CLOSING TAGS */
function getGameHTML(){
  const g=(id)=>document.getElementById(id).value;
  const bg=g('bgSelect')==='custom'?g('bgCustom'):ASSETS.bg[g('bgSelect')];
  const ch=g('charSelect')==='custom'?g('charCustom'):ASSETS.char[g('charSelect')];
  const pl=g('platSelect')==='custom'?g('platCustom'):ASSETS.plat[g('platSelect')];
  
  // PARSE
  const parsedLevels = levels.map(l=>{
    const qs=l.q.split('\n').filter(x=>x.trim()), as=l.a.split('\n').filter(x=>x.trim());
    return { name:l.name, questions: qs.map((txt,i)=>{
       const ans = (as[i]||"True|False").split('|').map(x=>x.trim());
       return {text:txt, answers:ans, correct:0}; 
    })};
  });

  // GAME CSS
  const css = `
<style>
:root{
  --neon:${g('colNeon')};
  --font-q:${g('qFont')}; --col-q:${g('qCol')}; --sz-q:${g('qSize')}px;
  --font-ans:${g('ansFont')}; --col-ans:${g('ansCol')}; --sz-ans:${g('ansSize')}px;
  --font-tm:${g('timeFont')}; --col-tm:${g('timeCol')}; --sz-tm:${g('timeSize')}px;
  --font-btn:${g('btnFont')}; --col-btn:${g('btnCol')}; --bg-btn:${g('btnBg')}; --sz-btn:${g('btnSize')}px;
  --overlay: ${g('colOverlay')}; --overlay-op: ${g('opOverlay')/100};
}
html,body{margin:0;width:100%;height:100%;overflow:hidden;font-family:Arial;background:#0a1730}
#GAME{position:relative;width:100%;height:100%}
#GAME.shake{animation:shake .25s}
@keyframes shake{0%{transform:translate(0)}25%{transform:translate(-4px,3px)}50%{transform:translate(4px,-3px)}75%{transform:translate(-3px,2px)}100%{transform:translate(0)}}
#BG{position:absolute;inset:0;z-index:0;background:url("${bg}") center/cover no-repeat}

/* UI */
#SCORE{position:absolute;top:30px;left:30px;font-size:20px;font-weight:900;z-index:20;color:#fff;text-shadow:0 2px 0 rgba(0,0,0,.35)}
#TIMER{
  position:absolute;top:26px;left:120px;transform:none;
  height:38px;border-radius:18px;display:flex;align-items:center;justify-content:center;gap:10px;padding:0 14px;
  background:rgba(255,255,255,.95); border:2px solid var(--neon); box-shadow:0 0 18px var(--neon);
  z-index:20; font-weight:900; 
  color:var(--col-tm); font-family:var(--font-tm); font-size:var(--sz-tm);
}
#TIMER.danger{border-color:red;color:red;box-shadow:0 0 25px red;animation:timerPulse .8s infinite}
@keyframes timerPulse{50%{transform:scale(1.07)}}
#LIVES{position:absolute;top:30px;right:30px;font-size:26px;z-index:20}

/* QUESTION */
#QUESTION{position:absolute;top:18px;width:100%;display:flex;justify-content:center;z-index:20}
#QUESTION_TXT{
  padding:10px 18px;border-radius:18px;background:rgba(255,255,255,.9);
  border:1px solid rgba(124,249,255,.40);box-shadow:0 0 18px rgba(124,249,255,.25);
  font-weight:900;
  color:var(--col-q); font-family:var(--font-q); font-size:var(--sz-q);
}

/* COMBO */
#COMBO{position:absolute;top:165px;left:50%;transform:translateX(-50%);z-index:20;padding:10px 16px;border-radius:18px;background:rgba(255,255,255,.88);border:2px solid var(--neon);font-weight:900;color:#043149;display:none;gap:10px;align-items:center}
#COMBO.show{display:inline-flex}

/* BUTTONS */
.btn{
  padding:12px 34px;border-radius:16px;font-weight:900;border:2px solid var(--neon);box-shadow:0 0 15px var(--neon);cursor:pointer;
  color:var(--col-btn); background:var(--bg-btn); font-family:var(--font-btn); font-size:var(--sz-btn);
}
.btn:active{transform:translateY(1px)}

/* START SCREEN */
#START_SCREEN{position:absolute;inset:0;z-index:60;display:flex;align-items:center;justify-content:center;background:var(--overlay);opacity:var(--overlay-op)}
#START_CARD{width:min(760px, calc(100vw - 40px));border-radius:26px;background:linear-gradient(180deg, rgba(10,20,50,.92), rgba(5,10,25,.92));border:2px solid var(--neon);box-shadow:0 0 30px var(--neon);padding:18px 18px 16px;color:#eaf6ff;position:relative}
#START_ICON{width:64px;height:64px;background:url("${ch}") no-repeat center/contain}

/* END SCREEN */
#END{position:absolute;inset:0;z-index:50;background:rgba(8,16,34,.92);display:none;align-items:center;justify-content:center;flex-direction:column}
#END.show{display:flex}
#END_TEXT{font-size:58px;font-weight:900;margin:0 0 10px;text-align:center}
.win{color:#ffe44d;text-shadow:0 0 12px #ffe44d}
.lose{color:#ff3b3b;text-shadow:0 0 12px #ff3b3b}

/* GAME OBJECTS */
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(6px)}}
#FROG_WRAP{position:absolute;left:calc(160px - 17mm + 15mm - 11mm);top:calc(50% + 13mm - 11mm);width:110px;height:110px;z-index:15;pointer-events:none;animation:float 3.5s ease-in-out infinite}
#FROG{width:110px;height:110px;background:url("${ch}") no-repeat center/contain;position:absolute;left:50%;top:50%;transform:translate(-50%,-65%);transition:transform .6s ease,opacity .6s ease}
#FROG.jump{transform:translate(-50%,-95%) scale(1.05)}
#FROG.sink{transform:translate(-50%,-10%) scale(.6);opacity:0}

#PLATFORMS{position:absolute;inset:0;z-index:10}
.platform{position:absolute;width:150px;height:150px;transition:transform .5s,opacity .6s}
.lily{
  width:150px;height:150px;background:url("${pl}") no-repeat center/contain;display:flex;align-items:center;justify-content:center;
  font-weight:900; animation:float 3.5s ease-in-out infinite;
  color:var(--col-ans); font-family:var(--font-ans); font-size:var(--sz-ans);
  text-shadow:0 2px 0 rgba(255,255,255,.65), 0 0 10px rgba(0,0,0,.35);
  cursor:pointer;
}
.platform.fade{opacity:0}
.platform.wrong .lily{filter:drop-shadow(0 0 18px red)}
.wobble .lily{animation:wobble .35s ease-in-out 3}
@keyframes wobble{0%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(1px) rotate(-3deg)}50%{transform:translateY(0) rotate(3deg)}75%{transform:translateY(1px) rotate(-2deg)}100%{transform:translateY(0) rotate(0deg)}}
</style>`;

  // GAME JS - SPLIT SCRIPT TAGS
  const jsStart = "<scr" + "ipt>";
  const jsEnd = "</scr" + "ipt>";
  const js = jsStart + `
const LEVELS=${JSON.stringify(parsedLevels)};
const CFG={t1:${g('t1')},t2:${g('t2')},t3:${g('t3')},win:"${g('audWin')}",fail:"${g('audFail')}",fWin:"${g('audFinalWin')}",fLose:"${g('audFinalLose')}",txtWin:"${g('txtWin')}",txtLose:"${g('txtLose')}"};
let q=0,lives=5,score=0,started=false,timer=null,timeLeft=0,lvl=0,combo=0,QUESTIONS=[];
const ctx=new(AudioContext||webkitAudioContext)();

function sfx(t){
 if(t==='win'&&CFG.win)new Audio(CFG.win).play().catch(()=>{});
 else if(t==='fail'&&CFG.fail)new Audio(CFG.fail).play().catch(()=>{});
 else if(t==='win'){ 
   const o=ctx.createOscillator(),g=ctx.createGain();o.frequency.value=523;g.gain.setValueAtTime(0,ctx.currentTime);g.gain.linearRampToValueAtTime(.2,ctx.currentTime+.05);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.4);o.connect(g);g.connect(ctx.destination);o.start();o.stop(ctx.currentTime+.5);
 } else if(t==='fail'){ 
   const o=ctx.createOscillator(),g=ctx.createGain();o.type='sawtooth';o.frequency.value=150;g.gain.value=.3;o.frequency.linearRampToValueAtTime(50,ctx.currentTime+.3);g.gain.linearRampToValueAtTime(0,ctx.currentTime+.3);o.connect(g);g.connect(ctx.destination);o.start();o.stop(ctx.currentTime+.3);
 }
}

function render(){
  document.getElementById('PLATFORMS').innerHTML=""; 
  document.getElementById('FROG').classList.remove('sink');
  document.getElementById('SCORE').textContent="‚≠ê "+score;
  document.getElementById('LIVES').textContent="‚ù§Ô∏è".repeat(lives);
  
  if(q>=QUESTIONS.length){ showEnd(true); return; }
  
  document.getElementById('QUESTION_TXT').textContent=QUESTIONS[q].text;
  
  const STEP=190, y=window.innerHeight/2 + 76;
  const count=Math.ceil((window.innerWidth-160)/STEP)+2;
  
  let ansPool = QUESTIONS[q].answers.map((txt,i)=>({txt, correct:(i===QUESTIONS[q].correct)}));
  for(let i=ansPool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[ansPool[i],ansPool[j]]=[ansPool[j],ansPool[i]];}
  
  for(let i=0;i<count;i++){
    const d=document.createElement("div");d.className="platform";
    d.style.left=160+STEP*i-75+"px"; d.style.top=y-75+"px";
    const lily=document.createElement("div");lily.className="lily";
    
    if(i>=1 && i<=ansPool.length){
       const ans = ansPool[i-1];
       lily.textContent = ans.txt;
       d.onclick=()=>pick(ans.correct, d);
    }
    
    d.appendChild(lily); document.getElementById('PLATFORMS').appendChild(d);
  }
}

function pick(isCorrect,el){
  if(!started)return;
  clearInterval(timer);
  document.getElementById('FROG').classList.add("jump"); setTimeout(()=>document.getElementById('FROG').classList.remove("jump"),300);
  const offset = el.offsetLeft + 75 - 160; 
  document.querySelectorAll(".platform").forEach(p=>p.style.transform=\`translateX(\${-offset}px)\`);
  
  setTimeout(()=>{
    if(isCorrect){
      sfx('win'); score+=100+timeLeft*10; combo++;
      document.getElementById('COMBO').textContent="COMBO x"+(1+combo*0.1).toFixed(1);
      document.getElementById('COMBO').classList.add('show');
      q++; if(q>=QUESTIONS.length)showEnd(true); else startRound();
    }else{
      sfx('fail'); lives--; combo=0; document.getElementById('COMBO').classList.remove('show');
      document.getElementById('FROG').classList.add("sink");
      document.querySelectorAll(".platform").forEach(p=>p.classList.add("fade","wrong","wobble"));
      setTimeout(()=>{ if(lives<=0)showEnd(false); else startRound(); },900);
    }
  },500);
}

function startRound(){
  render(); clearInterval(timer);
  const tTime = (q<3)?CFG.t1:(q<6)?CFG.t2:CFG.t3;
  timeLeft=tTime; document.getElementById('TIMER').textContent="00:"+String(timeLeft).padStart(2,'0');
  document.getElementById('TIMER').classList.remove('danger');
  timer=setInterval(()=>{
    timeLeft--;
    if(timeLeft<=3)document.getElementById('TIMER').classList.add('danger');
    document.getElementById('TIMER').textContent="00:"+String(timeLeft).padStart(2,'0');
    if(timeLeft<=0){clearInterval(timer);pick(false,document.querySelector('.platform'));} 
  },1000);
}

function showEnd(win){
  clearInterval(timer); document.getElementById('END').classList.add("show");
  const txt=document.getElementById('END_TEXT');
  if(win){
    txt.textContent=CFG.txtWin; txt.className="win";
    if(CFG.fWin) new Audio(CFG.fWin).play();
    document.getElementById('NEXT_LEVEL').style.display = (lvl<LEVELS.length-1)?"inline-block":"none";
    document.getElementById('RETRY').style.display="none";
  }else{
    txt.textContent=CFG.txtLose; txt.className="lose";
    if(CFG.fLose) new Audio(CFG.fLose).play();
    document.getElementById('NEXT_LEVEL').style.display="none";
    document.getElementById('RETRY').style.display="inline-block";
  }
}

function startGame(idx){
  lvl=idx; QUESTIONS=LEVELS[lvl].questions;
  q=0; lives=5; score=0; combo=0;
  started=true; document.getElementById('START_SCREEN').style.display="none"; document.getElementById('END').classList.remove("show");
  ctx.resume(); startRound();
}

document.getElementById('START_BTN').onclick=()=>startGame(0);
document.getElementById('NEXT_LEVEL').onclick=()=>startGame(lvl+1);
document.getElementById('RETRY').onclick=()=>startGame(lvl);

/* PREVIEW MSG */
window.onmessage=(e)=>{
  if(e.data==='rules'){started=false;document.getElementById('START_SCREEN').style.display="flex";document.getElementById('END').classList.remove("show");}
  if(e.data==='game'){startGame(0);}
};
` + jsEnd;

  return `<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">${css}</head><body>
<div id="GAME"><div id="BG"></div><div id="SCORE">‚≠ê 0</div><div id="TIMER">00:00</div><div id="QUESTION"><span id="QUESTION_TXT"></span></div><div id="COMBO">COMBO x1.0</div><div id="LIVES"></div>
<div id="START_SCREEN"><div id="START_CARD"><div style="display:flex;gap:14px;align-items:center"><div id="START_ICON"></div><div><h1 style="margin:0;font-size:34px">Leap & Learn</h1></div></div>
<div style="background:rgba(255,255,255,.08);border:1px solid var(--neon);border-radius:18px;padding:12px;margin:10px 0"><ul style="margin:0;padding-left:20px;line-height:1.4"><li>Select the correct answer.</li><li>Watch the timer!</li></ul></div>
<div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center"><button id="START_BTN" class="btn">‚ñ∂ START</button></div></div></div>
<div id="END"><div id="END_TEXT"></div><div id="LEVEL_BANNER" style="color:#fff;margin-bottom:10px;font-size:20px">LEVEL DONE</div><button id="NEXT_LEVEL" class="btn">‚è≠ Next</button><button id="RETRY" class="btn" style="display:none">üîÅ Retry</button></div>
<div id="FROG_WRAP"><div id="FROG"></div></div><div id="PLATFORMS"></div></div>
${js}
</body></html>`;
}

/* EDITOR UTILS */
let updTimer;
function upd(){ clearTimeout(updTimer); updTimer=setTimeout(updatePreview,500); }
function updatePreview(){
  const html=getGameHTML();
  const f=document.getElementById('previewFrame');
  f.srcdoc=html;
  f.onload=()=>{
    f.contentWindow.postMessage(viewMode,'*');
  };
}
function toggleView(m){
  viewMode=m;
  document.getElementById('btnRules').classList.toggle('active',m==='rules');
  document.getElementById('btnGame').classList.toggle('active',m==='game');
  document.getElementById('previewFrame').contentWindow.postMessage(m,'*');
}
function generateCode(){
  document.getElementById('finalCode').value=`<iframe style="width:100%;height:100%;border:0" srcdoc='${getGameHTML().replace(/'/g,"&#39;")}'></iframe>`;
  document.getElementById('COPY_MODAL').style.display='flex';
}

// INIT
renderLevels();
updatePreview();
</script>
</body>
</html>
